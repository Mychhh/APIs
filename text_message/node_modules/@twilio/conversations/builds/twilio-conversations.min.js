/*
@license
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2019, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes javascript-state-machine under the following license.

    Copyright (c) 2012, 2013, 2014, 2015, Jake Gordon and contributors

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

This software includes loglevel under the following license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

This software includes q under the following license.

    Copyright 2009–2014 Kristopher Michael Kowal. All rights reserved.
    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to
    deal in the Software without restriction, including without limitation the
    rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
    sell copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
    IN THE SOFTWARE.

This software includes platform.js under the following license.

    Copyright 2014 Benjamin Tan <https://d10.github.io/>
    Copyright 2011-2015 John-David Dalton <http://allyoucanleet.com/>

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

*/
this.Twilio=this.Twilio||{},this.Twilio.Conversations=function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})})),t}var r=function(e){return e&&e.Math==Math&&e},i=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof t&&t)||function(){return this}()||Function("return this")(),a={},o=function(e){try{return!!e()}catch(e){return!0}},s=!o((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),u={},c={}.propertyIsEnumerable,l=Object.getOwnPropertyDescriptor,f=l&&!c.call({1:2},1);u.f=f?function(e){var t=l(this,e);return!!t&&t.enumerable}:c;var d,p,h=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},v={}.toString,y=function(e){return v.call(e).slice(8,-1)},m=y,g="".split,b=o((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==m(e)?g.call(e,""):Object(e)}:Object,k=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},w=b,x=k,_=function(e){return w(x(e))},S=function(e){return"object"==typeof e?null!==e:"function"==typeof e},E=i,T=function(e){return"function"==typeof e?e:void 0},R=function(e,t){return arguments.length<2?T(E[e]):E[e]&&E[e][t]},I=R("navigator","userAgent")||"",C=i,O=I,P=C.process,A=C.Deno,j=P&&P.versions||A&&A.version,M=j&&j.v8;M?p=(d=M.split("."))[0]<4?1:d[0]+d[1]:O&&(!(d=O.match(/Edge\/(\d+)/))||d[1]>=74)&&(d=O.match(/Chrome\/(\d+)/))&&(p=d[1]);var L=p&&+p,N=L,U=o,F=!!Object.getOwnPropertySymbols&&!U((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&N&&N<41})),D=F&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,B=R,q=D?function(e){return"symbol"==typeof e}:function(e){var t=B("Symbol");return"function"==typeof t&&Object(e)instanceof t},z=S,W={exports:{}},G=i,$=function(e,t){try{Object.defineProperty(G,e,{value:t,configurable:!0,writable:!0})}catch(n){G[e]=t}return t},V=$,J="__core-js_shared__",K=i[J]||V(J,{}),H=K;(W.exports=function(e,t){return H[e]||(H[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.17.3",mode:"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"});var Y=k,Q=function(e){return Object(Y(e))},X=Q,Z={}.hasOwnProperty,ee=Object.hasOwn||function(e,t){return Z.call(X(e),t)},te=0,ne=Math.random(),re=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++te+ne).toString(36)},ie=i,ae=W.exports,oe=ee,se=re,ue=F,ce=D,le=ae("wks"),fe=ie.Symbol,de=ce?fe:fe&&fe.withoutSetter||se,pe=function(e){return oe(le,e)&&(ue||"string"==typeof le[e])||(ue&&oe(fe,e)?le[e]=fe[e]:le[e]=de("Symbol."+e)),le[e]},he=S,ve=q,ye=function(e,t){var n,r;if("string"===t&&"function"==typeof(n=e.toString)&&!z(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!z(r=n.call(e)))return r;if("string"!==t&&"function"==typeof(n=e.toString)&&!z(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")},me=pe("toPrimitive"),ge=function(e,t){if(!he(e)||ve(e))return e;var n,r=e[me];if(void 0!==r){if(void 0===t&&(t="default"),n=r.call(e,t),!he(n)||ve(n))return n;throw TypeError("Can't convert object to primitive value")}return void 0===t&&(t="number"),ye(e,t)},be=ge,ke=q,we=function(e){var t=be(e,"string");return ke(t)?t:String(t)},xe=S,_e=i.document,Se=xe(_e)&&xe(_e.createElement),Ee=function(e){return Se?_e.createElement(e):{}},Te=Ee,Re=!s&&!o((function(){return 7!=Object.defineProperty(Te("div"),"a",{get:function(){return 7}}).a})),Ie=s,Ce=u,Oe=h,Pe=_,Ae=we,je=ee,Me=Re,Le=Object.getOwnPropertyDescriptor;a.f=Ie?Le:function(e,t){if(e=Pe(e),t=Ae(t),Me)try{return Le(e,t)}catch(e){}if(je(e,t))return Oe(!Ce.f.call(e,t),e[t])};var Ne={},Ue=S,Fe=function(e){if(!Ue(e))throw TypeError(String(e)+" is not an object");return e},De=s,Be=Re,qe=Fe,ze=we,We=Object.defineProperty;Ne.f=De?We:function(e,t,n){if(qe(e),t=ze(t),qe(n),Be)try{return We(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var Ge=Ne,$e=h,Ve=s?function(e,t,n){return Ge.f(e,t,$e(1,n))}:function(e,t,n){return e[t]=n,e},Je={exports:{}},Ke=K,He=Function.toString;"function"!=typeof Ke.inspectSource&&(Ke.inspectSource=function(e){return He.call(e)});var Ye,Qe,Xe,Ze=Ke.inspectSource,et=Ze,tt=i.WeakMap,nt="function"==typeof tt&&/native code/.test(et(tt)),rt=W.exports,it=re,at=rt("keys"),ot=function(e){return at[e]||(at[e]=it(e))},st={},ut=nt,ct=S,lt=Ve,ft=ee,dt=K,pt=ot,ht=st,vt="Object already initialized",yt=i.WeakMap;if(ut||dt.state){var mt=dt.state||(dt.state=new yt),gt=mt.get,bt=mt.has,kt=mt.set;Ye=function(e,t){if(bt.call(mt,e))throw new TypeError(vt);return t.facade=e,kt.call(mt,e,t),t},Qe=function(e){return gt.call(mt,e)||{}},Xe=function(e){return bt.call(mt,e)}}else{var wt=pt("state");ht[wt]=!0,Ye=function(e,t){if(ft(e,wt))throw new TypeError(vt);return t.facade=e,lt(e,wt,t),t},Qe=function(e){return ft(e,wt)?e[wt]:{}},Xe=function(e){return ft(e,wt)}}var xt={set:Ye,get:Qe,has:Xe,enforce:function(e){return Xe(e)?Qe(e):Ye(e,{})},getterFor:function(e){return function(t){var n;if(!ct(t)||(n=Qe(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return n}}},_t=i,St=Ve,Et=ee,Tt=$,Rt=Ze,It=xt.get,Ct=xt.enforce,Ot=String(String).split("String");(Je.exports=function(e,t,n,r){var i,a=!!r&&!!r.unsafe,o=!!r&&!!r.enumerable,s=!!r&&!!r.noTargetGet;"function"==typeof n&&("string"!=typeof t||Et(n,"name")||St(n,"name",t),(i=Ct(n)).source||(i.source=Ot.join("string"==typeof t?t:""))),e!==_t?(a?!s&&e[t]&&(o=!0):delete e[t],o?e[t]=n:St(e,t,n)):o?e[t]=n:Tt(t,n)})(Function.prototype,"toString",(function(){return"function"==typeof this&&It(this).source||Rt(this)}));var Pt={},At=Math.ceil,jt=Math.floor,Mt=function(e){return isNaN(e=+e)?0:(e>0?jt:At)(e)},Lt=Mt,Nt=Math.min,Ut=function(e){return e>0?Nt(Lt(e),9007199254740991):0},Ft=Mt,Dt=Math.max,Bt=Math.min,qt=function(e,t){var n=Ft(e);return n<0?Dt(n+t,0):Bt(n,t)},zt=_,Wt=Ut,Gt=qt,$t=function(e){return function(t,n,r){var i,a=zt(t),o=Wt(a.length),s=Gt(r,o);if(e&&n!=n){for(;o>s;)if((i=a[s++])!=i)return!0}else for(;o>s;s++)if((e||s in a)&&a[s]===n)return e||s||0;return!e&&-1}},Vt={includes:$t(!0),indexOf:$t(!1)},Jt=ee,Kt=_,Ht=Vt.indexOf,Yt=st,Qt=function(e,t){var n,r=Kt(e),i=0,a=[];for(n in r)!Jt(Yt,n)&&Jt(r,n)&&a.push(n);for(;t.length>i;)Jt(r,n=t[i++])&&(~Ht(a,n)||a.push(n));return a},Xt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Zt=Qt,en=Xt.concat("length","prototype");Pt.f=Object.getOwnPropertyNames||function(e){return Zt(e,en)};var tn={};tn.f=Object.getOwnPropertySymbols;var nn=Pt,rn=tn,an=Fe,on=R("Reflect","ownKeys")||function(e){var t=nn.f(an(e)),n=rn.f;return n?t.concat(n(e)):t},sn=ee,un=on,cn=a,ln=Ne,fn=function(e,t){for(var n=un(t),r=ln.f,i=cn.f,a=0;a<n.length;a++){var o=n[a];sn(e,o)||r(e,o,i(t,o))}},dn=o,pn=/#|\.prototype\./,hn=function(e,t){var n=yn[vn(e)];return n==gn||n!=mn&&("function"==typeof t?dn(t):!!t)},vn=hn.normalize=function(e){return String(e).replace(pn,".").toLowerCase()},yn=hn.data={},mn=hn.NATIVE="N",gn=hn.POLYFILL="P",bn=hn,kn=i,wn=a.f,xn=Ve,_n=Je.exports,Sn=$,En=fn,Tn=bn,Rn=function(e,t){var n,r,i,a,o,s=e.target,u=e.global,c=e.stat;if(n=u?kn:c?kn[s]||Sn(s,{}):(kn[s]||{}).prototype)for(r in t){if(a=t[r],i=e.noTargetGet?(o=wn(n,r))&&o.value:n[r],!Tn(u?r:s+(c?".":"#")+r,e.forced)&&void 0!==i){if(typeof a==typeof i)continue;En(a,i)}(e.sham||i&&i.sham)&&xn(a,"sham",!0),_n(n,r,a,e)}},In=Ne.f,Cn=ee,On=pe("toStringTag"),Pn=function(e,t,n){e&&!Cn(e=n?e:e.prototype,On)&&In(e,On,{configurable:!0,value:t})},An=i,jn=Pn;Rn({global:!0},{Reflect:{}}),jn(An.Reflect,"Reflect",!0);var Mn,Ln=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},Nn=Qt,Un=Xt,Fn=Object.keys||function(e){return Nn(e,Un)},Dn=Ne,Bn=Fe,qn=Fn,zn=s?Object.defineProperties:function(e,t){Bn(e);for(var n,r=qn(t),i=r.length,a=0;i>a;)Dn.f(e,n=r[a++],t[n]);return e},Wn=R("document","documentElement"),Gn=Fe,$n=zn,Vn=Xt,Jn=st,Kn=Wn,Hn=Ee,Yn=ot("IE_PROTO"),Qn=function(){},Xn=function(e){return"<script>"+e+"</"+"script>"},Zn=function(e){e.write(Xn("")),e.close();var t=e.parentWindow.Object;return e=null,t},er=function(){try{Mn=new ActiveXObject("htmlfile")}catch(e){}var e,t;er="undefined"!=typeof document?document.domain&&Mn?Zn(Mn):((t=Hn("iframe")).style.display="none",Kn.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(Xn("document.F=Object")),e.close(),e.F):Zn(Mn);for(var n=Vn.length;n--;)delete er.prototype[Vn[n]];return er()};Jn[Yn]=!0;var tr=Object.create||function(e,t){var n;return null!==e?(Qn.prototype=Gn(e),n=new Qn,Qn.prototype=null,n[Yn]=e):n=er(),void 0===t?n:$n(n,t)},nr=Ln,rr=S,ir=[].slice,ar={},or=function(e,t,n){if(!(t in ar)){for(var r=[],i=0;i<t;i++)r[i]="a["+i+"]";ar[t]=Function("C,a","return new C("+r.join(",")+")")}return ar[t](e,n)},sr=Function.bind||function(e){var t=nr(this),n=ir.call(arguments,1),r=function(){var i=n.concat(ir.call(arguments));return this instanceof r?or(t,i.length,i):t.apply(e,i)};return rr(t.prototype)&&(r.prototype=t.prototype),r},ur=Rn,cr=Ln,lr=Fe,fr=S,dr=tr,pr=sr,hr=o,vr=R("Reflect","construct"),yr=hr((function(){function e(){}return!(vr((function(){}),[],e)instanceof e)})),mr=!hr((function(){vr((function(){}))})),gr=yr||mr;ur({target:"Reflect",stat:!0,forced:gr,sham:gr},{construct:function(e,t){cr(e),lr(t);var n=arguments.length<3?e:cr(arguments[2]);if(mr&&!yr)return vr(e,t,n);if(e==n){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var r=[null];return r.push.apply(r,t),new(pr.apply(e,r))}var i=n.prototype,a=dr(fr(i)?i:Object.prototype),o=Function.apply.call(e,a,t);return fr(o)?o:a}});var br=Q,kr=Fn;Rn({target:"Object",stat:!0,forced:o((function(){kr(1)}))},{keys:function(e){return kr(br(e))}});var wr=y,xr=Array.isArray||function(e){return"Array"==wr(e)},_r=q,Sr=function(e){if(_r(e))throw TypeError("Cannot convert a Symbol value to a string");return String(e)},Er={},Tr=_,Rr=Pt.f,Ir={}.toString,Cr="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Er.f=function(e){return Cr&&"[object Window]"==Ir.call(e)?function(e){try{return Rr(e)}catch(e){return Cr.slice()}}(e):Rr(Tr(e))};var Or={},Pr=pe;Or.f=Pr;var Ar=i,jr=ee,Mr=Or,Lr=Ne.f,Nr=function(e){var t=Ar.Symbol||(Ar.Symbol={});jr(t,e)||Lr(t,e,{value:Mr.f(e)})},Ur=Ln,Fr=function(e,t,n){if(Ur(e),void 0===t)return e;switch(n){case 0:return function(){return e.call(t)};case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)}}return function(){return e.apply(t,arguments)}},Dr=S,Br=xr,qr=pe("species"),zr=function(e){var t;return Br(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!Br(t.prototype)?Dr(t)&&null===(t=t[qr])&&(t=void 0):t=void 0),void 0===t?Array:t},Wr=function(e,t){return new(zr(e))(0===t?0:t)},Gr=Fr,$r=b,Vr=Q,Jr=Ut,Kr=Wr,Hr=[].push,Yr=function(e){var t=1==e,n=2==e,r=3==e,i=4==e,a=6==e,o=7==e,s=5==e||a;return function(u,c,l,f){for(var d,p,h=Vr(u),v=$r(h),y=Gr(c,l,3),m=Jr(v.length),g=0,b=f||Kr,k=t?b(u,m):n||o?b(u,0):void 0;m>g;g++)if((s||g in v)&&(p=y(d=v[g],g,h),e))if(t)k[g]=p;else if(p)switch(e){case 3:return!0;case 5:return d;case 6:return g;case 2:Hr.call(k,d)}else switch(e){case 4:return!1;case 7:Hr.call(k,d)}return a?-1:r||i?i:k}},Qr={forEach:Yr(0),map:Yr(1),filter:Yr(2),some:Yr(3),every:Yr(4),find:Yr(5),findIndex:Yr(6),filterReject:Yr(7)},Xr=Rn,Zr=i,ei=R,ti=s,ni=F,ri=o,ii=ee,ai=xr,oi=S,si=q,ui=Fe,ci=Q,li=_,fi=we,di=Sr,pi=h,hi=tr,vi=Fn,yi=Pt,mi=Er,gi=tn,bi=a,ki=Ne,wi=u,xi=Ve,_i=Je.exports,Si=W.exports,Ei=st,Ti=re,Ri=pe,Ii=Or,Ci=Nr,Oi=Pn,Pi=xt,Ai=Qr.forEach,ji=ot("hidden"),Mi="Symbol",Li=Ri("toPrimitive"),Ni=Pi.set,Ui=Pi.getterFor(Mi),Fi=Object.prototype,Di=Zr.Symbol,Bi=ei("JSON","stringify"),qi=bi.f,zi=ki.f,Wi=mi.f,Gi=wi.f,$i=Si("symbols"),Vi=Si("op-symbols"),Ji=Si("string-to-symbol-registry"),Ki=Si("symbol-to-string-registry"),Hi=Si("wks"),Yi=Zr.QObject,Qi=!Yi||!Yi.prototype||!Yi.prototype.findChild,Xi=ti&&ri((function(){return 7!=hi(zi({},"a",{get:function(){return zi(this,"a",{value:7}).a}})).a}))?function(e,t,n){var r=qi(Fi,t);r&&delete Fi[t],zi(e,t,n),r&&e!==Fi&&zi(Fi,t,r)}:zi,Zi=function(e,t){var n=$i[e]=hi(Di.prototype);return Ni(n,{type:Mi,tag:e,description:t}),ti||(n.description=t),n},ea=function(e,t,n){e===Fi&&ea(Vi,t,n),ui(e);var r=fi(t);return ui(n),ii($i,r)?(n.enumerable?(ii(e,ji)&&e[ji][r]&&(e[ji][r]=!1),n=hi(n,{enumerable:pi(0,!1)})):(ii(e,ji)||zi(e,ji,pi(1,{})),e[ji][r]=!0),Xi(e,r,n)):zi(e,r,n)},ta=function(e,t){ui(e);var n=li(t),r=vi(n).concat(aa(n));return Ai(r,(function(t){ti&&!na.call(n,t)||ea(e,t,n[t])})),e},na=function(e){var t=fi(e),n=Gi.call(this,t);return!(this===Fi&&ii($i,t)&&!ii(Vi,t))&&(!(n||!ii(this,t)||!ii($i,t)||ii(this,ji)&&this[ji][t])||n)},ra=function(e,t){var n=li(e),r=fi(t);if(n!==Fi||!ii($i,r)||ii(Vi,r)){var i=qi(n,r);return!i||!ii($i,r)||ii(n,ji)&&n[ji][r]||(i.enumerable=!0),i}},ia=function(e){var t=Wi(li(e)),n=[];return Ai(t,(function(e){ii($i,e)||ii(Ei,e)||n.push(e)})),n},aa=function(e){var t=e===Fi,n=Wi(t?Vi:li(e)),r=[];return Ai(n,(function(e){!ii($i,e)||t&&!ii(Fi,e)||r.push($i[e])})),r};(ni||(Di=function(){if(this instanceof Di)throw TypeError("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?di(arguments[0]):void 0,t=Ti(e),n=function(e){this===Fi&&n.call(Vi,e),ii(this,ji)&&ii(this[ji],t)&&(this[ji][t]=!1),Xi(this,t,pi(1,e))};return ti&&Qi&&Xi(Fi,t,{configurable:!0,set:n}),Zi(t,e)},_i(Di.prototype,"toString",(function(){return Ui(this).tag})),_i(Di,"withoutSetter",(function(e){return Zi(Ti(e),e)})),wi.f=na,ki.f=ea,bi.f=ra,yi.f=mi.f=ia,gi.f=aa,Ii.f=function(e){return Zi(Ri(e),e)},ti&&(zi(Di.prototype,"description",{configurable:!0,get:function(){return Ui(this).description}}),_i(Fi,"propertyIsEnumerable",na,{unsafe:!0}))),Xr({global:!0,wrap:!0,forced:!ni,sham:!ni},{Symbol:Di}),Ai(vi(Hi),(function(e){Ci(e)})),Xr({target:Mi,stat:!0,forced:!ni},{for:function(e){var t=di(e);if(ii(Ji,t))return Ji[t];var n=Di(t);return Ji[t]=n,Ki[n]=t,n},keyFor:function(e){if(!si(e))throw TypeError(e+" is not a symbol");if(ii(Ki,e))return Ki[e]},useSetter:function(){Qi=!0},useSimple:function(){Qi=!1}}),Xr({target:"Object",stat:!0,forced:!ni,sham:!ti},{create:function(e,t){return void 0===t?hi(e):ta(hi(e),t)},defineProperty:ea,defineProperties:ta,getOwnPropertyDescriptor:ra}),Xr({target:"Object",stat:!0,forced:!ni},{getOwnPropertyNames:ia,getOwnPropertySymbols:aa}),Xr({target:"Object",stat:!0,forced:ri((function(){gi.f(1)}))},{getOwnPropertySymbols:function(e){return gi.f(ci(e))}}),Bi)&&Xr({target:"JSON",stat:!0,forced:!ni||ri((function(){var e=Di();return"[null]"!=Bi([e])||"{}"!=Bi({a:e})||"{}"!=Bi(Object(e))}))},{stringify:function(e,t,n){for(var r,i=[e],a=1;arguments.length>a;)i.push(arguments[a++]);if(r=t,(oi(t)||void 0!==e)&&!si(e))return ai(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!si(t))return t}),i[1]=t,Bi.apply(null,i)}});Di.prototype[Li]||xi(Di.prototype,Li,Di.prototype.valueOf),Oi(Di,Mi),Ei[ji]=!0;var oa=o,sa=L,ua=pe("species"),ca=function(e){return sa>=51||!oa((function(){var t=[];return(t.constructor={})[ua]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},la=Qr.filter;Rn({target:"Array",proto:!0,forced:!ca("filter")},{filter:function(e){return la(this,e,arguments.length>1?arguments[1]:void 0)}});var fa=Rn,da=o,pa=_,ha=a.f,va=s,ya=da((function(){ha(1)}));fa({target:"Object",stat:!0,forced:!va||ya,sham:!va},{getOwnPropertyDescriptor:function(e,t){return ha(pa(e),t)}});var ma=we,ga=Ne,ba=h,ka=function(e,t,n){var r=ma(t);r in e?ga.f(e,r,ba(0,n)):e[r]=n},wa=on,xa=_,_a=a,Sa=ka;function Ea(e,t,n,r,i,a,o){try{var s=e[a](o),u=s.value}catch(e){return void n(e)}s.done?t(u):Promise.resolve(u).then(r,i)}function Ta(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){Ea(a,r,i,o,s,"next",e)}function s(e){Ea(a,r,i,o,s,"throw",e)}o(void 0)}))}}function Ra(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ia(e,t){return Ia=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},Ia(e,t)}function Ca(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Ia(e,t)}function Oa(e){return Oa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Oa(e)}function Pa(e,t){if(t&&("object"===Oa(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return Ra(e)}function Aa(e){return Aa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},Aa(e)}function ja(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ma(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function La(e,t,n){return t&&Ma(e.prototype,t),n&&Ma(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function Na(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Rn({target:"Object",stat:!0,sham:!s},{getOwnPropertyDescriptors:function(e){for(var t,n,r=xa(e),i=_a.f,a=wa(r),o={},s=0;a.length>s;)void 0!==(n=i(r,t=a[s++]))&&Sa(o,t,n);return o}});var Ua={};Ua[pe("toStringTag")]="z";var Fa="[object z]"===String(Ua),Da=Fa,Ba=y,qa=pe("toStringTag"),za="Arguments"==Ba(function(){return arguments}()),Wa=Da?Ba:function(e){var t,n,r;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),qa))?n:za?Ba(t):"Object"==(r=Ba(t))&&"function"==typeof t.callee?"Arguments":r},Ga=Wa,$a=Fa?{}.toString:function(){return"[object "+Ga(this)+"]"},Va=Fa,Ja=Je.exports,Ka=$a;Va||Ja(Object.prototype,"toString",Ka,{unsafe:!0});var Ha=i.Promise,Ya=Je.exports,Qa=function(e,t,n){for(var r in t)Ya(e,r,t[r],n);return e},Xa=S,Za=Fe,eo=function(e){if(!Xa(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype");return e},to=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),t=n instanceof Array}catch(e){}return function(n,r){return Za(n),eo(r),t?e.call(n,r):n.__proto__=r,n}}():void 0),no=R,ro=Ne,io=s,ao=pe("species"),oo=function(e){var t=no(e),n=ro.f;io&&t&&!t[ao]&&n(t,ao,{configurable:!0,get:function(){return this}})},so=function(e,t,n){if(!(e instanceof t))throw TypeError("Incorrect "+(n?n+" ":"")+"invocation");return e},uo={},co=uo,lo=pe("iterator"),fo=Array.prototype,po=function(e){return void 0!==e&&(co.Array===e||fo[lo]===e)},ho=Wa,vo=uo,yo=pe("iterator"),mo=function(e){if(null!=e)return e[yo]||e["@@iterator"]||vo[ho(e)]},go=Fe,bo=mo,ko=function(e,t){var n=arguments.length<2?bo(e):t;if("function"!=typeof n)throw TypeError(String(e)+" is not iterable");return go(n.call(e))},wo=Fe,xo=function(e,t,n){var r,i;wo(e);try{if(void 0===(r=e.return)){if("throw"===t)throw n;return n}r=r.call(e)}catch(e){i=!0,r=e}if("throw"===t)throw n;if(i)throw r;return wo(r),n},_o=Fe,So=po,Eo=Ut,To=Fr,Ro=ko,Io=mo,Co=xo,Oo=function(e,t){this.stopped=e,this.result=t},Po=function(e,t,n){var r,i,a,o,s,u,c,l=n&&n.that,f=!(!n||!n.AS_ENTRIES),d=!(!n||!n.IS_ITERATOR),p=!(!n||!n.INTERRUPTED),h=To(t,l,1+f+p),v=function(e){return r&&Co(r,"normal",e),new Oo(!0,e)},y=function(e){return f?(_o(e),p?h(e[0],e[1],v):h(e[0],e[1])):p?h(e,v):h(e)};if(d)r=e;else{if("function"!=typeof(i=Io(e)))throw TypeError("Target is not iterable");if(So(i)){for(a=0,o=Eo(e.length);o>a;a++)if((s=y(e[a]))&&s instanceof Oo)return s;return new Oo(!1)}r=Ro(e,i)}for(u=r.next;!(c=u.call(r)).done;){try{s=y(c.value)}catch(e){Co(r,"throw",e)}if("object"==typeof s&&s&&s instanceof Oo)return s}return new Oo(!1)},Ao=pe("iterator"),jo=!1;try{var Mo=0,Lo={next:function(){return{done:!!Mo++}},return:function(){jo=!0}};Lo[Ao]=function(){return this},Array.from(Lo,(function(){throw 2}))}catch(e){}var No,Uo,Fo,Do,Bo=function(e,t){if(!t&&!jo)return!1;var n=!1;try{var r={};r[Ao]=function(){return{next:function(){return{done:n=!0}}}},e(r)}catch(e){}return n},qo=Fe,zo=Ln,Wo=pe("species"),Go=function(e,t){var n,r=qo(e).constructor;return void 0===r||null==(n=qo(r)[Wo])?t:zo(n)},$o=/(?:ipad|iphone|ipod).*applewebkit/i.test(I),Vo="process"==y(i.process),Jo=i,Ko=o,Ho=Fr,Yo=Wn,Qo=Ee,Xo=$o,Zo=Vo,es=Jo.setImmediate,ts=Jo.clearImmediate,ns=Jo.process,rs=Jo.MessageChannel,is=Jo.Dispatch,as=0,os={},ss="onreadystatechange";try{No=Jo.location}catch(e){}var us=function(e){if(os.hasOwnProperty(e)){var t=os[e];delete os[e],t()}},cs=function(e){return function(){us(e)}},ls=function(e){us(e.data)},fs=function(e){Jo.postMessage(String(e),No.protocol+"//"+No.host)};es&&ts||(es=function(e){for(var t=[],n=arguments.length,r=1;n>r;)t.push(arguments[r++]);return os[++as]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},Uo(as),as},ts=function(e){delete os[e]},Zo?Uo=function(e){ns.nextTick(cs(e))}:is&&is.now?Uo=function(e){is.now(cs(e))}:rs&&!Xo?(Do=(Fo=new rs).port2,Fo.port1.onmessage=ls,Uo=Ho(Do.postMessage,Do,1)):Jo.addEventListener&&"function"==typeof postMessage&&!Jo.importScripts&&No&&"file:"!==No.protocol&&!Ko(fs)?(Uo=fs,Jo.addEventListener("message",ls,!1)):Uo=ss in Qo("script")?function(e){Yo.appendChild(Qo("script")).onreadystatechange=function(){Yo.removeChild(this),us(e)}}:function(e){setTimeout(cs(e),0)});var ds,ps,hs,vs,ys,ms,gs,bs,ks={set:es,clear:ts},ws=i,xs=/ipad|iphone|ipod/i.test(I)&&void 0!==ws.Pebble,_s=/web0s(?!.*chrome)/i.test(I),Ss=i,Es=a.f,Ts=ks.set,Rs=$o,Is=xs,Cs=_s,Os=Vo,Ps=Ss.MutationObserver||Ss.WebKitMutationObserver,As=Ss.document,js=Ss.process,Ms=Ss.Promise,Ls=Es(Ss,"queueMicrotask"),Ns=Ls&&Ls.value;Ns||(ds=function(){var e,t;for(Os&&(e=js.domain)&&e.exit();ps;){t=ps.fn,ps=ps.next;try{t()}catch(e){throw ps?vs():hs=void 0,e}}hs=void 0,e&&e.enter()},Rs||Os||Cs||!Ps||!As?!Is&&Ms&&Ms.resolve?((gs=Ms.resolve(void 0)).constructor=Ms,bs=gs.then,vs=function(){bs.call(gs,ds)}):vs=Os?function(){js.nextTick(ds)}:function(){Ts.call(Ss,ds)}:(ys=!0,ms=As.createTextNode(""),new Ps(ds).observe(ms,{characterData:!0}),vs=function(){ms.data=ys=!ys}));var Us=Ns||function(e){var t={fn:e,next:void 0};hs&&(hs.next=t),ps||(ps=t,vs()),hs=t},Fs={},Ds=Ln,Bs=function(e){var t,n;this.promise=new e((function(e,r){if(void 0!==t||void 0!==n)throw TypeError("Bad Promise constructor");t=e,n=r})),this.resolve=Ds(t),this.reject=Ds(n)};Fs.f=function(e){return new Bs(e)};var qs,zs,Ws,Gs,$s=Fe,Vs=S,Js=Fs,Ks=i,Hs="object"==typeof window,Ys=Rn,Qs=i,Xs=R,Zs=Ha,eu=Je.exports,tu=Qa,nu=to,ru=Pn,iu=oo,au=S,ou=Ln,su=so,uu=Ze,cu=Po,lu=Bo,fu=Go,du=ks.set,pu=Us,hu=function(e,t){if($s(e),Vs(t)&&t.constructor===e)return t;var n=Js.f(e);return(0,n.resolve)(t),n.promise},vu=function(e,t){var n=Ks.console;n&&n.error&&(1===arguments.length?n.error(e):n.error(e,t))},yu=Fs,mu=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},gu=xt,bu=bn,ku=Hs,wu=Vo,xu=L,_u=pe("species"),Su="Promise",Eu=gu.get,Tu=gu.set,Ru=gu.getterFor(Su),Iu=Zs&&Zs.prototype,Cu=Zs,Ou=Iu,Pu=Qs.TypeError,Au=Qs.document,ju=Qs.process,Mu=yu.f,Lu=Mu,Nu=!!(Au&&Au.createEvent&&Qs.dispatchEvent),Uu="function"==typeof PromiseRejectionEvent,Fu="unhandledrejection",Du=!1,Bu=bu(Su,(function(){var e=uu(Cu),t=e!==String(Cu);if(!t&&66===xu)return!0;if(xu>=51&&/native code/.test(e))return!1;var n=new Cu((function(e){e(1)})),r=function(e){e((function(){}),(function(){}))};return(n.constructor={})[_u]=r,!(Du=n.then((function(){}))instanceof r)||!t&&ku&&!Uu})),qu=Bu||!lu((function(e){Cu.all(e).catch((function(){}))})),zu=function(e){var t;return!(!au(e)||"function"!=typeof(t=e.then))&&t},Wu=function(e,t){if(!e.notified){e.notified=!0;var n=e.reactions;pu((function(){for(var r=e.value,i=1==e.state,a=0;n.length>a;){var o,s,u,c=n[a++],l=i?c.ok:c.fail,f=c.resolve,d=c.reject,p=c.domain;try{l?(i||(2===e.rejection&&Ju(e),e.rejection=1),!0===l?o=r:(p&&p.enter(),o=l(r),p&&(p.exit(),u=!0)),o===c.promise?d(Pu("Promise-chain cycle")):(s=zu(o))?s.call(o,f,d):f(o)):d(r)}catch(e){p&&!u&&p.exit(),d(e)}}e.reactions=[],e.notified=!1,t&&!e.rejection&&$u(e)}))}},Gu=function(e,t,n){var r,i;Nu?((r=Au.createEvent("Event")).promise=t,r.reason=n,r.initEvent(e,!1,!0),Qs.dispatchEvent(r)):r={promise:t,reason:n},!Uu&&(i=Qs["on"+e])?i(r):e===Fu&&vu("Unhandled promise rejection",n)},$u=function(e){du.call(Qs,(function(){var t,n=e.facade,r=e.value;if(Vu(e)&&(t=mu((function(){wu?ju.emit("unhandledRejection",r,n):Gu(Fu,n,r)})),e.rejection=wu||Vu(e)?2:1,t.error))throw t.value}))},Vu=function(e){return 1!==e.rejection&&!e.parent},Ju=function(e){du.call(Qs,(function(){var t=e.facade;wu?ju.emit("rejectionHandled",t):Gu("rejectionhandled",t,e.value)}))},Ku=function(e,t,n){return function(r){e(t,r,n)}},Hu=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,Wu(e,!0))},Yu=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw Pu("Promise can't be resolved itself");var r=zu(t);r?pu((function(){var n={done:!1};try{r.call(t,Ku(Yu,n,e),Ku(Hu,n,e))}catch(t){Hu(n,t,e)}})):(e.value=t,e.state=1,Wu(e,!1))}catch(t){Hu({done:!1},t,e)}}};if(Bu&&(Ou=(Cu=function(e){su(this,Cu,Su),ou(e),qs.call(this);var t=Eu(this);try{e(Ku(Yu,t),Ku(Hu,t))}catch(e){Hu(t,e)}}).prototype,(qs=function(e){Tu(this,{type:Su,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=tu(Ou,{then:function(e,t){var n=Ru(this),r=Mu(fu(this,Cu));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=wu?ju.domain:void 0,n.parent=!0,n.reactions.push(r),0!=n.state&&Wu(n,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),zs=function(){var e=new qs,t=Eu(e);this.promise=e,this.resolve=Ku(Yu,t),this.reject=Ku(Hu,t)},yu.f=Mu=function(e){return e===Cu||e===Ws?new zs(e):Lu(e)},"function"==typeof Zs&&Iu!==Object.prototype)){Gs=Iu.then,Du||(eu(Iu,"then",(function(e,t){var n=this;return new Cu((function(e,t){Gs.call(n,e,t)})).then(e,t)}),{unsafe:!0}),eu(Iu,"catch",Ou.catch,{unsafe:!0}));try{delete Iu.constructor}catch(e){}nu&&nu(Iu,Ou)}Ys({global:!0,wrap:!0,forced:Bu},{Promise:Cu}),ru(Cu,Su,!1),iu(Su),Ws=Xs(Su),Ys({target:Su,stat:!0,forced:Bu},{reject:function(e){var t=Mu(this);return t.reject.call(void 0,e),t.promise}}),Ys({target:Su,stat:!0,forced:Bu},{resolve:function(e){return hu(this,e)}}),Ys({target:Su,stat:!0,forced:qu},{all:function(e){var t=this,n=Mu(t),r=n.resolve,i=n.reject,a=mu((function(){var n=ou(t.resolve),a=[],o=0,s=1;cu(e,(function(e){var u=o++,c=!1;a.push(void 0),s++,n.call(t,e).then((function(e){c||(c=!0,a[u]=e,--s||r(a))}),i)})),--s||r(a)}));return a.error&&i(a.value),n.promise},race:function(e){var t=this,n=Mu(t),r=n.reject,i=mu((function(){var i=ou(t.resolve);cu(e,(function(e){i.call(t,e).then(n.resolve,r)}))}));return i.error&&r(i.value),n.promise}});var Qu=Qr.map;Rn({target:"Array",proto:!0,forced:!ca("map")},{map:function(e){return Qu(this,e,arguments.length>1?arguments[1]:void 0)}});var Xu={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Zu=Ee("span").classList,ec=Zu&&Zu.constructor&&Zu.constructor.prototype,tc=ec===Object.prototype?void 0:ec,nc=o,rc=function(e,t){var n=[][e];return!!n&&nc((function(){n.call(null,t||function(){throw 1},1)}))},ic=Qr.forEach,ac=rc("forEach")?[].forEach:function(e){return ic(this,e,arguments.length>1?arguments[1]:void 0)},oc=i,sc=Xu,uc=tc,cc=ac,lc=Ve,fc=function(e){if(e&&e.forEach!==cc)try{lc(e,"forEach",cc)}catch(t){e.forEach=cc}};for(var dc in sc)fc(oc[dc]&&oc[dc].prototype);fc(uc);var pc,hc=Object.prototype,vc=hc.hasOwnProperty,yc="function"==typeof Symbol?Symbol:{},mc=yc.iterator||"@@iterator",gc=yc.asyncIterator||"@@asyncIterator",bc=yc.toStringTag||"@@toStringTag";function kc(e,t,n,r){var i=t&&t.prototype instanceof Rc?t:Rc,a=Object.create(i.prototype),o=new Bc(r||[]);return a._invoke=function(e,t,n){var r=xc;return function(i,a){if(r===Sc)throw new Error("Generator is already running");if(r===Ec){if("throw"===i)throw a;return zc()}for(n.method=i,n.arg=a;;){var o=n.delegate;if(o){var s=Uc(o,n);if(s){if(s===Tc)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===xc)throw r=Ec,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=Sc;var u=wc(e,t,n);if("normal"===u.type){if(r=n.done?Ec:_c,u.arg===Tc)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=Ec,n.method="throw",n.arg=u.arg)}}}(e,n,o),a}function wc(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}var xc="suspendedStart",_c="suspendedYield",Sc="executing",Ec="completed",Tc={};function Rc(){}function Ic(){}function Cc(){}var Oc={};Oc[mc]=function(){return this};var Pc=Object.getPrototypeOf,Ac=Pc&&Pc(Pc(qc([])));Ac&&Ac!==hc&&vc.call(Ac,mc)&&(Oc=Ac);var jc=Cc.prototype=Rc.prototype=Object.create(Oc);function Mc(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function Lc(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===Ic||"GeneratorFunction"===(t.displayName||t.name))}function Nc(e,t){function n(r,i,a,o){var s=wc(e[r],e,i);if("throw"!==s.type){var u=s.arg,c=u.value;return c&&"object"===Oa(c)&&vc.call(c,"__await")?t.resolve(c.__await).then((function(e){n("next",e,a,o)}),(function(e){n("throw",e,a,o)})):t.resolve(c).then((function(e){u.value=e,a(u)}),(function(e){return n("throw",e,a,o)}))}o(s.arg)}var r;this._invoke=function(e,i){function a(){return new t((function(t,r){n(e,i,t,r)}))}return r=r?r.then(a,a):a()}}function Uc(e,t){var n=e.iterator[t.method];if(n===pc){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=pc,Uc(e,t),"throw"===t.method))return Tc;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return Tc}var r=wc(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,Tc;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=pc),t.delegate=null,Tc):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,Tc)}function Fc(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function Dc(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Bc(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(Fc,this),this.reset(!0)}function qc(e){if(e){var t=e[mc];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(vc.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=pc,t.done=!0,t};return r.next=r}}return{next:zc}}function zc(){return{value:pc,done:!0}}Ic.prototype=jc.constructor=Cc,Cc.constructor=Ic,Cc[bc]=Ic.displayName="GeneratorFunction",Mc(Nc.prototype),Nc.prototype[gc]=function(){return this},Mc(jc),jc[bc]="Generator",jc[mc]=function(){return this},jc.toString=function(){return"[object Generator]"},Bc.prototype={constructor:Bc,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=pc,this.done=!1,this.delegate=null,this.method="next",this.arg=pc,this.tryEntries.forEach(Dc),!e)for(var t in this)"t"===t.charAt(0)&&vc.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=pc)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=pc),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var o=vc.call(i,"catchLoc"),s=vc.call(i,"finallyLoc");if(o&&s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(o){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&vc.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,Tc):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),Tc},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),Dc(n),Tc}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;Dc(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:qc(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=pc),Tc}};var Wc={wrap:kc,isGeneratorFunction:Lc,AsyncIterator:Nc,mark:function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,Cc):(e.__proto__=Cc,bc in e||(e[bc]="GeneratorFunction")),e.prototype=Object.create(jc),e},awrap:function(e){return{__await:e}},async:function(e,t,n,r,i){void 0===i&&(i=Promise);var a=new Nc(kc(e,t,n,r),i);return Lc(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},keys:function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},values:qc},Gc=Object.freeze({__proto__:null,default:Wc});function $c(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":Oa(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o}function Vc(e,t){if("object"===("undefined"==typeof Reflect?"undefined":Oa(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}var Jc=Rn,Kc=o,Hc=xr,Yc=S,Qc=Q,Xc=Ut,Zc=ka,el=Wr,tl=ca,nl=L,rl=pe("isConcatSpreadable"),il=9007199254740991,al="Maximum allowed index exceeded",ol=nl>=51||!Kc((function(){var e=[];return e[rl]=!1,e.concat()[0]!==e})),sl=tl("concat"),ul=function(e){if(!Yc(e))return!1;var t=e[rl];return void 0!==t?!!t:Hc(e)};Jc({target:"Array",proto:!0,forced:!ol||!sl},{concat:function(e){var t,n,r,i,a,o=Qc(this),s=el(o,0),u=0;for(t=-1,r=arguments.length;t<r;t++)if(ul(a=-1===t?o:arguments[t])){if(u+(i=Xc(a.length))>il)throw TypeError(al);for(n=0;n<i;n++,u++)n in a&&Zc(s,u,a[n])}else{if(u>=il)throw TypeError(al);Zc(s,u++,a)}return s.length=u,s}});var cl=Fe,ll=xo,fl=Fr,dl=Q,pl=function(e,t,n,r){try{return r?t(cl(n)[0],n[1]):t(n)}catch(t){ll(e,"throw",t)}},hl=po,vl=Ut,yl=ka,ml=ko,gl=mo,bl=function(e){var t,n,r,i,a,o,s=dl(e),u="function"==typeof this?this:Array,c=arguments.length,l=c>1?arguments[1]:void 0,f=void 0!==l,d=gl(s),p=0;if(f&&(l=fl(l,c>2?arguments[2]:void 0,2)),null==d||u==Array&&hl(d))for(n=new u(t=vl(s.length));t>p;p++)o=f?l(s[p],p):s[p],yl(n,p,o);else for(a=(i=ml(s,d)).next,n=new u;!(r=a.call(i)).done;p++)o=f?pl(i,l,[r.value,p],!0):r.value,yl(n,p,o);return n.length=p,n},kl=bl;Rn({target:"Array",stat:!0,forced:!Bo((function(e){Array.from(e)}))},{from:kl});var wl,xl,_l,Sl=Mt,El=Sr,Tl=k,Rl=function(e){return function(t,n){var r,i,a=El(Tl(t)),o=Sl(n),s=a.length;return o<0||o>=s?e?"":void 0:(r=a.charCodeAt(o))<55296||r>56319||o+1===s||(i=a.charCodeAt(o+1))<56320||i>57343?e?a.charAt(o):r:e?a.slice(o,o+2):i-56320+(r-55296<<10)+65536}},Il={codeAt:Rl(!1),charAt:Rl(!0)},Cl=!o((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Ol=ee,Pl=Q,Al=Cl,jl=ot("IE_PROTO"),Ml=Object.prototype,Ll=Al?Object.getPrototypeOf:function(e){return e=Pl(e),Ol(e,jl)?e[jl]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?Ml:null},Nl=o,Ul=Ll,Fl=Ve,Dl=pe("iterator"),Bl=!1;[].keys&&("next"in(_l=[].keys())?(xl=Ul(Ul(_l)))!==Object.prototype&&(wl=xl):Bl=!0);var ql=null==wl||Nl((function(){var e={};return wl[Dl].call(e)!==e}));ql&&(wl={}),"function"!=typeof wl[Dl]&&Fl(wl,Dl,(function(){return this}));var zl={IteratorPrototype:wl,BUGGY_SAFARI_ITERATORS:Bl},Wl=zl.IteratorPrototype,Gl=tr,$l=h,Vl=Pn,Jl=uo,Kl=function(){return this},Hl=function(e,t,n){var r=t+" Iterator";return e.prototype=Gl(Wl,{next:$l(1,n)}),Vl(e,r,!1),Jl[r]=Kl,e},Yl=Rn,Ql=Hl,Xl=Ll,Zl=to,ef=Pn,tf=Ve,nf=Je.exports,rf=uo,af=zl.IteratorPrototype,of=zl.BUGGY_SAFARI_ITERATORS,sf=pe("iterator"),uf="keys",cf="values",lf="entries",ff=function(){return this},df=function(e,t,n,r,i,a,o){Ql(n,t,r);var s,u,c,l=function(e){if(e===i&&v)return v;if(!of&&e in p)return p[e];switch(e){case uf:case cf:case lf:return function(){return new n(this,e)}}return function(){return new n(this)}},f=t+" Iterator",d=!1,p=e.prototype,h=p[sf]||p["@@iterator"]||i&&p[i],v=!of&&h||l(i),y="Array"==t&&p.entries||h;if(y&&(s=Xl(y.call(new e)))!==Object.prototype&&s.next&&(Xl(s)!==af&&(Zl?Zl(s,af):"function"!=typeof s[sf]&&tf(s,sf,ff)),ef(s,f,!0)),i==cf&&h&&h.name!==cf&&(d=!0,v=function(){return h.call(this)}),p[sf]!==v&&tf(p,sf,v),rf[t]=v,i)if(u={values:l(cf),keys:a?v:l(uf),entries:l(lf)},o)for(c in u)(of||d||!(c in p))&&nf(p,c,u[c]);else Yl({target:t,proto:!0,forced:of||d},u);return u},pf=Il.charAt,hf=Sr,vf=xt,yf=df,mf="String Iterator",gf=vf.set,bf=vf.getterFor(mf);yf(String,"String",(function(e){gf(this,{type:mf,string:hf(e),index:0})}),(function(){var e,t=bf(this),n=t.string,r=t.index;return r>=n.length?{value:void 0,done:!0}:(e=pf(n,r),t.index+=e.length,{value:e,done:!1})}));var kf,wf,xf,_f={exports:{}};function Sf(e,t){return["".concat((new Date).toISOString()," Conversations ").concat(e,":")].concat(Array.from(t))}wf=t,xf=function(){var e=function(){},t="undefined",n=("undefined"==typeof window?"undefined":Oa(window))!==t&&Oa(window.navigator)!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function o(r){return"debug"===r&&(r="log"),("undefined"==typeof console?"undefined":Oa(console))!==t&&("trace"===r&&n?a:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}function s(t,n){for(var i=0;i<r.length;i++){var a=r[i];this[a]=i<t?e:this.methodFactory(a,t,n)}this.log=this.debug}function u(e,n,r){return function(){("undefined"==typeof console?"undefined":Oa(console))!==t&&(s.call(this,n,r),this[e].apply(this,arguments))}}function c(e,t,n){return o(e)||u.apply(this,arguments)}function l(e,n,i){var a,o=this;n=null==n?"WARN":n;var u="loglevel";function l(){var e;if(("undefined"==typeof window?"undefined":Oa(window))!==t&&u){try{e=window.localStorage[u]}catch(e){}if(Oa(e)===t)try{var n=window.document.cookie,r=n.indexOf(encodeURIComponent(u)+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r))[1])}catch(e){}return void 0===o.levels[e]&&(e=void 0),e}}"string"==typeof e?u+=":"+e:"symbol"===Oa(e)&&(u=void 0),o.name=e,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=i||c,o.getLevel=function(){return a},o.setLevel=function(n,i){if("string"==typeof n&&void 0!==o.levels[n.toUpperCase()]&&(n=o.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=o.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(a=n,!1!==i&&function(e){var n=(r[e]||"silent").toUpperCase();if(("undefined"==typeof window?"undefined":Oa(window))!==t&&u){try{return void(window.localStorage[u]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+n+";"}catch(e){}}}(n),s.call(o,n,e),("undefined"==typeof console?"undefined":Oa(console))===t&&n<o.levels.SILENT)return"No console available for logging"},o.setDefaultLevel=function(e){n=e,l()||o.setLevel(e,!1)},o.resetLevel=function(){o.setLevel(n,!1),function(){if(("undefined"==typeof window?"undefined":Oa(window))!==t&&u){try{return void window.localStorage.removeItem(u)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}()},o.enableAll=function(e){o.setLevel(o.levels.TRACE,e)},o.disableAll=function(e){o.setLevel(o.levels.SILENT,e)};var f=l();null==f&&(f=n),o.setLevel(f,!1)}var f=new l,d={};f.getLogger=function(e){if("symbol"!==Oa(e)&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new l(e,f.getLevel(),f.methodFactory)),t};var p=("undefined"==typeof window?"undefined":Oa(window))!==t?window.log:void 0;return f.noConflict=function(){return("undefined"==typeof window?"undefined":Oa(window))!==t&&window.log===f&&(window.log=p),f},f.getLoggers=function(){return d},f.default=f,f},(kf=_f).exports?kf.exports=xf():wf.log=xf();var Ef,Tf,Rf=_f.exports.getLogger("twilio-conversations"),If=function(){function e(t){Na(this,e),ja(this,"prefix",""),this.prefix=null!=t&&t.length>0?t+" ":""}return La(e,[{key:"setLevel",value:function(e){Rf.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.trace.apply(null,Sf(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.debug.apply(null,Sf(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.info.apply(null,Sf(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.warn.apply(null,Sf(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.error.apply(null,Sf(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){Rf.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.trace.apply(null,Sf("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.debug.apply(null,Sf("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.info.apply(null,Sf("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.warn.apply(null,Sf("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Rf.error.apply(null,Sf("E",t))}}]),e}(),Cf={};Object.defineProperty(Cf,"__esModule",{value:!0});var Of=["weeks","years","months","days","hours","minutes","seconds"],Pf=Cf.pattern=new RegExp("P(?:(\\d+(?:[\\.,]\\d+)?W)|(\\d+(?:[\\.,]\\d+)?Y)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?D)?(?:T(\\d+(?:[\\.,]\\d+)?H)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?S)?)?)"),Af=Tf=Cf.parse=function(e){return e.match(Pf).slice(1).reduce((function(e,t,n){return e[Of[n]]=parseFloat(t)||0,e}),{})},jf=Cf.end=function(e,t){var n=t?t.getTime():Date.now(),r=new Date(n);return r.setFullYear(r.getFullYear()+e.years),r.setMonth(r.getMonth()+e.months),r.setDate(r.getDate()+e.days),r.setHours(r.getHours()+e.hours),r.setMinutes(r.getMinutes()+e.minutes),r.setMilliseconds(r.getMilliseconds()+1e3*e.seconds),r.setDate(r.getDate()+7*e.weeks),r},Mf=Ef=Cf.toSeconds=function(e,t){var n=t?t.getTime():Date.now(),r=new Date(n);return(jf(e,r).getTime()-r.getTime())/1e3};function Lf(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Nf(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Lf(Object(n),!0).forEach((function(t){ja(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Lf(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}Cf.default={end:jf,toSeconds:Mf,pattern:Pf,parse:Af};var Uf="PT5S",Ff="PT5S",Df=La((function e(){var t,n,r,i,a,o,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},u=arguments.length>1?arguments[1]:void 0,c=arguments.length>2?arguments[2]:void 0;Na(this,e),ja(this,"typingIndicatorTimeoutDefault",5e3);var l=s.Chat||s.IPMessaging||s||{};this.productId=l.productId,this.links={myConversations:u.links.my_conversations,conversations:u.links.conversations,users:u.links.users,currentUser:u.links.current_user,typing:u.links.typing,mediaService:u.links.media_service,mediaSetService:u.links.media_set_service,messagesReceipts:u.links.messages_receipts},this.limits={mediaAttachmentsCountLimit:u.options.media_attachments_count_limit,mediaAttachmentSizeLimitInMb:u.options.media_attachment_size_limit_in_mb,mediaAttachmentsTotalSizeLimitInMb:u.options.media_attachments_total_size_limit_in_mb,emailHistoriesAllowedContentTypes:u.options.email_histories_allowed_mime_types,emailBodiesAllowedContentTypes:u.options.email_bodies_allowed_mime_types},this.typingIndicatorTimeoutOverride=l.typingIndicatorTimeoutOverride,this.backoffConfiguration=Nf({min:1e3,max:4e3,maxAttemptsCount:3},l.backoffConfigOverride),this.retryWhenThrottled=void 0===l.retryWhenThrottledOverride||l.retryWhenThrottledOverride,this.userInfosToSubscribe=null!==(t=null!==(n=l.userInfosToSubscribeOverride)&&void 0!==n?n:u.options.user_infos_to_subscribe)&&void 0!==t?t:100,this.reachabilityEnabled=u.options.reachability_enabled,this.userIdentity=u.identity,this.userInfo=u.sync_objects.my_user_info,this.myConversations=u.sync_objects.my_conversations;var f=null!==(r=null!==(i=l.httpCacheIntervalOverride)&&void 0!==i?i:u.options.http_cache_interval)&&void 0!==r?r:Uf;try{this.httpCacheInterval=Ef(Tf(f))}catch(e){c.error("Failed to parse http cache interval ".concat(f,", using default value ").concat(Uf)),this.httpCacheInterval=Ef(Tf(Uf))}var d=null!==(a=null!==(o=l.consumptionReportIntervalOverride)&&void 0!==o?o:u.options.consumption_report_interval)&&void 0!==a?a:Ff;try{this.consumptionReportInterval=Ef(Tf(d))}catch(e){c.error("Failed to parse consumption report interval ".concat(d,", using default value ").concat(Ff)),this.consumptionReportInterval=Ef(Tf(Ff))}})),Bf=tr,qf=Ne,zf=pe("unscopables"),Wf=Array.prototype;null==Wf[zf]&&qf.f(Wf,zf,{configurable:!0,value:Bf(null)});var Gf=function(e){Wf[zf][e]=!0},$f=_,Vf=Gf,Jf=uo,Kf=xt,Hf=df,Yf="Array Iterator",Qf=Kf.set,Xf=Kf.getterFor(Yf),Zf=Hf(Array,"Array",(function(e,t){Qf(this,{type:Yf,target:$f(e),index:0,kind:t})}),(function(){var e=Xf(this),t=e.target,n=e.kind,r=e.index++;return!t||r>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:r,done:!1}:"values"==n?{value:t[r],done:!1}:{value:[r,t[r]],done:!1}}),"values");Jf.Arguments=Jf.Array,Vf("keys"),Vf("values"),Vf("entries");var ed=i,td=Xu,nd=tc,rd=Zf,id=Ve,ad=pe,od=ad("iterator"),sd=ad("toStringTag"),ud=rd.values,cd=function(e,t){if(e){if(e[od]!==ud)try{id(e,od,ud)}catch(t){e[od]=ud}if(e[sd]||id(e,sd,t),td[t])for(var n in rd)if(e[n]!==rd[n])try{id(e,n,rd[n])}catch(t){e[n]=rd[n]}}};for(var ld in td)cd(ed[ld]&&ed[ld].prototype,ld);cd(nd,"DOMTokenList");var fd=Rn,dd=o,pd=R("JSON","stringify"),hd=/[\uD800-\uDFFF]/g,vd=/^[\uD800-\uDBFF]$/,yd=/^[\uDC00-\uDFFF]$/,md=function(e,t,n){var r=n.charAt(t-1),i=n.charAt(t+1);return vd.test(e)&&!yd.test(i)||yd.test(e)&&!vd.test(r)?"\\u"+e.charCodeAt(0).toString(16):e},gd=dd((function(){return'"\\udf06\\ud834"'!==pd("\udf06\ud834")||'"\\udead"'!==pd("\udead")}));pd&&fd({target:"JSON",stat:!0,forced:gd},{stringify:function(e,t,n){var r=pd.apply(null,arguments);return"string"==typeof r?r.replace(hd,md):r}});var bd=S,kd=to,wd=function(e,t,n){var r,i;return kd&&"function"==typeof(r=t.constructor)&&r!==n&&bd(i=r.prototype)&&i!==n.prototype&&kd(e,i),e},xd=k,_d=Sr,Sd="[\t\n\v\f\r                　\u2028\u2029\ufeff]",Ed=RegExp("^"+Sd+Sd+"*"),Td=RegExp(Sd+Sd+"*$"),Rd=function(e){return function(t){var n=_d(xd(t));return 1&e&&(n=n.replace(Ed,"")),2&e&&(n=n.replace(Td,"")),n}},Id={start:Rd(1),end:Rd(2),trim:Rd(3)},Cd=s,Od=i,Pd=bn,Ad=Je.exports,jd=ee,Md=y,Ld=wd,Nd=q,Ud=ge,Fd=o,Dd=tr,Bd=Pt.f,qd=a.f,zd=Ne.f,Wd=Id.trim,Gd="Number",$d=Od.Number,Vd=$d.prototype,Jd=Md(Dd(Vd))==Gd,Kd=function(e){if(Nd(e))throw TypeError("Cannot convert a Symbol value to a number");var t,n,r,i,a,o,s,u,c=Ud(e,"number");if("string"==typeof c&&c.length>2)if(43===(t=(c=Wd(c)).charCodeAt(0))||45===t){if(88===(n=c.charCodeAt(2))||120===n)return NaN}else if(48===t){switch(c.charCodeAt(1)){case 66:case 98:r=2,i=49;break;case 79:case 111:r=8,i=55;break;default:return+c}for(o=(a=c.slice(2)).length,s=0;s<o;s++)if((u=a.charCodeAt(s))<48||u>i)return NaN;return parseInt(a,r)}return+c};if(Pd(Gd,!$d(" 0o1")||!$d("0b1")||$d("+0x1"))){for(var Hd,Yd=function(e){var t=arguments.length<1?0:e,n=this;return n instanceof Yd&&(Jd?Fd((function(){Vd.valueOf.call(n)})):Md(n)!=Gd)?Ld(new $d(Kd(t)),n,Yd):Kd(t)},Qd=Cd?Bd($d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger,fromString,range".split(","),Xd=0;Qd.length>Xd;Xd++)jd($d,Hd=Qd[Xd])&&!jd(Yd,Hd)&&zd(Yd,Hd,qd($d,Hd));Yd.prototype=Vd,Vd.constructor=Yd,Ad(Od,Gd,Yd)}var Zd=Fe,ep=function(){var e=Zd(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t},tp={},np=o,rp=i.RegExp;tp.UNSUPPORTED_Y=np((function(){var e=rp("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),tp.BROKEN_CARET=np((function(){var e=rp("^r","gy");return e.lastIndex=2,null!=e.exec("str")}));var ip,ap,op=o,sp=i.RegExp,up=op((function(){var e=sp(".","s");return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),cp=o,lp=i.RegExp,fp=cp((function(){var e=lp("(?<a>b)","g");return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),dp=Sr,pp=ep,hp=tp,vp=W.exports,yp=tr,mp=xt.get,gp=up,bp=fp,kp=RegExp.prototype.exec,wp=vp("native-string-replace",String.prototype.replace),xp=kp,_p=(ip=/a/,ap=/b*/g,kp.call(ip,"a"),kp.call(ap,"a"),0!==ip.lastIndex||0!==ap.lastIndex),Sp=hp.UNSUPPORTED_Y||hp.BROKEN_CARET,Ep=void 0!==/()??/.exec("")[1];(_p||Ep||Sp||gp||bp)&&(xp=function(e){var t,n,r,i,a,o,s,u=this,c=mp(u),l=dp(e),f=c.raw;if(f)return f.lastIndex=u.lastIndex,t=xp.call(f,l),u.lastIndex=f.lastIndex,t;var d=c.groups,p=Sp&&u.sticky,h=pp.call(u),v=u.source,y=0,m=l;if(p&&(-1===(h=h.replace("y","")).indexOf("g")&&(h+="g"),m=l.slice(u.lastIndex),u.lastIndex>0&&(!u.multiline||u.multiline&&"\n"!==l.charAt(u.lastIndex-1))&&(v="(?: "+v+")",m=" "+m,y++),n=new RegExp("^(?:"+v+")",h)),Ep&&(n=new RegExp("^"+v+"$(?!\\s)",h)),_p&&(r=u.lastIndex),i=kp.call(p?n:u,m),p?i?(i.input=i.input.slice(y),i[0]=i[0].slice(y),i.index=u.lastIndex,u.lastIndex+=i[0].length):u.lastIndex=0:_p&&i&&(u.lastIndex=u.global?i.index+i[0].length:r),Ep&&i&&i.length>1&&wp.call(i[0],n,(function(){for(a=1;a<arguments.length-2;a++)void 0===arguments[a]&&(i[a]=void 0)})),i&&d)for(i.groups=o=yp(null),a=0;a<d.length;a++)o[(s=d[a])[0]]=i[s[1]];return i});var Tp=xp;Rn({target:"RegExp",proto:!0,forced:/./.exec!==Tp},{exec:Tp});var Rp=Je.exports,Ip=Tp,Cp=o,Op=pe,Pp=Ve,Ap=Op("species"),jp=RegExp.prototype,Mp=function(e,t,n,r){var i=Op(e),a=!Cp((function(){var t={};return t[i]=function(){return 7},7!=""[e](t)})),o=a&&!Cp((function(){var t=!1,n=/a/;return"split"===e&&((n={}).constructor={},n.constructor[Ap]=function(){return n},n.flags="",n[i]=/./[i]),n.exec=function(){return t=!0,null},n[i](""),!t}));if(!a||!o||n){var s=/./[i],u=t(i,""[e],(function(e,t,n,r,i){var o=t.exec;return o===Ip||o===jp.exec?a&&!i?{done:!0,value:s.call(t,n,r)}:{done:!0,value:e.call(n,t,r)}:{done:!1}}));Rp(String.prototype,e,u[0]),Rp(jp,i,u[1])}r&&Pp(jp[i],"sham",!0)},Lp=Il.charAt,Np=function(e,t,n){return t+(n?Lp(e,t).length:1)},Up=Q,Fp=Math.floor,Dp="".replace,Bp=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,qp=/\$([$&'`]|\d{1,2})/g,zp=y,Wp=Tp,Gp=function(e,t){var n=e.exec;if("function"==typeof n){var r=n.call(e,t);if("object"!=typeof r)throw TypeError("RegExp exec method returned something other than an Object or null");return r}if("RegExp"!==zp(e))throw TypeError("RegExp#exec called on incompatible receiver");return Wp.call(e,t)},$p=Mp,Vp=o,Jp=Fe,Kp=Mt,Hp=Ut,Yp=Sr,Qp=k,Xp=Np,Zp=function(e,t,n,r,i,a){var o=n+e.length,s=r.length,u=qp;return void 0!==i&&(i=Up(i),u=Bp),Dp.call(a,u,(function(a,u){var c;switch(u.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,n);case"'":return t.slice(o);case"<":c=i[u.slice(1,-1)];break;default:var l=+u;if(0===l)return a;if(l>s){var f=Fp(l/10);return 0===f?a:f<=s?void 0===r[f-1]?u.charAt(1):r[f-1]+u.charAt(1):a}c=r[l-1]}return void 0===c?"":c}))},eh=Gp,th=pe("replace"),nh=Math.max,rh=Math.min,ih="$0"==="a".replace(/./,"$0"),ah=!!/./[th]&&""===/./[th]("a","$0"),oh=!Vp((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}));$p("replace",(function(e,t,n){var r=ah?"$":"$0";return[function(e,n){var r=Qp(this),i=null==e?void 0:e[th];return void 0!==i?i.call(e,r,n):t.call(Yp(r),e,n)},function(e,i){var a=Jp(this),o=Yp(e);if("string"==typeof i&&-1===i.indexOf(r)&&-1===i.indexOf("$<")){var s=n(t,a,o,i);if(s.done)return s.value}var u="function"==typeof i;u||(i=Yp(i));var c=a.global;if(c){var l=a.unicode;a.lastIndex=0}for(var f=[];;){var d=eh(a,o);if(null===d)break;if(f.push(d),!c)break;""===Yp(d[0])&&(a.lastIndex=Xp(o,Hp(a.lastIndex),l))}for(var p,h="",v=0,y=0;y<f.length;y++){d=f[y];for(var m=Yp(d[0]),g=nh(rh(Kp(d.index),o.length),0),b=[],k=1;k<d.length;k++)b.push(void 0===(p=d[k])?p:String(p));var w=d.groups;if(u){var x=[m].concat(b,g,o);void 0!==w&&x.push(w);var _=Yp(i.apply(void 0,x))}else _=Zp(m,o,g,b,w,i);g>=v&&(h+=o.slice(v,g)+_,v=g+m.length)}return h+o.slice(v)}]}),!oh||!ih||ah);var sh=Rn,uh=_,ch=[].join,lh=b!=Object,fh=rc("join",",");function dh(e){return JSON.parse(JSON.stringify(e))}function ph(e){return void 0===e||isNaN(Number(e))?null:Number(e)}function hh(e){try{return new Date(e)}catch(e){return null}}function vh(e,t,n){var r={};if(e)try{r=JSON.parse(e)}catch(e){n.warn(t,e)}return r}sh({target:"Array",proto:!0,forced:lh||!fh},{join:function(e){return ch.call(uh(this),void 0===e?",":e)}});var yh=function(){function e(t){Na(this,e),this.base=t.replace(/\/$/,""),this.args=[],this.paths=[]}return La(e,[{key:"arg",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"path",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}(),mh={},gh=Rn,bh=S,kh=xr,wh=qt,xh=Ut,_h=_,Sh=ka,Eh=pe,Th=ca("slice"),Rh=Eh("species"),Ih=[].slice,Ch=Math.max;gh({target:"Array",proto:!0,forced:!Th},{slice:function(e,t){var n,r,i,a=_h(this),o=xh(a.length),s=wh(e,o),u=wh(void 0===t?o:t,o);if(kh(a)&&("function"!=typeof(n=a.constructor)||n!==Array&&!kh(n.prototype)?bh(n)&&null===(n=n[Rh])&&(n=void 0):n=void 0,n===Array||void 0===n))return Ih.call(a,s,u);for(r=new(void 0===n?Array:n)(Ch(u-s,0)),i=0;s<u;s++,i++)s in a&&Sh(r,i,a[s]);return r.length=i,r}});var Oh=Rn,Ph=S,Ah=function(){var e=!1,t=/[ac]/;return t.exec=function(){return e=!0,/./.exec.apply(this,arguments)},!0===t.test("abc")&&e}(),jh=/./.test;Oh({target:"RegExp",proto:!0,forced:!Ah},{test:function(e){if("function"!=typeof this.exec)return jh.call(this,e);var t=this.exec(e);if(null!==t&&!Ph(t))throw new Error("RegExp exec method returned something other than an Object or null");return!!t}});var Mh=Rn,Lh=s,Nh=i,Uh=ee,Fh=S,Dh=Ne.f,Bh=fn,qh=Nh.Symbol;if(Lh&&"function"==typeof qh&&(!("description"in qh.prototype)||void 0!==qh().description)){var zh={},Wh=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),t=this instanceof Wh?new qh(e):void 0===e?qh():qh(e);return""===e&&(zh[t]=!0),t};Bh(Wh,qh);var Gh=Wh.prototype=qh.prototype;Gh.constructor=Wh;var $h=Gh.toString,Vh="Symbol(test)"==String(qh("test")),Jh=/^Symbol\((.*)\)[^)]+$/;Dh(Gh,"description",{configurable:!0,get:function(){var e=Fh(this)?this.valueOf():this,t=$h.call(e);if(Uh(zh,e))return"";var n=Vh?t.slice(7,-1):t.replace(Jh,"$1");return""===n?void 0:n}}),Mh({global:!0,forced:!0},{Symbol:Wh})}Nr("iterator");var Kh={exports:{}};!function(e){function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}(Kh);var Hh=s,Yh=Ne.f,Qh=Function.prototype,Xh=Qh.toString,Zh=/^\s*function ([^ (]*)/,ev="name";Hh&&!(ev in Qh)&&Yh(Qh,ev,{configurable:!0,get:function(){try{return Xh.call(this).match(Zh)[1]}catch(e){return""}}});var tv={exports:{}},nv={exports:{}};!function(e){e.exports=function(e){if(Array.isArray(e))return e},e.exports.__esModule=!0,e.exports.default=e.exports}(nv);var rv={exports:{}};!function(e){e.exports=function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}},e.exports.__esModule=!0,e.exports.default=e.exports}(rv);var iv={exports:{}},av={exports:{}};!function(e){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r},e.exports.__esModule=!0,e.exports.default=e.exports}(av),function(e){var t=av.exports;e.exports=function(e,n){if(e){if("string"==typeof e)return t(e,n);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,n):void 0}},e.exports.__esModule=!0,e.exports.default=e.exports}(iv);var ov={exports:{}};!function(e){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.__esModule=!0,e.exports.default=e.exports}(ov),function(e){var t=nv.exports,n=rv.exports,r=iv.exports,i=ov.exports;e.exports=function(e,a){return t(e)||n(e,a)||r(e,a)||i()},e.exports.__esModule=!0,e.exports.default=e.exports}(tv);var sv={exports:{}},uv={exports:{}};!function(e){var t=av.exports;e.exports=function(e){if(Array.isArray(e))return t(e)},e.exports.__esModule=!0,e.exports.default=e.exports}(uv);var cv={exports:{}};!function(e){e.exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.__esModule=!0,e.exports.default=e.exports}(cv);var lv={exports:{}};!function(e){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.__esModule=!0,e.exports.default=e.exports}(lv),function(e){var t=uv.exports,n=cv.exports,r=iv.exports,i=lv.exports;e.exports=function(e){return t(e)||n(e)||r(e)||i()},e.exports.__esModule=!0,e.exports.default=e.exports}(sv);var fv={exports:{}};!function(e){function t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}e.exports=function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e},e.exports.__esModule=!0,e.exports.default=e.exports}(fv);var dv={exports:{}};!function(e){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.__esModule=!0,e.exports.default=e.exports}(dv);var pv={exports:{}},hv={exports:{}};!function(e){function t(n,r){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n,r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}(hv),function(e){var t=hv.exports;e.exports=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&t(e,n)},e.exports.__esModule=!0,e.exports.default=e.exports}(pv);var vv={exports:{}},yv={exports:{}};!function(e){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.__esModule=!0,e.exports.default=e.exports}(yv),function(e){var t=Kh.exports.default,n=yv.exports;e.exports=function(e,r){if(r&&("object"===t(r)||"function"==typeof r))return r;if(void 0!==r)throw new TypeError("Derived constructors may only return object or undefined");return n(e)},e.exports.__esModule=!0,e.exports.default=e.exports}(vv);var mv={exports:{}};!function(e){function t(n){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports}(mv);var gv=Vt.includes,bv=Gf;Rn({target:"Array",proto:!0},{includes:function(e){return gv(this,e,arguments.length>1?arguments[1]:void 0)}}),bv("includes");var kv=S,wv=Math.floor,xv=function(e){return!kv(e)&&isFinite(e)&&wv(e)===e};Rn({target:"Number",stat:!0},{isInteger:xv});var _v=s,Sv=Fn,Ev=_,Tv=u.f,Rv=function(e){return function(t){for(var n,r=Ev(t),i=Sv(r),a=i.length,o=0,s=[];a>o;)n=i[o++],_v&&!Tv.call(r,n)||s.push(e?[n,r[n]]:r[n]);return s}},Iv={entries:Rv(!0),values:Rv(!1)}.entries;Rn({target:"Object",stat:!0},{entries:function(e){return Iv(e)}}),Object.defineProperty(mh,"__esModule",{value:!0});var Cv=tv.exports,Ov=sv.exports,Pv=fv.exports,Av=dv.exports,jv=pv.exports,Mv=vv.exports,Lv=mv.exports;function Nv(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}var Uv=Nv(Kh.exports),Fv=Nv(Cv),Dv=Nv(Ov),Bv=Nv(Pv),qv=Nv(Av),zv=Nv(jv),Wv=Nv(Mv),Gv=Nv(Lv),$v=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{checks:t}};function Vv(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Jv(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Jv(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Jv(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Kv=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return $v((function(e){var n,r=!1,i=[],a=Vv(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;"string"!=typeof o?(r=r||e instanceof o,i.push("an instance of ".concat(o.name))):(r=r||Uv.default(e)===o,i.push("of type ".concat(o)))}}catch(e){a.e(e)}finally{a.f()}return[r,i]}))};function Hv(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Yv(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Yv(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Yv(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Qv(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Gv.default(e);if(t){var i=Gv.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Wv.default(this,n)}}function Xv(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Zv(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Zv(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Zv(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var ey=function(e,t){if(t.length>e.length)throw new Error("Expected at most ".concat(e.length," argument(s), but got ").concat(t.length));for(;t.length<e.length;)t.push(void 0);var n,r=Xv(t.entries());try{for(r.s();!(n=r.n()).done;){var i=Fv.default(n.value,2),a=i[0],o=i[1],s=iy(e[a],o),u=Fv.default(s,4),c=u[0],l=u[1],f=u[2],d=u[3];if(!c)throw new Error("Argument ".concat(a+1," is expected to be ").concat(f).concat(d," but got ").concat(l))}}catch(e){r.e(e)}finally{r.f()}},ty=function(e){var t,n,r;(["undefined","boolean","number","bigint","string"].includes(Uv.default(e))&&(n="string"==typeof e?'"'.concat(e,'"'):"".concat(e)),"object"===Uv.default(e)&&"Object"!==(null==e||null===(t=e.constructor)||void 0===t?void 0:t.name))&&(n=null===e?"null":"instance of ".concat(null==e||null===(r=e.constructor)||void 0===r?void 0:r.name));return n||(n=Uv.default(e)),n},ny=function(e){var t,n=[],r=Xv(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.push(ry(i))}}catch(e){r.e(e)}finally{r.f()}return n},ry=function(e){var t,n=[],r=Xv(Array.isArray(e)?e:[e]);try{for(r.s();!(t=r.n()).done;){var i=t.value;"string"!=typeof i&&"function"!=typeof i?n.push(i):n.push(Kv(i))}}catch(e){r.e(e)}finally{r.f()}return n},iy=function(e,t){var n,r,i=[],a=!1,o=Xv(e);try{for(o.s();!(r=o.n()).done;){var s,u=Xv(r.value.checks);try{for(u.s();!(s=u.n()).done;){var c=(0,s.value)(t),l=Fv.default(c,3),f=l[0],d=l[1],p=l[2];a=a||f,!n&&p&&(n=p),d&&(i=[].concat(Dv.default(i),"string"==typeof d?[d]:Dv.default(d)))}}catch(e){u.e(e)}finally{u.f()}}}catch(e){o.e(e)}finally{o.f()}if(a)return[!0];var h=n||ty(t),v=i.length-1;return[!1,h,v>0?"".concat(i.slice(0,v).join(", ")," or ").concat(i[v]):i.join(", "),v>1?";":","]};function ay(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return oy(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return oy(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function oy(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var sy=$v((function(e){return["string"==typeof e&&e.length>0,"a non-empty string"]})),uy=$v((function(e){return["number"==typeof e&&Number.isInteger(e)&&e>=0,"a non-negative integer"]})),cy=$v((function(e){return["object"===Uv.default(e)&&null!==e&&!Array.isArray(e),"a pure object (non-null and non-array)"]}));function ly(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return fy(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return fy(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function fy(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}mh.array=function(e,t){return $v((function(n){if(!Array.isArray(n))return[!1,"an array of ".concat(e)];var r,i=ly(n.entries());try{for(i.s();!(r=i.n()).done;){var a=Fv.default(r.value,2),o=a[0],s=a[1],u=iy(ry(t),s),c=Fv.default(u,3),l=c[0],f=c[1],d=c[2];if(!l)return[!1,"a valid array of ".concat(e," (index ").concat(o," should be ").concat(d,")"),"malformed array of ".concat(e," (index ").concat(o," is ").concat(f,")")]}}catch(e){i.e(e)}finally{i.f()}return[!0]}))};var dy=mh.custom=$v,py=mh.literal=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return $v((function(e){var n,r=!1,i=[],a=Hv(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;r=r||e===o,i.push("string"==typeof o?'"'.concat(o,'"'):"".concat(o))}}catch(e){a.e(e)}finally{a.f()}return[r,i]}))},hy=mh.nonEmptyArray=function(e,t){return $v((function(n){if(!Array.isArray(n)||n.length<1)return[!1,"a non-empty array of ".concat(e)];var r,i=ay(n.entries());try{for(i.s();!(r=i.n()).done;){var a=Fv.default(r.value,2),o=a[0],s=a[1],u=iy(ry(t),s),c=Fv.default(u,3),l=c[0],f=c[1],d=c[2];if(!l)return[!1,"a valid non-empty array of ".concat(e," (index ").concat(o," should be ").concat(d,")"),"malformed array of ".concat(e," (index ").concat(o," is ").concat(f,")")]}}catch(e){i.e(e)}finally{i.f()}return[!0]}))},vy=mh.nonEmptyString=sy,yy=mh.nonNegativeInteger=uy,my=mh.objectSchema=function(e,t){return $v((function(n){if("object"!==Uv.default(n)||null===n||Array.isArray(n))return[!1,"valid ".concat(e," (should be a pure object)")];for(var r=0,i=Object.entries(t);r<i.length;r++){var a=Fv.default(i[r],2),o=a[0],s=a[1],u=iy(ry(s),n[o]),c=Fv.default(u,3),l=c[0],f=c[1],d=c[2];if(!l)return[!1,"valid ".concat(e,' (key "').concat(o,'" should be ').concat(d,")"),"malformed ".concat(e,' (key "').concat(o,'" is ').concat(f,")")]}return[!0]}))},gy=mh.pureObject=cy;mh.runtimeTypeValidation=ey,mh.stringifyReceivedType=ty,mh.type=Kv;var by=mh.validateConstructorTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=ny(t);return function(e){return function(e){zv.default(n,e);var t=Qv(n);function n(){qv.default(this,n);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return ey(r,i),t.call.apply(t,[this].concat(i))}return Bv.default(n)}(e)}},ky=mh.validateTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=ny(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypes decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return ey(r,t),i.apply(this,t)}}},wy=mh.validateTypesAsync=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=ny(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypesAsync decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];try{ey(r,t)}catch(e){return Promise.reject(e)}return i.apply(this,t)}}},xy=dy((function(e){return[["string","number","boolean","object"].includes(Oa(e)),"a JSON type"]})),_y=dy((function(e){return[["undefined","string","number","boolean","object"].includes(Oa(e)),"an optional JSON type"]})),Sy={},Ey={exports:{}},Ty={exports:{}};!function(e){var t=mv.exports;e.exports=function(e,n){for(;!Object.prototype.hasOwnProperty.call(e,n)&&null!==(e=t(e)););return e},e.exports.__esModule=!0,e.exports.default=e.exports}(Ty),function(e){var t=Ty.exports;function n(){return"undefined"!=typeof Reflect&&Reflect.get?(e.exports=n=Reflect.get,e.exports.__esModule=!0,e.exports.default=e.exports):(e.exports=n=function(e,n,r){var i=t(e,n);if(i){var a=Object.getOwnPropertyDescriptor(i,n);return a.get?a.get.call(arguments.length<3?e:r):a.value}},e.exports.__esModule=!0,e.exports.default=e.exports),n.apply(this,arguments)}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports}(Ey);var Ry={exports:{}};!function(e){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.__esModule=!0,e.exports.default=e.exports}(Ry),Object.defineProperty(Sy,"__esModule",{value:!0});var Iy=dv.exports,Cy=fv.exports,Oy=yv.exports,Py=Ey.exports,Ay=pv.exports,jy=vv.exports,My=mv.exports,Ly=Ry.exports;function Ny(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}var Uy=Ny(sv.exports),Fy=Ny(Iy),Dy=Ny(Cy),By=Ny(Oy),qy=Ny(Py),zy=Ny(Ay),Wy=Ny(jy),Gy=Ny(My),$y=Ny(Ly);function Vy(){}function Jy(){Jy.init.call(this)}function Ky(e){return void 0===e._maxListeners?Jy.defaultMaxListeners:e._maxListeners}function Hy(e,t,n){if(t)e.call(n);else for(var r=e.length,i=rm(e,r),a=0;a<r;++a)i[a].call(n)}function Yy(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=rm(e,i),o=0;o<i;++o)a[o].call(n,r)}function Qy(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=rm(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function Xy(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=rm(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function Zy(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=rm(e,i),o=0;o<i;++o)a[o].apply(n,r)}function em(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new Vy,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=Ky(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function tm(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function nm(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function rm(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function im(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Gy.default(e);if(t){var i=Gy.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Wy.default(this,n)}}Vy.prototype=Object.create(null),Jy.EventEmitter=Jy,Jy.usingDomains=!1,Jy.prototype.domain=void 0,Jy.prototype._events=void 0,Jy.prototype._maxListeners=void 0,Jy.defaultMaxListeners=10,Jy.init=function(){this.domain=null,Jy.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Vy,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Jy.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},Jy.prototype.getMaxListeners=function(){return Ky(this)},Jy.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:Hy(n,l,this);break;case 2:Yy(n,l,this,arguments[1]);break;case 3:Qy(n,l,this,arguments[1],arguments[2]);break;case 4:Xy(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];Zy(n,l,this,i)}return!0},Jy.prototype.addListener=function(e,t){return em(this,e,t,!1)},Jy.prototype.on=Jy.prototype.addListener,Jy.prototype.prependListener=function(e,t){return em(this,e,t,!0)},Jy.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,tm(this,e,t)),this},Jy.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,tm(this,e,t)),this},Jy.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new Vy:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new Vy,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},Jy.prototype.off=function(e,t){return this.removeListener(e,t)},Jy.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new Vy,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new Vy:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new Vy,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},Jy.prototype.listeners=function(e){var t,n,r=this._events;return n=r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[],n},Jy.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):nm.call(e,t)},Jy.prototype.listenerCount=nm,Jy.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var am=function(e){zy.default(n,e);var t=im(n);function n(){var e;return Fy.default(this,n),e=t.call(this),$y.default(By.default(e),"eventHistory",new Map),e}return Dy.default(n,[{key:"on",value:function(e,t){return qy.default(Gy.default(n.prototype),"on",this).call(this,e,t)}},{key:"once",value:function(e,t){return qy.default(Gy.default(n.prototype),"once",this).call(this,e,t)}},{key:"off",value:function(e,t){return qy.default(Gy.default(n.prototype),"off",this).call(this,e,t)}},{key:"emit",value:function(e){for(var t,r=arguments.length,i=new Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return this.eventHistory.set(e,i),(t=qy.default(Gy.default(n.prototype),"emit",this)).call.apply(t,[this,e].concat(i))}},{key:"addListener",value:function(e,t){return qy.default(Gy.default(n.prototype),"addListener",this).call(this,e,t)}},{key:"removeListener",value:function(e,t){return qy.default(Gy.default(n.prototype),"removeListener",this).call(this,e,t)}},{key:"addListenerWithReplay",value:function(e,t){var n=this.eventHistory.get(e);return void 0!==n&&t.apply(void 0,Uy.default(n)),this.addListener(e,t)}},{key:"onWithReplay",value:function(e,t){return this.addListenerWithReplay(e,t)}},{key:"onceWithReplay",value:function(e,t){var r=this.eventHistory.get(e);return void 0!==r?(t.apply(void 0,Uy.default(r)),this):qy.default(Gy.default(n.prototype),"once",this).call(this,e,t)}}]),n}(Jy),om=Sy.ReplayEventEmitter=am,sm={exports:{}};!function(e,n){var r="__lodash_hash_undefined__",i=9007199254740991,a="[object Arguments]",o="[object Array]",s="[object Boolean]",u="[object Date]",c="[object Error]",l="[object Function]",f="[object Map]",d="[object Number]",p="[object Object]",h="[object Promise]",v="[object RegExp]",y="[object Set]",m="[object String]",g="[object Symbol]",b="[object WeakMap]",k="[object ArrayBuffer]",w="[object DataView]",x=/^\[object .+?Constructor\]$/,_=/^(?:0|[1-9]\d*)$/,S={};S["[object Float32Array]"]=S["[object Float64Array]"]=S["[object Int8Array]"]=S["[object Int16Array]"]=S["[object Int32Array]"]=S["[object Uint8Array]"]=S["[object Uint8ClampedArray]"]=S["[object Uint16Array]"]=S["[object Uint32Array]"]=!0,S[a]=S[o]=S[k]=S[s]=S[w]=S[u]=S[c]=S[l]=S[f]=S[d]=S[p]=S[v]=S[y]=S[m]=S[b]=!1;var E="object"==Oa(t)&&t&&t.Object===Object&&t,T="object"==("undefined"==typeof self?"undefined":Oa(self))&&self&&self.Object===Object&&self,R=E||T||Function("return this")(),I=n&&!n.nodeType&&n,C=I&&e&&!e.nodeType&&e,O=C&&C.exports===I,P=O&&E.process,A=function(){try{return P&&P.binding&&P.binding("util")}catch(e){}}(),j=A&&A.isTypedArray;function M(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}function L(e,t){return e.has(t)}function N(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function U(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var F,D,B=Array.prototype,q=Function.prototype,z=Object.prototype,W=R["__core-js_shared__"],G=q.toString,$=z.hasOwnProperty,V=function(){var e=/[^.]+$/.exec(W&&W.keys&&W.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}(),J=z.toString,K=RegExp("^"+G.call($).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),H=O?R.Buffer:void 0,Y=R.Symbol,Q=R.Uint8Array,X=z.propertyIsEnumerable,Z=B.splice,ee=Y?Y.toStringTag:void 0,te=Object.getOwnPropertySymbols,ne=H?H.isBuffer:void 0,re=(F=Object.keys,D=Object,function(e){return F(D(e))}),ie=Ae(R,"DataView"),ae=Ae(R,"Map"),oe=Ae(R,"Promise"),se=Ae(R,"Set"),ue=Ae(R,"WeakMap"),ce=Ae(Object,"create"),le=Ne(ie),fe=Ne(ae),de=Ne(oe),pe=Ne(se),he=Ne(ue),ve=Y?Y.prototype:void 0,ye=ve?ve.valueOf:void 0;function me(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function ge(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function be(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function ke(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new be;++t<n;)this.add(e[t])}function we(e){var t=this.__data__=new ge(e);this.size=t.size}function xe(e,t){var n=De(e),r=!n&&Fe(e),i=!n&&!r&&Be(e),a=!n&&!r&&!i&&$e(e),o=n||r||i||a,s=o?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],u=s.length;for(var c in e)!t&&!$.call(e,c)||o&&("length"==c||i&&("offset"==c||"parent"==c)||a&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||Le(c,u))||s.push(c);return s}function _e(e,t){for(var n=e.length;n--;)if(Ue(e[n][0],t))return n;return-1}function Se(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":ee&&ee in Object(e)?function(e){var t=$.call(e,ee),n=e[ee];try{e[ee]=void 0;var r=!0}catch(e){}var i=J.call(e);r&&(t?e[ee]=n:delete e[ee]);return i}(e):function(e){return J.call(e)}(e)}function Ee(e){return Ge(e)&&Se(e)==a}function Te(e,t,n,r,i){return e===t||(null==e||null==t||!Ge(e)&&!Ge(t)?e!=e&&t!=t:function(e,t,n,r,i,l){var h=De(e),b=De(t),x=h?o:Me(e),_=b?o:Me(t),S=(x=x==a?p:x)==p,E=(_=_==a?p:_)==p,T=x==_;if(T&&Be(e)){if(!Be(t))return!1;h=!0,S=!1}if(T&&!S)return l||(l=new we),h||$e(e)?Ce(e,t,n,r,i,l):function(e,t,n,r,i,a,o){switch(n){case w:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case k:return!(e.byteLength!=t.byteLength||!a(new Q(e),new Q(t)));case s:case u:case d:return Ue(+e,+t);case c:return e.name==t.name&&e.message==t.message;case v:case m:return e==t+"";case f:var l=N;case y:var p=1&r;if(l||(l=U),e.size!=t.size&&!p)return!1;var h=o.get(e);if(h)return h==t;r|=2,o.set(e,t);var b=Ce(l(e),l(t),r,i,a,o);return o.delete(e),b;case g:if(ye)return ye.call(e)==ye.call(t)}return!1}(e,t,x,n,r,i,l);if(!(1&n)){var R=S&&$.call(e,"__wrapped__"),I=E&&$.call(t,"__wrapped__");if(R||I){var C=R?e.value():e,O=I?t.value():t;return l||(l=new we),i(C,O,n,r,l)}}if(!T)return!1;return l||(l=new we),function(e,t,n,r,i,a){var o=1&n,s=Oe(e),u=s.length,c=Oe(t).length;if(u!=c&&!o)return!1;var l=u;for(;l--;){var f=s[l];if(!(o?f in t:$.call(t,f)))return!1}var d=a.get(e);if(d&&a.get(t))return d==t;var p=!0;a.set(e,t),a.set(t,e);var h=o;for(;++l<u;){var v=e[f=s[l]],y=t[f];if(r)var m=o?r(y,v,f,t,e,a):r(v,y,f,e,t,a);if(!(void 0===m?v===y||i(v,y,n,r,a):m)){p=!1;break}h||(h="constructor"==f)}if(p&&!h){var g=e.constructor,b=t.constructor;g==b||!("constructor"in e)||!("constructor"in t)||"function"==typeof g&&g instanceof g&&"function"==typeof b&&b instanceof b||(p=!1)}return a.delete(e),a.delete(t),p}(e,t,n,r,i,l)}(e,t,n,r,Te,i))}function Re(e){return!(!We(e)||function(e){return!!V&&V in e}(e))&&(qe(e)?K:x).test(Ne(e))}function Ie(e){if(n=(t=e)&&t.constructor,r="function"==typeof n&&n.prototype||z,t!==r)return re(e);var t,n,r,i=[];for(var a in Object(e))$.call(e,a)&&"constructor"!=a&&i.push(a);return i}function Ce(e,t,n,r,i,a){var o=1&n,s=e.length,u=t.length;if(s!=u&&!(o&&u>s))return!1;var c=a.get(e);if(c&&a.get(t))return c==t;var l=-1,f=!0,d=2&n?new ke:void 0;for(a.set(e,t),a.set(t,e);++l<s;){var p=e[l],h=t[l];if(r)var v=o?r(h,p,l,t,e,a):r(p,h,l,e,t,a);if(void 0!==v){if(v)continue;f=!1;break}if(d){if(!M(t,(function(e,t){if(!L(d,t)&&(p===e||i(p,e,n,r,a)))return d.push(t)}))){f=!1;break}}else if(p!==h&&!i(p,h,n,r,a)){f=!1;break}}return a.delete(e),a.delete(t),f}function Oe(e){return function(e,t,n){var r=t(e);return De(e)?r:function(e,t){for(var n=-1,r=t.length,i=e.length;++n<r;)e[i+n]=t[n];return e}(r,n(e))}(e,Ve,je)}function Pe(e,t){var n=e.__data__;return function(e){var t=Oa(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}(t)?n["string"==typeof t?"string":"hash"]:n.map}function Ae(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return Re(n)?n:void 0}me.prototype.clear=function(){this.__data__=ce?ce(null):{},this.size=0},me.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},me.prototype.get=function(e){var t=this.__data__;if(ce){var n=t[e];return n===r?void 0:n}return $.call(t,e)?t[e]:void 0},me.prototype.has=function(e){var t=this.__data__;return ce?void 0!==t[e]:$.call(t,e)},me.prototype.set=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=ce&&void 0===t?r:t,this},ge.prototype.clear=function(){this.__data__=[],this.size=0},ge.prototype.delete=function(e){var t=this.__data__,n=_e(t,e);return!(n<0)&&(n==t.length-1?t.pop():Z.call(t,n,1),--this.size,!0)},ge.prototype.get=function(e){var t=this.__data__,n=_e(t,e);return n<0?void 0:t[n][1]},ge.prototype.has=function(e){return _e(this.__data__,e)>-1},ge.prototype.set=function(e,t){var n=this.__data__,r=_e(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this},be.prototype.clear=function(){this.size=0,this.__data__={hash:new me,map:new(ae||ge),string:new me}},be.prototype.delete=function(e){var t=Pe(this,e).delete(e);return this.size-=t?1:0,t},be.prototype.get=function(e){return Pe(this,e).get(e)},be.prototype.has=function(e){return Pe(this,e).has(e)},be.prototype.set=function(e,t){var n=Pe(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this},ke.prototype.add=ke.prototype.push=function(e){return this.__data__.set(e,r),this},ke.prototype.has=function(e){return this.__data__.has(e)},we.prototype.clear=function(){this.__data__=new ge,this.size=0},we.prototype.delete=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n},we.prototype.get=function(e){return this.__data__.get(e)},we.prototype.has=function(e){return this.__data__.has(e)},we.prototype.set=function(e,t){var n=this.__data__;if(n instanceof ge){var r=n.__data__;if(!ae||r.length<199)return r.push([e,t]),this.size=++n.size,this;n=this.__data__=new be(r)}return n.set(e,t),this.size=n.size,this};var je=te?function(e){return null==e?[]:(e=Object(e),function(e,t){for(var n=-1,r=null==e?0:e.length,i=0,a=[];++n<r;){var o=e[n];t(o,n,e)&&(a[i++]=o)}return a}(te(e),(function(t){return X.call(e,t)})))}:function(){return[]},Me=Se;function Le(e,t){return!!(t=null==t?i:t)&&("number"==typeof e||_.test(e))&&e>-1&&e%1==0&&e<t}function Ne(e){if(null!=e){try{return G.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Ue(e,t){return e===t||e!=e&&t!=t}(ie&&Me(new ie(new ArrayBuffer(1)))!=w||ae&&Me(new ae)!=f||oe&&Me(oe.resolve())!=h||se&&Me(new se)!=y||ue&&Me(new ue)!=b)&&(Me=function(e){var t=Se(e),n=t==p?e.constructor:void 0,r=n?Ne(n):"";if(r)switch(r){case le:return w;case fe:return f;case de:return h;case pe:return y;case he:return b}return t});var Fe=Ee(function(){return arguments}())?Ee:function(e){return Ge(e)&&$.call(e,"callee")&&!X.call(e,"callee")},De=Array.isArray;var Be=ne||function(){return!1};function qe(e){if(!We(e))return!1;var t=Se(e);return t==l||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}function ze(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=i}function We(e){var t=Oa(e);return null!=e&&("object"==t||"function"==t)}function Ge(e){return null!=e&&"object"==Oa(e)}var $e=j?function(e){return function(t){return e(t)}}(j):function(e){return Ge(e)&&ze(e.length)&&!!S[Se(e)]};function Ve(e){return null!=(t=e)&&ze(t.length)&&!qe(t)?xe(e):Ie(e);var t}e.exports=function(e,t){return Te(e,t)}}(sm,sm.exports);var um=sm.exports;function cm(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}var lm=If.scope("User"),User=function(e){Ca(User,e);var t,n,r,i,a,o,s,u=cm(User);function User(e,t,n,r){var i;return Na(this,User),ja(Ra(i=u.call(this)),"promiseToFetch",null),ja(Ra(i),"updated","updated"),ja(Ra(i),"userSubscribed","userSubscribed"),ja(Ra(i),"userUnsubscribed","userUnsubscribed"),i.services=r,i.subscribed="initializing",i.setMaxListeners(0),i.state={identity:e,entityName:t,friendlyName:null,attributes:{},online:null,notifiable:null},i._initializationPromise=new Promise((function(e){i._resolveInitializationPromise=e})),null!==n&&i._resolveInitialization(n,e,t,!1),i}return La(User,[{key:"identity",get:function(){return this.state.identity},set:function(e){this.state.identity=e}},{key:"entityName",set:function(e){this.state.entityName=e}},{key:"attributes",get:function(){return this.state.attributes}},{key:"friendlyName",get:function(){return this.state.friendlyName}},{key:"isOnline",get:function(){return this.state.online}},{key:"isNotifiable",get:function(){return this.state.notifiable}},{key:"isSubscribed",get:function(){return"subscribed"==this.subscribed}},{key:"_update",value:(s=Ta(Wc.mark((function e(t,n){var r,i;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:r=[],lm.debug("User for",this.state.identity,"updated:",t,n),e.t0=t,e.next="friendlyName"===e.t0?7:"attributes"===e.t0?9:"reachability"===e.t0?12:15;break;case 7:return this.state.friendlyName!==n.value&&(r.push("friendlyName"),this.state.friendlyName=n.value),e.abrupt("break",16);case 9:return i=vh(n.value,"Retrieved malformed attributes from the server for user: ".concat(this.state.identity),lm),um(this.state.attributes,i)||(this.state.attributes=i,r.push("attributes")),e.abrupt("break",16);case 12:return this.state.online!==n.online&&(this.state.online=n.online,r.push("reachabilityOnline")),this.state.notifiable!==n.notifiable&&(this.state.notifiable=n.notifiable,r.push("reachabilityNotifiable")),e.abrupt("break",16);case 15:return e.abrupt("return");case 16:r.length>0&&this.emit("updated",{user:this,updateReasons:r});case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"_updateReachabilityInfo",value:(o=Ta(Wc.mark((function e(t,n){var r=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.configuration.reachabilityEnabled){e.next=4;break}return e.abrupt("return",Promise.resolve());case 4:return e.abrupt("return",t.get("reachability").then(n).catch((function(e){lm.warn("Failed to get reachability info for ",r.state.identity,e)})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"_fetch",value:(a=Ta(Wc.mark((function e(){var t=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(this.state.entityName){e.next=4;break}return e.abrupt("return",this);case 4:return this.promiseToFetch=this.services.syncClient.map({id:this.state.entityName,mode:"open_existing",includeItems:!0}).then((function(e){return t.entity=e,e.on("itemUpdated",(function(e){return lm.debug(t.state.entityName+" ("+t.state.identity+") itemUpdated: "+e.item.key),t._update(e.item.key,e.item.data)})),Promise.all([e.get("friendlyName").then((function(e){return t._update(e.key,e.data)})),e.get("attributes").then((function(e){return t._update(e.key,e.data)})),t._updateReachabilityInfo(e,(function(e){return t._update(e.key,e.data)}))])})).then((function(){return lm.debug("Fetched for",t.identity),t.subscribed="subscribed",t.emit("userSubscribed",t),t})).catch((function(e){throw t.promiseToFetch=null,e})),e.abrupt("return",this.promiseToFetch);case 6:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"_ensureFetched",value:(i=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:return e.abrupt("return",this.promiseToFetch||this._fetch());case 3:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"updateAttributes",value:(r=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if("unsubscribed"!=this.subscribed){e.next=4;break}throw new Error("Can't modify unsubscribed object");case 4:return e.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(t)});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"updateFriendlyName",value:(n=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if("unsubscribed"!=this.subscribed){e.next=4;break}throw new Error("Can't modify unsubscribed object");case 4:return e.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:t});case 6:return e.abrupt("return",this);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"unsubscribe",value:(t=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initializationPromise;case 2:if(!this.promiseToFetch){e.next=9;break}return e.next=5,this.promiseToFetch;case 5:this.entity.close(),this.promiseToFetch=null,this.subscribed="unsubscribed",this.emit("userUnsubscribed",this);case 9:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_resolveInitialization",value:function(e,t,n,r){this.configuration=e,this.identity=t,this.entityName=n,this.links={self:"".concat(this.configuration.links.users,"/").concat(encodeURIComponent(this.identity))},this._resolveInitializationPromise(),r&&this.emit("updated",{user:this,updateReasons:["friendlyName","attributes","reachabilityOnline","reachabilityNotifiable"]})}}]),User}(om);function fm(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function dm(e,t){if(e){if("string"==typeof e)return fm(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?fm(e,t):void 0}}function pm(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}}(e,t)||dm(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}$c([wy(xy),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],User.prototype,"updateAttributes",null),$c([wy(["string"]),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],User.prototype,"updateFriendlyName",null);var hm={exports:{}},vm=!o((function(){return Object.isExtensible(Object.preventExtensions({}))})),ym=Rn,mm=st,gm=S,bm=ee,km=Ne.f,wm=Pt,xm=Er,_m=vm,Sm=!1,Em=re("meta"),Tm=0,Rm=Object.isExtensible||function(){return!0},Im=function(e){km(e,Em,{value:{objectID:"O"+Tm++,weakData:{}}})},Cm=hm.exports={enable:function(){Cm.enable=function(){},Sm=!0;var e=wm.f,t=[].splice,n={};n[Em]=1,e(n).length&&(wm.f=function(n){for(var r=e(n),i=0,a=r.length;i<a;i++)if(r[i]===Em){t.call(r,i,1);break}return r},ym({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:xm.f}))},fastKey:function(e,t){if(!gm(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!bm(e,Em)){if(!Rm(e))return"F";if(!t)return"E";Im(e)}return e[Em].objectID},getWeakData:function(e,t){if(!bm(e,Em)){if(!Rm(e))return!0;if(!t)return!1;Im(e)}return e[Em].weakData},onFreeze:function(e){return _m&&Sm&&Rm(e)&&!bm(e,Em)&&Im(e),e}};mm[Em]=!0;var Om=Rn,Pm=i,Am=bn,jm=Je.exports,Mm=hm.exports,Lm=Po,Nm=so,Um=S,Fm=o,Dm=Bo,Bm=Pn,qm=wd,zm=function(e,t,n){var r=-1!==e.indexOf("Map"),i=-1!==e.indexOf("Weak"),a=r?"set":"add",o=Pm[e],s=o&&o.prototype,u=o,c={},l=function(e){var t=s[e];jm(s,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(i&&!Um(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return i&&!Um(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(i&&!Um(e))&&t.call(this,0===e?0:e)}:function(e,n){return t.call(this,0===e?0:e,n),this})};if(Am(e,"function"!=typeof o||!(i||s.forEach&&!Fm((function(){(new o).entries().next()})))))u=n.getConstructor(t,e,r,a),Mm.enable();else if(Am(e,!0)){var f=new u,d=f[a](i?{}:-0,1)!=f,p=Fm((function(){f.has(1)})),h=Dm((function(e){new o(e)})),v=!i&&Fm((function(){for(var e=new o,t=5;t--;)e[a](t,t);return!e.has(-0)}));h||((u=t((function(t,n){Nm(t,u,e);var i=qm(new o,t,u);return null!=n&&Lm(n,i[a],{that:i,AS_ENTRIES:r}),i}))).prototype=s,s.constructor=u),(p||v)&&(l("delete"),l("has"),r&&l("get")),(v||d)&&l(a),i&&s.clear&&delete s.clear}return c[e]=u,Om({global:!0,forced:u!=o},c),Bm(u,e),i||n.setStrong(u,e,r),u},Wm=Ne.f,Gm=tr,$m=Qa,Vm=Fr,Jm=so,Km=Po,Hm=df,Ym=oo,Qm=s,Xm=hm.exports.fastKey,Zm=xt.set,eg=xt.getterFor,tg={getConstructor:function(e,t,n,r){var i=e((function(e,a){Jm(e,i,t),Zm(e,{type:t,index:Gm(null),first:void 0,last:void 0,size:0}),Qm||(e.size=0),null!=a&&Km(a,e[r],{that:e,AS_ENTRIES:n})})),a=eg(t),o=function(e,t,n){var r,i,o=a(e),u=s(e,t);return u?u.value=n:(o.last=u={index:i=Xm(t,!0),key:t,value:n,previous:r=o.last,next:void 0,removed:!1},o.first||(o.first=u),r&&(r.next=u),Qm?o.size++:e.size++,"F"!==i&&(o.index[i]=u)),e},s=function(e,t){var n,r=a(e),i=Xm(t);if("F"!==i)return r.index[i];for(n=r.first;n;n=n.next)if(n.key==t)return n};return $m(i.prototype,{clear:function(){for(var e=a(this),t=e.index,n=e.first;n;)n.removed=!0,n.previous&&(n.previous=n.previous.next=void 0),delete t[n.index],n=n.next;e.first=e.last=void 0,Qm?e.size=0:this.size=0},delete:function(e){var t=this,n=a(t),r=s(t,e);if(r){var i=r.next,o=r.previous;delete n.index[r.index],r.removed=!0,o&&(o.next=i),i&&(i.previous=o),n.first==r&&(n.first=i),n.last==r&&(n.last=o),Qm?n.size--:t.size--}return!!r},forEach:function(e){for(var t,n=a(this),r=Vm(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:n.first;)for(r(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!s(this,e)}}),$m(i.prototype,n?{get:function(e){var t=s(this,e);return t&&t.value},set:function(e,t){return o(this,0===e?0:e,t)}}:{add:function(e){return o(this,e=0===e?0:e,e)}}),Qm&&Wm(i.prototype,"size",{get:function(){return a(this).size}}),i},setStrong:function(e,t,n){var r=t+" Iterator",i=eg(t),a=eg(r);Hm(e,t,(function(e,t){Zm(this,{type:r,target:e,state:i(e),kind:t,last:void 0})}),(function(){for(var e=a(this),t=e.kind,n=e.last;n&&n.removed;)n=n.previous;return e.target&&(e.last=n=n?n.next:e.state.first)?"keys"==t?{value:n.key,done:!1}:"values"==t?{value:n.value,done:!1}:{value:[n.key,n.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),n?"entries":"values",!n,!0),Ym(t)}};zm("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),tg);var ng={};Object.defineProperty(ng,"__esModule",{value:!0});var rg=fv.exports,ig=yv.exports,ag=pv.exports,og=vv.exports,sg=mv.exports,ug=Ry.exports;function cg(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}var lg=cg(dv.exports),fg=cg(rg),dg=cg(ig),pg=cg(ag),hg=cg(og),vg=cg(sg),yg=cg(ug);function mg(){}function gg(){gg.init.call(this)}function bg(e){return void 0===e._maxListeners?gg.defaultMaxListeners:e._maxListeners}function kg(e,t,n){if(t)e.call(n);else for(var r=e.length,i=Ig(e,r),a=0;a<r;++a)i[a].call(n)}function wg(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=Ig(e,i),o=0;o<i;++o)a[o].call(n,r)}function xg(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=Ig(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function _g(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=Ig(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function Sg(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=Ig(e,i),o=0;o<i;++o)a[o].apply(n,r)}function Eg(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new mg,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=bg(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function Tg(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function Rg(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function Ig(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function Cg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vg.default(e);if(t){var i=vg.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return hg.default(this,n)}}mg.prototype=Object.create(null),gg.EventEmitter=gg,gg.usingDomains=!1,gg.prototype.domain=void 0,gg.prototype._events=void 0,gg.prototype._maxListeners=void 0,gg.defaultMaxListeners=10,gg.init=function(){this.domain=null,gg.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new mg,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},gg.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},gg.prototype.getMaxListeners=function(){return bg(this)},gg.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:kg(n,l,this);break;case 2:wg(n,l,this,arguments[1]);break;case 3:xg(n,l,this,arguments[1],arguments[2]);break;case 4:_g(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];Sg(n,l,this,i)}return!0},gg.prototype.addListener=function(e,t){return Eg(this,e,t,!1)},gg.prototype.on=gg.prototype.addListener,gg.prototype.prependListener=function(e,t){return Eg(this,e,t,!0)},gg.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Tg(this,e,t)),this},gg.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Tg(this,e,t)),this},gg.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new mg:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new mg,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},gg.prototype.off=function(e,t){return this.removeListener(e,t)},gg.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new mg,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new mg:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new mg,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},gg.prototype.listeners=function(e){var t,n,r=this._events;return n=r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[],n},gg.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Rg.call(e,t)},gg.prototype.listenerCount=Rg,gg.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Og=function(e){pg.default(n,e);var t=Cg(n);function n(e){var r;return lg.default(this,n),r=t.call(this),yg.default(dg.default(r),"timeout",null),yg.default(dg.default(r),"startTimestamp",-1),r.minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return fg.default(n,[{key:"attempt",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.attemptNum++,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,n=Math.round(Math.random()*t*2-t);return Math.max(0,e+n)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),void this.emit("failed",new Error("Maximum attempt count limit reached"));var n=this.nextDelay(e);if(n=this.randomize(n),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+n)return this.cleanup(),void this.emit("failed",new Error("Maximum attempt time limit reached"));this.timeout=setTimeout((function(){return t.attempt()}),n)}},{key:"cleanup",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){if(this.inProgress)throw new Error("Retrier is already in progress");this.inProgress=!0,this.startTimestamp=Date.now(),this.scheduleAttempt(this.initialDelay)}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"))}},{key:"succeeded",value:function(e){this.emit("succeeded",e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}}]),n}(gg),Pg=function(e){pg.default(n,e);var t=Cg(n);function n(e){var r;return lg.default(this,n),r=t.call(this),yg.default(dg.default(r),"resolve",(function(){})),yg.default(dg.default(r),"reject",(function(){})),r.retrier=new Og(e),r}return fg.default(n,[{key:"run",value:function(e){var t=this;return this.retrier.on("attempt",(function(){e().then((function(e){return t.retrier.succeeded(e)})).catch((function(e){return t.retrier.failed(e)}))})),this.retrier.on("succeeded",(function(e){return t.resolve(e)})),this.retrier.on("cancelled",(function(){return t.reject(new Error("Cancelled"))})),this.retrier.on("failed",(function(e){return t.reject(e)})),new Promise((function(e,n){t.resolve=e,t.reject=n,t.retrier.start()}))}},{key:"cancel",value:function(){this.retrier.cancel()}}]),n}(gg);function Ag(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vg.default(e);if(t){var i=vg.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return hg.default(this,n)}}function jg(e){return null!=e}var Mg=function(e){pg.default(n,e);var t=Ag(n);function n(e){var r;lg.default(this,n),r=t.call(this),yg.default(dg.default(r),"backoffDelay",0),yg.default(dg.default(r),"nextBackoffDelay",0),yg.default(dg.default(r),"backoffNumber",0),yg.default(dg.default(r),"timeoutID",null),yg.default(dg.default(r),"maxNumberOfRetry",-1);var i=e=e||{},a=i.initialDelay,o=i.maxDelay,s=i.randomisationFactor,u=i.factor;if(jg(a)&&a<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(jg(o)&&o<=1)throw new Error("The maximal timeout must be greater than 1.");if(jg(s)&&(s<0||s>1))throw new Error("The randomisation factor must be between 0 and 1.");if(jg(u)&&u<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=a||100,r.maxDelay=o||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=s||0,r.factor=u||2,r.reset(),r}return fg.default(n,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,this.timeoutID&&clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new n(e)}}]),n}(gg),Lg=ng.AsyncRetrier=Pg;ng.Backoff=Mg;var Ng=ng.Retrier=Og;function Ug(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Fg(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Fg(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Fg(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Dg=function(){function e(t,n){Na(this,e),this.configuration=t,this.services=n,this.cache=new Map,this.cacheLifetime=100*this.configuration.httpCacheInterval,this.cleanupCache()}return La(e,[{key:"isExpired",value:function(e){return!this.cacheLifetime||Date.now()-e>this.cacheLifetime}},{key:"cleanupCache",value:function(){var e,t=Ug(this.cache);try{for(t.s();!(e=t.n()).done;){var n=pm(e.value,2),r=n[0],i=n[1];this.isExpired(i.timestamp)&&this.cache.delete(r)}}catch(e){t.e(e)}finally{t.f()}0===this.cache.size&&clearInterval(this.timer)}},{key:"pokeTimer",value:function(){var e=this;this.timer=this.timer||setInterval((function(){return e.cleanupCache()}),2*this.cacheLifetime)}},{key:"executeWithRetry",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var o=new Ng(t.configuration.backoffConfiguration);o.on("attempt",(function(){e().then((function(e){return o.succeeded(e)})).catch((function(e){a.indexOf(e.status)>-1||"Twilsock disconnected"===e.message?o.failed(e):(o.removeAllListeners(),o.cancel(),i(e))}))})),o.on("succeeded",(function(e){r(e)})),o.on("cancelled",(function(e){return i(e)})),o.on("failed",(function(e){return i(e)})),o.start()}))}},{key:"get",value:function(){var e=Ta(Wc.mark((function e(t){var n,r,i,a=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.cache.get(t))||this.isExpired(n.timestamp)){e.next=3;break}return e.abrupt("return",n.response);case 3:return r={},e.next=6,this.executeWithRetry((function(){return a.services.transport.get(t,r,a.configuration.productId)}),this.configuration.retryWhenThrottled);case 6:return i=e.sent,this.cache.set(t,{response:i,timestamp:Date.now()}),this.pokeTimer(),e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),Bg=La((function e(){Na(this,e)}));ja(Bg,"TYPING_INDICATOR","twilio.ipmsg.typing_indicator"),ja(Bg,"NEW_MESSAGE","twilio.conversations.new_message"),ja(Bg,"ADDED_TO_CONVERSATION","twilio.conversations.added_to_conversation"),ja(Bg,"REMOVED_FROM_CONVERSATION","twilio.conversations.removed_from_conversation"),ja(Bg,"CONSUMPTION_UPDATE","twilio.channel.consumption_update");var qg={},zg={exports:{}};!function(e){function t(e,t,n,r,i,a,o){try{var s=e[a](o),u=s.value}catch(e){return void n(e)}s.done?t(u):Promise.resolve(u).then(r,i)}e.exports=function(e){return function(){var n=this,r=arguments;return new Promise((function(i,a){var o=e.apply(n,r);function s(e){t(o,i,a,s,u,"next",e)}function u(e){t(o,i,a,s,u,"throw",e)}s(void 0)}))}},e.exports.__esModule=!0,e.exports.default=e.exports}(zg);var Wg=n(Gc),Gg=Je.exports,$g=Fe,Vg=Sr,Jg=o,Kg=ep,Hg="toString",Yg=RegExp.prototype,Qg=Yg.toString,Xg=Jg((function(){return"/a/b"!=Qg.call({source:"a",flags:"b"})})),Zg=Qg.name!=Hg;(Xg||Zg)&&Gg(RegExp.prototype,Hg,(function(){var e=$g(this),t=Vg(e.source),n=e.flags;return"/"+t+"/"+Vg(void 0===n&&e instanceof RegExp&&!("flags"in Yg)?Kg.call(e):n)}),{unsafe:!0}),zm("Set",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),tg);var eb={exports:{}};!function(e,t){var n;n=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){e.exports=function(e,t){var n,r,i;for(n=1;n<arguments.length;n++)for(i in r=arguments[n])r.hasOwnProperty(i)&&(e[i]=r[i]);return e}},function(e,t,n){var r=n(0);e.exports={build:function(e,t){var n,i,a,o=t.plugins;for(n=0,i=o.length;n<i;n++)(a=o[n]).methods&&r(e,a.methods),a.properties&&Object.defineProperties(e,a.properties)},hook:function(e,t,n){var r,i,a,o,s=e.config.plugins,u=[e.context];for(n&&(u=u.concat(n)),r=0,i=s.length;r<i;r++)o=s[r],(a=s[r][t])&&a.apply(o,u)}}},function(e,t,n){function r(e){if(0===e.length)return e;var t,n,r=e.split(/[_-]/);if(1===r.length&&r[0][0].toLowerCase()===r[0][0])return e;for(n=r[0].toLowerCase(),t=1;t<r.length;t++)n=n+r[t].charAt(0).toUpperCase()+r[t].substring(1).toLowerCase();return n}r.prepended=function(e,t){return e+(t=r(t))[0].toUpperCase()+t.substring(1)},e.exports=r},function(e,t,n){var r=n(0),i=n(2);function a(e,t){e=e||{},this.options=e,this.defaults=t.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(e.init),this.data=this.configureData(e.data),this.methods=this.configureMethods(e.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(e.transitions||[]),this.plugins=this.configurePlugins(e.plugins,t.plugin)}r(a.prototype,{addState:function(e){this.map[e]||(this.states.push(e),this.addStateLifecycleNames(e),this.map[e]={})},addStateLifecycleNames:function(e){this.lifecycle.onEnter[e]=i.prepended("onEnter",e),this.lifecycle.onLeave[e]=i.prepended("onLeave",e),this.lifecycle.on[e]=i.prepended("on",e)},addTransition:function(e){this.transitions.indexOf(e)<0&&(this.transitions.push(e),this.addTransitionLifecycleNames(e))},addTransitionLifecycleNames:function(e){this.lifecycle.onBefore[e]=i.prepended("onBefore",e),this.lifecycle.onAfter[e]=i.prepended("onAfter",e),this.lifecycle.on[e]=i.prepended("on",e)},mapTransition:function(e){var t=e.name,n=e.from,r=e.to;return this.addState(n),"function"!=typeof r&&this.addState(r),this.addTransition(t),this.map[n][t]=e,e},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(e){return"string"==typeof e?this.mapTransition(r({},this.defaults.init,{to:e,active:!0})):"object"===Oa(e)?this.mapTransition(r({},this.defaults.init,e,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(e){return"function"==typeof e?e:"object"===Oa(e)?function(){return e}:function(){return{}}},configureMethods:function(e){return e||{}},configurePlugins:function(e,t){var n,r,i;for(n=0,r=(e=e||[]).length;n<r;n++)"function"==typeof(i=e[n])&&(e[n]=i=i()),i.configure&&i.configure(this);return e},configureTransitions:function(e){var t,n,r,i,a,o=this.defaults.wildcard;for(n=0;n<e.length;n++)for(r=e[n],i=Array.isArray(r.from)?r.from:[r.from||o],a=r.to||o,t=0;t<i.length;t++)this.mapTransition({name:r.name,from:i[t],to:a})},transitionFor:function(e,t){var n=this.defaults.wildcard;return this.map[e][t]||this.map[n][t]},transitionsFor:function(e){var t=this.defaults.wildcard;return Object.keys(this.map[e]).concat(Object.keys(this.map[t]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),e.exports=a},function(e,t,n){var r=n(0),i=n(6),a=n(1),o=[null,[]];function s(e,t){this.context=e,this.config=t,this.state=t.init.from,this.observers=[e]}r(s.prototype,{init:function(e){if(r(this.context,this.config.data.apply(this.context,e)),a.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(e){return Array.isArray(e)?e.indexOf(this.state)>=0:this.state===e},isPending:function(){return this.pending},can:function(e){return!this.isPending()&&!!this.seek(e)},cannot:function(e){return!this.can(e)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(e,t){var n=this.config.defaults.wildcard,r=this.config.transitionFor(this.state,e),i=r&&r.to;return"function"==typeof i?i.apply(this.context,t):i===n?this.state:i},fire:function(e,t){return this.transit(e,this.state,this.seek(e,t),t)},transit:function(e,t,n,r){var i=this.config.lifecycle,a=this.config.options.observeUnchangedState||t!==n;return n?this.isPending()?this.context.onPendingTransition(e,t,n):(this.config.addState(n),this.beginTransit(),r.unshift({transition:e,from:t,to:n,fsm:this.context}),this.observeEvents([this.observersForEvent(i.onBefore.transition),this.observersForEvent(i.onBefore[e]),a?this.observersForEvent(i.onLeave.state):o,a?this.observersForEvent(i.onLeave[t]):o,this.observersForEvent(i.on.transition),a?["doTransit",[this]]:o,a?this.observersForEvent(i.onEnter.state):o,a?this.observersForEvent(i.onEnter[n]):o,a?this.observersForEvent(i.on[n]):o,this.observersForEvent(i.onAfter.transition),this.observersForEvent(i.onAfter[e]),this.observersForEvent(i.on[e])],r)):this.context.onInvalidTransition(e,t,n)},beginTransit:function(){this.pending=!0},endTransit:function(e){return this.pending=!1,e},failTransit:function(e){throw this.pending=!1,e},doTransit:function(e){this.state=e.to},observe:function(e){if(2===e.length){var t={};t[e[0]]=e[1],this.observers.push(t)}else this.observers.push(e[0])},observersForEvent:function(e){for(var t,n=0,r=this.observers.length,i=[];n<r;n++)(t=this.observers[n])[e]&&i.push(t);return[e,i,!0]},observeEvents:function(e,t,n,r){if(0===e.length)return this.endTransit(void 0===r||r);var i=e[0][0],o=e[0][1],s=e[0][2];if(t[0].event=i,i&&s&&i!==n&&a.hook(this,"lifecycle",t),0===o.length)return e.shift(),this.observeEvents(e,t,i,r);var u=o.shift(),c=u[i].apply(u,t);return c&&"function"==typeof c.then?c.then(this.observeEvents.bind(this,e,t,i)).catch(this.failTransit.bind(this)):!1===c?this.endTransit(!1):this.observeEvents(e,t,i,c)},onInvalidTransition:function(e,t,n){throw new i("transition is invalid in current state",e,t,n,this.state)},onPendingTransition:function(e,t,n){throw new i("transition is invalid while previous transition is still in progress",e,t,n,this.state)}}),e.exports=s},function(e,t,n){var r=n(0),i=n(2),a=n(1),o=n(3),s=n(4),u={is:function(e){return this._fsm.is(e)},can:function(e){return this._fsm.can(e)},cannot:function(e){return this._fsm.cannot(e)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(e,t,n){return this._fsm.onInvalidTransition(e,t,n)},onPendingTransition:function(e,t,n){return this._fsm.onPendingTransition(e,t,n)}},c={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(e){throw Error("use transitions to change state")}}};function l(e){return f(this||{},e)}function f(e,t){return d(e,new o(t,l)),e._fsm(),e}function d(e,t){if("object"!==Oa(e)||Array.isArray(e))throw Error("StateMachine can only be applied to objects");a.build(e,t),Object.defineProperties(e,c),r(e,u),r(e,t.methods),t.allTransitions().forEach((function(t){e[i(t)]=function(){return this._fsm.fire(t,[].slice.call(arguments))}})),e._fsm=function(){this._fsm=new s(this,t),this._fsm.init(arguments)}}l.version="3.0.1",l.factory=function(){var e,t;"function"==typeof arguments[0]?(e=arguments[0],t=arguments[1]||{}):(e=function(){this._fsm.apply(this,arguments)},t=arguments[0]||{});var n=new o(t,l);return d(e.prototype,n),e.prototype._fsm.config=n,e},l.apply=f,l.defaults={wildcard:"*",init:{name:"init",from:"none"}},e.exports=l},function(e,t,n){e.exports=function(e,t,n,r,i){this.message=e,this.transition=t,this.from=n,this.to=r,this.current=i}}])},e.exports=n()}(eb);var tb={exports:{}},nb="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(nb){var rb=new Uint8Array(16);tb.exports=function(){return nb(rb),rb}}else{var ib=new Array(16);tb.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),ib[t]=e>>>((3&t)<<3)&255;return ib}}for(var ab=[],ob=0;ob<256;++ob)ab[ob]=(ob+256).toString(16).substr(1);var sb,ub,cb=function(e,t){var n=t||0,r=ab;return[r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]]].join("")},lb=tb.exports,fb=cb,db=0,pb=0;var hb=function(e,t,n){var r=t&&n||0,i=t||[],a=(e=e||{}).node||sb,o=void 0!==e.clockseq?e.clockseq:ub;if(null==a||null==o){var s=lb();null==a&&(a=sb=[1|s[0],s[1],s[2],s[3],s[4],s[5]]),null==o&&(o=ub=16383&(s[6]<<8|s[7]))}var u=void 0!==e.msecs?e.msecs:(new Date).getTime(),c=void 0!==e.nsecs?e.nsecs:pb+1,l=u-db+(c-pb)/1e4;if(l<0&&void 0===e.clockseq&&(o=o+1&16383),(l<0||u>db)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");db=u,pb=c,ub=o;var f=(1e4*(268435455&(u+=122192928e5))+c)%4294967296;i[r++]=f>>>24&255,i[r++]=f>>>16&255,i[r++]=f>>>8&255,i[r++]=255&f;var d=u/4294967296*1e4&268435455;i[r++]=d>>>8&255,i[r++]=255&d,i[r++]=d>>>24&15|16,i[r++]=d>>>16&255,i[r++]=o>>>8|128,i[r++]=255&o;for(var p=0;p<6;++p)i[r+p]=a[p];return t||fb(i)},vb=tb.exports,yb=cb;var mb=function(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var i=(e=e||{}).random||(e.rng||vb)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var a=0;a<16;++a)t[r+a]=i[a];return t||yb(i)},gb=hb,bb=mb,kb=bb;kb.v1=gb,kb.v4=bb;var wb,xb,_b,Sb=kb,Eb={exports:{}},Tb="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Rb=Tb,Ib=s,Cb=i,Ob=S,Pb=ee,Ab=Wa,jb=Ve,Mb=Je.exports,Lb=Ne.f,Nb=Ll,Ub=to,Fb=pe,Db=re,Bb=Cb.Int8Array,qb=Bb&&Bb.prototype,zb=Cb.Uint8ClampedArray,Wb=zb&&zb.prototype,Gb=Bb&&Nb(Bb),$b=qb&&Nb(qb),Vb=Object.prototype,Jb=Vb.isPrototypeOf,Kb=Fb("toStringTag"),Hb=Db("TYPED_ARRAY_TAG"),Yb=Db("TYPED_ARRAY_CONSTRUCTOR"),Qb=Rb&&!!Ub&&"Opera"!==Ab(Cb.opera),Xb=!1,Zb={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},ek={BigInt64Array:8,BigUint64Array:8},tk=function(e){if(!Ob(e))return!1;var t=Ab(e);return Pb(Zb,t)||Pb(ek,t)};for(wb in Zb)(_b=(xb=Cb[wb])&&xb.prototype)?jb(_b,Yb,xb):Qb=!1;for(wb in ek)(_b=(xb=Cb[wb])&&xb.prototype)&&jb(_b,Yb,xb);if((!Qb||"function"!=typeof Gb||Gb===Function.prototype)&&(Gb=function(){throw TypeError("Incorrect invocation")},Qb))for(wb in Zb)Cb[wb]&&Ub(Cb[wb],Gb);if((!Qb||!$b||$b===Vb)&&($b=Gb.prototype,Qb))for(wb in Zb)Cb[wb]&&Ub(Cb[wb].prototype,$b);if(Qb&&Nb(Wb)!==$b&&Ub(Wb,$b),Ib&&!Pb($b,Kb))for(wb in Xb=!0,Lb($b,Kb,{get:function(){return Ob(this)?this[Hb]:void 0}}),Zb)Cb[wb]&&jb(Cb[wb],Hb,wb);var nk={NATIVE_ARRAY_BUFFER_VIEWS:Qb,TYPED_ARRAY_CONSTRUCTOR:Yb,TYPED_ARRAY_TAG:Xb&&Hb,aTypedArray:function(e){if(tk(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(Ub&&!Jb.call(Gb,e))throw TypeError("Target is not a typed array constructor");return e},exportTypedArrayMethod:function(e,t,n){if(Ib){if(n)for(var r in Zb){var i=Cb[r];if(i&&Pb(i.prototype,e))try{delete i.prototype[e]}catch(e){}}$b[e]&&!n||Mb($b,e,n?t:Qb&&qb[e]||t)}},exportTypedArrayStaticMethod:function(e,t,n){var r,i;if(Ib){if(Ub){if(n)for(r in Zb)if((i=Cb[r])&&Pb(i,e))try{delete i[e]}catch(e){}if(Gb[e]&&!n)return;try{return Mb(Gb,e,n?t:Qb&&Gb[e]||t)}catch(e){}}for(r in Zb)!(i=Cb[r])||i[e]&&!n||Mb(i,e,t)}},isView:function(e){if(!Ob(e))return!1;var t=Ab(e);return"DataView"===t||Pb(Zb,t)||Pb(ek,t)},isTypedArray:tk,TypedArray:Gb,TypedArrayPrototype:$b},rk=i,ik=o,ak=Bo,ok=nk.NATIVE_ARRAY_BUFFER_VIEWS,sk=rk.ArrayBuffer,uk=rk.Int8Array,ck=!ok||!ik((function(){uk(1)}))||!ik((function(){new uk(-1)}))||!ak((function(e){new uk,new uk(null),new uk(1.5),new uk(e)}),!0)||ik((function(){return 1!==new uk(new sk(2),1,void 0).length})),lk=Mt,fk=Ut,dk=function(e){if(void 0===e)return 0;var t=lk(e),n=fk(t);if(t!==n)throw RangeError("Wrong length or index");return n},pk=Math.abs,hk=Math.pow,vk=Math.floor,yk=Math.log,mk=Math.LN2,gk=Q,bk=qt,kk=Ut,wk=function(e){for(var t=gk(this),n=kk(t.length),r=arguments.length,i=bk(r>1?arguments[1]:void 0,n),a=r>2?arguments[2]:void 0,o=void 0===a?n:bk(a,n);o>i;)t[i++]=e;return t},xk=i,_k=s,Sk=Tb,Ek=Ve,Tk=Qa,Rk=o,Ik=so,Ck=Mt,Ok=Ut,Pk=dk,Ak={pack:function(e,t,n){var r,i,a,o=new Array(n),s=8*n-t-1,u=(1<<s)-1,c=u>>1,l=23===t?hk(2,-24)-hk(2,-77):0,f=e<0||0===e&&1/e<0?1:0,d=0;for((e=pk(e))!=e||e===1/0?(i=e!=e?1:0,r=u):(r=vk(yk(e)/mk),e*(a=hk(2,-r))<1&&(r--,a*=2),(e+=r+c>=1?l/a:l*hk(2,1-c))*a>=2&&(r++,a/=2),r+c>=u?(i=0,r=u):r+c>=1?(i=(e*a-1)*hk(2,t),r+=c):(i=e*hk(2,c-1)*hk(2,t),r=0));t>=8;o[d++]=255&i,i/=256,t-=8);for(r=r<<t|i,s+=t;s>0;o[d++]=255&r,r/=256,s-=8);return o[--d]|=128*f,o},unpack:function(e,t){var n,r=e.length,i=8*r-t-1,a=(1<<i)-1,o=a>>1,s=i-7,u=r-1,c=e[u--],l=127&c;for(c>>=7;s>0;l=256*l+e[u],u--,s-=8);for(n=l&(1<<-s)-1,l>>=-s,s+=t;s>0;n=256*n+e[u],u--,s-=8);if(0===l)l=1-o;else{if(l===a)return n?NaN:c?-1/0:1/0;n+=hk(2,t),l-=o}return(c?-1:1)*n*hk(2,l-t)}},jk=Ll,Mk=to,Lk=Pt.f,Nk=Ne.f,Uk=wk,Fk=Pn,Dk=xt.get,Bk=xt.set,qk="ArrayBuffer",zk="DataView",Wk="Wrong index",Gk=xk.ArrayBuffer,$k=Gk,Vk=xk.DataView,Jk=Vk&&Vk.prototype,Kk=Object.prototype,Hk=xk.RangeError,Yk=Ak.pack,Qk=Ak.unpack,Xk=function(e){return[255&e]},Zk=function(e){return[255&e,e>>8&255]},ew=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},tw=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},nw=function(e){return Yk(e,23,4)},rw=function(e){return Yk(e,52,8)},iw=function(e,t){Nk(e.prototype,t,{get:function(){return Dk(this)[t]}})},aw=function(e,t,n,r){var i=Pk(n),a=Dk(e);if(i+t>a.byteLength)throw Hk(Wk);var o=Dk(a.buffer).bytes,s=i+a.byteOffset,u=o.slice(s,s+t);return r?u:u.reverse()},ow=function(e,t,n,r,i,a){var o=Pk(n),s=Dk(e);if(o+t>s.byteLength)throw Hk(Wk);for(var u=Dk(s.buffer).bytes,c=o+s.byteOffset,l=r(+i),f=0;f<t;f++)u[c+f]=l[a?f:t-f-1]};if(Sk){if(!Rk((function(){Gk(1)}))||!Rk((function(){new Gk(-1)}))||Rk((function(){return new Gk,new Gk(1.5),new Gk(NaN),Gk.name!=qk}))){for(var sw,uw=($k=function(e){return Ik(this,$k),new Gk(Pk(e))}).prototype=Gk.prototype,cw=Lk(Gk),lw=0;cw.length>lw;)(sw=cw[lw++])in $k||Ek($k,sw,Gk[sw]);uw.constructor=$k}Mk&&jk(Jk)!==Kk&&Mk(Jk,Kk);var fw=new Vk(new $k(2)),dw=Jk.setInt8;fw.setInt8(0,2147483648),fw.setInt8(1,2147483649),!fw.getInt8(0)&&fw.getInt8(1)||Tk(Jk,{setInt8:function(e,t){dw.call(this,e,t<<24>>24)},setUint8:function(e,t){dw.call(this,e,t<<24>>24)}},{unsafe:!0})}else $k=function(e){Ik(this,$k,qk);var t=Pk(e);Bk(this,{bytes:Uk.call(new Array(t),0),byteLength:t}),_k||(this.byteLength=t)},Vk=function(e,t,n){Ik(this,Vk,zk),Ik(e,$k,zk);var r=Dk(e).byteLength,i=Ck(t);if(i<0||i>r)throw Hk("Wrong offset");if(i+(n=void 0===n?r-i:Ok(n))>r)throw Hk("Wrong length");Bk(this,{buffer:e,byteLength:n,byteOffset:i}),_k||(this.buffer=e,this.byteLength=n,this.byteOffset=i)},_k&&(iw($k,"byteLength"),iw(Vk,"buffer"),iw(Vk,"byteLength"),iw(Vk,"byteOffset")),Tk(Vk.prototype,{getInt8:function(e){return aw(this,1,e)[0]<<24>>24},getUint8:function(e){return aw(this,1,e)[0]},getInt16:function(e){var t=aw(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=aw(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return tw(aw(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return tw(aw(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return Qk(aw(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return Qk(aw(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){ow(this,1,e,Xk,t)},setUint8:function(e,t){ow(this,1,e,Xk,t)},setInt16:function(e,t){ow(this,2,e,Zk,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){ow(this,2,e,Zk,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){ow(this,4,e,ew,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){ow(this,4,e,ew,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){ow(this,4,e,nw,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){ow(this,8,e,rw,t,arguments.length>2?arguments[2]:void 0)}});Fk($k,qk),Fk(Vk,zk);var pw={ArrayBuffer:$k,DataView:Vk},hw=Mt,vw=function(e){var t=hw(e);if(t<0)throw RangeError("The argument can't be less than 0");return t},yw=function(e,t){var n=vw(e);if(n%t)throw RangeError("Wrong offset");return n},mw=Q,gw=Ut,bw=ko,kw=mo,ww=po,xw=Fr,_w=nk.aTypedArrayConstructor,Sw=Rn,Ew=i,Tw=s,Rw=ck,Iw=nk,Cw=pw,Ow=so,Pw=h,Aw=Ve,jw=xv,Mw=Ut,Lw=dk,Nw=yw,Uw=we,Fw=ee,Dw=Wa,Bw=S,qw=q,zw=tr,Ww=to,Gw=Pt.f,$w=function(e){var t,n,r,i,a,o,s=mw(e),u=arguments.length,c=u>1?arguments[1]:void 0,l=void 0!==c,f=kw(s);if(null!=f&&!ww(f))for(o=(a=bw(s,f)).next,s=[];!(i=o.call(a)).done;)s.push(i.value);for(l&&u>2&&(c=xw(c,arguments[2],2)),n=gw(s.length),r=new(_w(this))(n),t=0;n>t;t++)r[t]=l?c(s[t],t):s[t];return r},Vw=Qr.forEach,Jw=oo,Kw=Ne,Hw=a,Yw=wd,Qw=xt.get,Xw=xt.set,Zw=Kw.f,ex=Hw.f,tx=Math.round,nx=Ew.RangeError,rx=Cw.ArrayBuffer,ix=Cw.DataView,ax=Iw.NATIVE_ARRAY_BUFFER_VIEWS,ox=Iw.TYPED_ARRAY_CONSTRUCTOR,sx=Iw.TYPED_ARRAY_TAG,ux=Iw.TypedArray,cx=Iw.TypedArrayPrototype,lx=Iw.aTypedArrayConstructor,fx=Iw.isTypedArray,dx="BYTES_PER_ELEMENT",px="Wrong length",hx=function(e,t){for(var n=0,r=t.length,i=new(lx(e))(r);r>n;)i[n]=t[n++];return i},vx=function(e,t){Zw(e,t,{get:function(){return Qw(this)[t]}})},yx=function(e){var t;return e instanceof rx||"ArrayBuffer"==(t=Dw(e))||"SharedArrayBuffer"==t},mx=function(e,t){return fx(e)&&!qw(t)&&t in e&&jw(+t)&&t>=0},gx=function(e,t){return t=Uw(t),mx(e,t)?Pw(2,e[t]):ex(e,t)},bx=function(e,t,n){return t=Uw(t),!(mx(e,t)&&Bw(n)&&Fw(n,"value"))||Fw(n,"get")||Fw(n,"set")||n.configurable||Fw(n,"writable")&&!n.writable||Fw(n,"enumerable")&&!n.enumerable?Zw(e,t,n):(e[t]=n.value,e)};Tw?(ax||(Hw.f=gx,Kw.f=bx,vx(cx,"buffer"),vx(cx,"byteOffset"),vx(cx,"byteLength"),vx(cx,"length")),Sw({target:"Object",stat:!0,forced:!ax},{getOwnPropertyDescriptor:gx,defineProperty:bx}),Eb.exports=function(e,t,n){var r=e.match(/\d+$/)[0]/8,i=e+(n?"Clamped":"")+"Array",a="get"+e,o="set"+e,s=Ew[i],u=s,c=u&&u.prototype,l={},f=function(e,t){Zw(e,t,{get:function(){return function(e,t){var n=Qw(e);return n.view[a](t*r+n.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,i){var a=Qw(e);n&&(i=(i=tx(i))<0?0:i>255?255:255&i),a.view[o](t*r+a.byteOffset,i,!0)}(this,t,e)},enumerable:!0})};ax?Rw&&(u=t((function(e,t,n,a){return Ow(e,u,i),Yw(Bw(t)?yx(t)?void 0!==a?new s(t,Nw(n,r),a):void 0!==n?new s(t,Nw(n,r)):new s(t):fx(t)?hx(u,t):$w.call(u,t):new s(Lw(t)),e,u)})),Ww&&Ww(u,ux),Vw(Gw(s),(function(e){e in u||Aw(u,e,s[e])})),u.prototype=c):(u=t((function(e,t,n,a){Ow(e,u,i);var o,s,c,l=0,d=0;if(Bw(t)){if(!yx(t))return fx(t)?hx(u,t):$w.call(u,t);o=t,d=Nw(n,r);var p=t.byteLength;if(void 0===a){if(p%r)throw nx(px);if((s=p-d)<0)throw nx(px)}else if((s=Mw(a)*r)+d>p)throw nx(px);c=s/r}else c=Lw(t),o=new rx(s=c*r);for(Xw(e,{buffer:o,byteOffset:d,byteLength:s,length:c,view:new ix(o)});l<c;)f(e,l++)})),Ww&&Ww(u,ux),c=u.prototype=zw(cx)),c.constructor!==u&&Aw(c,"constructor",u),Aw(c,ox,u),sx&&Aw(c,sx,i),l[i]=u,Sw({global:!0,forced:u!=s,sham:!ax},l),dx in u||Aw(u,dx,r),dx in c||Aw(c,dx,r),Jw(i)}):Eb.exports=function(){},(0,Eb.exports)("Uint8",(function(e){return function(t,n,r){return e(this,t,n,r)}}));var kx=Q,wx=qt,xx=Ut,_x=Math.min,Sx=[].copyWithin||function(e,t){var n=kx(this),r=xx(n.length),i=wx(e,r),a=wx(t,r),o=arguments.length>2?arguments[2]:void 0,s=_x((void 0===o?r:wx(o,r))-a,r-i),u=1;for(a<i&&i<a+s&&(u=-1,a+=s-1,i+=s-1);s-- >0;)a in n?n[i]=n[a]:delete n[i],i+=u,a+=u;return n},Ex=Sx,Tx=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("copyWithin",(function(e,t){return Ex.call(Tx(this),e,t,arguments.length>2?arguments[2]:void 0)}));var Rx=Qr.every,Ix=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("every",(function(e){return Rx(Ix(this),e,arguments.length>1?arguments[1]:void 0)}));var Cx=wk,Ox=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("fill",(function(e){return Cx.apply(Ox(this),arguments)}));var Px=Go,Ax=nk.TYPED_ARRAY_CONSTRUCTOR,jx=nk.aTypedArrayConstructor,Mx=function(e){return jx(Px(e,e[Ax]))},Lx=function(e,t){for(var n=0,r=t.length,i=new e(r);r>n;)i[n]=t[n++];return i},Nx=Mx,Ux=Qr.filter,Fx=function(e,t){return Lx(Nx(e),t)},Dx=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("filter",(function(e){var t=Ux(Dx(this),e,arguments.length>1?arguments[1]:void 0);return Fx(this,t)}));var Bx=Qr.find,qx=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("find",(function(e){return Bx(qx(this),e,arguments.length>1?arguments[1]:void 0)}));var zx=Qr.findIndex,Wx=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("findIndex",(function(e){return zx(Wx(this),e,arguments.length>1?arguments[1]:void 0)}));var Gx=Qr.forEach,$x=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("forEach",(function(e){Gx($x(this),e,arguments.length>1?arguments[1]:void 0)}));var Vx=Vt.includes,Jx=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("includes",(function(e){return Vx(Jx(this),e,arguments.length>1?arguments[1]:void 0)}));var Kx=Vt.indexOf,Hx=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("indexOf",(function(e){return Kx(Hx(this),e,arguments.length>1?arguments[1]:void 0)}));var Yx=i,Qx=nk,Xx=Zf,Zx=pe("iterator"),e_=Yx.Uint8Array,t_=Xx.values,n_=Xx.keys,r_=Xx.entries,i_=Qx.aTypedArray,a_=Qx.exportTypedArrayMethod,o_=e_&&e_.prototype[Zx],s_=!!o_&&("values"==o_.name||null==o_.name),u_=function(){return t_.call(i_(this))};a_("entries",(function(){return r_.call(i_(this))})),a_("keys",(function(){return n_.call(i_(this))})),a_("values",u_,!s_),a_(Zx,u_,!s_);var c_=nk.aTypedArray,l_=[].join;(0,nk.exportTypedArrayMethod)("join",(function(e){return l_.apply(c_(this),arguments)}));var f_=_,d_=Mt,p_=Ut,h_=rc,v_=Math.min,y_=[].lastIndexOf,m_=!!y_&&1/[1].lastIndexOf(1,-0)<0,g_=h_("lastIndexOf"),b_=m_||!g_?function(e){if(m_)return y_.apply(this,arguments)||0;var t=f_(this),n=p_(t.length),r=n-1;for(arguments.length>1&&(r=v_(r,d_(arguments[1]))),r<0&&(r=n+r);r>=0;r--)if(r in t&&t[r]===e)return r||0;return-1}:y_,k_=b_,w_=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("lastIndexOf",(function(e){return k_.apply(w_(this),arguments)}));var x_=Qr.map,__=Mx,S_=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("map",(function(e){return x_(S_(this),e,arguments.length>1?arguments[1]:void 0,(function(e,t){return new(__(e))(t)}))}));var E_=Ln,T_=Q,R_=b,I_=Ut,C_=function(e){return function(t,n,r,i){E_(n);var a=T_(t),o=R_(a),s=I_(a.length),u=e?s-1:0,c=e?-1:1;if(r<2)for(;;){if(u in o){i=o[u],u+=c;break}if(u+=c,e?u<0:s<=u)throw TypeError("Reduce of empty array with no initial value")}for(;e?u>=0:s>u;u+=c)u in o&&(i=n(i,o[u],u,a));return i}},O_={left:C_(!1),right:C_(!0)},P_=O_.left,A_=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("reduce",(function(e){return P_(A_(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var j_=O_.right,M_=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("reduceRight",(function(e){return j_(M_(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var L_=nk.aTypedArray,N_=nk.exportTypedArrayMethod,U_=Math.floor;N_("reverse",(function(){for(var e,t=this,n=L_(t).length,r=U_(n/2),i=0;i<r;)e=t[i],t[i++]=t[--n],t[n]=e;return t}));var F_=Ut,D_=yw,B_=Q,q_=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("set",(function(e){q_(this);var t=D_(arguments.length>1?arguments[1]:void 0,1),n=this.length,r=B_(e),i=F_(r.length),a=0;if(i+t>n)throw RangeError("Wrong length");for(;a<i;)this[t+a]=r[a++]}),o((function(){new Int8Array(1).set({})})));var z_=Mx,W_=nk.aTypedArray,G_=[].slice;(0,nk.exportTypedArrayMethod)("slice",(function(e,t){for(var n=G_.call(W_(this),e,t),r=z_(this),i=0,a=n.length,o=new r(a);a>i;)o[i]=n[i++];return o}),o((function(){new Int8Array(1).slice()})));var $_=Qr.some,V_=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("some",(function(e){return $_(V_(this),e,arguments.length>1?arguments[1]:void 0)}));var J_=Math.floor,K_=function(e,t){var n=e.length,r=J_(n/2);return n<8?H_(e,t):Y_(K_(e.slice(0,r),t),K_(e.slice(r),t),t)},H_=function(e,t){for(var n,r,i=e.length,a=1;a<i;){for(r=a,n=e[a];r&&t(e[r-1],n)>0;)e[r]=e[--r];r!==a++&&(e[r]=n)}return e},Y_=function(e,t,n){for(var r=e.length,i=t.length,a=0,o=0,s=[];a<r||o<i;)a<r&&o<i?s.push(n(e[a],t[o])<=0?e[a++]:t[o++]):s.push(a<r?e[a++]:t[o++]);return s},Q_=K_,X_=I.match(/firefox\/(\d+)/i),Z_=!!X_&&+X_[1],eS=/MSIE|Trident/.test(I),tS=I.match(/AppleWebKit\/(\d+)\./),nS=!!tS&&+tS[1],rS=o,iS=Ln,aS=Ut,oS=Q_,sS=Z_,uS=eS,cS=L,lS=nS,fS=nk.aTypedArray,dS=nk.exportTypedArrayMethod,pS=i.Uint16Array,hS=pS&&pS.prototype.sort,vS=!!hS&&!rS((function(){var e=new pS(2);e.sort(null),e.sort({})})),yS=!!hS&&!rS((function(){if(cS)return cS<74;if(sS)return sS<67;if(uS)return!0;if(lS)return lS<602;var e,t,n=new pS(516),r=Array(516);for(e=0;e<516;e++)t=e%4,n[e]=515-e,r[e]=e-2*t+3;for(n.sort((function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(n[e]!==r[e])return!0}));dS("sort",(function(e){var t=this;if(void 0!==e&&iS(e),yS)return hS.call(t,e);fS(t);var n,r=aS(t.length),i=Array(r);for(n=0;n<r;n++)i[n]=t[n];for(i=oS(t,function(e){return function(t,n){return void 0!==e?+e(t,n)||0:n!=n?-1:t!=t?1:0===t&&0===n?1/t>0&&1/n<0?1:-1:t>n}}(e)),n=0;n<r;n++)t[n]=i[n];return t}),!yS||vS);var mS=Ut,gS=qt,bS=Mx,kS=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("subarray",(function(e,t){var n=kS(this),r=n.length,i=gS(e,r);return new(bS(n))(n.buffer,n.byteOffset+i*n.BYTES_PER_ELEMENT,mS((void 0===t?r:gS(t,r))-i))}));var wS=nk,xS=o,_S=i.Int8Array,SS=wS.aTypedArray,ES=wS.exportTypedArrayMethod,TS=[].toLocaleString,RS=[].slice,IS=!!_S&&xS((function(){TS.call(new _S(1))}));ES("toLocaleString",(function(){return TS.apply(IS?RS.call(SS(this)):SS(this),arguments)}),xS((function(){return[1,2].toLocaleString()!=new _S([1,2]).toLocaleString()}))||!xS((function(){_S.prototype.toLocaleString.call([1,2])})));var CS=nk.exportTypedArrayMethod,OS=o,PS=i.Uint8Array,AS=PS&&PS.prototype||{},jS=[].toString,MS=[].join;OS((function(){jS.call({})}))&&(jS=function(){return MS.call(this)});var LS=AS.toString!=jS;CS("toString",jS,LS);var NS=S,US=y,FS=pe("match"),DS=function(e){var t;return NS(e)&&(void 0!==(t=e[FS])?!!t:"RegExp"==US(e))},BS=Mp,qS=DS,zS=Fe,WS=k,GS=Go,$S=Np,VS=Ut,JS=Sr,KS=Gp,HS=Tp,YS=o,QS=tp.UNSUPPORTED_Y,XS=[].push,ZS=Math.min,eE=4294967295,tE=!YS((function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var n="ab".split(e);return 2!==n.length||"a"!==n[0]||"b"!==n[1]}));BS("split",(function(e,t,n){var r;return r="c"=="abbc".split(/(b)*/)[1]||4!="test".split(/(?:)/,-1).length||2!="ab".split(/(?:ab)*/).length||4!=".".split(/(.?)(.?)/).length||".".split(/()()/).length>1||"".split(/.?/).length?function(e,n){var r=JS(WS(this)),i=void 0===n?eE:n>>>0;if(0===i)return[];if(void 0===e)return[r];if(!qS(e))return t.call(r,e,i);for(var a,o,s,u=[],c=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),l=0,f=new RegExp(e.source,c+"g");(a=HS.call(f,r))&&!((o=f.lastIndex)>l&&(u.push(r.slice(l,a.index)),a.length>1&&a.index<r.length&&XS.apply(u,a.slice(1)),s=a[0].length,l=o,u.length>=i));)f.lastIndex===a.index&&f.lastIndex++;return l===r.length?!s&&f.test("")||u.push(""):u.push(r.slice(l)),u.length>i?u.slice(0,i):u}:"0".split(void 0,0).length?function(e,n){return void 0===e&&0===n?[]:t.call(this,e,n)}:t,[function(t,n){var i=WS(this),a=null==t?void 0:t[e];return void 0!==a?a.call(t,i,n):r.call(JS(i),t,n)},function(e,i){var a=zS(this),o=JS(e),s=n(r,a,o,i,r!==t);if(s.done)return s.value;var u=GS(a,RegExp),c=a.unicode,l=(a.ignoreCase?"i":"")+(a.multiline?"m":"")+(a.unicode?"u":"")+(QS?"g":"y"),f=new u(QS?"^(?:"+a.source+")":a,l),d=void 0===i?eE:i>>>0;if(0===d)return[];if(0===o.length)return null===KS(f,o)?[o]:[];for(var p=0,h=0,v=[];h<o.length;){f.lastIndex=QS?0:h;var y,m=KS(f,QS?o.slice(h):o);if(null===m||(y=ZS(VS(f.lastIndex+(QS?h:0)),o.length))===p)h=$S(o,h,c);else{if(v.push(o.slice(p,h)),v.length===d)return v;for(var g=1;g<=m.length-1;g++)if(v.push(m[g]),v.length===d)return v;h=p=y}}return v.push(o.slice(p)),v}]}),!tE,QS);var nE={exports:{}},rE={exports:{}};!function(e){e.exports=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")},e.exports.__esModule=!0,e.exports.default=e.exports}(rE);var iE={exports:{}},aE={exports:{}};!function(e){e.exports=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}},e.exports.__esModule=!0,e.exports.default=e.exports}(aE),function(e){var t=hv.exports,n=aE.exports;function r(i,a,o){return n()?(e.exports=r=Reflect.construct,e.exports.__esModule=!0,e.exports.default=e.exports):(e.exports=r=function(e,n,r){var i=[null];i.push.apply(i,n);var a=new(Function.bind.apply(e,i));return r&&t(a,r.prototype),a},e.exports.__esModule=!0,e.exports.default=e.exports),r.apply(null,arguments)}e.exports=r,e.exports.__esModule=!0,e.exports.default=e.exports}(iE),function(e){var t=mv.exports,n=hv.exports,r=rE.exports,i=iE.exports;function a(o){var s="function"==typeof Map?new Map:void 0;return e.exports=a=function(e){if(null===e||!r(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==s){if(s.has(e))return s.get(e);s.set(e,a)}function a(){return i(e,arguments,t(this).constructor)}return a.prototype=Object.create(e.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),n(a,e)},e.exports.__esModule=!0,e.exports.default=e.exports,a(o)}e.exports=a,e.exports.__esModule=!0,e.exports.default=e.exports}(nE);var oE={exports:{}};!function(e,n){(function(){var r={function:!0,object:!0}["undefined"==typeof window?"undefined":Oa(window)]&&window||this,i=n,a=e&&!e.nodeType&&e,o=i&&a&&"object"==Oa(t)&&t;!o||o.global!==o&&o.window!==o&&o.self!==o||(r=o);var s=Math.pow(2,53)-1,u=/\bOpera/,c=Object.prototype,l=c.hasOwnProperty,f=c.toString;function d(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function p(e){return e=g(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:d(e)}function h(e,t){for(var n in e)l.call(e,n)&&t(e[n],n,e)}function v(e){return null==e?d(e):f.call(e).slice(8,-1)}function y(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function m(e,t){var n=null;return function(e,t){var n=-1,r=e?e.length:0;if("number"==typeof r&&r>-1&&r<=s)for(;++n<r;)t(e[n],n,e);else h(e,t)}(e,(function(r,i){n=t(n,r,i,e)})),n}function g(e){return String(e).replace(/^ +| +$/g,"")}var b=function e(t){var n=r,i=t&&"object"==Oa(t)&&"String"!=v(t);i&&(n=t,t=null);var a=n.navigator||{},o=a.userAgent||"";t||(t=o);var s,c,l=i?!!a.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(f.toString()),d="Object",b=i?d:"ScriptBridgingProxyObject",k=i?d:"Environment",w=i&&n.java?"JavaPackage":v(n.java),x=i?d:"RuntimeObject",_=/\bJava/.test(w)&&n.java,S=_&&v(n.environment)==k,E=_?"a":"α",T=_?"b":"β",R=n.document||{},I=n.operamini||n.opera,C=u.test(C=i&&I?I["[[Class]]"]:v(I))?C:I=null,O=t,P=[],A=null,j=t==o,M=j&&I&&"function"==typeof I.version&&I.version(),L=m([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],(function(e,n){return e||RegExp("\\b"+(n.pattern||y(n))+"\\b","i").exec(t)&&(n.label||n)})),N=function(e){return m(e,(function(e,n){return e||RegExp("\\b"+(n.pattern||y(n))+"\\b","i").exec(t)&&(n.label||n)}))}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),U=B([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),F=function(e){return m(e,(function(e,n,r){return e||(n[U]||n[/^[a-z]+(?: +[a-z]+\b)*/i.exec(U)]||RegExp("\\b"+y(r)+"(?:\\b|\\w*\\d)","i").exec(t))&&r}))}({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}}),D=function(e){return m(e,(function(e,n){var r=n.pattern||y(n);return!e&&(e=RegExp("\\b"+r+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(e=function(e,t,n){var r={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return t&&n&&/^Win/i.test(e)&&!/^Windows Phone /i.test(e)&&(r=r[/[\d.]+$/.exec(e)])&&(e="Windows "+r),e=String(e),t&&n&&(e=e.replace(RegExp(t,"i"),n)),p(e.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}(e,r,n.label||n)),e}))}(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function B(e){return m(e,(function(e,n){var r=n.pattern||y(n);return!e&&(e=RegExp("\\b"+r+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+r+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+r+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(n.label&&!RegExp(r,"i").test(n.label)?n.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),n=n.label||n,e=p(e[0].replace(RegExp(r,"i"),n).replace(RegExp("; *(?:"+n+"[_-])?","i")," ").replace(RegExp("("+n+")[-_.]?(\\w)","i"),"$1 $2"))),e}))}function q(e){return m(e,(function(e,n){return e||(RegExp(n+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null}))}if(L&&(L=[L]),/\bAndroid\b/.test(D)&&!U&&(s=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(t))&&(U=g(s[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),F&&!U?U=B([F]):F&&U&&(U=U.replace(RegExp("^("+y(F)+")[-_.\\s]","i"),F+" ").replace(RegExp("^("+y(F)+")[-_.]?(\\w)","i"),F+" $2")),(s=/\bGoogle TV\b/.exec(U))&&(U=s[0]),/\bSimulator\b/i.test(t)&&(U=(U?U+" ":"")+"Simulator"),"Opera Mini"==N&&/\bOPiOS\b/.test(t)&&P.push("running in Turbo/Uncompressed mode"),"IE"==N&&/\blike iPhone OS\b/.test(t)?(F=(s=e(t.replace(/like iPhone OS/,""))).manufacturer,U=s.product):/^iP/.test(U)?(N||(N="Safari"),D="iOS"+((s=/ OS ([\d_]+)/i.exec(t))?" "+s[1].replace(/_/g,"."):"")):"Konqueror"==N&&/^Linux\b/i.test(D)?D="Kubuntu":F&&"Google"!=F&&(/Chrome/.test(N)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(U))||/\bAndroid\b/.test(D)&&/^Chrome/.test(N)&&/\bVersion\//i.test(t)?(N="Android Browser",D=/\bAndroid\b/.test(D)?D:"Android"):"Silk"==N?(/\bMobi/i.test(t)||(D="Android",P.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&P.unshift("accelerated")):"UC Browser"==N&&/\bUCWEB\b/.test(t)?P.push("speed mode"):"PaleMoon"==N&&(s=/\bFirefox\/([\d.]+)\b/.exec(t))?P.push("identifying as Firefox "+s[1]):"Firefox"==N&&(s=/\b(Mobile|Tablet|TV)\b/i.exec(t))?(D||(D="Firefox OS"),U||(U=s[1])):!N||(s=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(N))?(N&&!U&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(s+"/")+8))&&(N=null),(s=U||F||D)&&(U||F||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(D))&&(N=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(D)?D:s)+" Browser")):"Electron"==N&&(s=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&P.push("Chromium "+s),M||(M=q(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",y(N),"(?:Firefox|Minefield|NetFront)"])),(s=("iCab"==L&&parseFloat(M)>3?"WebKit":/\bOpera\b/.test(N)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test(L)&&"WebKit"||!L&&/\bMSIE\b/i.test(t)&&("Mac OS"==D?"Tasman":"Trident")||"WebKit"==L&&/\bPlayStation\b(?! Vita\b)/i.test(N)&&"NetFront")&&(L=[s]),"IE"==N&&(s=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(N+=" Mobile",D="Windows Phone "+(/\+$/.test(s)?s:s+".x"),P.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(N="IE Mobile",D="Windows Phone 8.x",P.unshift("desktop mode"),M||(M=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=N&&"Trident"==L&&(s=/\brv:([\d.]+)/.exec(t))&&(N&&P.push("identifying as "+N+(M?" "+M:"")),N="IE",M=s[1]),j){if(function(e,t){var n=null!=e?Oa(e[t]):"number";return!(/^(?:boolean|number|string|undefined)$/.test(n)||"object"==n&&!e[t])}(n,"global"))if(_&&(O=(s=_.lang.System).getProperty("os.arch"),D=D||s.getProperty("os.name")+" "+s.getProperty("os.version")),S){try{M=n.require("ringo/engine").version.join("."),N="RingoJS"}catch(e){(s=n.system)&&s.global.system==n.system&&(N="Narwhal",D||(D=s[0].os||null))}N||(N="Rhino")}else"object"==Oa(n.process)&&!n.process.browser&&(s=n.process)&&("object"==Oa(s.versions)&&("string"==typeof s.versions.electron?(P.push("Node "+s.versions.node),N="Electron",M=s.versions.electron):"string"==typeof s.versions.nw&&(P.push("Chromium "+M,"Node "+s.versions.node),N="NW.js",M=s.versions.nw)),N||(N="Node.js",O=s.arch,D=s.platform,M=(M=/[\d.]+/.exec(s.version))?M[0]:null));else v(s=n.runtime)==b?(N="Adobe AIR",D=s.flash.system.Capabilities.os):v(s=n.phantom)==x?(N="PhantomJS",M=(s=s.version||null)&&s.major+"."+s.minor+"."+s.patch):"number"==typeof R.documentMode&&(s=/\bTrident\/(\d+)/i.exec(t))?(M=[M,R.documentMode],(s=+s[1]+4)!=M[1]&&(P.push("IE "+M[1]+" mode"),L&&(L[1]=""),M[1]=s),M="IE"==N?String(M[1].toFixed(1)):M[0]):"number"==typeof R.documentMode&&/^(?:Chrome|Firefox)\b/.test(N)&&(P.push("masking as "+N+" "+M),N="IE",M="11.0",L=["Trident"],D="Windows");D=D&&p(D)}if(M&&(s=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(M)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(j&&a.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(A=/b/i.test(s)?"beta":"alpha",M=M.replace(RegExp(s+"\\+?$"),"")+("beta"==A?T:E)+(/\d+\+?/.exec(s)||"")),"Fennec"==N||"Firefox"==N&&/\b(?:Android|Firefox OS|KaiOS)\b/.test(D))N="Firefox Mobile";else if("Maxthon"==N&&M)M=M.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(U))"Xbox 360"==U&&(D=null),"Xbox 360"==U&&/\bIEMobile\b/.test(t)&&P.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(N)&&(!N||U||/Browser|Mobi/.test(N))||"Windows CE"!=D&&!/Mobi/i.test(t))if("IE"==N&&j)try{null===n.external&&P.unshift("platform preview")}catch(e){P.unshift("embedded")}else(/\bBlackBerry\b/.test(U)||/\bBB10\b/.test(t))&&(s=(RegExp(U.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||M)?(D=((s=[s,/BB10/.test(t)])[1]?(U=null,F="BlackBerry"):"Device Software")+" "+s[0],M=null):this!=h&&"Wii"!=U&&(j&&I||/Opera/.test(N)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==N&&/\bOS X (?:\d+\.){2,}/.test(D)||"IE"==N&&(D&&!/^Win/.test(D)&&M>5.5||/\bWindows XP\b/.test(D)&&M>8||8==M&&!/\bTrident\b/.test(t)))&&!u.test(s=e.call(h,t.replace(u,"")+";"))&&s.name&&(s="ing as "+s.name+((s=s.version)?" "+s:""),u.test(N)?(/\bIE\b/.test(s)&&"Mac OS"==D&&(D=null),s="identify"+s):(s="mask"+s,N=C?p(C.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(s)&&(D=null),j||(M=null)),L=["Presto"],P.push(s));else N+=" Mobile";(s=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(s=[parseFloat(s.replace(/\.(\d)$/,".0$1")),s],"Safari"==N&&"+"==s[1].slice(-1)?(N="WebKit Nightly",A="alpha",M=s[1].slice(0,-1)):M!=s[1]&&M!=(s[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(M=null),s[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(t)||0)[1],537.36==s[0]&&537.36==s[2]&&parseFloat(s[1])>=28&&"WebKit"==L&&(L=["Blink"]),j&&(l||s[1])?(L&&(L[1]="like Chrome"),s=s[1]||((s=s[0])<530?1:s<532?2:s<532.05?3:s<533?4:s<534.03?5:s<534.07?6:s<534.1?7:s<534.13?8:s<534.16?9:s<534.24?10:s<534.3?11:s<535.01?12:s<535.02?"13+":s<535.07?15:s<535.11?16:s<535.19?17:s<536.05?18:s<536.1?19:s<537.01?20:s<537.11?"21+":s<537.13?23:s<537.18?24:s<537.24?25:s<537.36?26:"Blink"!=L?"27":"28")):(L&&(L[1]="like Safari"),s=(s=s[0])<400?1:s<500?2:s<526?3:s<533?4:s<534?"4+":s<535?5:s<537?6:s<538?7:s<601?8:s<602?9:s<604?10:s<606?11:s<608?12:"12"),L&&(L[1]+=" "+(s+="number"==typeof s?".x":/[.+]/.test(s)?"":"+")),"Safari"==N&&(!M||parseInt(M)>45)?M=s:"Chrome"==N&&/\bHeadlessChrome/i.test(t)&&P.unshift("headless")),"Opera"==N&&(s=/\bzbov|zvav$/.exec(D))?(N+=" ",P.unshift("desktop mode"),"zvav"==s?(N+="Mini",M=null):N+="Mobile",D=D.replace(RegExp(" *"+s+"$"),"")):"Safari"==N&&/\bChrome\b/.exec(L&&L[1])?(P.unshift("desktop mode"),N="Chrome Mobile",M=null,/\bOS X\b/.test(D)?(F="Apple",D="iOS 4.3+"):D=null):/\bSRWare Iron\b/.test(N)&&!M&&(M=q("Chrome")),M&&0==M.indexOf(s=/[\d.]+$/.exec(D))&&t.indexOf("/"+s+"-")>-1&&(D=g(D.replace(s,""))),D&&-1!=D.indexOf(N)&&!RegExp(N+" OS").test(D)&&(D=D.replace(RegExp(" *"+y(N)+" *"),"")),L&&!/\b(?:Avant|Nook)\b/.test(N)&&(/Browser|Lunascape|Maxthon/.test(N)||"Safari"!=N&&/^iOS/.test(D)&&/\bSafari\b/.test(L[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(N)&&L[1])&&(s=L[L.length-1])&&P.push(s),P.length&&(P=["("+P.join("; ")+")"]),F&&U&&U.indexOf(F)<0&&P.push("on "+F),U&&P.push((/^on /.test(P[P.length-1])?"":"on ")+U),D&&(s=/ ([\d.+]+)$/.exec(D),c=s&&"/"==D.charAt(D.length-s[0].length-1),D={architecture:32,family:s&&!c?D.replace(s[0],""):D,version:s?s[1]:null,toString:function(){var e=this.version;return this.family+(e&&!c?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(s=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(O))&&!/\bi686\b/i.test(O)?(D&&(D.architecture=64,D.family=D.family.replace(RegExp(" *"+s),"")),N&&(/\bWOW64\b/i.test(t)||j&&/\w(?:86|32)$/.test(a.cpuClass||a.platform)&&!/\bWin64; x64\b/i.test(t))&&P.unshift("32-bit")):D&&/^OS X/.test(D.family)&&"Chrome"==N&&parseFloat(M)>=39&&(D.architecture=64),t||(t=null);var z={};return z.description=t,z.layout=L&&L[0],z.manufacturer=F,z.name=N,z.prerelease=A,z.product=U,z.ua=t,z.version=N&&M,z.os=D||{architecture:null,family:null,version:null,toString:function(){return"null"}},z.parse=e,z.toString=function(){return this.description||""},z.version&&P.unshift(M),z.name&&P.unshift(N),D&&N&&(D!=String(D).split(" ")[0]||D!=N.split(" ")[0]&&!U)&&P.push(U?"("+D+")":"on "+D),P.length&&(z.description=P.join(" ")),z}();i&&a?h(b,(function(e,t){i[t]=e})):r.platform=b}).call(t)}(oE,oE.exports);var sE=Fe,uE=Ut,cE=Sr,lE=k,fE=Np,dE=Gp;Mp("match",(function(e,t,n){return[function(t){var n=lE(this),r=null==t?void 0:t[e];return void 0!==r?r.call(t,n):new RegExp(t)[e](cE(n))},function(e){var r=sE(this),i=cE(e),a=n(t,r,i);if(a.done)return a.value;if(!r.global)return dE(r,i);var o=r.unicode;r.lastIndex=0;for(var s,u=[],c=0;null!==(s=dE(r,i));){var l=cE(s[0]);u[c]=l,""===l&&(r.lastIndex=fE(i,uE(r.lastIndex),o)),c++}return 0===c?null:u}]}));var pE=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t},hE=Fe,vE=k,yE=pE,mE=Sr,gE=Gp;Mp("search",(function(e,t,n){return[function(t){var n=vE(this),r=null==t?void 0:t[e];return void 0!==r?r.call(t,n):new RegExp(t)[e](mE(n))},function(e){var r=hE(this),i=mE(e),a=n(t,r,i);if(a.done)return a.value;var o=r.lastIndex;yE(o,0)||(r.lastIndex=0);var s=gE(r,i);return yE(r.lastIndex,o)||(r.lastIndex=o),null===s?-1:s.index}]}));var bE=Rn,kE=qt,wE=Mt,xE=Ut,_E=Q,SE=Wr,EE=ka,TE=ca("splice"),RE=Math.max,IE=Math.min,CE=9007199254740991,OE="Maximum allowed length exceeded";bE({target:"Array",proto:!0,forced:!TE},{splice:function(e,t){var n,r,i,a,o,s,u=_E(this),c=xE(u.length),l=kE(e,c),f=arguments.length;if(0===f?n=r=0:1===f?(n=0,r=c-l):(n=f-2,r=IE(RE(wE(t),0),c-l)),c+n-r>CE)throw TypeError(OE);for(i=SE(u,r),a=0;a<r;a++)(o=l+a)in u&&EE(i,a,u[o]);if(i.length=r,n<r){for(a=l;a<c-r;a++)s=a+n,(o=a+r)in u?u[s]=u[o]:delete u[s];for(a=c;a>c-r+n;a--)delete u[a-1]}else if(n>r)for(a=c-r;a>l;a--)s=a+n-1,(o=a+r-1)in u?u[s]=u[o]:delete u[s];for(a=0;a<n;a++)u[a+l]=arguments[a+2];return u.length=c-r+n,i}}),function(e){var t=void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};Object.defineProperty(e,"__esModule",{value:!0});var n=zg.exports,r=fv.exports,i=yv.exports,a=Ey.exports,o=pv.exports,s=vv.exports,u=mv.exports,c=dv.exports,l=Ry.exports,f=Wg,d=Kh.exports,p=mh,h=_f.exports,v=eb.exports,y=Sb,m=nE.exports,g=ng,b=oE.exports;function k(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}function w(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var x=k(n),_=k(r),S=k(i),E=k(a),T=k(o),R=k(s),I=k(u),C=k(c),O=k(l),P=k(f),A=k(d),j=w(h),M=w(v),L=k(m),N=w(b);function U(){}function F(){F.init.call(this)}function D(e){return void 0===e._maxListeners?F.defaultMaxListeners:e._maxListeners}function B(e,t,n){if(t)e.call(n);else for(var r=e.length,i=K(e,r),a=0;a<r;++a)i[a].call(n)}function q(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=K(e,i),o=0;o<i;++o)a[o].call(n,r)}function z(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=K(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function W(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=K(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function G(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=K(e,i),o=0;o<i;++o)a[o].apply(n,r)}function $(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new U,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=D(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function V(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function J(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function K(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}U.prototype=Object.create(null),F.EventEmitter=F,F.usingDomains=!1,F.prototype.domain=void 0,F.prototype._events=void 0,F.prototype._maxListeners=void 0,F.defaultMaxListeners=10,F.init=function(){this.domain=null,F.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new U,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},F.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},F.prototype.getMaxListeners=function(){return D(this)},F.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:B(n,l,this);break;case 2:q(n,l,this,arguments[1]);break;case 3:z(n,l,this,arguments[1],arguments[2]);break;case 4:W(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];G(n,l,this,i)}return!0},F.prototype.addListener=function(e,t){return $(this,e,t,!1)},F.prototype.on=F.prototype.addListener,F.prototype.prependListener=function(e,t){return $(this,e,t,!0)},F.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,V(this,e,t)),this},F.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,V(this,e,t)),this},F.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new U:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new U,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},F.prototype.off=function(e,t){return this.removeListener(e,t)},F.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new U,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new U:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new U,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},F.prototype.listeners=function(e){var t,n,r=this._events;return n=r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[],n},F.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):J.call(e,t)},F.prototype.listenerCount=J,F.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var H=j.getLogger("twilsock");function Y(e,t){return["".concat((new Date).toISOString()," Twilsock ").concat(e,":")].concat(Array.from(t))}var Q=function(){function e(t){C.default(this,e),O.default(this,"prefix",""),this.prefix=null!=t&&t.length>0?" "+t+":":""}return _.default(e,[{key:"setLevel",value:function(e){H.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.trace.apply(null,Y("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.debug.apply(null,Y("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.info.apply(null,Y("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.warn.apply(null,Y("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.error.apply(null,Y("E",t))}}],[{key:"setLevel",value:function(e){H.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.trace.apply(null,Y("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.debug.apply(null,Y("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.info.apply(null,Y("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.warn.apply(null,Y("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];H.error.apply(null,Y("E",t))}}]),e}(),X=new Q(""),Z="0.12.2",ee=function(){function e(t,n,r){C.default(this,e),O.default(this,"confirmedCapabilities",new Set),this.activeGrant=n,this._token=t;var i=r.region||"us1",a="wss://tsock.".concat(i,".twilio.com/v3/wsconnect"),o=r.twilsock||r.Twilsock||{};this.url=o.uri||a,this._continuationToken=r.continuationToken?r.continuationToken:null,this.logLevel=r.logLevel?r.logLevel:"error",this.retryPolicy=r.retryPolicy?r.retryPolicy:{min:1e3,max:12e4,randomness:.2},this.clientMetadata=r.clientMetadata?r.clientMetadata:{},this.clientMetadata.ver=Z,this.initRegistrations=r.initRegistrations?r.initRegistrations:null,this.tweaks=r.tweaks?r.tweaks:null}return _.default(e,[{key:"token",get:function(){return this._token}},{key:"continuationToken",get:function(){return this._continuationToken}},{key:"updateToken",value:function(e){this._token=e}},{key:"updateContinuationToken",value:function(e){this._continuationToken=e}}]),e}(),te=function e(t){C.default(this,e),this.id=t||"TM".concat(y.v4())};function ne(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var re=function(e){T.default(n,e);var t=ne(n);function n(e,r,i,a,o){var s;return C.default(this,n),s=t.call(this),O.default(S.default(s),"method","init"),s.token=e,s.continuation_token=r,s.metadata=i,s.registrations=a,s.tweaks=o,s.capabilities=["client_update","offline_storage","telemetry.v1"],s}return n}(te);function ie(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var ae=function(e){T.default(n,e);var t=ie(n);function n(e,r,i,a,o,s,u){var c;return C.default(this,n),(c=t.call(this,e)).continuationToken=r,c.continuationTokenStatus=a,c.offlineStorage=o,c.initRegistrations=s,c.debugInfo=u,c.confirmedCapabilities=i,c}return n}(te);function oe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var se=function(e){T.default(n,e);var t=oe(n);function n(e){var r;return C.default(this,n),r=t.call(this),O.default(S.default(r),"method","update"),r.token=e,r}return n}(te);function ue(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Message=function(e){T.default(Message,e);var t=ue(Message);function Message(e,n,r){var i;return C.default(this,Message),i=t.call(this),O.default(S.default(i),"method","message"),i.active_grant=e,i.payload_type=n,i.http_request=r,i}return Message}(te);function ce(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var le=function(e){T.default(n,e);var t=ce(n);function n(e){var r;return C.default(this,n),r=t.call(this,e),O.default(S.default(r),"method","reply"),O.default(S.default(r),"payload_type","application/json"),O.default(S.default(r),"status",{code:200,status:"OK"}),r}return n}(te);function fe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var de=function(e){T.default(n,e);var t=fe(n);function n(){var e;return C.default(this,n),e=t.call(this),O.default(S.default(e),"method","close"),e}return n}(te);function pe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var he=function e(t,n,r,i,a,o){C.default(this,e),this.start=t,this.end=n,this.title=r,this.details=i,this.id=a,this.type=o},ve=function(e){T.default(n,e);var t=pe(n);function n(e){var r;return C.default(this,n),r=t.call(this),O.default(S.default(r),"method","telemetry.v1"),r.events=e,r}return n}(te);function ye(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(Number("0x"+t))})).length}function me(e){var t=encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode(Number("0x"+t))})),n=new Uint8Array(t.length);return Array.prototype.forEach.call(t,(function(e,t){n[t]=e.charCodeAt(0)})),n}function ge(e){var t=Array.prototype.map.call(e,(function(e){return String.fromCharCode(e)})).join("").replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}));return decodeURIComponent(t)}function be(e){return JSON.parse(ge(e))}var ke=function(){function e(){C.default(this,e)}return _.default(e,null,[{key:"parse",value:function(e){var t,n,r=new Uint8Array(e),i=function(e){for(var t="",n=0;n<e.length;++n){var r=String.fromCharCode(e[n]);if(t+=r,"\r"===r){n+=2;break}}var i=t.split(" ");return{size:n,protocol:i[0],version:i[1],headerSize:Number(i[2])}}(r);if("TWILSOCK"!==i.protocol||"V3.0"!==i.version)return X.error("unsupported protocol: ".concat(i.protocol," ver ").concat(i.version)),null;try{t=be(r.subarray(i.size,i.size+i.headerSize))}catch(t){return X.error("failed to parse message header",t,e),null}if(X.debug("message received: ",t.method),X.trace("message received: ",t),t.payload_size>0){var a=2+i.size+i.headerSize,o=t.payload_size;if(t.hasOwnProperty("payload_type")&&0!==t.payload_type.indexOf("application/json"))0===t.payload_type.indexOf("text/plain")&&(n=ge(r.subarray(a,a+o)));else try{n=be(r.subarray(a,a+o))}catch(t){return X.error("failed to parse message body",t,e),null}}return{method:t.method,header:t,payload:n}}},{key:"createPacket",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e.payload_size=ye(t);var n=JSON.stringify(e),r="TWILSOCK V3.0 "+ye(n);X.debug("send request:",r+n+t);var i=me(r+"\r\n"+n+"\r\n"+t);return i.buffer}}]),e}();function we(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var xe=function(e){T.default(n,e);var t=we(n);function n(e){return C.default(this,n),t.call(this,e)}return n}(L.default(Error));function _e(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Se=function(e){T.default(n,e);var t=_e(n);function n(e,r){var i;return C.default(this,n),(i=t.call(this,e)).reply=r,i}return n}(xe);function Ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Te(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(n),!0).forEach((function(t){O.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Re(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Ie=function(e){T.default(n,e);var t=Re(n);function n(e){var r;return C.default(this,n),r=t.call(this),O.default(S.default(r),"newBackoff",null),O.default(S.default(r),"usedBackoff",null),O.default(S.default(r),"retrier",null),r.options=e?Te({},e):{},r}return _.default(n,[{key:"inProgress",get:function(){return!!this.retrier}},{key:"start",value:function(){if(this.inProgress)throw new Error("Already waiting for next attempt, call finishAttempt(success : boolean) to finish it");this.createRetrier()}},{key:"stop",value:function(){this.cleanRetrier(),this.newBackoff=null,this.usedBackoff=null}},{key:"modifyBackoff",value:function(e){this.newBackoff=e}},{key:"attemptFailed",value:function(){if(!this.inProgress)throw new Error("No attempt is in progress");var e,t;this.newBackoff?!this.usedBackoff||this.usedBackoff<this.newBackoff?this.createRetrier():null===(e=this.retrier)||void 0===e||e.failed(new Error):null===(t=this.retrier)||void 0===t||t.failed(new Error)}},{key:"cancel",value:function(){var e;null===(e=this.retrier)||void 0===e||e.cancel()}},{key:"cleanRetrier",value:function(){var e,t;null===(e=this.retrier)||void 0===e||e.removeAllListeners(),null===(t=this.retrier)||void 0===t||t.cancel(),this.retrier=null}},{key:"getRetryPolicy",value:function(){var e=Te({},this.options);return this.newBackoff&&(e.min=this.newBackoff,e.max=this.options.max&&this.options.max>this.newBackoff?this.options.max:this.newBackoff),e.maxAttemptsCount=this.options.maxAttemptsCount?this.options.maxAttemptsCount+1:void 0,e}},{key:"createRetrier",value:function(){var e=this;this.cleanRetrier();var t=this.getRetryPolicy();this.retrier=new g.Retrier(t),this.retrier.once("attempt",(function(){var t,n;null===(t=e.retrier)||void 0===t||t.on("attempt",(function(){return e.emit("attempt")})),null===(n=e.retrier)||void 0===n||n.failed(new Error("Skipping first attempt"))})),this.retrier.on("failed",(function(t){return e.emit("failed",t)})),this.usedBackoff=this.newBackoff,this.newBackoff=null,this.retrier.start()}}]),n}(F);function Ce(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Oe=function(e){T.default(i,e);var t,n,r=Ce(i);function i(e,t,n){var a;C.default(this,i),a=r.call(this),O.default(S.default(a),"disconnectingTimer",null),O.default(S.default(a),"disconnectedPromiseResolve",null),O.default(S.default(a),"terminalStates",["disconnected","rejected"]),O.default(S.default(a),"tokenExpiredSasCode",20104),O.default(S.default(a),"terminationReason","Connection is not initialized"),a.websocket=e,a.websocket.on("connected",(function(){return a.fsm.socketConnected()})),a.websocket.on("disconnected",(function(){return a.fsm.socketClosed()})),a.websocket.on("message",(function(e){return a.onIncomingMessage(e)})),a.websocket.on("socketError",(function(e){return a.emit("connectionError",{terminal:!1,message:"Socket error: ".concat(e.message),httpStatusCode:null,errorCode:null})})),a.transport=t,a.config=n,a.retrier=new Ie(n.retryPolicy),a.retrier.on("attempt",(function(){return a.retry()})),a.retrier.on("failed",(function(e){X.warn("Retrying failed: ".concat(e.message)),a.disconnect()})),"undefined"!=typeof window&&void 0!==window.addEventListener&&(window.addEventListener("online",(function(){X.debug("Browser reported connectivity state: online"),a.resetBackoff(),a.fsm.systemOnline()})),window.addEventListener("offline",(function(){X.debug("Browser reported connectivity state: offline"),a.websocket.close(),a.fsm.socketClosed()})));var o=M.factory({init:"disconnected",transitions:[{name:"userConnect",from:["disconnected","rejected"],to:"connecting"},{name:"userConnect",from:["connecting","connected"]},{name:"userDisconnect",from:["connecting","initialising","connected","updating","retrying","rejected","waitSocketClosed","waitOffloadSocketClosed"],to:"disconnecting"},{name:"userRetry",from:["retrying"],to:"connecting"},{name:"socketConnected",from:["connecting"],to:"initialising"},{name:"socketClosed",from:["connecting","initialising","connected","updating","error","waitOffloadSocketClosed"],to:"retrying"},{name:"socketClosed",from:["disconnecting"],to:"disconnected"},{name:"socketClosed",from:["waitSocketClosed"],to:"disconnected"},{name:"socketClosed",from:["rejected"],to:"rejected"},{name:"initSuccess",from:["initialising"],to:"connected"},{name:"initError",from:["initialising"],to:"error"},{name:"tokenRejected",from:["initialising","updating"],to:"rejected"},{name:"protocolError",from:["initialising","connected","updating"],to:"error"},{name:"receiveClose",from:["initialising","connected","updating"],to:"waitSocketClosed"},{name:"receiveOffload",from:["initialising","connected","updating"],to:"waitOffloadSocketClosed"},{name:"unsupportedProtocol",from:["initialising","connected","updating"],to:"unsupported"},{name:"receiveFatalClose",from:["initialising","connected","updating"],to:"unsupported"},{name:"userUpdateToken",from:["disconnected","rejected","connecting","retrying"],to:"connecting"},{name:"userUpdateToken",from:["connected"],to:"updating"},{name:"updateSuccess",from:["updating"],to:"connected"},{name:"updateError",from:["updating"],to:"error"},{name:"userSend",from:["connected"],to:"connected"},{name:"systemOnline",from:["retrying"],to:"connecting"}],methods:{onConnecting:function(){a.setupSocket(),a.emit("connecting")},onEnterInitialising:function(){a.sendInit()},onLeaveInitialising:function(){a.cancelInit()},onEnterUpdating:function(){a.sendUpdate()},onLeaveUpdating:function(){a.cancelUpdate()},onEnterRetrying:function(){a.initRetry(),a.emit("connecting")},onEnterConnected:function(){a.resetBackoff(),a.onConnected()},onUserUpdateToken:function(){a.resetBackoff()},onTokenRejected:function(){a.resetBackoff(),a.closeSocket(!0),a.finalizeSocket()},onUserDisconnect:function(){a.closeSocket(!0)},onEnterDisconnecting:function(){a.startDisconnectTimer()},onLeaveDisconnecting:function(){a.cancelDisconnectTimer()},onEnterWaitSocketClosed:function(){a.startDisconnectTimer()},onLeaveWaitSocketClosed:function(){a.cancelDisconnectTimer()},onEnterWaitOffloadSocketClosed:function(){a.startDisconnectTimer()},onLeaveWaitOffloadSocketClosed:function(){a.cancelDisconnectTimer()},onDisconnected:function(){a.resetBackoff(),a.finalizeSocket()},onReceiveClose:function(){a.onCloseReceived()},onReceiveOffload:function(e,t){X.debug("onreceiveoffload: ",t),a.modifyBackoff(t.body),a.onCloseReceived()},onUnsupported:function(){a.closeSocket(!0),a.finalizeSocket()},onError:function(e,t){a.closeSocket(t),a.finalizeSocket()},onEnterState:function(e){"none"!==e.from&&a.changeState(e)},onInvalidTransition:function(e,t,n){X.warn("FSM: unexpected transition",t,n)}}});return a.fsm=new o,a}return _.default(i,[{key:"changeState",value:function(e){X.debug("FSM: ".concat(e.transition,": ").concat(e.from," --\x3e ").concat(e.to)),this.lastEmittedState!==this.state&&(this.lastEmittedState=this.state,this.emit("stateChanged",this.state))}},{key:"resetBackoff",value:function(){X.trace("resetBackoff"),this.retrier.stop()}},{key:"modifyBackoff",value:function(e){X.trace("modifyBackoff",e);var t=e?e.backoff_policy:null;t&&"number"==typeof t.reconnect_min_ms&&this.retrier.modifyBackoff(t.reconnect_min_ms)}},{key:"startDisconnectTimer",value:function(){var e=this;X.trace("startDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null),this.disconnectingTimer=setTimeout((function(){X.debug("disconnecting is timed out"),e.closeSocket(!0)}),3e3)}},{key:"cancelDisconnectTimer",value:function(){X.trace("cancelDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null)}},{key:"isConnected",get:function(){return"connected"===this.state&&this.websocket.isConnected}},{key:"state",get:function(){switch(this.fsm.state){case"connecting":case"initialising":case"retrying":case"error":return"connecting";case"updating":case"connected":return"connected";case"rejected":return"denied";case"disconnecting":case"waitSocketClosed":case"waitOffloadSocketClosed":return"disconnecting";default:return"disconnected"}}},{key:"initRetry",value:function(){X.debug("initRetry"),this.retrier.inProgress?this.retrier.attemptFailed():this.retrier.start()}},{key:"retry",value:function(){"connecting"!=this.fsm.state?(X.trace("retry"),this.websocket.close(),this.fsm.userRetry()):X.trace("can\t retry as already connecting")}},{key:"onConnected",value:function(){this.emit("connected")}},{key:"finalizeSocket",value:function(){X.trace("finalizeSocket"),this.websocket.close(),this.emit("disconnected"),this.disconnectedPromiseResolve&&(this.disconnectedPromiseResolve(),this.disconnectedPromiseResolve=null)}},{key:"setupSocket",value:function(){X.trace("setupSocket:",this.config.token),this.emit("beforeConnect"),this.websocket.connect()}},{key:"onIncomingMessage",value:function(e){var t=ke.parse(e);if(t){var n=t.method,r=t.header,i=t.payload;if("reply"!==n&&this.confirmReceiving(r),"notification"===n)this.emit("message",r.message_type,i);else if("reply"===r.method)this.transport.processReply({id:r.id,status:r.status,header:r,body:i});else if("client_update"===r.method)"token_about_to_expire"===r.client_update_type&&this.emit("tokenAboutToExpire");else if("close"===r.method)if(308===r.status.code)X.debug("Connection has been offloaded"),this.fsm.receiveOffload({status:r.status.status,body:i});else if(406===r.status.code){var a="Server closed connection because can't parse protocol: ".concat(JSON.stringify(r.status));this.emitReplyConnectionError(a,r,!0),X.error(a),this.fsm.receiveFatalClose()}else 417===r.status.code?(X.error("Server closed connection because can't parse client reply: ".concat(JSON.stringify(r.status))),this.fsm.receiveFatalClose(r.status.status)):410===r.status.code?(X.warn("Server closed connection: ".concat(JSON.stringify(r.status))),this.fsm.receiveClose(r.status.status),this.emit("tokenExpired")):401===r.status.code?(X.error("Server closed connection: ".concat(JSON.stringify(r.status))),this.fsm.receiveClose(r.status.status)):(X.warn("unexpected message: ",r.status),this.fsm.receiveOffload({status:r.status.status,body:null}))}}},{key:"sendInit",value:(n=x.default(P.default.mark((function e(){var t,n;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return X.trace("sendInit"),e.prev=1,this.emit("beforeSendInit"),e.next=5,this.transport.sendInit();case 5:t=e.sent,this.config.updateContinuationToken(t.continuationToken),this.config.confirmedCapabilities=t.confirmedCapabilities,this.fsm.initSuccess(t),this.emit("initialized",t),this.emit("tokenUpdated"),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(1),e.t0 instanceof Se?(n=!1,X.warn("Init rejected by server: ".concat(JSON.stringify(e.t0.reply.status))),this.emit("sendInitFailed"),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(n=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.initError(!0)):500===e.t0.reply.status.code?this.fsm.initError(!1):this.fsm.initError(!0),this.emitReplyConnectionError(e.t0.message,e.t0.reply,n)):(this.terminationReason=e.t0.message,this.emit("connectionError",{terminal:!0,message:"Unknown error during connection initialisation: ".concat(e.t0.message,"\n").concat(JSON.stringify(e.t0,null,2)),httpStatusCode:null,errorCode:null}),this.fsm.initError(!0)),this.emit("tokenUpdated",e.t0);case 17:case"end":return e.stop()}}),e,this,[[1,13]])}))),function(){return n.apply(this,arguments)})},{key:"sendUpdate",value:(t=x.default(P.default.mark((function e(){var t,n,r;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return X.trace("sendUpdate"),t=new se(this.config.token),e.prev=2,e.next=5,this.transport.sendWithReply(t);case 5:n=e.sent,this.fsm.updateSuccess(n.body),this.emit("tokenUpdated"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),e.t0 instanceof Se?(r=!1,X.warn("Token update rejected by server: ".concat(JSON.stringify(e.t0.reply.status))),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(r=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.updateError(e.t0.reply.status)):this.fsm.updateError(e.t0.reply.status),this.emitReplyConnectionError(e.t0.message,e.t0.reply,r)):(this.emit("error",!1,e.t0.message,null,null),this.fsm.updateError(e.t0)),this.emit("tokenUpdated",e.t0);case 14:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(){return t.apply(this,arguments)})},{key:"emitReplyConnectionError",value:function(e,t,n){var r=t.status&&t.status.description?t.status.description:e,i=t.status.code,a=t.status&&t.status.errorCode?t.status.errorCode:null;n&&(this.terminationReason=r),this.emit("connectionError",{terminal:n,message:"Connection error: ".concat(r),httpStatusCode:i,errorCode:a})}},{key:"cancelInit",value:function(){X.trace("cancelInit")}},{key:"cancelUpdate",value:function(){X.trace("cancelUpdate")}},{key:"confirmReceiving",value:function(e){X.trace("confirmReceiving");try{this.transport.send(new le(e.id))}catch(e){X.debug("failed to confirm packet receiving",e)}}},{key:"closeSocket",value:function(e){var t=this;X.trace("closeSocket (graceful: ".concat(e,")")),e&&this.transport.isConnected&&this.transport.sendClose(),this.websocket.close(),setTimeout((function(){return t.fsm.socketClosed()}),0)}},{key:"connect",value:function(){X.trace("connect"),this.fsm.userConnect()}},{key:"disconnect",value:function(){var e=this;return X.trace("disconnect"),this.fsm.is("disconnected")?Promise.resolve():new Promise((function(t){e.disconnectedPromiseResolve=t,e.fsm.userDisconnect()}))}},{key:"updateToken",value:function(e){var t=this;return X.trace("updateToken:",e),new Promise((function(e,n){t.once("tokenUpdated",(function(t){t?n(t):e()})),t.fsm.userUpdateToken()}))}},{key:"isTerminalState",get:function(){return-1!==this.terminalStates.indexOf(this.fsm.state)}},{key:"getTerminationReason",get:function(){return this.terminationReason}},{key:"onCloseReceived",value:function(){this.websocket.close()}}]),i}(F),Pe=function(){function e(){C.default(this,e)}return _.default(e,null,[{key:"getMetadata",value:function(e){var t,n,r,i,a,o,s,u,c=e&&e.clientMetadata?e.clientMetadata:{},l={env:null!==(t=N.name)&&void 0!==t?t:"unknown",envv:null!==(n=N.version)&&void 0!==n?n:"unknown",os:null!==(r=null===(i=N.os)||void 0===i?void 0:i.family)&&void 0!==r?r:"unknown",osv:null!==(a=null===(o=N.os)||void 0===o?void 0:o.version)&&void 0!==a?a:"unknown",osa:null!==(s=null===(u=N.os)||void 0===u?void 0:u.architecture)&&void 0!==s?s:"unknown",sdk:"js-default"},f={};return["ver","env","envv","os","osv","osa","type","sdk","sdkv","dev","devv","devt","app","appv"].filter((function(e){return e in c||e in l})).forEach((function(e){return f[e]=e in c?c[e]:l[e]})),f}}]),e}();var Ae=function(){function e(t,n){var r=this;C.default(this,e),this.config=n,this.activeRequests=new Map,this.channel=t,this.channel.on("reply",(function(e){return r.processReply(e)})),this.channel.on("disconnected",(function(){r.activeRequests.forEach((function(e){clearTimeout(e.timeout),e.reject(new xe("disconnected"))})),r.activeRequests.clear()}))}var t;return _.default(e,[{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"processReply",value:function(e){var t,n=this.activeRequests.get(e.id);n&&(clearTimeout(n.timeout),this.activeRequests.delete(e.id),(t=e.status.code)>=200&&t<300?n.resolve(e):(n.reject(new Se("Transport failure: "+e.status.status,e)),X.trace("message rejected")))}},{key:"storeRequest",value:function(e,t,n){var r={resolve:t,reject:n,timeout:setTimeout((function(){X.trace("request",e,"is timed out"),n(new xe("Twilsock: request timeout: "+e))}),3e4)};this.activeRequests.set(e,r)}},{key:"shutdown",value:function(){this.activeRequests.forEach((function(e){clearTimeout(e.timeout),e.reject(new xe("Twilsock: request cancelled by user"))})),this.activeRequests.clear()}},{key:"sendInit",value:(t=x.default(P.default.mark((function e(){var t,n,r;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return X.trace("sendInit"),t=Pe.getMetadata(this.config),n=new re(this.config.token,this.config.continuationToken,t,this.config.initRegistrations,this.config.tweaks),e.next=5,this.sendWithReply(n);case 5:return r=e.sent,e.abrupt("return",new ae(r.id,r.header.continuation_token,new Set(r.header.capabilities),r.header.continuation_token_status,r.header.offline_storage,r.header.init_registrations,r.header.debug_info));case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"sendClose",value:function(){var e=new de;this.send(e)}},{key:"sendWithReply",value:function(e,t){var n=this;return new Promise((function(r,i){var a=n.send(e,t);n.storeRequest(a,r,i)}))}},{key:"send",value:function(e,t){e.id=e.id||"TM".concat(y.v4());var n=ke.createPacket(e,function(e){switch(A.default(e)){case"undefined":return"";case"object":return JSON.stringify(e);default:return e}}(t));try{return this.channel.send(n),e.id}catch(t){throw X.debug("failed to send ",e,t),X.trace(t.stack),t}}}]),e}();function je(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Me=function(e){T.default(r,e);var n=je(r);function r(e){var i;return C.default(this,r),i=n.call(this),O.default(S.default(i),"socket",null),i.url=e,i.url=e,i.WebSocket=t.WebSocket||t.MozWebSocket||{},i}return _.default(r,[{key:"isConnected",get:function(){return!!this.socket&&1===this.socket.readyState}},{key:"connect",value:function(){var e,t=this;X.trace("connecting to socket");try{e=new this.WebSocket(this.url)}catch(e){return X.debug("Socket error: ".concat(this.url)),void this.emit("socketError",e)}e.binaryType="arraybuffer",e.onopen=function(){X.debug("socket opened ".concat(t.url)),t.emit("connected")},e.onclose=function(e){X.debug("socket closed",e),t.emit("disconnected",e)},e.onerror=function(e){X.debug("Socket error:",e),t.emit("socketError",e)},e.onmessage=function(e){t.emit("message",e.data)},this.socket=e}},{key:"send",value:function(e){return this.socket&&this.socket.send(e)}},{key:"close",value:function(){if(X.trace("closing socket"),this.socket){this.socket.onopen=null,this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null;try{this.socket.close()}finally{}}}}]),r}(F);function Le(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Ne=function(e){T.default(u,e);var t,n,r,i,a,o,s=Le(u);function u(e){var t;return C.default(this,u),(t=s.call(this)).transport=e,t.registrations=new Map,t.registrationsInProgress=new Map,t}return _.default(u,[{key:"putNotificationContext",value:(o=x.default(P.default.mark((function e(t,n){var r;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={method:"put_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(r,n);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"deleteNotificationContext",value:(a=x.default(P.default.mark((function e(t){var n;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={method:"delete_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"updateRegistration",value:(i=x.default(P.default.mark((function e(t,n){var r,i;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return X.debug("update registration for context",t),(r=this.registrationsInProgress.get(t))||(r=new Set,this.registrationsInProgress.set(t,r)),i=y.v4(),r.add(i),e.prev=5,e.next=8,this.putNotificationContext(t,n);case 8:X.debug("registration attempt succeeded for context",n),r.delete(i),0===r.size&&(this.registrationsInProgress.delete(t),this.emit("registered",t)),e.next=19;break;case 13:e.prev=13,e.t0=e.catch(5),X.warn("registration attempt failed for context",n),X.debug(e.t0),r.delete(i),0===r.size&&(this.registrationsInProgress.delete(t),this.emit("registrationFailed",t,e.t0));case 19:case"end":return e.stop()}}),e,this,[[5,13]])}))),function(e,t){return i.apply(this,arguments)})},{key:"updateRegistrations",value:(r=x.default(P.default.mark((function e(){var t,n=this;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return X.trace("refreshing ".concat(this.registrations.size," registrations")),t=[],this.registrations.forEach((function(e,r){t.push(n.updateRegistration(r,e))})),e.next=5,Promise.all(t);case 5:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"setNotificationsContext",value:(n=x.default(P.default.mark((function e(t,n){return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&n){e.next=2;break}throw new xe("Invalid arguments provided");case 2:return this.registrations.set(t,n),e.next=5,this.updateRegistration(t,n);case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeNotificationsContext",value:(t=x.default(P.default.mark((function e(t){return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrations.has(t)){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.deleteNotificationContext(t);case 4:this.transport.isConnected&&this.registrations.delete(t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),u}(F);function Ue(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Fe=function(e){T.default(n,e);var t=Ue(n);function n(e,r,i){var a;return C.default(this,n),(a=t.call(this,r)).status=e,a.description=r,a.body=i,a}return n}(xe);function De(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Be=function(e){T.default(n,e);var t=De(n);function n(e){return C.default(this,n),t.call(this,e)}return n}(xe);function qe(e,t){var n=function(e){var t=e.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);if(t){var n={protocol:t[1],host:t[2],hostname:t[3],port:t[4],pathname:t[5],search:t[6],hash:t[7],params:{}};if(n.search.length>0){var r=n.search.substring(1);n.params=r.split("&").map((function(e){return e.split("=")})).reduce((function(e,t){return e.hasOwnProperty(t[0])?Array.isArray(e[t[0]])?e[t[0]].push(t[1]):e[t[0]]=[e[t[0]],t[1]]:e[t[0]]=t[1],e}),{})}return n}throw new xe("Incorrect URI: "+e)}(t),r={method:e,host:n.host,path:n.pathname};return n.params&&(r.params=n.params),r}function ze(e,t,n,r,i){return{to:qe(e,t),headers:n,body:r,grant:i}}var We=function(){function e(t,n,r){C.default(this,e),this.config=r,this.transport=t,this.pendingMessages=[],this.twilsock=n}var t;return _.default(e,[{key:"saveMessage",value:function(e){var t=this;return new Promise((function(n,r){var i={message:e,resolve:n,reject:r,alreadyRejected:!1,timeout:setTimeout((function(){X.debug("request is timed out"),r(new xe("request '".concat(e.to.method,"' to '").concat(e.to.host,"' timed out"))),i.alreadyRejected=!0}),2e4)};t.pendingMessages.push(i)}))}},{key:"sendPendingMessages",value:function(){for(var e=this,t=function(){var t=e.pendingMessages[0];if(!t.alreadyRejected)try{var n=t.message;e.actualSend(n).then((function(e){return t.resolve(e)})).catch((function(e){return t.reject(e)})),clearTimeout(t.timeout)}catch(e){return X.debug("Failed to send pending message",e),"break"}e.pendingMessages.splice(0,1)};this.pendingMessages.length>0;){if("break"===t())break}}},{key:"rejectPendingMessages",value:function(){var e=this;this.pendingMessages.forEach((function(t){t.reject(new Be("Unable to connect: "+e.twilsock.getTerminationReason)),t.alreadyRejected=!0,clearTimeout(t.timeout)})),this.pendingMessages.splice(0,this.pendingMessages.length)}},{key:"actualSend",value:(t=x.default(P.default.mark((function e(t){var n,r,i,a,o,s,u,c;return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.to,i=t.headers,a=t.body,o=null!==(n=t.grant)&&void 0!==n?n:this.config.activeGrant,s={host:r.host,path:r.path,method:r.method,params:r.params,headers:i},u=new Message(o,i["Content-Type"]||"application/json",s),X.trace("Sending upstream message",u),e.next=9,this.transport.sendWithReply(u,a);case 9:if(c=e.sent,X.trace("Received upstream message response",c),!((f=c)&&f.header&&f.header.http_status)||(l=c.header.http_status.code)>=200&&l<300){e.next=13;break}throw new Fe(c.header.http_status.code,c.header.http_status.status,c.body);case 13:return e.abrupt("return",{status:c.header.http_status,headers:c.header.http_headers,body:c.body});case 14:case"end":return e.stop()}var l,f}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"send",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;if(this.twilsock.isTerminalState)return Promise.reject(new Be("Unable to connect: "+this.twilsock.getTerminationReason));var a=ze(e,t,n,r,i);return this.twilsock.isConnected?this.actualSend(a):this.saveMessage(a)}}]),e}(),Ge=function(){function e(){var t=this;C.default(this,e),this._promise=new Promise((function(e,n){t._resolve=e,t._reject=n}))}return _.default(e,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),e}(),$e=function(){function e(t){C.default(this,e),this.id=t}return _.default(e,null,[{key:"create",value:function(t){if(t instanceof Object&&"storage_id"in t)return new e(t.storage_id);throw new xe('Field "storage_id" is missing')}}]),e}(),Ve=function(){function e(){return C.default(this,e),O.default(this,"initializedFlag","twilio_twilsock_token_storage"),O.default(this,"tokenStoragePrefix","twilio_continuation_token_"),e._instance||(this.initialize(),e._instance=this),e._instance}return _.default(e,[{key:"sessionStorage",value:function(){try{return t.sessionStorage}catch(e){return null}}},{key:"window",value:function(){try{return t.window}catch(e){return null}}},{key:"storeToken",value:function(e,t){this.canStore()&&this.sessionStorage.setItem(this.getKeyName(t),e)}},{key:"getStoredToken",value:function(e){return this.canStore()?this.sessionStorage.getItem(this.getKeyName(e)):null}},{key:"initialize",value:function(){var e=this;if(this.canStore()){this.sessionStorage.getItem(this.initializedFlag)&&this.clear(),this.sessionStorage.setItem(this.initializedFlag,"true");var t=this.sessionStorage.removeItem;this.window.addEventListener("unload",(function(){t(e.initializedFlag)}))}}},{key:"clear",value:function(){if(this.canStore()){for(var e=[],t=0;t<this.sessionStorage.length;t++){var n=this.sessionStorage.key(t);n&&0===n.indexOf(this.tokenStoragePrefix)&&e.push(n)}var r=this.sessionStorage.removeItem;e.forEach((function(e){return r(e)})),r(this.initializedFlag)}}},{key:"getKeyName",value:function(e){return"".concat(this.tokenStoragePrefix).concat(e)}},{key:"canStore",value:function(){return!!(this.sessionStorage&&this.sessionStorage.length&&this.window)}}]),e}();O.default(Ve,"_instance",null);var Je,Ke,He=new Ve,Ye=function(){function e(t,n,r,i,a,o){C.default(this,e),this.title=t,this.details=n,this.start=r,this.type=a,this.id=o,this.end=i}return _.default(e,[{key:"toTelemetryEvent",value:function(){var e=new Date,t=this.start,n=this.end?this.end:e;if(n<t){var r=n;n=t,t=r}var i=t.getTime()-e.getTime(),a=n.getTime()-e.getTime();return new he(i,a,this.title,this.details,this.id,this.type)}}]),e}();e.TelemetryPoint=void 0,(Je=e.TelemetryPoint||(e.TelemetryPoint={}))[Je.Start=0]="Start",Je[Je.End=1]="End",e.EventSendingLimitation=void 0,(Ke=e.EventSendingLimitation||(e.EventSendingLimitation={}))[Ke.MinEventsPortion=0]="MinEventsPortion",Ke[Ke.AnyEvents=1]="AnyEvents",Ke[Ke.AnyEventsIncludingUnfinished=2]="AnyEventsIncludingUnfinished";var Qe=function(){function t(e,n){C.default(this,t),O.default(this,"minEventsPortionToSend",50),O.default(this,"maxEventsPortionToSend",100),O.default(this,"pendingEvents",new Map),O.default(this,"readyEvents",[]),O.default(this,"hasInitializationFinished",!1),O.default(this,"_canSendTelemetry",!1),this.config=e,this.packetInterface=n}return _.default(t,[{key:"isTelemetryEnabled",get:function(){return this.config.confirmedCapabilities.has("telemetry.v1")}},{key:"canSendTelemetry",get:function(){return this._canSendTelemetry&&this.isTelemetryEnabled},set:function(t){X.debug("TelemetryTracker.canSendTelemetry: ".concat(t," TelemetryTracker.isTelemetryEnabled: ").concat(this.isTelemetryEnabled)),this._canSendTelemetry&&!t&&(this.pendingEvents.clear(),this.readyEvents=[]),this._canSendTelemetry=t,t&&this.sendTelemetry(e.EventSendingLimitation.AnyEvents),t&&!this.hasInitializationFinished&&(this.hasInitializationFinished=!0)}},{key:"addTelemetryEvent",value:function(e){!this.canSendTelemetry&&this.hasInitializationFinished||this.readyEvents.push(e)}},{key:"addPartialEvent",value:function(t,n,r){X.debug("Adding ".concat(r===e.TelemetryPoint.Start?"starting":"ending"," timepoint for '").concat(n,"' event"));var i=this.pendingEvents.has(n);if(r===e.TelemetryPoint.Start)i&&X.debug("Overwriting starting point for '".concat(n,"' event")),this.pendingEvents.set(n,t);else{if(!i)return void X.info("Could not find started event for '".concat(n,"' event"));this.addTelemetryEvent(this.merge(this.pendingEvents.get(n),t)),this.pendingEvents.delete(n)}}},{key:"getTelemetryToSend",value:function(t){return this.canSendTelemetry&&0!=this.readyEvents.length?t==e.EventSendingLimitation.MinEventsPortion&&this.readyEvents.length<this.minEventsPortionToSend?[]:this.getTelemetryPortion(t==e.EventSendingLimitation.AnyEventsIncludingUnfinished):[]}},{key:"getTelemetryPortion",value:function(e){var t=this,n=Math.min(this.readyEvents.length,this.maxEventsPortionToSend),r=this.readyEvents.splice(0,n);return e&&r.length<this.maxEventsPortionToSend&&this.pendingEvents.forEach((function(e,n){if(!(r.length>=t.maxEventsPortionToSend)){var i=t.pendingEvents.get(n);t.pendingEvents.delete(n),r.push(new Ye("[UNFINISHED] ".concat(i.title),i.details,i.start,null,i.type,i.id))}})),r}},{key:"merge",value:function(e,t){return new Ye(t.title?t.title:e.title,t.details?t.details:e.details,e.start,t.end,t.type?t.type:e.type,t.id?t.id:e.id)}},{key:"sendTelemetryIfMinimalPortionCollected",value:function(){this.sendTelemetry(e.EventSendingLimitation.MinEventsPortion)}},{key:"sendTelemetry",value:function(e){var t=this.getTelemetryToSend(e);if(0!==t.length)try{this.packetInterface.send(new ve(t.map((function(e){return e.toTelemetryEvent()}))))}catch(e){X.debug("Error while sending ".concat(t.length," telemetry events due to ").concat(e,"; they will be resubmitted")),this.readyEvents=this.readyEvents.concat(t)}}}]),t}();function Xe(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=I.default(e);if(t){var i=I.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return R.default(this,n)}}var Ze=function e(){C.default(this,e)};O.default(Ze,"TWILSOCK_CONNECT","twilsock.sdk.connect"),O.default(Ze,"TWILSOCK_INIT","twilsock.sdk.init"),e.TwilsockClient=function(t){T.default(f,t);var n,r,i,a,o,s,u,c,l=Xe(f);function f(t,n,r){var i;C.default(this,f),i=l.call(this),O.default(S.default(i),"version",Z),O.default(S.default(i),"offlineStorageDeferred",new Ge),r.continuationToken=r.continuationToken?r.continuationToken:He.getStoredToken(n);var a=i.config=new ee(t,n,r);X.setLevel(a.logLevel);var o=new Me(a.url),s=new Ae(o,a);return i.channel=new Oe(o,s,a),i.registrations=new Ne(s),i.upstream=new We(s,i.channel,a),i.telemetryTracker=new Qe(a,s),i.channel.on("initialized",(function(){return i.telemetryTracker.canSendTelemetry=!0})),o.on("disconnected",(function(){return i.telemetryTracker.canSendTelemetry=!1})),i.registrations.on("registered",(function(e){return i.emit("registered",e)})),i.channel.on("message",(function(e,t){return setTimeout((function(){return i.emit("message",e,t)}),0)})),i.channel.on("stateChanged",(function(e){return setTimeout((function(){return i.emit("stateChanged",e)}),0)})),i.channel.on("connectionError",(function(e){return setTimeout((function(){return i.emit("connectionError",e)}),0)})),i.channel.on("tokenAboutToExpire",(function(){return setTimeout((function(){return i.emit("tokenAboutToExpire")}),0)})),i.channel.on("tokenExpired",(function(){return setTimeout((function(){return i.emit("tokenExpired")}),0)})),i.channel.on("connected",(function(){return i.registrations.updateRegistrations()})),i.channel.on("connected",(function(){return i.upstream.sendPendingMessages()})),i.channel.on("connected",(function(){return setTimeout((function(){return i.emit("connected")}),0)})),i.channel.on("beforeConnect",(function(){return i.telemetryTracker.addPartialEvent(new Ye("Establish WebSocket connection","",new Date),Ze.TWILSOCK_CONNECT,e.TelemetryPoint.Start)})),i.channel.on("connected",(function(){return i.telemetryTracker.addPartialEvent(new Ye("Establish WebSocket connection","",new Date,new Date),Ze.TWILSOCK_CONNECT,e.TelemetryPoint.End)})),i.channel.on("beforeSendInit",(function(){return i.telemetryTracker.addPartialEvent(new Ye("Send Twilsock init","",new Date),Ze.TWILSOCK_INIT,e.TelemetryPoint.Start)})),i.channel.on("initialized",(function(){return i.telemetryTracker.addPartialEvent(new Ye("Send Twilsock init","Succeeded",new Date,new Date),Ze.TWILSOCK_INIT,e.TelemetryPoint.End)})),i.channel.on("sendInitFailed",(function(){return i.telemetryTracker.addPartialEvent(new Ye("Send Twilsock init","Failed",new Date,new Date),Ze.TWILSOCK_INIT,e.TelemetryPoint.End)})),i.channel.on("initialized",(function(e){i.handleStorageId(n,e),He.storeToken(e.continuationToken,n),setTimeout((function(){return i.emit("initialized",e)}),0)})),i.channel.on("disconnected",(function(){return setTimeout((function(){return i.emit("disconnected")}),0)})),i.channel.on("disconnected",(function(){return i.upstream.rejectPendingMessages()})),i.channel.on("disconnected",(function(){return i.offlineStorageDeferred.fail(new xe("Client disconnected"))})),i.offlineStorageDeferred.promise.catch((function(){})),i}return _.default(f,[{key:"emit",value:function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return X.debug("Emitting ".concat(e.toString(),"(").concat(r.map((function(e){return JSON.stringify(e)})).join(", "),")")),(t=E.default(I.default(f.prototype),"emit",this)).call.apply(t,[this,e].concat(r))}},{key:"handleStorageId",value:function(e,t){if(t.offlineStorage)if(t.offlineStorage.hasOwnProperty(e))try{this.offlineStorageDeferred.set($e.create(t.offlineStorage[e])),X.debug("Offline storage for '".concat(e,"' product: ").concat(JSON.stringify(t.offlineStorage[e]),"."))}catch(n){this.offlineStorageDeferred.fail(new xe("Failed to parse offline storage for ".concat(e," ").concat(JSON.stringify(t.offlineStorage[e]),". ").concat(n,".")))}else this.offlineStorageDeferred.fail(new xe("No offline storage id for '".concat(e,"' product: ").concat(JSON.stringify(t.offlineStorage))));else this.offlineStorageDeferred.fail(new xe("No offline storage id"))}},{key:"storageId",value:function(){return this.offlineStorageDeferred.promise}},{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"state",get:function(){return this.channel.state}},{key:"updateToken",value:(c=x.default(P.default.mark((function e(t){return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(X.trace("updating token '".concat(t,"'")),this.config.token!==t){e.next=3;break}return e.abrupt("return");case 3:return this.config.updateToken(t),e.next=6,this.channel.updateToken(t);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"setNotificationsContext",value:(u=x.default(P.default.mark((function e(t,n){return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.registrations.setNotificationsContext(t,n);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"removeNotificationsContext",value:(s=x.default(P.default.mark((function e(t){return P.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.registrations.removeNotificationsContext(t);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"connect",value:function(){return this.channel.connect()}},{key:"disconnect",value:(o=x.default(P.default.mark((function t(){return P.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.telemetryTracker.sendTelemetry(e.EventSendingLimitation.AnyEventsIncludingUnfinished),t.next=3,this.channel.disconnect();case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(){return o.apply(this,arguments)})},{key:"get",value:(a=x.default(P.default.mark((function t(n,r,i){return P.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.telemetryTracker.sendTelemetry(e.EventSendingLimitation.AnyEvents),t.next=3,this.upstream.send("GET",n,r,void 0,i);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"post",value:(i=x.default(P.default.mark((function t(n,r,i,a){return P.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.telemetryTracker.sendTelemetry(e.EventSendingLimitation.AnyEvents),t.next=3,this.upstream.send("POST",n,r,i,a);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,n,r){return i.apply(this,arguments)})},{key:"put",value:(r=x.default(P.default.mark((function t(n,r,i,a){return P.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.telemetryTracker.sendTelemetry(e.EventSendingLimitation.AnyEvents),t.next=3,this.upstream.send("PUT",n,r,i,a);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,n,i){return r.apply(this,arguments)})},{key:"delete",value:(n=x.default(P.default.mark((function t(n,r,i,a){return P.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.telemetryTracker.sendTelemetry(e.EventSendingLimitation.AnyEvents),t.next=3,this.upstream.send("DELETE",n,r,i,a);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,r,i){return n.apply(this,arguments)})},{key:"addTelemetryEvent",value:function(e){this.telemetryTracker.addTelemetryEvent(e),this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}},{key:"addPartialTelemetryEvent",value:function(t,n,r){this.telemetryTracker.addPartialEvent(t,n,r),r===e.TelemetryPoint.End&&this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}}]),f}(F),e.TwilsockClient=function(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":A.default(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o}([p.validateConstructorTypes(p.nonEmptyString,p.nonEmptyString,[p.pureObject,"undefined",p.literal(null)]),function(e,t){if("object"===("undefined"==typeof Reflect?"undefined":A.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}("design:paramtypes",[String,String,Object])],e.TwilsockClient);var et=function(){function e(t){C.default(this,e),this.product=t,this.type="ers",this.notification_protocol_version=0,this.message_types=[]}return _.default(e,[{key:"populateInitRegistrations",value:function(e){var t=new Set(this.message_types);for(var n in e)t.add(e[n]);this.message_types=Array.from(t)}}]),e}();e.InitRegistration=et,e.TelemetryEventDescription=Ye,e.TelemetryTracker=Qe,e.TransportUnavailableError=Be,e.Twilsock=e.TwilsockClient,e.TwilsockError=xe}(qg);var PE={},AE=s,jE=o,ME=Fn,LE=tn,NE=u,UE=Q,FE=b,DE=Object.assign,BE=Object.defineProperty,qE=!DE||jE((function(){if(AE&&1!==DE({b:1},DE(BE({},"a",{enumerable:!0,get:function(){BE(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach((function(e){t[e]=e})),7!=DE({},e)[n]||ME(DE({},t)).join("")!=r}))?function(e,t){for(var n=UE(e),r=arguments.length,i=1,a=LE.f,o=NE.f;r>i;)for(var s,u=FE(arguments[i++]),c=a?ME(u).concat(a(u)):ME(u),l=c.length,f=0;l>f;)s=c[f++],AE&&!o.call(u,s)||(n[s]=u[s]);return n}:DE,zE=qE;Rn({target:"Object",stat:!0,forced:Object.assign!==zE},{assign:zE}),function(e){Object.defineProperty(e,"__esModule",{value:!0});var t=zg.exports,n=dv.exports,r=fv.exports,i=pv.exports,a=vv.exports,o=mv.exports,s=Wg,u=Kh.exports,c=qg,l=yv.exports,f=Ry.exports,d=ng,p=tv.exports,h=sv.exports,v=_f.exports,y=Sb,m=mh;function g(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}function b(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var k=g(t),w=g(n),x=g(r),_=g(i),S=g(a),E=g(o),T=g(s),R=g(u),I=g(l),C=g(f),O=g(p),P=g(h),A=b(v),j=b(y);function M(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":R.default(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o}function L(e,t){if("object"===("undefined"==typeof Reflect?"undefined":R.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function N(){}function U(){U.init.call(this)}function F(e){return void 0===e._maxListeners?U.defaultMaxListeners:e._maxListeners}function D(e,t,n){if(t)e.call(n);else for(var r=e.length,i=J(e,r),a=0;a<r;++a)i[a].call(n)}function B(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=J(e,i),o=0;o<i;++o)a[o].call(n,r)}function q(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=J(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function z(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=J(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function W(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=J(e,i),o=0;o<i;++o)a[o].apply(n,r)}function G(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new N,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=F(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function $(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function V(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function J(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}N.prototype=Object.create(null),U.EventEmitter=U,U.usingDomains=!1,U.prototype.domain=void 0,U.prototype._events=void 0,U.prototype._maxListeners=void 0,U.defaultMaxListeners=10,U.init=function(){this.domain=null,U.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new N,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},U.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},U.prototype.getMaxListeners=function(){return F(this)},U.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:D(n,l,this);break;case 2:B(n,l,this,arguments[1]);break;case 3:q(n,l,this,arguments[1],arguments[2]);break;case 4:z(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];W(n,l,this,i)}return!0},U.prototype.addListener=function(e,t){return G(this,e,t,!1)},U.prototype.on=U.prototype.addListener,U.prototype.prependListener=function(e,t){return G(this,e,t,!0)},U.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,$(this,e,t)),this},U.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,$(this,e,t)),this},U.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new N:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new N,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},U.prototype.off=function(e,t){return this.removeListener(e,t)},U.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new N,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new N:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new N,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},U.prototype.listeners=function(e){var t,n,r=this._events;return n=r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[],n},U.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):V.call(e,t)},U.prototype.listenerCount=V,U.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var K=A.getLogger("twilio-notificatiions");function H(e,t){return["".concat((new Date).toISOString()," Twilio.Notifications ").concat(e,":")].concat(Array.from(t))}var Y=function(){function e(){w.default(this,e)}return x.default(e,[{key:"setLevel",value:function(e){K.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.trace.apply(null,H("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.debug.apply(null,H("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.info.apply(null,H("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.warn.apply(null,H("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];K.error.apply(null,H("E",t))}}]),e}(),Q=new Y;function X(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E.default(e);if(t){var i=E.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S.default(this,n)}}var Z=x.default((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;w.default(this,e),this.token=t,this.notificationId=n,this.messageTypes=r}));function ee(e,t){var n=new Set;return e.notificationId!==t.notificationId&&n.add("notificationId"),e.token!==t.token&&n.add("token"),function(e,t){return[].concat(P.default(P.default(e).filter((function(e){return!t.has(e)}))),P.default(P.default(t).filter((function(t){return!e.has(t)}))))}(e.messageTypes,t.messageTypes).length>0&&n.add("messageType"),[n.size>0,n]}var te=function(e){_.default(r,e);var t,n=X(r);function r(e){var t;return w.default(this,r),t=n.call(this),C.default(I.default(t),"desiredState",new Z),C.default(I.default(t),"currentState",new Z),C.default(I.default(t),"_hasActiveAttempt",!1),t.channelType=e,t}return x.default(r,[{key:"setNotificationId",value:function(e){this.desiredState.notificationId=e}},{key:"isActive",value:function(){return""!==this.desiredState.notificationId}},{key:"subscribe",value:function(e){this.desiredState.messageTypes.has(e)?Q.debug("message type '".concat(e,"' for channel ").concat(this.channelType," is already registered")):this.desiredState.messageTypes.add(e)}},{key:"unsubscribe",value:function(e){this.desiredState.messageTypes.has(e)&&this.desiredState.messageTypes.delete(e)}},{key:"updateToken",value:function(e){this.desiredState.token=e}},{key:"commitChanges",value:(t=k.default(T.default.mark((function e(){var t,n,r,i,a,o;return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._hasActiveAttempt){e.next=3;break}throw Q.error("One registration attempt is already in progress"),new Error("One registration attempt is already in progress");case 3:if(t=ee(this.desiredState,this.currentState),n=O.default(t,2),r=n[0],i=n[1],r){e.next=6;break}return e.abrupt("return");case 6:if(this.currentState.notificationId||i.delete("notificationId"),Q.trace("Persisting ".concat(this.channelType," registration"),i,this.desiredState),e.prev=8,this._hasActiveAttempt=!0,(a=new Z).token=this.desiredState.token,a.notificationId=this.desiredState.notificationId,a.messageTypes=new Set(this.desiredState.messageTypes),!(a.messageTypes.size>0)){e.next=24;break}return e.next=17,this.updateRegistration(a,i);case 17:o=e.sent,this.currentState.token=o.token,this.currentState.notificationId=o.notificationId,this.currentState.messageTypes=new Set(o.messageTypes),this.emit("stateChanged",this.channelType,"registered",this.currentState),e.next=30;break;case 24:return e.next=26,this.removeRegistration();case 26:this.currentState.token=a.token,this.currentState.notificationId=a.notificationId,this.currentState.messageTypes.clear(),this.emit("stateChanged",this.channelType,"unregistered",this.currentState);case 30:e.next=35;break;case 32:throw e.prev=32,e.t0=e.catch(8),e.t0;case 35:return e.prev=35,this._hasActiveAttempt=!1,e.finish(35);case 38:case"end":return e.stop()}}),e,this,[[8,32,35,38]])}))),function(){return t.apply(this,arguments)})}]),r}(U);function ne(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E.default(e);if(t){var i=E.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S.default(this,n)}}var re={min:2e3,max:12e4,randomness:.2},ie=function(e){_.default(a,e);var t,n,r,i=ne(a);function a(e,t,n,r){var o;return w.default(this,a),o=i.call(this,e),C.default(I.default(o),"registrationId",null),o.context=t,o.twilsock=n,o.registrarUrl=r,o}return x.default(a,[{key:"updateRegistration",value:(r=k.default(T.default.mark((function e(t,n){var r,i,a,o,s,u=this;return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.has("notificationId")){e.next=3;break}return e.next=3,this.removeRegistration();case 3:if(t.notificationId&&t.notificationId.length){e.next=6;break}throw Q.error("No push notification ID for registration"),new Error("No push notification ID for registration");case 6:return Q.trace("Registering",this.channelType,t),r={endpoint_platform:this.context.platform,channel_type:this.channelType,version:this.context.protocolVersion.toString(),message_types:Array.from(t.messageTypes),data:{registration_id:t.notificationId}},i=this.context.productId,a="".concat(this.registrarUrl,"?productId=").concat(i),o={"Content-Type":"application/json"},Q.trace("Creating registration for channel ".concat(this.channelType)),e.prev=12,e.next=15,new d.AsyncRetrier(re).run((function(){return u.twilsock.post(a,o,r,i)}));case 15:s=e.sent,this.registrationId=s.body.id,Q.debug("Registration created: ",s),e.next=24;break;case 20:throw e.prev=20,e.t0=e.catch(12),Q.error("Registration failed: ",e.t0),e.t0;case 24:return e.abrupt("return",t);case 25:case"end":return e.stop()}}),e,this,[[12,20]])}))),function(e,t){return r.apply(this,arguments)})},{key:"removeRegistration",value:(n=k.default(T.default.mark((function e(){var t,n,r,i=this;return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrationId){e.next=2;break}return e.abrupt("return");case 2:return t=this.context.productId,n="".concat(this.registrarUrl,"/").concat(this.registrationId,"?productId=").concat(t),r={"Content-Type":"application/json"},Q.trace("Removing registration for ".concat(this.channelType)),e.prev=6,e.next=9,new d.AsyncRetrier(Object.assign(re,{maxAttemptsCount:3})).run((function(){return i.twilsock.delete(n,r,{},t)}));case 9:this.registrationId=null,this.currentState.notificationId="",Q.debug("Registration removed for ".concat(this.channelType)),e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(6),Q.error("Failed to remove registration ",this.channelType,e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(){return n.apply(this,arguments)})},{key:"sendDeviceRemoveRequest",value:(t=k.default(T.default.mark((function e(t){var n,r,i,a,o=this;return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""!==t){e.next=2;break}throw new Error("Empty registration ID");case 2:return n=this.context.productId,r="".concat(this.registrarUrl,"?productId=").concat(n),i={"Content-Type":"application/json"},a={binding_type:this.channelType,address:t},e.prev=6,Q.trace("Removing old registrations for ".concat(this.channelType)),e.next=10,new d.AsyncRetrier(Object.assign(re,{maxAttemptsCount:3})).run((function(){return o.twilsock.delete(r,i,a,n)}));case 10:this.registrationId=null,this.currentState.notificationId="",Q.debug("Registration removed for ".concat(this.channelType)),e.next=19;break;case 15:throw e.prev=15,e.t0=e.catch(6),Q.error("Failed to remove registration ",this.channelType,e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[6,15]])}))),function(e){return t.apply(this,arguments)})}]),a}(te);function ae(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E.default(e);if(t){var i=E.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S.default(this,n)}}var oe,se=function(e){_.default(a,e);var t,n,r,i=ae(a);function a(e,t,n){var r;return w.default(this,a),r=i.call(this,"twilsock"),C.default(I.default(r),"contextId",j.v4()),r.productId=e,r.platform=t,r.twilsock=n,r}return x.default(a,[{key:"updateRegistration",value:(r=k.default(T.default.mark((function e(t,n){var r,i;return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.has("messageType")){e.next=2;break}return e.abrupt("return",t);case 2:return r=Array.from(t.messageTypes),i={product_id:this.productId,notification_protocol_version:4,endpoint_platform:this.platform,message_types:r},e.prev=4,e.next=7,this.twilsock.setNotificationsContext(this.contextId,i);case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(4),Q.error("Failed to update twilsock notification context: ".concat(e.t0)),e.t0;case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e,this,[[4,9]])}))),function(e,t){return r.apply(this,arguments)})},{key:"removeRegistration",value:(n=k.default(T.default.mark((function e(){return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.twilsock.removeNotificationsContext(this.contextId);case 3:e.next=9;break;case 5:throw e.prev=5,e.t0=e.catch(0),Q.error("Failed to remove twilsock notification context: ".concat(e.t0)),e.t0;case 9:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(){return n.apply(this,arguments)})},{key:"sendDeviceRemoveRequest",value:(t=k.default(T.default.mark((function e(t){return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),a}(te);function ue(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=E.default(e);if(t){var i=E.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return S.default(this,n)}}var ce=m.literal("apn","fcm","twilsock");e.Notifications=oe=function(e){_.default(Client,e);var t,n,r,i=ue(Client);function Client(e){var t,n,r,a,o,s,u,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};w.default(this,Client),u=i.call(this),l.logLevel=null!==(t=l.logLevel)&&void 0!==t?t:"error",Q.setLevel(l.logLevel);var f=null!==(n=l.productId)&&void 0!==n?n:"notifications",d=!l.twilsockClient,p=l.twilsockClient=null!==(r=l.twilsockClient)&&void 0!==r?r:new c.TwilsockClient(e,f,l),h=null!==(a=l.notifications)&&void 0!==a?a:{},v=null!==(o=null!==(s=h.region)&&void 0!==s?s:l.region)&&void 0!==o?o:"us1",y="https://ers.".concat(v,".twilio.com/v1/registrations"),m=h.ersUrl||y;u.connectors=new Map;var g=oe._detectPlatform();return u.connectors.set("apn",new ie("apn",{protocolVersion:4,productId:f,platform:g},p,m)),u.connectors.set("fcm",new ie("fcm",{protocolVersion:3,productId:f,platform:g},p,m)),u.connectors.set("twilsock",new se(f,g,p)),p.on("stateChanged",(function(e){return u.emit("transportState",e)})),u._connector("twilsock").on("stateChanged",(function(e,t,n){return u.emit("stateChanged",e,t,n)})),u._connector("apn").on("stateChanged",(function(e,t,n){return u.emit("stateChanged",e,t,n)})),u._connector("fcm").on("stateChanged",(function(e,t,n){return u.emit("stateChanged",e,t,n)})),p.on("message",(function(e,t){return u._routeMessage(e,t)})),u.updateToken(e),d&&(p.connect(),u.twilsock=p),u}return x.default(Client,[{key:"shutdown",value:(r=k.default(T.default.mark((function e(){return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.connectors.clear(),!this.twilsock){e.next=4;break}return e.next=4,this.twilsock.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"setPushRegistrationId",value:function(e,t){Q.debug("Set ".concat(e," push registration id '").concat(t,"'")),this._connector(e).setNotificationId(t)}},{key:"subscribe",value:function(e,t){Q.debug("Add ".concat(e," subscriptions for message type ").concat(t)),this._connector(e).subscribe(t)}},{key:"unsubscribe",value:function(e,t){Q.debug("Remove ".concat(e," subscriptions for message type ").concat(t)),this._connector(e).unsubscribe(t)}},{key:"updateToken",value:function(e){this.connectors.forEach((function(t){return t.updateToken(e)}))}},{key:"commitChanges",value:(n=k.default(T.default.mark((function e(){var t;return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.connectors.forEach((function(e){e.isActive()&&t.push(e.commitChanges())})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"removeRegistrations",value:(t=k.default(T.default.mark((function e(t,n){return T.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._connector(t).sendDeviceRemoveRequest(n);case 2:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"handlePushNotification",value:function(e){return{messageType:e.twi_message_type,payload:e.payload}}},{key:"_routeMessage",value:function(e,t){Q.debug("Notification message arrived: ",e,t),this.emit("message",e,t)}},{key:"_connector",value:function(e){var t=this.connectors.get(e);if(!t)throw new Error("Unknown channel type: ".concat(e));return t}}],[{key:"_detectPlatform",value:function(){var e="";return"undefined"!=typeof navigator?(e="unknown",void 0!==navigator.product&&(e=navigator.product),void 0!==navigator.userAgent&&(e=navigator.userAgent)):e="web",e.substring(0,128)}}]),Client}(U),M([m.validateTypes(ce,m.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",void 0)],e.Notifications.prototype,"setPushRegistrationId",null),M([m.validateTypes(ce,m.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",void 0)],e.Notifications.prototype,"subscribe",null),M([m.validateTypes(ce,m.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",void 0)],e.Notifications.prototype,"unsubscribe",null),M([m.validateTypes(m.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String]),L("design:returntype",void 0)],e.Notifications.prototype,"updateToken",null),M([m.validateTypesAsync(ce,m.nonEmptyString),L("design:type",Function),L("design:paramtypes",[String,String]),L("design:returntype",Promise)],e.Notifications.prototype,"removeRegistrations",null),e.Notifications=oe=M([m.validateConstructorTypes(m.nonEmptyString,[m.pureObject,"undefined",m.literal(null)]),L("design:paramtypes",[String,Object])],e.Notifications)}(PE);var WE={};Object.defineProperty(WE,"__esModule",{value:!0});var GE=zg.exports,$E=dv.exports,VE=fv.exports,JE=yv.exports,KE=pv.exports,HE=vv.exports,YE=mv.exports,QE=Ry.exports,XE=Wg,ZE=Kh.exports,eT=mh,tT=qg,nT=nE.exports,rT=_f.exports,iT=tv.exports,aT=ng,oT=Sb,sT=Ey.exports,uT=oE.exports;function cT(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}function lT(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var fT=cT(GE),dT=cT($E),pT=cT(VE),hT=cT(JE),vT=cT(KE),yT=cT(HE),mT=cT(YE),gT=cT(QE),bT=cT(XE),kT=cT(ZE),wT=cT(nT),xT=lT(rT),_T=cT(iT),ST=lT(oT),ET=cT(sT),TT=lT(uT);function RT(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":kT.default(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o}function IT(e,t){if("object"===("undefined"==typeof Reflect?"undefined":kT.default(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function CT(){}function OT(){OT.init.call(this)}function PT(e){return void 0===e._maxListeners?OT.defaultMaxListeners:e._maxListeners}function AT(e,t,n){if(t)e.call(n);else for(var r=e.length,i=BT(e,r),a=0;a<r;++a)i[a].call(n)}function jT(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=BT(e,i),o=0;o<i;++o)a[o].call(n,r)}function MT(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=BT(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function LT(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=BT(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function NT(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=BT(e,i),o=0;o<i;++o)a[o].apply(n,r)}function UT(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new CT,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=PT(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function FT(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function DT(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function BT(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}CT.prototype=Object.create(null),OT.EventEmitter=OT,OT.usingDomains=!1,OT.prototype.domain=void 0,OT.prototype._events=void 0,OT.prototype._maxListeners=void 0,OT.defaultMaxListeners=10,OT.init=function(){this.domain=null,OT.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new CT,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},OT.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},OT.prototype.getMaxListeners=function(){return PT(this)},OT.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:AT(n,l,this);break;case 2:jT(n,l,this,arguments[1]);break;case 3:MT(n,l,this,arguments[1],arguments[2]);break;case 4:LT(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];NT(n,l,this,i)}return!0},OT.prototype.addListener=function(e,t){return UT(this,e,t,!1)},OT.prototype.on=OT.prototype.addListener,OT.prototype.prependListener=function(e,t){return UT(this,e,t,!0)},OT.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,FT(this,e,t)),this},OT.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,FT(this,e,t)),this},OT.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new CT:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new CT,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},OT.prototype.off=function(e,t){return this.removeListener(e,t)},OT.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new CT,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new CT:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new CT,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},OT.prototype.listeners=function(e){var t,n,r=this._events;return n=r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[],n},OT.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):DT.call(e,t)},OT.prototype.listenerCount=DT,OT.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var qT=function(){function e(t){dT.default(this,e),this.base=t,this.args=new Array,this.paths=new Array}return pT.default(e,[{key:"pathSegment",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"queryParam",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}();function zT(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}var SyncError=function(e){vT.default(SyncError,e);var t=zT(SyncError);function SyncError(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return dT.default(this,SyncError),(n=t.call(this)).name=n.constructor.name,n.message="".concat(e," (status: ").concat(r,", code: ").concat(i,")"),n.status=r,n.code=i,n}return SyncError}(wT.default(Error)),WT=function(e){vT.default(n,e);var t=zT(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3?arguments[3]:void 0;return dT.default(this,n),(r=t.call(this,e,i,a)).body=o,r}return n}(SyncError);function GT(e){return JSON.parse(JSON.stringify(e))}function $T(e){if(!(void 0===e||VT(e)))throw new SyncError("Invalid pageSize parameter. Expected a positive integer, was '".concat(e,"'."),400,20007)}function VT(e){return function(e){return!isNaN(parseInt(e))&&isFinite(e)}(e)&&e>0}var JT=xT.getLogger("twilio-sync");function KT(e,t){return["".concat((new Date).toISOString()," Sync ").concat(e,":")].concat(Array.from(t))}var HT=function(e){JT.setLevel(e)},YT=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];JT.trace.apply(null,KT("T",t))},QT=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];JT.debug.apply(null,KT("D",t))},XT=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];JT.warn.apply(null,KT("W",t))},ZT=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];JT.error.apply(null,KT("E",t))},eR="/v4/Subscriptions",tR="/v3/Maps",nR="/v3/Lists",rR="/v3/Documents",iR="/v3/Streams",aR="/v3/Insights";function oR(e,t,n){return e&&void 0!==e[t]?e[t]:n}var sR=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};dT.default(this,e);var n=t.region||"us1",r="https://cds.".concat(n,".twilio.com"),i=t.cdsUri||r;this.settings={subscriptionsUri:i+eR,documentsUri:i+rR,listsUri:i+nR,mapsUri:i+tR,streamsUri:i+iR,insightsUri:i+aR,sessionStorageEnabled:oR(t.Sync,"enableSessionStorage",!0),productId:t.productId}}return pT.default(e,[{key:"subscriptionsUri",get:function(){return this.settings.subscriptionsUri}},{key:"documentsUri",get:function(){return this.settings.documentsUri}},{key:"listsUri",get:function(){return this.settings.listsUri}},{key:"mapsUri",get:function(){return this.settings.mapsUri}},{key:"streamsUri",get:function(){return this.settings.streamsUri}},{key:"insightsUri",get:function(){return this.settings.insightsUri}},{key:"backoffConfig",get:function(){return this.settings.backoffConfig||{}}},{key:"sessionStorageEnabled",get:function(){return this.settings.sessionStorageEnabled}},{key:"productId",get:function(){return this.settings.productId}}]),e}();function uR(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return cR(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return cR(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function cR(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var lR=function(){function e(t){dT.default(this,e),this.localObject=t,this.pendingCorrelationId=null,this.pendingAction=null,this.established=!1,this.retryCount=0}return pT.default(e,[{key:"sid",get:function(){return this.localObject.sid}},{key:"type",get:function(){return this.localObject.type}},{key:"lastEventId",get:function(){return this.localObject.lastEventId}},{key:"indexName",get:function(){return this.localObject.indexName}},{key:"queryString",get:function(){return this.localObject.queryString}},{key:"isEstablished",get:function(){return this.established}},{key:"update",value:function(e,t){this.localObject._update(e,t)}},{key:"updatePending",value:function(e,t){this.pendingAction=e,this.pendingCorrelationId=t}},{key:"reset",value:function(){this.updatePending(null,null),this.retryCount=0,this.established=!1,this.setSubscriptionState("none")}},{key:"markAsFailed",value:function(e){this.rejectedWithError=e.error,this.updatePending(null,null),this.localObject.reportFailure(new SyncError("Failed to subscribe on service events: ".concat(e.error.message),e.error.status,e.error.code))}},{key:"complete",value:function(e){this.updatePending(null,null),this.established=!0,this.localObject._advanceLastEventId(e)}},{key:"setSubscriptionState",value:function(e){this.localObject._setSubscriptionState(e)}}]),e}(),fR=function(){function e(t){var n=this;dT.default(this,e),gT.default(this,"isConnected",!1),gT.default(this,"maxBatchSize",100),gT.default(this,"subscriptionTtlTimer",null),gT.default(this,"pendingPokeReason",null),this.services=t,this.subscriptions=new Map,this.persisted=new Map,this.latestPokeResponseArrivalTimestampByCorrelationId=new Map;this.backoff=aT.Backoff.exponential(Object.assign({randomisationFactor:.2,initialDelay:100,maxDelay:12e4},this.services.config.backoffConfig)),this.backoff.on("ready",(function(){var e=n.getSubscriptionUpdateBatch(),t=e.action,r=e.subscriptions;t?n.applyNewSubscriptionUpdateBatch(t,r):(n.backoff.reset(),QT("All subscriptions resolved."))}))}var t;return pT.default(e,[{key:"getSubscriptionUpdateBatch",value:function(){function e(e,t,n,r){var i,a=[],o=uR(e);try{for(o.s();!(i=o.n()).done;){var s=_T.default(i.value,2),u=s[0],c=s[1];if(!t.get(u)&&n!==c.pendingAction&&!c.rejectedWithError&&(a.push(c),r&&a.length>=r))break}}catch(e){o.e(e)}finally{o.f()}return a}var t=e(this.subscriptions,this.persisted,"establish",this.maxBatchSize);if(t.length>0)return{action:"establish",subscriptions:t};var n=e(this.persisted,this.subscriptions,"cancel",this.maxBatchSize);return n.length>0?{action:"cancel",subscriptions:n}:{action:null,subscriptions:null}}},{key:"persist",value:function(){this.backoff.backoff()}},{key:"applyNewSubscriptionUpdateBatch",value:(t=fT.default(bT.default.mark((function e(t,n){var r,i,a,o,s,u,c,l,f,d,p,h,v=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isConnected){e.next=4;break}return QT("Twilsock connection (required for subscription) not ready; waiting…"),this.backoff.reset(),e.abrupt("return");case 4:n=this.processLocalActions(t,n),r=(new Date).getTime(),i=uR(n);try{for(i.s();!(a=i.n()).done;)o=a.value,this.recordActionAttemptOn(o,t,r)}catch(e){i.e(e)}finally{i.f()}return s=this.pendingPokeReason,this.pendingPokeReason=null,e.prev=10,e.next=13,this.request(t,r,s,n);case 13:u=e.sent,c=u.body.max_batch_size,!isNaN(parseInt(c))&&isFinite(c)&&c>0&&(this.maxBatchSize=c),this.subscriptionTtlTimer||(l=u.body.ttl_in_s,!isNaN(parseFloat(l))&&isFinite(l)&&l>0&&(this.subscriptionTtlTimer=setTimeout((function(){return v.onSubscriptionTtlElapsed()}),1e3*l))),"establish"===t&&(f=u.body.estimated_delivery_in_ms,!isNaN(parseFloat(f))&&isFinite(f)&&f>0?setTimeout((function(){return v.verifyPokeDelivery(r,f,n)}),f):ZT("Invalid timeout: ".concat(f)),n.filter((function(e){return e.pendingCorrelationId===r})).forEach((function(e){return e.setSubscriptionState("response_in_flight")}))),this.backoff.reset(),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(10),d=uR(n);try{for(d.s();!(p=d.n()).done;)h=p.value,this.recordActionFailureOn(h,t)}catch(e){d.e(e)}finally{d.f()}e.t0 instanceof tT.TransportUnavailableError?(QT("Twilsock connection (required for subscription) not ready (c:".concat(r,"); waiting…")),this.backoff.reset()):(QT("Failed an attempt to ".concat(t," subscriptions (c:").concat(r,"); retrying"),e.t0),this.persist());case 26:case"end":return e.stop()}}),e,this,[[10,21]])}))),function(e,n){return t.apply(this,arguments)})},{key:"verifyPokeDelivery",value:function(e,t,n){var r=this,i=this.latestPokeResponseArrivalTimestampByCorrelationId.get(e),a=i?(new Date).getTime()-i:t;a>=t?(n.filter((function(t){return t.pendingCorrelationId===e})).forEach((function(e){e.updatePending(null,null),e.retryCount++,r.persisted.delete(e.sid)})),this.persist(),this.latestPokeResponseArrivalTimestampByCorrelationId.delete(e)):setTimeout((function(){return r.verifyPokeDelivery(e,t,n)}),t-a)}},{key:"processLocalActions",value:function(e,t){return"cancel"===e?t.filter((function(e){return!e.rejectedWithError})):t}},{key:"recordActionAttemptOn",value:function(e,t,n){if(e.setSubscriptionState("request_in_flight"),"establish"===t)this.persisted.set(e.sid,e),e.updatePending(t,n);else{var r=this.persisted.get(e.sid);r&&r.updatePending(t,n)}}},{key:"recordActionFailureOn",value:function(e,t){e.setSubscriptionState("none"),e.updatePending(null,null),"establish"===t&&this.persisted.delete(e.sid)}},{key:"request",value:function(e,t,n,r){var i=r.map((function(t){return{object_sid:t.sid,object_type:t.type,last_event_id:"establish"===e?t.lastEventId:void 0,index_name:"establish"===e?t.indexName:void 0,query_string:"establish"===e?t.queryString:void 0}})),a=r.filter((function(e){return e.retryCount>0})).length;QT("Attempting '".concat(e,"' request (c:").concat(t,"):"),i);var o={event_protocol_version:4,action:e,correlation_id:t,retried_requests:a,ttl_in_s:-1,requests:i};return"ttl"===n&&(o.reason=n),this.services.network.post(this.services.config.subscriptionsUri,o)}},{key:"add",value:function(e,t){QT("Establishing intent to subscribe to ".concat(e));var n=this.subscriptions.get(e);n&&t&&n.lastEventId===t.lastEventId||(this.persisted.delete(e),this.subscriptions.set(e,new lR(t)),this.persist())}},{key:"remove",value:function(e){QT("Establishing intent to unsubscribe from ".concat(e)),this.subscriptions.delete(e)&&this.persist()}},{key:"acceptMessage",value:function(e,t){YT("Subscriptions received",e);var n=e.event_type,r=void 0!==e.events?e.events:[e.event],i=e.correlation_id;i&&this.latestPokeResponseArrivalTimestampByCorrelationId.set(i,(new Date).getTime());var a,o=uR(r);try{for(o.s();!(a=o.n()).done;){var s=a.value,u=void 0;switch(e.event_type){case"subscription_established":this.applySubscriptionEstablishedMessage(s,i);break;case"subscription_canceled":this.applySubscriptionCancelledMessage(s,i);break;case"subscription_failed":this.applySubscriptionFailedMessage(s,i);break;case(u=n.match(/^(?:map|list|document|stream|live_query)_/)||{}).input:var c=void 0;switch(u[0]){case"map_":c=s.map_sid;break;case"list_":c=s.list_sid;break;case"document_":c=s.document_sid;break;case"stream_":c=s.stream_sid;break;case"live_query_":c=s.query_id,t=!1,!0===e.strictly_ordered&&(t=!0);break;default:c=void 0}this.applyEventToSubscribedEntity(c,s,n,t);break;default:QT("Dropping unknown message type ".concat(n))}}}catch(e){o.e(e)}finally{o.f()}}},{key:"applySubscriptionEstablishedMessage",value:function(e,t){var n=e.object_sid,r=this.persisted.get(e.object_sid);r&&r.pendingCorrelationId===t?"interrupted"===e.replay_status?(QT("Event Replay for subscription to ".concat(n," (c:").concat(t,") interrupted; continuing eagerly.")),r.updatePending(null,null),this.persisted.delete(r.sid),this.backoff.reset()):"completed"===e.replay_status&&(QT("Event Replay for subscription to ".concat(n," (c:").concat(t,") completed. Subscription is ready.")),r.complete(e.last_event_id),this.persisted.set(e.object_sid,r),r.setSubscriptionState("established"),this.backoff.reset()):QT("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionCancelledMessage",value:function(e,t){var n=this.persisted.get(e.object_sid);n&&n.pendingCorrelationId===t?(n.updatePending(null,null),n.setSubscriptionState("none"),this.persisted.delete(e.object_sid)):QT("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionFailedMessage",value:function(e,t){var n=e.object_sid,r=this.subscriptions.get(n),i=this.persisted.get(n);r&&i?i.pendingCorrelationId===t&&(ZT("Failed to subscribe on ".concat(i.sid),e.error),i.markAsFailed(e),i.setSubscriptionState("none")):!r&&i&&(this.persisted.delete(n),i.setSubscriptionState("none")),this.persist()}},{key:"applyEventToSubscribedEntity",value:function(e,t,n,r){if(e){var i;r=r||(i=this.persisted.get(e))&&i.isEstablished;var a=this.subscriptions.get(e);a?(t.type=n,a.update(t,r)):QT("Message dropped for SID '".concat(e,"', for which there is no subscription."))}}},{key:"onConnectionStateChanged",value:function(e){this.isConnected=e,e&&this.poke("reconnect")}},{key:"onSubscriptionTtlElapsed",value:function(){this.isConnected&&this.poke("ttl")}},{key:"poke",value:function(e){QT("Triggering event replay for all subscriptions, reason=".concat(e)),this.pendingPokeReason=e,this.subscriptionTtlTimer&&(clearTimeout(this.subscriptionTtlTimer),this.subscriptionTtlTimer=null);var t,n=[],r=uR(this.persisted.values());try{for(r.s();!(t=r.n()).done;){var i=t.value;i.reset(),i.rejectedWithError&&n.push(i)}}catch(e){r.e(e)}finally{r.f()}this.persisted.clear();for(var a=0,o=n;a<o.length;a++){var s=o[a];this.persisted.set(s.sid,s)}this.persist()}},{key:"shutdown",value:function(){this.backoff.reset(),this.subscriptions.clear()}}]),e}();function dR(e){if(e.body&&e.body.message)return e.body.message;switch(e.status){case 429:return"Throttled by server";case 404:return"Not found from server";default:return"Error from server"}}function pR(e){return e.body?e.body.code:0}function hR(e){return 409===e.status?new WT(dR(e),e.status,pR(e),e.body):e.status?new SyncError(dR(e),e.status,pR(e)):e instanceof tT.TransportUnavailableError?e:new SyncError(e.message,0,0)}var vR=function(){function e(t,n,r){dT.default(this,e),this.clientInfo=t,this.config=n,this.transport=r}return pT.default(e,[{key:"createHeaders",value:function(){return{"Content-Type":"application/json","Twilio-Sync-Client-Info":JSON.stringify(this.clientInfo),"Twilio-Request-Id":"RQ"+ST.v4().replace(/-/g,"")}}},{key:"backoffConfig",value:function(){return Object.assign({min:4e3,max:6e4,maxAttemptsTime:9e4,randomness:.2},this.config.backoffConfig)}},{key:"executeWithRetry",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var o=new aT.Retrier(t.backoffConfig());o.on("attempt",(function(){e().then((function(e){return o.succeeded(e)})).catch((function(e){if(a.includes(e.status)){var t=parseInt(e.headers?e.headers["Retry-After"]:null);o.failed(hR(e),isNaN(t)?null:1e3*t)}else"Twilsock disconnected"===e.message?o.failed(hR(e)):(o.removeAllListeners(),o.cancel(),i(hR(e)))}))})),o.on("succeeded",(function(e){r(e)})),o.on("cancelled",(function(e){return i(hR(e))})),o.on("failed",(function(e){return i(hR(e))})),o.start()}))}},{key:"get",value:function(e){var t=this,n=this.createHeaders();return QT("GET",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry((function(){return t.transport.get(e,n,t.config.productId)}),!0)}},{key:"post",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=this.createHeaders();return null!=n&&(a["If-Match"]=n),QT("POST",e,"ID:",a["Twilio-Request-Id"]),this.executeWithRetry((function(){return r.transport.post(e,a,t,r.config.productId)}),i)}},{key:"put",value:function(e,t,n){var r=this,i=this.createHeaders();return null!=n&&(i["If-Match"]=n),QT("PUT",e,"ID:",i["Twilio-Request-Id"]),this.executeWithRetry((function(){return r.transport.put(e,i,t,r.config.productId)}),!1)}},{key:"delete",value:function(e){var t=this,n=this.createHeaders();return QT("DELETE",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry((function(){return t.transport.delete(e,n,t.config.productId)}),!1)}}]),e}(),yR=function(){function e(t,n){dT.default(this,e),this.config=t,this.storageId=null;try{this.storage=n||sessionStorage}catch(e){}}return pT.default(e,[{key:"storageKey",value:function(e,t){return"".concat(this.storageId,"::").concat(e,"::").concat(t)}},{key:"isReady",get:function(){return this.config.sessionStorageEnabled&&!!this.storageId}},{key:"updateStorageId",value:function(e){this.storageId=e}},{key:"store",value:function(e,t,n){return this.isReady?this._store(this.storageKey(e,t),n):null}},{key:"read",value:function(e,t){return this.isReady?this._read(this.storageKey(e,t)):null}},{key:"remove",value:function(e,t,n){if(!this.isReady)return null;try{this.storage.removeItem(this.storageKey(e,t)),n&&this.storage.removeItem(this.storageKey(e,n))}catch(e){}}},{key:"update",value:function(e,t,n,r){if(!this.isReady)return null;this._apply(this.storageKey(e,t),r),n&&this._apply(this.storageKey(e,n),r)}},{key:"_store",value:function(e,t){try{this.storage.setItem(e,JSON.stringify(t))}catch(e){}}},{key:"_read",value:function(e){try{var t=this.storage.getItem(e);if(t)return JSON.parse(t)}catch(e){}return null}},{key:"_apply",value:function(e,t){var n=this._read(e);if(!n)return!1;this._store(e,Object.assign(n,t))}}]),e}();function mR(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return gR(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return gR(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function gR(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var bR=function(){function e(t,n){dT.default(this,e),this.services=t,this.removalHandler=n,this.subscriptionState="none",this._attachedListeners=new Map}return pT.default(e,[{key:"_advanceLastEventId",value:function(e,t){}},{key:"reportFailure",value:function(e){404===e.status?this.onRemoved(!1):this.broadcastEventToListeners("failure",e)}},{key:"_subscribe",value:function(){this.services.router._subscribe(this.sid,this)}},{key:"_unsubscribe",value:function(){this.services.router._unsubscribe(this.sid)}},{key:"_setSubscriptionState",value:function(e){this.subscriptionState=e,this.broadcastEventToListeners("_subscriptionStateChanged",e)}},{key:"close",value:function(){this._unsubscribe(),null!=this.removalHandler&&this.removalHandler(this.type,this.sid,this.uniqueName)}},{key:"attach",value:function(e){var t=e.listenerUuid;this._attachedListeners.get(t)||(this._attachedListeners.size||this._subscribe(),this._attachedListeners.set(t,e))}},{key:"detach",value:function(e){this._attachedListeners.delete(e),this._attachedListeners.size||this.close()}},{key:"broadcastEventToListeners",value:function(e,t){var n,r=mR(this._attachedListeners.values());try{for(r.s();!(n=r.n()).done;){n.value.emit(e,t)}}catch(e){r.e(e)}finally{r.f()}}}]),e}(),kR=function(){function e(t){dT.default(this,e),gT.default(this,"queuedRequests",[]),gT.default(this,"isRequestInFlight",!1),this.inputMergingFunction=t}return pT.default(e,[{key:"add",value:function(e,t){var n=this,r=new Promise((function(r,i){return n.queuedRequests.push({input:e,requestFunction:t,resolve:r,reject:i})}));return this.wakeupQueue(),r}},{key:"squashAndAdd",value:function(e,t){var n,r=this.queuedRequests;this.queuedRequests=[],r.length>0?(n=r.map((function(e){return e.input})).reduce(this.inputMergingFunction),n=this.inputMergingFunction(n,e)):n=e;var i=this.add(n,t);return r.forEach((function(e){return i.then(e.resolve,e.reject)})),i}},{key:"isEmpty",value:function(){return 0===this.queuedRequests.length&&!this.isRequestInFlight}},{key:"wakeupQueue",value:function(){var e=this;if(0!==this.queuedRequests.length&&!this.isRequestInFlight){var t=this.queuedRequests.shift();this.isRequestInFlight=!0,t.requestFunction(t.input).then(t.resolve,t.reject).then((function(t){e.isRequestInFlight=!1,e.wakeupQueue()}))}}}]),e}(),wR=function(){function e(t){dT.default(this,e),gT.default(this,"queueByNamespaceKey",new Map),this.inputReducer=t}var t,n,r;return pT.default(e,[{key:"add",value:(r=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,(function(e){return e.add(n,r)})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"squashAndAdd",value:(n=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,(function(e){return e.squashAndAdd(n,r)})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"invokeQueueMethod",value:(t=fT.default(bT.default.mark((function e(t,n){var r,i;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.queueByNamespaceKey.has(t)||this.queueByNamespaceKey.set(t,new kR(this.inputReducer)),r=this.queueByNamespaceKey.get(t),i=n(r),this.queueByNamespaceKey.get(t).isEmpty()&&this.queueByNamespaceKey.delete(t),e.abrupt("return",i);case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}]),e}();function xR(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}var _R=function(e){vT.default(n,e);var t=xR(n);function n(){var e;return dT.default(this,n),(e=t.call(this)).closed=!1,e.uuid=oT.v4(),e}return pT.default(n,[{key:"listenerUuid",get:function(){return this.uuid}},{key:"close",value:function(){this.removeAllListeners(),this.closed=!0}},{key:"ensureNotClosed",value:function(){if(this.closed)throw new Error("Invalid operation on closed object")}}]),n}(OT);function SR(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}var ER=function(e){vT.default(f,e);var t,n,r,i,a,o,s,u,c,l=SR(f);function f(e,t,n){var r;dT.default(this,f),r=l.call(this,e,n),gT.default(hT.default(r),"isDeleted",!1);return r.updateMergingQueue=new kR((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.descriptor=t,r.descriptor.data=r.descriptor.data||{},r.descriptor.date_updated=new Date(r.descriptor.date_updated),r}return pT.default(f,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"document"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"_update",value:function(e){switch(e.date_created=new Date(e.date_created),e.type){case"document_updated":if(e.id<=this.lastEventId){YT("Document update skipped, current:",this.lastEventId,", remote:",e.id);break}var t=void 0!==this.descriptor.data?GT(this.descriptor.data):null;this.descriptor.last_event_id=e.id,this.descriptor.revision=e.document_revision,this.descriptor.date_updated=e.date_created,this.descriptor.data=e.document_data,this.broadcastEventToListeners("updated",{data:e.document_data,isLocal:!1,previousData:t}),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.id,revision:e.document_revision,date_updated:e.date_created,data:e.document_data});break;case"document_removed":this.onRemoved(!1)}}},{key:"set",value:(c=fT.default(bT.default.mark((function e(t,n){var r,i=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(r,(function(e){return i._setUnconditionally(t,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"mutate",value:(u=fT.default(bT.default.mark((function e(t,n){var r,i=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},e.abrupt("return",this.updateMergingQueue.add(r,(function(e){return i._setWithIfMatch(t,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"update",value:(s=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate((function(e){return Object.assign(e,t)}),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"setTtl",value:(o=fT.default(bT.default.mark((function e(t){var n;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({ttl:t});case 2:n=e.sent,this.descriptor.date_expires=n.date_expires;case 4:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"_setUnconditionally",value:(a=fT.default(bT.default.mark((function e(t,n){var r;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({data:t,revision:void 0,ttl:n});case 2:return r=e.sent,this._handleSuccessfulUpdateResult(r),e.abrupt("return",this.descriptor.data);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"_setWithIfMatch",value:(i=fT.default(bT.default.mark((function e(t,n){var r,i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=t(GT(this.descriptor.data)))){e.next=22;break}return i=this.revision,e.prev=3,e.next=6,this._postUpdateToServer({data:r,revision:i,ttl:n});case 6:return a=e.sent,this._handleSuccessfulUpdateResult(a),e.abrupt("return",this.descriptor.data);case 11:if(e.prev=11,e.t0=e.catch(3),412!==e.t0.status){e.next=19;break}return e.next=16,this._softSync();case 16:return e.abrupt("return",this._setWithIfMatch(t));case 19:throw e.t0;case 20:e.next=23;break;case 22:return e.abrupt("return",this.descriptor.data);case 23:case"end":return e.stop()}}),e,this,[[3,11]])}))),function(e,t){return i.apply(this,arguments)})},{key:"_handleSuccessfulUpdateResult",value:function(e){if(!(e.last_event_id<=this.descriptor.last_event_id)){var t=void 0!==this.descriptor.data?GT(this.descriptor.data):null;this.descriptor.revision=e.revision,this.descriptor.data=e.data,this.descriptor.last_event_id=e.last_event_id,this.descriptor.date_expires=e.date_expires,this.descriptor.date_updated=new Date(e.date_updated),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.last_event_id,revision:e.revision,date_updated:e.date_updated,data:e.data}),this.broadcastEventToListeners("updated",{data:this.descriptor.data,isLocal:!0,previousData:t})}}},{key:"_postUpdateToServer",value:(r=fT.default(bT.default.mark((function e(t){var n,r,i;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=17;break}return n={data:t.data},void 0!==t.ttl&&(n.ttl=t.ttl),r=t.revision,e.prev=4,e.next=7,this.services.network.post(this.uri,n,r);case 7:return i=e.sent,e.abrupt("return",{revision:i.body.revision,data:t.data,last_event_id:i.body.last_event_id,date_updated:i.body.date_updated,date_expires:i.body.date_expires});case 11:throw e.prev=11,e.t0=e.catch(4),404===e.t0.status&&this.onRemoved(!1),e.t0;case 15:e.next=18;break;case 17:return e.abrupt("return",Promise.reject(new SyncError("The Document has been removed",404,54100)));case 18:case"end":return e.stop()}}),e,this,[[4,11]])}))),function(e){return r.apply(this,arguments)})},{key:"_softSync",value:(n=fT.default(bT.default.mark((function e(){var t=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.network.get(this.uri).then((function(e){var n={type:"document_updated",id:e.body.last_event_id,document_revision:e.body.revision,document_data:e.body.data,date_created:e.body.date_updated};return t._update(n),t})).catch((function(e){404===e.status?t.onRemoved(!1):ZT("Can't get updates for ".concat(t.sid,":"),e)})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onRemoved",value:function(e){if(!this.isDeleted){var t=void 0!==this.descriptor.data?GT(this.descriptor.data):null;this.isDeleted=!0,this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e,previousData:t})}}},{key:"removeDocument",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=6;break}return e.next=3,this.services.network.delete(this.uri);case 3:this.onRemoved(!0),e.next=7;break;case 6:return e.abrupt("return",Promise.reject(new SyncError("The Document has been removed",404,54100)));case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"type",get:function(){return"document"}}]),f}(bR),TR=function(e){vT.default(s,e);var t,n,r,i,a,o=SR(s);function s(e){var t;return dT.default(this,s),(t=o.call(this)).syncDocumentImpl=e,t.syncDocumentImpl.attach(hT.default(t)),t}return pT.default(s,[{key:"uri",get:function(){return this.syncDocumentImpl.uri}},{key:"revision",get:function(){return this.syncDocumentImpl.revision}},{key:"lastEventId",get:function(){return this.syncDocumentImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncDocumentImpl.dateExpires}},{key:"type",get:function(){return ER.type}},{key:"sid",get:function(){return this.syncDocumentImpl.sid}},{key:"data",get:function(){return this.syncDocumentImpl.data}},{key:"dateUpdated",get:function(){return this.syncDocumentImpl.dateUpdated}},{key:"uniqueName",get:function(){return this.syncDocumentImpl.uniqueName}},{key:"set",value:(a=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.set(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"mutate",value:(i=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.mutate(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"update",value:(r=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.update(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"setTtl",value:(n=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"removeDocument",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.removeDocument());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){ET.default(mT.default(s.prototype),"close",this).call(this),this.syncDocumentImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return ER.type}}]),s}(_R);gT.default(TR,"removed","removed"),gT.default(TR,"updated","updated"),RT([eT.validateTypesAsync(eT.pureObject,["undefined",eT.objectSchema("document metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object,Object]),IT("design:returntype",Promise)],TR.prototype,"set",null),RT([eT.validateTypesAsync("function",["undefined",eT.objectSchema("document metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Function,Object]),IT("design:returntype",Promise)],TR.prototype,"mutate",null),RT([eT.validateTypesAsync(eT.pureObject,["undefined",eT.objectSchema("document metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object,Object]),IT("design:returntype",Promise)],TR.prototype,"update",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],TR.prototype,"setTtl",null);var RR=function(){function e(t){dT.default(this,e),this.descriptor=t}return pT.default(e,[{key:"uri",get:function(){return this.descriptor.uri}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.lastEventId}},{key:"dateUpdated",get:function(){return this.descriptor.dateUpdated}},{key:"dateExpires",get:function(){return this.descriptor.dateExpires}},{key:"index",get:function(){return this.descriptor.index}},{key:"data",get:function(){return this.descriptor.data}},{key:"update",value:function(e,t,n,r){return this.descriptor.lastEventId=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.dateUpdated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.dateExpires=e}}]),e}(),Paginator=function(){function Paginator(e,t,n,r){dT.default(this,Paginator),this.prevToken=n,this.nextToken=r,this.items=e,this.source=t}var e,t;return pT.default(Paginator,[{key:"hasNextPage",get:function(){return!!this.nextToken}},{key:"hasPrevPage",get:function(){return!!this.prevToken}},{key:"nextPage",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasNextPage){e.next=2;break}throw new Error("No next page");case 2:return e.abrupt("return",this.source(this.nextToken));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"prevPage",value:(e=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPrevPage){e.next=2;break}throw new Error("No previous page");case 2:return e.abrupt("return",this.source(this.prevToken));case 3:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})}]),Paginator}();function IR(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return CR(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return CR(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function CR(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var OR=function(){function e(t,n){dT.default(this,e),this.balanceFactor=0,this.key=t,this.value=n,this.parent=null,this.left=null,this.right=null}return pT.default(e,[{key:"isRoot",get:function(){return null===this.parent}},{key:"isLeaf",get:function(){return null===this.left&&null===this.right}},{key:"isLeftChild",get:function(){return this.parent.left===this}},{key:"update",value:function(e){this.value=e}},{key:"replace",value:function(e,t){e&&(this.left===t?this.left=t:this.right===t&&(this.right=t))}}]),e}(),PR=function(){function e(t,n){dT.default(this,e),this.isLessThan=t||function(e,t){return e<t},this.isEqual=n||function(e,t){return e===t},this.root=null,this.count=null}return pT.default(e,[{key:"size",get:function(){return this.count}},{key:"clear",value:function(){this.root=null,this.count=0}},{key:"set",value:function(e,t){var n=this.getNode(e);n?n.update(t):this.insert(e,t)}},{key:"insert",value:function(e,t){var n=new OR(e,t);if(this.count++,this.root){for(var r=this.root;;)if(this.isLessThan(e,r.key)){if(!r.left){r.left=n;break}r=r.left}else{if(!r.right){r.right=n;break}r=r.right}for(n.parent=r,r=n;r.parent;){var i=r.parent,a=i.balanceFactor;if(r.isLeftChild?i.balanceFactor++:i.balanceFactor--,Math.abs(i.balanceFactor)<Math.abs(a))break;if(i.balanceFactor<-1||i.balanceFactor>1){this.rebalance(i);break}r=i}}else this.root=n}},{key:"get",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t.value;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"delete",value:function(e){var t=this.getNode(e);if(!t||t.key!==e)return null;var n=t.parent,r=t.left,i=t.right;if(!!r!=!!i){var a=r||i;n||a?n&&!a?this.root=a:(n.replace(t,null),this.rebalance(n)):this.root=null}else{for(var o=t.left;o.right;)o=o.right;if(t.left===o)t.isRoot?(this.root=o,o.parent=null):(t.isLeftChild?t.parent.left=o:t.parent.right=o,o.parent=t.parent),o.right=t.right,o.right.parent=o,o.balanceFactor=t.balanceFactor,t={parent:o,isLeftChild:!0};else{var s=o.parent,u=o.left;s.right=u,u&&(u.parent=s),t.isRoot?(this.root=o,o.parent=null):(t.isLeftChild?t.parent.left=o:t.parent.right=o,o.parent=t.parent),o.right=t.right,o.right.parent=o,o.left=t.left,o.left.parent=o,o.balanceFactor=t.balanceFactor,t={parent:s,isLeftChild:!1}}}for(this.count--;t.parent;){var c=t.parent,l=c.balanceFactor;if(t.isLeftChild?c.balanceFactor-=1:c.balanceFactor+=1,Math.abs(c.balanceFactor)>Math.abs(l)){if(!(c.balanceFactor<-1||c.balanceFactor>1))break;if(this.rebalance(c),0!==c.parent.balanceFactor)break;t=c.parent}else t=c}return null}},{key:"getNode",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"rebalance",value:function(e){e.balanceFactor<0?e.right.balanceFactor>0?(this.rotateRight(e.right),this.rotateLeft(e)):this.rotateLeft(e):e.balanceFactor>0&&(e.left.balanceFactor<0?(this.rotateLeft(e.left),this.rotateRight(e)):this.rotateRight(e))}},{key:"rotateLeft",value:function(e){var t=e.right;e.right=t.left,null!==t.left&&(t.left.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.left=e,e.parent=t,e.balanceFactor=e.balanceFactor+1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor+1-Math.max(e.balanceFactor,0)}},{key:"rotateRight",value:function(e){var t=e.left;e.left=t.right,null!==t.right&&(t.right.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.right=e,e.parent=t,e.balanceFactor=e.balanceFactor-1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor-1-Math.max(e.balanceFactor,0)}},{key:Symbol.iterator,value:bT.default.mark((function e(){var t,n,r;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=IR(this.getIterator()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"getIterator",value:bT.default.mark((function e(){var t,n,r,i=arguments;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=i.length>0&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(!n){e.next=8;break}if(!this.isEqual(t,n.key)&&(null!==t||n.left)){e.next=5;break}return e.abrupt("break",8);case 5:n=this.isLessThan(t,n.key)||null===t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(!r){e.next=29;break}return e.next=14,[n.key,n.value];case 14:if(r=!1,!n.right){e.next=21;break}for(n=n.right;n.left;)n=n.left;r=!0,e.next=27;break;case 21:if(!n.parent){e.next=26;break}r=n.parent.left===n,n=n.parent,e.next=27;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:if(!n.parent){e.next=34;break}r=n.parent.left===n,n=n.parent,e.next=35;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}}),e,this)}))},{key:"getReverseIterator",value:bT.default.mark((function e(){var t,n,r,i=arguments;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=i.length>0&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(!n){e.next=8;break}if(!this.isEqual(t,n.key)&&(null!==t||n.right)){e.next=5;break}return e.abrupt("break",8);case 5:n=this.isLessThan(t,n.key)&&null!==t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(!r){e.next=29;break}return e.next=14,[n.key,n.value];case 14:if(r=!1,!n.left){e.next=21;break}for(n=n.left;n.right;)n=n.right;r=!0,e.next=27;break;case 21:if(!n.parent){e.next=26;break}r=n.parent.right===n,n=n.parent,e.next=27;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:if(!n.parent){e.next=34;break}r=n.parent.right===n,n=n.parent,e.next=35;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}}),e,this)}))}]),e}();function AR(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return jR(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return jR(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function jR(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var MR=function(){function e(t,n){dT.default(this,e),this.value=t,this.revision=n||0}return pT.default(e,[{key:"isValid",get:function(){return!0}}]),e}(),LR=function(){function e(t){dT.default(this,e),this.revision=t}return pT.default(e,[{key:"isValid",get:function(){return!1}}]),e}(),NR=function(){function e(){dT.default(this,e),this.items=new PR}return pT.default(e,[{key:"store",value:function(e,t,n){var r=this.items.get(e);return r&&r.revision>n?r.isValid?r.value:null:(this.items.set(e,new MR(t,n)),t)}},{key:"delete",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.items.get(e);(!r||r.revision<t||r&&!0===n)&&this.items.set(e,new LR(t))}},{key:"isKnown",value:function(e,t){var n=this.items.get(e);return n&&n.revision>=t}},{key:"get",value:function(e){var t=this.items.get(e);return t&&t.isValid?t.value:null}},{key:"has",value:function(e){var t=this.items.get(e);return t&&t.isValid}},{key:"forEach",value:function(e){if(this.items){var t,n=AR(this.items);try{for(n.s();!(t=n.n()).done;){var r=_T.default(t.value,2),i=r[0],a=r[1];a.isValid&&e(i,a.value)}}catch(e){n.e(e)}finally{n.f()}}}}]),e}();function UR(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}var FR=function(e){vT.default(y,e);var t,n,r,i,a,o,s,u,c,l,f,d,p,h,v=UR(y);function y(e,t,n){var r;dT.default(this,y);return(r=v.call(this,e,n)).updateMergingQueue=new wR((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.cache=new NR,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),r}return pT.default(y,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"list"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"_addOrUpdateItemOnServer",value:(h=fT.default(bT.default.mark((function e(t,n,r,i){var a,o;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={data:n},void 0!==i&&(a.ttl=i),e.next=4,this.services.network.post(t,a,r);case 4:return(o=e.sent).body.data=n,o.body.date_updated=new Date(o.body.date_updated),e.abrupt("return",o.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return h.apply(this,arguments)})},{key:"push",value:(p=fT.default(bT.default.mark((function e(t,n){var r,i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(n||{}).ttl,e.next=3,this._addOrUpdateItemOnServer(this.links.items,t,void 0,r);case 3:return i=e.sent,a=Number(i.index),this._handleItemMutated(a,i.url,i.last_event_id,i.revision,t,i.date_updated,i.date_expires,!0,!1),e.abrupt("return",this.cache.get(a));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"set",value:(d=fT.default(bT.default.mark((function e(t,n,r){var i,a=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,(function(e){return a._updateItemUnconditionally(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return d.apply(this,arguments)})},{key:"_updateItemUnconditionally",value:(f=fT.default(bT.default.mark((function e(t,n,r){var i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return i=e.sent,e.next=5,this._addOrUpdateItemOnServer(i.uri,n,void 0,r);case 5:return a=e.sent,this._handleItemMutated(t,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"_updateItemWithIfMatch",value:(l=fT.default(bT.default.mark((function e(t,n,r){var i,a,o,s;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:if(i=e.sent,!(a=n(GT(i.data)))){e.next=25;break}return o=i.revision,e.prev=6,e.next=9,this._addOrUpdateItemOnServer(i.uri,a,o,r);case 9:return s=e.sent,this._handleItemMutated(t,s.url,s.last_event_id,s.revision,s.data,s.date_updated,s.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 14:if(e.prev=14,e.t0=e.catch(6),412!==e.t0.status){e.next=22;break}return e.next=19,this._getItemFromServer(t);case 19:return e.abrupt("return",this._updateItemWithIfMatch(t,n,r));case 22:throw e.t0;case 23:e.next=26;break;case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(e,t,n){return l.apply(this,arguments)})},{key:"mutate",value:(c=fT.default(bT.default.mark((function e(t,n,r){var i,a=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.add(t,i,(function(e){return a._updateItemWithIfMatch(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"update",value:(u=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,(function(e){return Object.assign(e,n)}),r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"remove",value:(s=fT.default(bT.default.mark((function e(t){var n,r,i;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return n=e.sent,r=GT(n.data),e.next=6,this.services.network.delete(n.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,r,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"get",value:function(){var e=fT.default(bT.default.mark((function e(t){var n;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.cache.get(t))){e.next=5;break}return e.abrupt("return",n);case 5:return e.abrupt("return",this._getItemFromServer(t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:(o=fT.default(bT.default.mark((function e(t){var n;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({index:t});case 2:if(!((n=e.sent).items.length<1)){e.next=7;break}throw new SyncError("No item with index ".concat(t," found"),404,54151);case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"queryItems",value:function(){var e=fT.default(bT.default.mark((function e(t){var n,r,i,a,o=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new qT(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Index",t.index).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return r=e.sent,i=r.body.items.map((function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.index)?o._handleItemMutated(e.index,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(Number(e.index),new RR({index:Number(e.index),uri:e.url,revision:e.revision,lastEventId:e.last_event_id,dateUpdated:e.date_updated,dateExpires:e.date_expires,data:e.data}),e.last_event_id),o.cache.get(e.index)})),a=r.body.meta,e.abrupt("return",new Paginator(i,(function(e){return o.queryItems({pageToken:e})}),a.previous_token,a.next_token));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:(a=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return $T((t=t||{}).pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getContext",value:(i=fT.default(bT.default.mark((function e(){var t;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=5;break}return e.next=3,this.services.network.get(this.links.context);case 3:t=e.sent,this._updateContextIfRequired(t.body.data,t.body.last_event_id);case 5:return e.abrupt("return",this.context);case 6:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"setTtl",value:(r=fT.default(bT.default.mark((function e(t){var n,r;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=fT.default(bT.default.mark((function e(t,n){var r,i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,i={ttl:n},e.next=6,this.services.network.post(r.uri,i);case 6:a=e.sent,r.updateDateExpires(a.body.date_expires);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeList",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){var n=Number(e.item_index);switch(e.date_created=new Date(e.date_created),e.type){case"list_item_added":case"list_item_updated":this._handleItemMutated(n,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"list_item_added"===e.type,!0);break;case"list_item_removed":this._handleItemRemoved(n,e.id,e.item_data,e.date_created,!0);break;case"list_context_updated":this._handleContextUpdate(e.context_data,e.id,e.date_created);break;case"list_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.list_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,a,o,s,u){if(this.shouldIgnoreEvent(e,n))YT("Item ".concat(e," update skipped, current: ").concat(this.lastEventId,", remote: ").concat(n));else{this._updateRootDateUpdated(a);var c=this.cache.get(e);if(!c){var l=new RR({index:e,uri:t,lastEventId:n,revision:r,data:i,dateUpdated:a,dateExpires:o});return this.cache.store(e,l,n),void this.emitItemMutationEvent(l,u,s)}var f=GT(c.data);c.update(n,r,i,a),this.cache.store(e,c,n),void 0!==o&&c.updateDateExpires(o),this.emitItemMutationEvent(c,u,!1,f)}}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=n?"itemAdded":"itemUpdated",a={item:e,isLocal:!t};n||(a.previousItemData=r),this.broadcastEventToListeners(i,a)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{index:e,isLocal:!i,previousItemData:n})}},{key:"_handleContextUpdate",value:function(e,t,n){this._updateRootDateUpdated(n),this._updateContextIfRequired(e,t)&&this.broadcastEventToListeners("contextUpdated",{context:e,isLocal:!1})}},{key:"_updateContextIfRequired",value:function(e,t){return!this.contextEventId||t>this.contextEventId?(this.context=e,this.contextEventId=t,!0):(YT("Context update skipped, current:",this.lastEventId,", remote:",t),!1)}}],[{key:"type",get:function(){return"list"}}]),y}(bR),DR=function(e){vT.default(p,e);var t,n,r,i,a,o,s,u,c,l,f,d=UR(p);function p(e){var t;return dT.default(this,p),(t=d.call(this)).syncListImpl=e,t.syncListImpl.attach(hT.default(t)),t}return pT.default(p,[{key:"uri",get:function(){return this.syncListImpl.uri}},{key:"revision",get:function(){return this.syncListImpl.revision}},{key:"lastEventId",get:function(){return this.syncListImpl.lastEventId}},{key:"links",get:function(){return this.syncListImpl.links}},{key:"dateExpires",get:function(){return this.syncListImpl.dateExpires}},{key:"type",get:function(){return FR.type}},{key:"sid",get:function(){return this.syncListImpl.sid}},{key:"uniqueName",get:function(){return this.syncListImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncListImpl.dateUpdated}},{key:"push",value:(f=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.push(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"set",value:(l=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.set(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"mutate",value:(c=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.mutate(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"update",value:(u=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.update(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"remove",value:(s=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.remove(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"get",value:(o=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.get(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getContext",value:(a=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getContext());case 2:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getItems",value:(i=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getItems(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setTtl",value:(r=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeList",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.removeList());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){ET.default(mT.default(p.prototype),"close",this).call(this),this.syncListImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return FR.type}}]),p}(_R);gT.default(DR,"itemAdded","itemAdded"),gT.default(DR,"itemUpdated","itemUpdated"),gT.default(DR,"itemRemoved","itemRemoved"),gT.default(DR,"removed","removed"),RT([eT.validateTypesAsync(eT.pureObject,["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object,Object]),IT("design:returntype",Promise)],DR.prototype,"push",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger,eT.pureObject,["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Number,Object,Object]),IT("design:returntype",Promise)],DR.prototype,"set",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger,"function",["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Number,Function,Object]),IT("design:returntype",Promise)],DR.prototype,"mutate",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger,eT.pureObject,["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Number,Object,Object]),IT("design:returntype",Promise)],DR.prototype,"update",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],DR.prototype,"remove",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],DR.prototype,"get",null),RT([eT.validateTypesAsync(["undefined",eT.objectSchema("query options",{from:[eT.nonNegativeInteger,"undefined"],pageSize:[eT.custom((function(e){return[VT(e),"a positive integer"]})),"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],DR.prototype,"getItems",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],DR.prototype,"setTtl",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger,eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number,Number]),IT("design:returntype",Promise)],DR.prototype,"setItemTtl",null);var BR=function(){function e(t){dT.default(this,e),this.descriptor=t}return pT.default(e,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"key",get:function(){return this.descriptor.key}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"update",value:function(e,t,n,r){return this.descriptor.last_event_id=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.date_updated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.date_expires=e}}]),e}();function qR(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}var zR=function(e){vT.default(h,e);var t,n,r,i,a,o,s,u,c,l,f,d,p=qR(h);function h(e,t,n){var r;dT.default(this,h);return(r=p.call(this,e,n)).updateMergingQueue=new wR((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.cache=new NR,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),t.items&&t.items.forEach((function(e){e.date_updated=new Date(e.date_updated),r.cache.store(e.key,new BR(e),e.last_event_id)})),r}return pT.default(h,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"map"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"set",value:(d=fT.default(bT.default.mark((function e(t,n,r){var i,a=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,(function(e){return a._putItemUnconditionally(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return d.apply(this,arguments)})},{key:"get",value:function(){var e=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=2;break}throw new SyncError("SyncMapItem key may not be empty",400,54209);case 2:if(!this.cache.has(t)){e.next=6;break}return e.abrupt("return",this.cache.get(t));case 6:return e.abrupt("return",this._getItemFromServer(t));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:(f=fT.default(bT.default.mark((function e(t){var n;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({key:t});case 2:if(!((n=e.sent).items.length<1)){e.next=7;break}throw new SyncError("The specified Map Item does not exist",404,54201);case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"mutate",value:(l=fT.default(bT.default.mark((function e(t,n,r){var i,a=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},e.abrupt("return",this.updateMergingQueue.add(t,i,(function(e){return a._putItemWithIfMatch(t,n,e.ttl)})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"update",value:(c=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,(function(e){return Object.assign(e,n)}),r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"_putItemUnconditionally",value:(u=fT.default(bT.default.mark((function e(t,n,r){var i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._putItemToServer(t,n,void 0,r);case 2:return i=e.sent,a=i.item,this._handleItemMutated(a.key,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,i.added,!1),e.abrupt("return",this.cache.get(a.key));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"_putItemWithIfMatch",value:(s=fT.default(bT.default.mark((function e(t,n,r){var i,a,o,s,u;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t).catch((function(e){if(404===e.status)return new BR({key:t,data:{},last_event_id:-1,revision:"-1",url:null,date_updated:null,date_expires:null});throw e}));case 2:if(i=e.sent,!(a=n(GT(i.data)))){e.next=26;break}return o=i.revision,e.prev=6,e.next=9,this._putItemToServer(t,a,o,r);case 9:return s=e.sent,u=s.item,this._handleItemMutated(u.key,u.url,u.last_event_id,u.revision,u.data,u.date_updated,u.date_expires,s.added,!1),e.abrupt("return",this.cache.get(u.key));case 15:if(e.prev=15,e.t0=e.catch(6),412!==e.t0.status){e.next=23;break}return e.next=20,this._getItemFromServer(t);case 20:return e.abrupt("return",this._putItemWithIfMatch(t,n,r));case 23:throw e.t0;case 24:e.next=27;break;case 26:return e.abrupt("return",i);case 27:case"end":return e.stop()}}),e,this,[[6,15]])}))),function(e,t,n){return s.apply(this,arguments)})},{key:"_putItemToServer",value:(o=fT.default(bT.default.mark((function e(t,n,r,i){var a,o,s,u,c;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new qT(this.links.items).pathSegment(t).build(),o={data:n},void 0!==i&&(o.ttl=i),e.prev=3,e.next=6,this.services.network.put(a,o,r);case 6:return s=e.sent,(u=s.body).data=n,u.date_updated=new Date(u.date_updated),c=201===s.status.code,e.abrupt("return",{added:c,item:u});case 14:throw e.prev=14,e.t0=e.catch(3),404===e.t0.status&&this.onRemoved(!1),e.t0;case 18:case"end":return e.stop()}}),e,this,[[3,14]])}))),function(e,t,n,r){return o.apply(this,arguments)})},{key:"remove",value:(a=fT.default(bT.default.mark((function e(t){var n,r,i;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return n=e.sent,r=GT(n.data),e.next=6,this.services.network.delete(n.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,r,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"queryItems",value:function(){var e=fT.default(bT.default.mark((function e(t){var n,r,i,a,o=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new qT(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Key",t.key).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return r=e.sent,i=r.body.items.map((function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.key)?o._handleItemMutated(e.key,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(e.key,new BR(e),e.last_event_id),o.cache.get(e.key)})),a=r.body.meta,e.abrupt("return",new Paginator(i,(function(e){return o.queryItems({pageToken:e})}),a.previous_token,a.next_token));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:(i=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return $T((t=t||{}).pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){switch(e.date_created=new Date(e.date_created),e.type){case"map_item_added":case"map_item_updated":this._handleItemMutated(e.item_key,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"map_item_added"===e.type,!0);break;case"map_item_removed":this._handleItemRemoved(e.item_key,e.id,e.item_data,e.date_created,!0);break;case"map_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.map_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,a,o,s,u){if(this.shouldIgnoreEvent(e,n))YT("SyncMapItem ",e," update skipped, current:",this.lastEventId,", remote:",n);else{this._updateRootDateUpdated(a);var c=this.cache.get(e);if(!c){var l=new BR({key:e,url:t,last_event_id:n,revision:r,data:i,date_updated:a,date_expires:o});return this.cache.store(e,l,n),void this.emitItemMutationEvent(l,u,s)}var f=GT(c.data);c.update(n,r,i,a),this.cache.store(e,c,n),void 0!==o&&c.updateDateExpires(o),this.emitItemMutationEvent(c,u,!1,f)}}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=n?"itemAdded":"itemUpdated",a={item:e,isLocal:!t};n||(a.previousItemData=r),this.broadcastEventToListeners(i,a)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{key:e,isLocal:!i,previousItemData:n})}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"setTtl",value:(r=fT.default(bT.default.mark((function e(t){var n,r;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=fT.default(bT.default.mark((function e(t,n){var r,i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return r=e.sent,i={ttl:n},e.next=6,this.services.network.post(r.uri,i);case 6:a=e.sent,r.updateDateExpires(a.body.date_expires);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeMap",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"type",get:function(){return"map"}}]),h}(bR),WR=function(e){vT.default(f,e);var t,n,r,i,a,o,s,u,c,l=qR(f);function f(e){var t;return dT.default(this,f),(t=l.call(this)).syncMapImpl=e,t.syncMapImpl.attach(hT.default(t)),t}return pT.default(f,[{key:"uri",get:function(){return this.syncMapImpl.uri}},{key:"links",get:function(){return this.syncMapImpl.links}},{key:"revision",get:function(){return this.syncMapImpl.revision}},{key:"lastEventId",get:function(){return this.syncMapImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncMapImpl.dateExpires}},{key:"type",get:function(){return zR.type}},{key:"sid",get:function(){return this.syncMapImpl.sid}},{key:"uniqueName",get:function(){return this.syncMapImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncMapImpl.dateUpdated}},{key:"set",value:(c=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.set(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"get",value:(u=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.get(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"mutate",value:(s=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.mutate(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"update",value:(o=fT.default(bT.default.mark((function e(t,n,r){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.update(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"remove",value:(a=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.remove(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getItems",value:(i=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.getItems(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setTtl",value:(r=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=fT.default(bT.default.mark((function e(t,n){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeMap",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.next=3,this.syncMapImpl.removeMap();case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){ET.default(mT.default(f.prototype),"close",this).call(this),this.syncMapImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return zR.type}}]),f}(_R);function GR(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}gT.default(WR,"itemAdded","itemAdded"),gT.default(WR,"itemUpdated","itemUpdated"),gT.default(WR,"itemRemoved","itemRemoved"),gT.default(WR,"removed","removed"),RT([eT.validateTypesAsync("string",eT.pureObject,["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[String,Object,Object]),IT("design:returntype",Promise)],WR.prototype,"set",null),RT([eT.validateTypesAsync("string"),IT("design:type",Function),IT("design:paramtypes",[String]),IT("design:returntype",Promise)],WR.prototype,"get",null),RT([eT.validateTypesAsync("string","function",["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[String,Function,Object]),IT("design:returntype",Promise)],WR.prototype,"mutate",null),RT([eT.validateTypesAsync("string",eT.pureObject,["undefined",eT.objectSchema("item metadata",{ttl:[eT.nonNegativeInteger,"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[String,Object,Object]),IT("design:returntype",Promise)],WR.prototype,"update",null),RT([eT.validateTypesAsync("string"),IT("design:type",Function),IT("design:paramtypes",[String]),IT("design:returntype",Promise)],WR.prototype,"remove",null),RT([eT.validateTypesAsync(["undefined",eT.objectSchema("query options",{from:["string","undefined"],pageSize:[eT.custom((function(e){return[VT(e),"a positive integer"]})),"undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],WR.prototype,"getItems",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],WR.prototype,"setTtl",null),RT([eT.validateTypesAsync("string",eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[String,Number]),IT("design:returntype",Promise)],WR.prototype,"setItemTtl",null);var $R=function(e){vT.default(a,e);var t,n,r,i=GR(a);function a(e,t,n){var r;return dT.default(this,a),(r=i.call(this,e,n)).descriptor=t,r}return pT.default(a,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"stream"}},{key:"lastEventId",get:function(){return null}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"publishMessage",value:(r=fT.default(bT.default.mark((function e(t){var n,r,i,a;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={data:t},e.next=3,this.services.network.post(this.links.messages,n);case 3:return r=e.sent,i=r.body,a=this._handleMessagePublished(i.sid,t,!1),e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setTtl",value:(n=fT.default(bT.default.mark((function e(t){var n,r;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n={ttl:t},e.next=4,this.services.network.post(this.uri,n);case 4:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=12;break;case 8:throw e.prev=8,e.t0=e.catch(0),404===e.t0.status&&this.onRemoved(!1),e.t0;case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return n.apply(this,arguments)})},{key:"removeStream",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_update",value:function(e){switch(e.type){case"stream_message_published":this._handleMessagePublished(e.message_sid,e.message_data,!0);break;case"stream_removed":this.onRemoved(!1)}}},{key:"_handleMessagePublished",value:function(e,t,n){var r={sid:e,data:t};return this.broadcastEventToListeners("messagePublished",{message:r,isLocal:!n}),r}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}}],[{key:"type",get:function(){return"stream"}}]),a}(bR);RT([eT.validateTypesAsync(eT.pureObject),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],$R.prototype,"publishMessage",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],$R.prototype,"setTtl",null);var VR=function(e){vT.default(a,e);var t,n,r,i=GR(a);function a(e){var t;return dT.default(this,a),(t=i.call(this)).syncStreamImpl=e,t.syncStreamImpl.attach(hT.default(t)),t}return pT.default(a,[{key:"uri",get:function(){return this.syncStreamImpl.uri}},{key:"links",get:function(){return this.syncStreamImpl.links}},{key:"dateExpires",get:function(){return this.syncStreamImpl.dateExpires}},{key:"type",get:function(){return $R.type}},{key:"lastEventId",get:function(){return null}},{key:"sid",get:function(){return this.syncStreamImpl.sid}},{key:"uniqueName",get:function(){return this.syncStreamImpl.uniqueName}},{key:"publishMessage",value:(r=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.publishMessage(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setTtl",value:(n=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"removeStream",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.removeStream());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){ET.default(mT.default(a.prototype),"close",this).call(this),this.syncStreamImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return $R.type}}]),a}(_R);gT.default(VR,"messagePublished","messagePublished"),gT.default(VR,"removed","removed"),RT([eT.validateTypesAsync(eT.pureObject),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],VR.prototype,"publishMessage",null),RT([eT.validateTypesAsync(eT.nonNegativeInteger),IT("design:type",Function),IT("design:paramtypes",[Number]),IT("design:returntype",Promise)],VR.prototype,"setTtl",null);var JR=function e(t){dT.default(this,e),this.sdk="js",this.sdkVer=t,this.os=TT.os.family,this.osVer=TT.os.version,this.pl=TT.name,this.plVer=TT.version},KR=function(){function e(){dT.default(this,e),this.names=new Map,this.entities=new Map}return pT.default(e,[{key:"store",value:function(e){var t=this.entities.get(e.sid);return t||(this.entities.set(e.sid,e),e.uniqueName&&this.names.set(e.type+"::"+e.uniqueName,e.sid),e)}},{key:"getResolved",value:function(e,t){var n=this.names.get(t+"::"+e);return n?this.entities.get(n):null}},{key:"get",value:function(e,t){return this.entities.get(e)||this.getResolved(e,t)||null}},{key:"remove",value:function(e){var t=this.entities.get(e);t&&(this.entities.delete(e),t.uniqueName&&this.names.delete(t.type+"::"+t.uniqueName))}}]),e}();function HR(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}var YR=function(e){vT.default(n,e);var t=HR(n);function n(e,r,i,a){var o;return dT.default(this,n),(o=t.call(this,r,i)).descriptor=e,o.cache=new NR,a&&a.forEach((function(e){o.cache.store(e.key,{key:e.key,value:e.data},e.revision)})),o}return pT.default(n,[{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return null}},{key:"type",get:function(){return n.type}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"indexName",get:function(){return this.descriptor.indexName}},{key:"queryString",get:function(){return this.descriptor.queryExpression}},{key:"queryUri",get:function(){return this.descriptor.queryUri}},{key:"liveQueryDescriptor",get:function(){return this.descriptor}},{key:"onRemoved",value:function(){}},{key:"getItems",value:function(){var e={};return this.cache.forEach((function(t,n){e[t]=n.value})),e}},{key:"_update",value:function(e,t){switch(e.type){case"live_query_item_updated":this.handleItemMutated(e.item_key,e.item_data,e.item_revision);break;case"live_query_item_removed":this.handleItemRemoved(e.item_key,e.item_revision);break;case"live_query_updated":this.handleBatchUpdate(e.items)}t&&this._advanceLastEventId(e.last_event_id)}},{key:"handleItemMutated",value:function(e,t,n){if(this.shouldIgnoreEvent(e,n))YT("Item ".concat(e," update skipped, revision: ").concat(n));else{var r={key:e,value:t};this.cache.store(e,r,n),this.broadcastEventToListeners("itemUpdated",r)}}},{key:"handleItemRemoved",value:function(e,t){var n=null===t;this.shouldIgnoreEvent(e,t)?YT("Item ".concat(e," delete skipped, revision: ").concat(t)):(this.cache.delete(e,t,n),this.broadcastEventToListeners("itemRemoved",{key:e}))}},{key:"handleBatchUpdate",value:function(e){var t=this,n={};for(var r in null!=e&&e.forEach((function(e){n[e.key]={data:e.data,revision:e.revision}})),this.cache.forEach((function(e,r){var i=n[e];null!=i?t.handleItemMutated(e,i.data,i.revision):t.handleItemRemoved(e,null),delete n[e]})),n)this.handleItemMutated(r,n[r].data,n[r].revision)}},{key:"shouldIgnoreEvent",value:function(e,t){return null!=e&&null!=t&&this.cache.isKnown(e,t)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e)}}],[{key:"type",get:function(){return"live_query"}}]),n}(bR);function QR(e){return XR.apply(this,arguments)}function XR(){return XR=fT.default(bT.default.mark((function e(t){var n,r,i,a,o,s;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.network,r=t.queryString,i=t.uri,a=t.type,null!=r){e.next=3;break}throw new SyncError("Invalid query",400,54507);case 3:return o={query_string:r},a===ZR.type&&(o.type=a),e.next=7,n.post(i,o,void 0,!0);case 7:return s=e.sent,e.abrupt("return",s.body);case 9:case"end":return e.stop()}}),e)}))),XR.apply(this,arguments)}var ZR=function(e){vT.default(n,e);var t=HR(n);function n(e){var r;return dT.default(this,n),(r=t.call(this)).liveQueryImpl=e,r.liveQueryImpl.attach(hT.default(r)),r}return pT.default(n,[{key:"type",get:function(){return YR.type}},{key:"lastEventId",get:function(){return this.liveQueryImpl.lastEventId}},{key:"sid",get:function(){return this.liveQueryImpl.sid}},{key:"close",value:function(){ET.default(mT.default(n.prototype),"close",this).call(this),this.liveQueryImpl.detach(this.listenerUuid)}},{key:"getItems",value:function(){return this.ensureNotClosed(),this.liveQueryImpl.getItems()}}],[{key:"type",get:function(){return YR.type}}]),n}(_R);gT.default(ZR,"itemUpdated","itemUpdated"),gT.default(ZR,"itemRemoved","itemRemoved");var eI=function(e){vT.default(i,e);var t,n,r=HR(i);function i(e){var t;return dT.default(this,i),t=r.call(this),gT.default(hT.default(t),"queryExpression",null),gT.default(hT.default(t),"items",{}),Object.assign(hT.default(t),e),t.updateIndexName(e.indexName),t}return pT.default(i,[{key:"type",get:function(){return i.type}},{key:"search",value:(n=fT.default(bT.default.mark((function e(t){var n=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.items={},e.abrupt("return",QR({network:this.network,uri:this.queryUri,queryString:t}).then((function(e){n.queryExpression=t,e.items&&e.items.forEach((function(e){n.items[e.key]=e.data})),n.emit("searchResult",n.getItems())})).catch((function(e){throw ZT("Error '".concat(e.message,"' while executing query '").concat(t,"'")),n.queryExpression=null,e})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"subscribe",value:(t=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.queryExpression){e.next=2;break}return e.abrupt("return",Promise.reject(new SyncError("Invalid query",400,54507)));case 2:return e.abrupt("return",this.liveQueryCreator(this.indexName,this.queryExpression));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getItems",value:function(){return this.items}},{key:"updateIndexName",value:function(e){this.indexName=e,this.queryUri=this.generateQueryUri(this.indexName)}},{key:"generateQueryUri",value:function(e){return new qT(this.insightsUri).pathSegment(e).pathSegment("Items").build()}}],[{key:"type",get:function(){return"instant_query"}}]),i}(OT);gT.default(eI,"searchResult","searchResult"),RT([eT.validateTypesAsync("string"),IT("design:type",Function),IT("design:paramtypes",[String]),IT("design:returntype",Promise)],eI.prototype,"search",null),RT([eT.validateTypes(eT.nonEmptyString),IT("design:type",Function),IT("design:paramtypes",[String]),IT("design:returntype",void 0)],eI.prototype,"updateIndexName",null);function tI(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=mT.default(e);if(t){var i=mT.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return yT.default(this,n)}}function nI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function rI(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nI(Object(n),!0).forEach((function(t){gT.default(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nI(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var iI="data_sync",aI="3.1.0";function oI(e){if(e){if("string"==typeof e)return{id:e,mode:"open_or_create"};var t=e.mode||(e.id?"open_or_create":"create_new");return rI(rI({},e),{},{mode:t})}return{mode:"create_new"}}var sI="com.twilio.rtd.cds.document",uI="com.twilio.rtd.cds.list",cI="com.twilio.rtd.cds.map",lI="twilio.sync.event",Client=function(e){vT.default(Client,e);var t,n,r,i,a,o,s,u,c,l,f,d,p,h,v,y=tI(Client);function Client(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(dT.default(this,Client),t=y.call(this),!e)throw new Error("Sync library needs a valid Twilio token to be passed");n.hasOwnProperty("logLevel")?HT(n.logLevel):HT("silent");var r=n.productId=n.productId||iI;n.clientMetadata=n.clientMetadata||{},n.clientMetadata.hasOwnProperty("type")||(n.clientMetadata.type="sync"),n.clientMetadata.hasOwnProperty("sdk")||(n.clientMetadata.sdk="JS",n.clientMetadata.sdkv=aI);var i=!n.twilsockClient;if(!n.initRegistrations){var a=new tT.InitRegistration(r);Client.populateInitRegistrations(a),n.initRegistrations=[a]}var o=n.twilsockClient=n.twilsockClient||new tT.Twilsock(e,r,n);o.on("tokenAboutToExpire",(function(e){return t.emit("tokenAboutToExpire",e)})),o.on("tokenExpired",(function(){return t.emit("tokenExpired")})),o.on("connectionError",(function(e){return t.emit("connectionError",e)})),o.on("stateChanged",(function(e){t.emit("connectionStateChanged",e),t.services.subscriptions.onConnectionStateChanged("connected"===e)})),o.on("message",(function(e,n){return t._routeMessage(e,n)}));var s=new sR(n),u=new vR(new JR(aI),s,o),c=new yR(s);return t.services={config:s,twilsock:o,network:u,storage:c,router:hT.default(t),subscriptions:null},t.services.subscriptions=new fR(t.services),t.entities=new KR,i&&o.connect(),t}return pT.default(Client,[{key:"_routeMessage",value:function(e,t){switch(YT("Notification type:",e,"content:",t),e){case sI:case uI:case cI:this.services.subscriptions.acceptMessage(t,!1);break;case lI:this.services.subscriptions.acceptMessage(t,!0)}}},{key:"_subscribe",value:function(e,t){this.services.subscriptions.add(e,t)}},{key:"_unsubscribe",value:function(e){this.services.subscriptions.remove(e)}},{key:"connectionState",get:function(){return this.services.twilsock.state}},{key:"ensureReady",value:(v=fT.default(bT.default.mark((function e(){var t;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.services.config.sessionStorageEnabled){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.services.twilsock.storageId();case 5:t=e.sent,this.services.storage.updateStorageId(t.id),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),XT("Failed to initialize storage",e.t0);case 12:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(){return v.apply(this,arguments)})},{key:"storeRootInSessionCache",value:function(e,t,n){if(this.services.config.sessionStorageEnabled&&t){var r=GT(n);e!==DR.type&&e!==WR.type||(r.last_event_id=null,delete r.items),this.services.storage.store(e,t,r)}}},{key:"readRootFromSessionCache",value:function(e,t){return this.services.config.sessionStorageEnabled&&t?this.services.storage.read(e,t):null}},{key:"_get",value:(h=fT.default(bT.default.mark((function e(t,n){var r,i,a,o=arguments;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>2&&void 0!==o[2]&&o[2],n){e.next=3;break}throw new SyncError("Cannot get entity without id",404);case 3:return i=new qT(t).pathSegment(n).queryParam("Include",r?"items":void 0).build(),e.next=6,this.services.network.get(i);case 6:return a=e.sent,e.abrupt("return",a.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"_createDocument",value:function(e,t,n){var r={unique_name:e,data:t||{}};return void 0!==n&&(r.ttl=n),this.services.network.post(this.services.config.documentsUri,r).then((function(e){return e.body.data=r.data,e.body}))}},{key:"_getDocument",value:(p=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(TR.type,t)||this._get(this.services.config.documentsUri,t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"_createList",value:function(e,t,n,r){var i={unique_name:e,purpose:t,context:n};return void 0!==r&&(i.ttl=r),this.services.network.post(this.services.config.listsUri,i).then((function(e){return e.body}))}},{key:"_getList",value:(d=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(DR.type,t)||this._get(this.services.config.listsUri,t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"_createMap",value:function(e,t){var n={unique_name:e};return void 0!==t&&(n.ttl=t),this.services.network.post(this.services.config.mapsUri,n).then((function(e){return e.body}))}},{key:"_getMap",value:(f=fT.default(bT.default.mark((function e(t){var n,r=arguments;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.readRootFromSessionCache(WR.type,t)||this._get(this.services.config.mapsUri,t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"_getStream",value:(l=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(VR.type,t)||this._get(this.services.config.streamsUri,t,!1));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"_createStream",value:(c=fT.default(bT.default.mark((function e(t,n){var r,i;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={unique_name:t},void 0!==n&&(r.ttl=n),e.next=4,this.services.network.post(this.services.config.streamsUri,r);case 4:return i=e.sent,e.abrupt("return",i.body);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"_getLiveQuery",value:function(e){return this.readRootFromSessionCache(ZR.type,e)}},{key:"getCached",value:function(e,t){return e&&this.entities.get(e,t)||null}},{key:"removeFromCacheAndSession",value:function(e,t,n){this.entities.remove(t),this.services.config.sessionStorageEnabled&&this.services.storage.remove(e,t,n)}},{key:"document",value:(u=fT.default(bT.default.mark((function e(t){var n,r,i,a,o=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=oI(t)).mode){e.next=9;break}return e.next=6,this._createDocument(n.id,n.data,n.ttl);case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,TR.type))){e.next=14;break}return e.abrupt("return",new TR(i));case 14:return e.prev=14,e.next=17,this._getDocument(n.id);case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createDocument(n.id,n.data,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.document(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(TR.type,n.id,r),a=new ER(this.services,r,(function(e,t,n){return o.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new TR(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return u.apply(this,arguments)})},{key:"map",value:(s=fT.default(bT.default.mark((function e(t){var n,r,i,a,o=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=oI(t)).mode){e.next=9;break}return e.next=6,this._createMap(n.id,n.ttl);case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,WR.type))){e.next=14;break}return e.abrupt("return",new WR(i));case 14:return e.prev=14,e.next=17,this._getMap(n.id,n.includeItems);case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createMap(n.id,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.map(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(WR.type,n.id,r),a=new zR(this.services,r,(function(e,t,n){return o.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new WR(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return s.apply(this,arguments)})},{key:"list",value:(o=fT.default(bT.default.mark((function e(t){var n,r,i,a,o=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=oI(t)).mode){e.next=9;break}return e.next=6,this._createList(n.id,n.purpose,n.context,n.ttl);case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,DR.type))){e.next=14;break}return e.abrupt("return",new DR(i));case 14:return e.prev=14,e.next=17,this._getList(n.id);case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createList(n.id,n.purpose,n.context,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.list(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(DR.type,n.id,r),a=new FR(this.services,r,(function(e,t,n){return o.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new DR(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return o.apply(this,arguments)})},{key:"stream",value:(a=fT.default(bT.default.mark((function e(t){var n,r,i,a,o,s=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=oI(t)).mode){e.next=9;break}return e.next=6,this._createStream(n.id,n.ttl);case 6:case 17:case 29:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,VR.type))){e.next=14;break}return e.abrupt("return",new VR(i));case 14:return e.prev=14,e.next=17,this._getStream(n.id);case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createStream(n.id,n.ttl);case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.stream(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(VR.type,n.id,r),a=function(e,t,n){return s.removeFromCacheAndSession(e,t,n)},o=new $R(this.services,r,a),o=this.entities.store(o),e.abrupt("return",new VR(o));case 44:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return a.apply(this,arguments)})},{key:"shutdown",value:(i=fT.default(bT.default.mark((function e(){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.subscriptions.shutdown();case 2:return e.next=4,this.services.twilsock.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"updateToken",value:(r=fT.default(bT.default.mark((function e(t){return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.twilsock.updateToken(t).catch((function(e){var t,n=null==e||null===(t=e.reply)||void 0===t?void 0:t.status;if(401===(null==n?void 0:n.code)&&"UNAUTHORIZED"===(null==n?void 0:n.status))throw new SyncError("Updated token was rejected by server",400,51130);throw e})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"liveQuery",value:(n=fT.default(bT.default.mark((function e(t,n){var r,i,a,o,s,u=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return r=new qT(this.services.config.insightsUri).pathSegment(t).pathSegment("Items").build(),e.next=5,QR({network:this.services.network,uri:r,queryString:n,type:ZR.type});case 5:return i=e.sent,(a=this.getCached(i.query_id,ZR.type))||((o=this._getLiveQuery(i.query_id))||(o={indexName:t,queryExpression:n,sid:i.query_id,queryUri:r,last_event_id:i.last_event_id}),s=function(e,t,n){return u.removeFromCacheAndSession(e,t,n)},a=new YR(o,this.services,s,i.items)),this.storeRootInSessionCache(ZR.type,i.query_id,a.liveQueryDescriptor),a=this.entities.store(a),e.abrupt("return",new ZR(a));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"instantQuery",value:(t=fT.default(bT.default.mark((function e(t){var n,r=this;return bT.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return n=function(e,t){return r.liveQuery(e,t)},e.abrupt("return",new eI({indexName:t,network:this.services.network,insightsUri:this.services.config.insightsUri,liveQueryCreator:n}));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"populateInitRegistrations",value:function(e){e.populateInitRegistrations([lI,sI,uI,cI])}},{key:"version",get:function(){return aI}}]),Client}(OT);gT.default(Client,"connectionStateChanged","connectionStateChanged"),gT.default(Client,"connectionError","connectionError"),gT.default(Client,"tokenAboutToExpire","tokenAboutToExpire"),gT.default(Client,"tokenExpired","tokenExpired"),RT([eT.validateTypesAsync(["undefined","string",eT.objectSchema("open document options",{id:["string","undefined"],mode:[eT.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[eT.nonNegativeInteger,"undefined"],data:[eT.pureObject,"undefined",eT.literal(null)]})]),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],Client.prototype,"document",null),RT([eT.validateTypesAsync(["undefined","string",eT.objectSchema("open map options",{id:["string","undefined"],mode:[eT.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[eT.nonNegativeInteger,"undefined"],data:[eT.pureObject,"undefined",eT.literal(null)],includeItems:["boolean","undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],Client.prototype,"map",null),RT([eT.validateTypesAsync(["undefined","string",eT.objectSchema("open list options",{id:["string","undefined"],mode:[eT.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[eT.nonNegativeInteger,"undefined"],data:[eT.pureObject,"undefined",eT.literal(null)],purpose:["string","undefined"],context:[eT.pureObject,"undefined"],includeItems:["boolean","undefined"]})]),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],Client.prototype,"list",null),RT([eT.validateTypesAsync(["undefined","string",eT.objectSchema("open stream options",{id:["string","undefined"],mode:[eT.literal("open_or_create","open_existing","create_new"),"undefined"],ttl:[eT.nonNegativeInteger,"undefined"],data:[eT.pureObject,"undefined",eT.literal(null)]})]),IT("design:type",Function),IT("design:paramtypes",[Object]),IT("design:returntype",Promise)],Client.prototype,"stream",null),RT([eT.validateTypesAsync(eT.nonEmptyString),IT("design:type",Function),IT("design:paramtypes",[String]),IT("design:returntype",Promise)],Client.prototype,"updateToken",null),RT([eT.validateTypesAsync(eT.nonEmptyString,"string"),IT("design:type",Function),IT("design:paramtypes",[String,String]),IT("design:returntype",Promise)],Client.prototype,"liveQuery",null),RT([eT.validateTypesAsync(eT.nonEmptyString),IT("design:type",Function),IT("design:paramtypes",[String]),IT("design:returntype",Promise)],Client.prototype,"instantQuery",null),WE.Client=Client,WE.InsightsItem=function e(){dT.default(this,e)},WE.InstantQuery=eI,WE.LiveQuery=ZR,WE.Paginator=Paginator;var fI=WE.SyncClient=Client;function dI(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function pI(e,t,n){return pI=dI()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&Ia(i,n.prototype),i},pI.apply(null,arguments)}function hI(e){var t="function"==typeof Map?new Map:void 0;return hI=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return pI(e,arguments,Aa(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),Ia(r,e)},hI(e)}WE.SyncDocument=TR,WE.SyncList=DR,WE.SyncListItem=RR,WE.SyncMap=WR,WE.SyncMapItem=BR,WE.SyncStream=VR;var vI,yI={},mI=DS,gI=function(e){if(mI(e))throw TypeError("The method doesn't accept regular expressions");return e},bI=pe("match"),kI=function(e){var t=/./;try{"/./"[e](t)}catch(n){try{return t[bI]=!1,"/./"[e](t)}catch(e){}}return!1},wI=Rn,xI=a.f,_I=Ut,SI=Sr,EI=gI,TI=k,RI=kI,II="".startsWith,CI=Math.min,OI=RI("startsWith");wI({target:"String",proto:!0,forced:!!(OI||(vI=xI(String.prototype,"startsWith"),!vI||vI.writable))&&!OI},{startsWith:function(e){var t=SI(TI(this));EI(e);var n=_I(CI(arguments.length>1?arguments[1]:void 0,t.length)),r=SI(e);return II?II.call(t,r,n):t.slice(n,n+r.length)===r}});var PI=O_.left,AI=L,jI=Vo;Rn({target:"Array",proto:!0,forced:!rc("reduce")||!jI&&AI>79&&AI<83},{reduce:function(e){return PI(this,e,arguments.length,arguments.length>1?arguments[1]:void 0)}});var MI=o,LI=pe("iterator"),NI=!MI((function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,n="";return e.pathname="c%20d",t.forEach((function(e,r){t.delete("b"),n+=r+e})),!t.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[LI]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://тест").host||"#%D0%B1"!==new URL("http://a#б").hash||"a1c3"!==n||"x"!==new URL("http://x",void 0).host})),UI=2147483647,FI=/[^\0-\u007E]/,DI=/[.\u3002\uFF0E\uFF61]/g,BI="Overflow: input needs wider integers to process",qI=Math.floor,zI=String.fromCharCode,WI=function(e){return e+22+75*(e<26)},GI=function(e,t,n){var r=0;for(e=n?qI(e/700):e>>1,e+=qI(e/t);e>455;r+=36)e=qI(e/35);return qI(r+36*e/(e+38))},$I=function(e){var t=[];e=function(e){for(var t=[],n=0,r=e.length;n<r;){var i=e.charCodeAt(n++);if(i>=55296&&i<=56319&&n<r){var a=e.charCodeAt(n++);56320==(64512&a)?t.push(((1023&i)<<10)+(1023&a)+65536):(t.push(i),n--)}else t.push(i)}return t}(e);var n,r,i=e.length,a=128,o=0,s=72;for(n=0;n<e.length;n++)(r=e[n])<128&&t.push(zI(r));var u=t.length,c=u;for(u&&t.push("-");c<i;){var l=UI;for(n=0;n<e.length;n++)(r=e[n])>=a&&r<l&&(l=r);var f=c+1;if(l-a>qI((UI-o)/f))throw RangeError(BI);for(o+=(l-a)*f,a=l,n=0;n<e.length;n++){if((r=e[n])<a&&++o>UI)throw RangeError(BI);if(r==a){for(var d=o,p=36;;p+=36){var h=p<=s?1:p>=s+26?26:p-s;if(d<h)break;var v=d-h,y=36-h;t.push(zI(WI(h+v%y))),d=qI(v/y)}t.push(zI(WI(d))),s=GI(o,f,c==u),o=0,++c}}++o,++a}return t.join("")},VI=Rn,JI=R,KI=NI,HI=Je.exports,YI=Qa,QI=Pn,XI=Hl,ZI=xt,eC=so,tC=ee,nC=Fr,rC=Wa,iC=Fe,aC=S,oC=Sr,sC=tr,uC=h,cC=ko,lC=mo,fC=pe,dC=JI("fetch"),pC=JI("Request"),hC=pC&&pC.prototype,vC=JI("Headers"),yC=fC("iterator"),mC="URLSearchParams",gC="URLSearchParamsIterator",bC=ZI.set,kC=ZI.getterFor(mC),wC=ZI.getterFor(gC),xC=/\+/g,_C=Array(4),SC=function(e){return _C[e-1]||(_C[e-1]=RegExp("((?:%[\\da-f]{2}){"+e+"})","gi"))},EC=function(e){try{return decodeURIComponent(e)}catch(t){return e}},TC=function(e){var t=e.replace(xC," "),n=4;try{return decodeURIComponent(t)}catch(e){for(;n;)t=t.replace(SC(n--),EC);return t}},RC=/[!'()~]|%20/g,IC={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},CC=function(e){return IC[e]},OC=function(e){return encodeURIComponent(e).replace(RC,CC)},PC=function(e,t){if(t)for(var n,r,i=t.split("&"),a=0;a<i.length;)(n=i[a++]).length&&(r=n.split("="),e.push({key:TC(r.shift()),value:TC(r.join("="))}))},AC=function(e){this.entries.length=0,PC(this.entries,e)},jC=function(e,t){if(e<t)throw TypeError("Not enough arguments")},MC=XI((function(e,t){bC(this,{type:gC,iterator:cC(kC(e).entries),kind:t})}),"Iterator",(function(){var e=wC(this),t=e.kind,n=e.iterator.next(),r=n.value;return n.done||(n.value="keys"===t?r.key:"values"===t?r.value:[r.key,r.value]),n})),LC=function(){eC(this,LC,mC);var e,t,n,r,i,a,o,s,u,c=arguments.length>0?arguments[0]:void 0,l=this,f=[];if(bC(l,{type:mC,entries:f,updateURL:function(){},updateSearchParams:AC}),void 0!==c)if(aC(c))if("function"==typeof(e=lC(c)))for(n=(t=cC(c,e)).next;!(r=n.call(t)).done;){if((o=(a=(i=cC(iC(r.value))).next).call(i)).done||(s=a.call(i)).done||!a.call(i).done)throw TypeError("Expected sequence with length 2");f.push({key:oC(o.value),value:oC(s.value)})}else for(u in c)tC(c,u)&&f.push({key:u,value:oC(c[u])});else PC(f,"string"==typeof c?"?"===c.charAt(0)?c.slice(1):c:oC(c))},NC=LC.prototype;if(YI(NC,{append:function(e,t){jC(arguments.length,2);var n=kC(this);n.entries.push({key:oC(e),value:oC(t)}),n.updateURL()},delete:function(e){jC(arguments.length,1);for(var t=kC(this),n=t.entries,r=oC(e),i=0;i<n.length;)n[i].key===r?n.splice(i,1):i++;t.updateURL()},get:function(e){jC(arguments.length,1);for(var t=kC(this).entries,n=oC(e),r=0;r<t.length;r++)if(t[r].key===n)return t[r].value;return null},getAll:function(e){jC(arguments.length,1);for(var t=kC(this).entries,n=oC(e),r=[],i=0;i<t.length;i++)t[i].key===n&&r.push(t[i].value);return r},has:function(e){jC(arguments.length,1);for(var t=kC(this).entries,n=oC(e),r=0;r<t.length;)if(t[r++].key===n)return!0;return!1},set:function(e,t){jC(arguments.length,1);for(var n,r=kC(this),i=r.entries,a=!1,o=oC(e),s=oC(t),u=0;u<i.length;u++)(n=i[u]).key===o&&(a?i.splice(u--,1):(a=!0,n.value=s));a||i.push({key:o,value:s}),r.updateURL()},sort:function(){var e,t,n,r=kC(this),i=r.entries,a=i.slice();for(i.length=0,n=0;n<a.length;n++){for(e=a[n],t=0;t<n;t++)if(i[t].key>e.key){i.splice(t,0,e);break}t===n&&i.push(e)}r.updateURL()},forEach:function(e){for(var t,n=kC(this).entries,r=nC(e,arguments.length>1?arguments[1]:void 0,3),i=0;i<n.length;)r((t=n[i++]).value,t.key,this)},keys:function(){return new MC(this,"keys")},values:function(){return new MC(this,"values")},entries:function(){return new MC(this,"entries")}},{enumerable:!0}),HI(NC,yC,NC.entries),HI(NC,"toString",(function(){for(var e,t=kC(this).entries,n=[],r=0;r<t.length;)e=t[r++],n.push(OC(e.key)+"="+OC(e.value));return n.join("&")}),{enumerable:!0}),QI(LC,mC),VI({global:!0,forced:!KI},{URLSearchParams:LC}),!KI&&"function"==typeof vC){var UC=function(e){if(aC(e)){var t,n=e.body;if(rC(n)===mC)return(t=e.headers?new vC(e.headers):new vC).has("content-type")||t.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"),sC(e,{body:uC(0,String(n)),headers:uC(0,t)})}return e};if("function"==typeof dC&&VI({global:!0,enumerable:!0,forced:!0},{fetch:function(e){return dC(e,arguments.length>1?UC(arguments[1]):{})}}),"function"==typeof pC){var FC=function(e){return eC(this,FC,"Request"),new pC(e,arguments.length>1?UC(arguments[1]):{})};hC.constructor=FC,FC.prototype=hC,VI({global:!0,forced:!0},{Request:FC})}}var DC,BC={URLSearchParams:LC,getState:kC},qC=Rn,zC=s,WC=NI,GC=i,$C=zn,VC=Je.exports,JC=so,KC=ee,HC=qE,YC=bl,QC=Il.codeAt,XC=function(e){var t,n,r=[],i=e.toLowerCase().replace(DI,".").split(".");for(t=0;t<i.length;t++)n=i[t],r.push(FI.test(n)?"xn--"+$I(n):n);return r.join(".")},ZC=Sr,eO=Pn,tO=BC,nO=xt,rO=GC.URL,iO=tO.URLSearchParams,aO=tO.getState,oO=nO.set,sO=nO.getterFor("URL"),uO=Math.floor,cO=Math.pow,lO="Invalid scheme",fO="Invalid host",dO="Invalid port",pO=/[A-Za-z]/,hO=/[\d+-.A-Za-z]/,vO=/\d/,yO=/^0x/i,mO=/^[0-7]+$/,gO=/^\d+$/,bO=/^[\dA-Fa-f]+$/,kO=/[\0\t\n\r #%/:<>?@[\\\]^|]/,wO=/[\0\t\n\r #/:<>?@[\\\]^|]/,xO=/^[\u0000-\u0020]+|[\u0000-\u0020]+$/g,_O=/[\t\n\r]/g,SO=function(e,t){var n,r,i;if("["==t.charAt(0)){if("]"!=t.charAt(t.length-1))return fO;if(!(n=TO(t.slice(1,-1))))return fO;e.host=n}else if(MO(e)){if(t=XC(t),kO.test(t))return fO;if(null===(n=EO(t)))return fO;e.host=n}else{if(wO.test(t))return fO;for(n="",r=YC(t),i=0;i<r.length;i++)n+=AO(r[i],IO);e.host=n}},EO=function(e){var t,n,r,i,a,o,s,u=e.split(".");if(u.length&&""==u[u.length-1]&&u.pop(),(t=u.length)>4)return e;for(n=[],r=0;r<t;r++){if(""==(i=u[r]))return e;if(a=10,i.length>1&&"0"==i.charAt(0)&&(a=yO.test(i)?16:8,i=i.slice(8==a?1:2)),""===i)o=0;else{if(!(10==a?gO:8==a?mO:bO).test(i))return e;o=parseInt(i,a)}n.push(o)}for(r=0;r<t;r++)if(o=n[r],r==t-1){if(o>=cO(256,5-t))return null}else if(o>255)return null;for(s=n.pop(),r=0;r<n.length;r++)s+=n[r]*cO(256,3-r);return s},TO=function(e){var t,n,r,i,a,o,s,u=[0,0,0,0,0,0,0,0],c=0,l=null,f=0,d=function(){return e.charAt(f)};if(":"==d()){if(":"!=e.charAt(1))return;f+=2,l=++c}for(;d();){if(8==c)return;if(":"!=d()){for(t=n=0;n<4&&bO.test(d());)t=16*t+parseInt(d(),16),f++,n++;if("."==d()){if(0==n)return;if(f-=n,c>6)return;for(r=0;d();){if(i=null,r>0){if(!("."==d()&&r<4))return;f++}if(!vO.test(d()))return;for(;vO.test(d());){if(a=parseInt(d(),10),null===i)i=a;else{if(0==i)return;i=10*i+a}if(i>255)return;f++}u[c]=256*u[c]+i,2!=++r&&4!=r||c++}if(4!=r)return;break}if(":"==d()){if(f++,!d())return}else if(d())return;u[c++]=t}else{if(null!==l)return;f++,l=++c}}if(null!==l)for(o=c-l,c=7;0!=c&&o>0;)s=u[c],u[c--]=u[l+o-1],u[l+--o]=s;else if(8!=c)return;return u},RO=function(e){var t,n,r,i;if("number"==typeof e){for(t=[],n=0;n<4;n++)t.unshift(e%256),e=uO(e/256);return t.join(".")}if("object"==typeof e){for(t="",r=function(e){for(var t=null,n=1,r=null,i=0,a=0;a<8;a++)0!==e[a]?(i>n&&(t=r,n=i),r=null,i=0):(null===r&&(r=a),++i);return i>n&&(t=r,n=i),t}(e),n=0;n<8;n++)i&&0===e[n]||(i&&(i=!1),r===n?(t+=n?":":"::",i=!0):(t+=e[n].toString(16),n<7&&(t+=":")));return"["+t+"]"}return e},IO={},CO=HC({},IO,{" ":1,'"':1,"<":1,">":1,"`":1}),OO=HC({},CO,{"#":1,"?":1,"{":1,"}":1}),PO=HC({},OO,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),AO=function(e,t){var n=QC(e,0);return n>32&&n<127&&!KC(t,e)?e:encodeURIComponent(e)},jO={ftp:21,file:null,http:80,https:443,ws:80,wss:443},MO=function(e){return KC(jO,e.scheme)},LO=function(e){return""!=e.username||""!=e.password},NO=function(e){return!e.host||e.cannotBeABaseURL||"file"==e.scheme},UO=function(e,t){var n;return 2==e.length&&pO.test(e.charAt(0))&&(":"==(n=e.charAt(1))||!t&&"|"==n)},FO=function(e){var t;return e.length>1&&UO(e.slice(0,2))&&(2==e.length||"/"===(t=e.charAt(2))||"\\"===t||"?"===t||"#"===t)},DO=function(e){var t=e.path,n=t.length;!n||"file"==e.scheme&&1==n&&UO(t[0],!0)||t.pop()},BO=function(e){return"."===e||"%2e"===e.toLowerCase()},qO={},zO={},WO={},GO={},$O={},VO={},JO={},KO={},HO={},YO={},QO={},XO={},ZO={},eP={},tP={},nP={},rP={},iP={},aP={},oP={},sP={},uP=function(e,t,n,r){var i,a,o,s,u,c=n||qO,l=0,f="",d=!1,p=!1,h=!1;for(n||(e.scheme="",e.username="",e.password="",e.host=null,e.port=null,e.path=[],e.query=null,e.fragment=null,e.cannotBeABaseURL=!1,t=t.replace(xO,"")),t=t.replace(_O,""),i=YC(t);l<=i.length;){switch(a=i[l],c){case qO:if(!a||!pO.test(a)){if(n)return lO;c=WO;continue}f+=a.toLowerCase(),c=zO;break;case zO:if(a&&(hO.test(a)||"+"==a||"-"==a||"."==a))f+=a.toLowerCase();else{if(":"!=a){if(n)return lO;f="",c=WO,l=0;continue}if(n&&(MO(e)!=KC(jO,f)||"file"==f&&(LO(e)||null!==e.port)||"file"==e.scheme&&!e.host))return;if(e.scheme=f,n)return void(MO(e)&&jO[e.scheme]==e.port&&(e.port=null));f="","file"==e.scheme?c=eP:MO(e)&&r&&r.scheme==e.scheme?c=GO:MO(e)?c=KO:"/"==i[l+1]?(c=$O,l++):(e.cannotBeABaseURL=!0,e.path.push(""),c=aP)}break;case WO:if(!r||r.cannotBeABaseURL&&"#"!=a)return lO;if(r.cannotBeABaseURL&&"#"==a){e.scheme=r.scheme,e.path=r.path.slice(),e.query=r.query,e.fragment="",e.cannotBeABaseURL=!0,c=sP;break}c="file"==r.scheme?eP:VO;continue;case GO:if("/"!=a||"/"!=i[l+1]){c=VO;continue}c=HO,l++;break;case $O:if("/"==a){c=YO;break}c=iP;continue;case VO:if(e.scheme=r.scheme,a==DC)e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.query=r.query;else if("/"==a||"\\"==a&&MO(e))c=JO;else if("?"==a)e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.query="",c=oP;else{if("#"!=a){e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.path.pop(),c=iP;continue}e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,e.path=r.path.slice(),e.query=r.query,e.fragment="",c=sP}break;case JO:if(!MO(e)||"/"!=a&&"\\"!=a){if("/"!=a){e.username=r.username,e.password=r.password,e.host=r.host,e.port=r.port,c=iP;continue}c=YO}else c=HO;break;case KO:if(c=HO,"/"!=a||"/"!=f.charAt(l+1))continue;l++;break;case HO:if("/"!=a&&"\\"!=a){c=YO;continue}break;case YO:if("@"==a){d&&(f="%40"+f),d=!0,o=YC(f);for(var v=0;v<o.length;v++){var y=o[v];if(":"!=y||h){var m=AO(y,PO);h?e.password+=m:e.username+=m}else h=!0}f=""}else if(a==DC||"/"==a||"?"==a||"#"==a||"\\"==a&&MO(e)){if(d&&""==f)return"Invalid authority";l-=YC(f).length+1,f="",c=QO}else f+=a;break;case QO:case XO:if(n&&"file"==e.scheme){c=nP;continue}if(":"!=a||p){if(a==DC||"/"==a||"?"==a||"#"==a||"\\"==a&&MO(e)){if(MO(e)&&""==f)return fO;if(n&&""==f&&(LO(e)||null!==e.port))return;if(s=SO(e,f))return s;if(f="",c=rP,n)return;continue}"["==a?p=!0:"]"==a&&(p=!1),f+=a}else{if(""==f)return fO;if(s=SO(e,f))return s;if(f="",c=ZO,n==XO)return}break;case ZO:if(!vO.test(a)){if(a==DC||"/"==a||"?"==a||"#"==a||"\\"==a&&MO(e)||n){if(""!=f){var g=parseInt(f,10);if(g>65535)return dO;e.port=MO(e)&&g===jO[e.scheme]?null:g,f=""}if(n)return;c=rP;continue}return dO}f+=a;break;case eP:if(e.scheme="file","/"==a||"\\"==a)c=tP;else{if(!r||"file"!=r.scheme){c=iP;continue}if(a==DC)e.host=r.host,e.path=r.path.slice(),e.query=r.query;else if("?"==a)e.host=r.host,e.path=r.path.slice(),e.query="",c=oP;else{if("#"!=a){FO(i.slice(l).join(""))||(e.host=r.host,e.path=r.path.slice(),DO(e)),c=iP;continue}e.host=r.host,e.path=r.path.slice(),e.query=r.query,e.fragment="",c=sP}}break;case tP:if("/"==a||"\\"==a){c=nP;break}r&&"file"==r.scheme&&!FO(i.slice(l).join(""))&&(UO(r.path[0],!0)?e.path.push(r.path[0]):e.host=r.host),c=iP;continue;case nP:if(a==DC||"/"==a||"\\"==a||"?"==a||"#"==a){if(!n&&UO(f))c=iP;else if(""==f){if(e.host="",n)return;c=rP}else{if(s=SO(e,f))return s;if("localhost"==e.host&&(e.host=""),n)return;f="",c=rP}continue}f+=a;break;case rP:if(MO(e)){if(c=iP,"/"!=a&&"\\"!=a)continue}else if(n||"?"!=a)if(n||"#"!=a){if(a!=DC&&(c=iP,"/"!=a))continue}else e.fragment="",c=sP;else e.query="",c=oP;break;case iP:if(a==DC||"/"==a||"\\"==a&&MO(e)||!n&&("?"==a||"#"==a)){if(".."===(u=(u=f).toLowerCase())||"%2e."===u||".%2e"===u||"%2e%2e"===u?(DO(e),"/"==a||"\\"==a&&MO(e)||e.path.push("")):BO(f)?"/"==a||"\\"==a&&MO(e)||e.path.push(""):("file"==e.scheme&&!e.path.length&&UO(f)&&(e.host&&(e.host=""),f=f.charAt(0)+":"),e.path.push(f)),f="","file"==e.scheme&&(a==DC||"?"==a||"#"==a))for(;e.path.length>1&&""===e.path[0];)e.path.shift();"?"==a?(e.query="",c=oP):"#"==a&&(e.fragment="",c=sP)}else f+=AO(a,OO);break;case aP:"?"==a?(e.query="",c=oP):"#"==a?(e.fragment="",c=sP):a!=DC&&(e.path[0]+=AO(a,IO));break;case oP:n||"#"!=a?a!=DC&&("'"==a&&MO(e)?e.query+="%27":e.query+="#"==a?"%23":AO(a,IO)):(e.fragment="",c=sP);break;case sP:a!=DC&&(e.fragment+=AO(a,CO))}l++}},cP=function(e){var t,n,r=JC(this,cP,"URL"),i=arguments.length>1?arguments[1]:void 0,a=ZC(e),o=oO(r,{type:"URL"});if(void 0!==i)if(i instanceof cP)t=sO(i);else if(n=uP(t={},ZC(i)))throw TypeError(n);if(n=uP(o,a,null,t))throw TypeError(n);var s=o.searchParams=new iO,u=aO(s);u.updateSearchParams(o.query),u.updateURL=function(){o.query=String(s)||null},zC||(r.href=fP.call(r),r.origin=dP.call(r),r.protocol=pP.call(r),r.username=hP.call(r),r.password=vP.call(r),r.host=yP.call(r),r.hostname=mP.call(r),r.port=gP.call(r),r.pathname=bP.call(r),r.search=kP.call(r),r.searchParams=wP.call(r),r.hash=xP.call(r))},lP=cP.prototype,fP=function(){var e=sO(this),t=e.scheme,n=e.username,r=e.password,i=e.host,a=e.port,o=e.path,s=e.query,u=e.fragment,c=t+":";return null!==i?(c+="//",LO(e)&&(c+=n+(r?":"+r:"")+"@"),c+=RO(i),null!==a&&(c+=":"+a)):"file"==t&&(c+="//"),c+=e.cannotBeABaseURL?o[0]:o.length?"/"+o.join("/"):"",null!==s&&(c+="?"+s),null!==u&&(c+="#"+u),c},dP=function(){var e=sO(this),t=e.scheme,n=e.port;if("blob"==t)try{return new cP(t.path[0]).origin}catch(e){return"null"}return"file"!=t&&MO(e)?t+"://"+RO(e.host)+(null!==n?":"+n:""):"null"},pP=function(){return sO(this).scheme+":"},hP=function(){return sO(this).username},vP=function(){return sO(this).password},yP=function(){var e=sO(this),t=e.host,n=e.port;return null===t?"":null===n?RO(t):RO(t)+":"+n},mP=function(){var e=sO(this).host;return null===e?"":RO(e)},gP=function(){var e=sO(this).port;return null===e?"":String(e)},bP=function(){var e=sO(this),t=e.path;return e.cannotBeABaseURL?t[0]:t.length?"/"+t.join("/"):""},kP=function(){var e=sO(this).query;return e?"?"+e:""},wP=function(){return sO(this).searchParams},xP=function(){var e=sO(this).fragment;return e?"#"+e:""},_P=function(e,t){return{get:e,set:t,configurable:!0,enumerable:!0}};if(zC&&$C(lP,{href:_P(fP,(function(e){var t=sO(this),n=ZC(e),r=uP(t,n);if(r)throw TypeError(r);aO(t.searchParams).updateSearchParams(t.query)})),origin:_P(dP),protocol:_P(pP,(function(e){var t=sO(this);uP(t,ZC(e)+":",qO)})),username:_P(hP,(function(e){var t=sO(this),n=YC(ZC(e));if(!NO(t)){t.username="";for(var r=0;r<n.length;r++)t.username+=AO(n[r],PO)}})),password:_P(vP,(function(e){var t=sO(this),n=YC(ZC(e));if(!NO(t)){t.password="";for(var r=0;r<n.length;r++)t.password+=AO(n[r],PO)}})),host:_P(yP,(function(e){var t=sO(this);t.cannotBeABaseURL||uP(t,ZC(e),QO)})),hostname:_P(mP,(function(e){var t=sO(this);t.cannotBeABaseURL||uP(t,ZC(e),XO)})),port:_P(gP,(function(e){var t=sO(this);NO(t)||(""==(e=ZC(e))?t.port=null:uP(t,e,ZO))})),pathname:_P(bP,(function(e){var t=sO(this);t.cannotBeABaseURL||(t.path=[],uP(t,ZC(e),rP))})),search:_P(kP,(function(e){var t=sO(this);""==(e=ZC(e))?t.query=null:("?"==e.charAt(0)&&(e=e.slice(1)),t.query="",uP(t,e,oP)),aO(t.searchParams).updateSearchParams(t.query)})),searchParams:_P(wP),hash:_P(xP,(function(e){var t=sO(this);""!=(e=ZC(e))?("#"==e.charAt(0)&&(e=e.slice(1)),t.fragment="",uP(t,e,sP)):t.fragment=null}))}),VC(lP,"toJSON",(function(){return fP.call(this)}),{enumerable:!0}),VC(lP,"toString",(function(){return fP.call(this)}),{enumerable:!0}),rO){var SP=rO.createObjectURL,EP=rO.revokeObjectURL;SP&&VC(cP,"createObjectURL",(function(e){return SP.apply(rO,arguments)})),EP&&VC(cP,"revokeObjectURL",(function(e){return EP.apply(rO,arguments)}))}function TP(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}function RP(e){return function(e){if(Array.isArray(e))return fm(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||dm(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}eO(cP,"URL"),qC({global:!0,forced:!WC,sham:!zC},{URL:cP}),function(e){var t=void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};Object.defineProperty(e,"__esModule",{value:!0});var n=Ry.exports,r=zg.exports,i=Wg,a=_f.exports,o=ng,s=mh;function u(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}function c(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}var l=u(n),f=u(r),d=u(i),p=c(a),h={exports:{}},v="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(v){var y=new Uint8Array(16);h.exports=function(){return v(y),y}}else{var m=new Array(16);h.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),m[t]=e>>>((3&t)<<3)&255;return m}}for(var g=[],b=0;b<256;++b)g[b]=(b+256).toString(16).substr(1);var k,w,x=function(e,t){var n=t||0,r=g;return[r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]]].join("")},_=h.exports,S=x,E=0,T=0;var R=function(e,t,n){var r=t&&n||0,i=t||[],a=(e=e||{}).node||k,o=void 0!==e.clockseq?e.clockseq:w;if(null==a||null==o){var s=_();null==a&&(a=k=[1|s[0],s[1],s[2],s[3],s[4],s[5]]),null==o&&(o=w=16383&(s[6]<<8|s[7]))}var u=void 0!==e.msecs?e.msecs:(new Date).getTime(),c=void 0!==e.nsecs?e.nsecs:T+1,l=u-E+(c-T)/1e4;if(l<0&&void 0===e.clockseq&&(o=o+1&16383),(l<0||u>E)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");E=u,T=c,w=o;var f=(1e4*(268435455&(u+=122192928e5))+c)%4294967296;i[r++]=f>>>24&255,i[r++]=f>>>16&255,i[r++]=f>>>8&255,i[r++]=255&f;var d=u/4294967296*1e4&268435455;i[r++]=d>>>8&255,i[r++]=255&d,i[r++]=d>>>24&15|16,i[r++]=d>>>16&255,i[r++]=o>>>8|128,i[r++]=255&o;for(var p=0;p<6;++p)i[r+p]=a[p];return t||S(i)},I=h.exports,C=x;var O=function(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var i=(e=e||{}).random||(e.rng||I)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var a=0;a<16;++a)t[r+a]=i[a];return t||C(i)},P=R,A=O,j=A;j.v1=P,j.v4=A;var M=j,L=function(e){Ca(n,e);var t=TP(n);function n(e){var r;Na(this,n);var i,a=M.v4();return(r=t.call(this,(function(t,r){return i=r,e((function(e){n.cancellationMap.delete(a),t(e)}),(function(e){n.cancellationMap.delete(a),r(e)}),(function(e){n.cancellationMap.set(a,e)}))}))).id=a,r.rejectPromise=i,r}return La(n,[{key:"cancel",value:function(){var e=n.cancellationMap.get(this.id);return null==e||e(),this.rejectPromise&&(this.catch((function(){})),this.rejectPromise(new Error("Promise was cancelled"))),this}}]),n}(hI(Promise));function N(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":Oa(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o}function U(e,t){if("object"===("undefined"==typeof Reflect?"undefined":Oa(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function F(e,t){return["".concat((new Date).toISOString()," MCS Client ").concat(e,":")].concat(Array.from(t))}l.default(L,"cancellationMap",new Map);var D=function(){function e(t){Na(this,e),l.default(this,"prefix",""),this.prefix=null!=t&&t.length>0?t+" ":""}return La(e,[{key:"setLevel",value:function(e){p.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.trace.apply(null,F(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.debug.apply(null,F(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.info.apply(null,F(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.warn.apply(null,F(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.error.apply(null,F(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){p.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.trace.apply(null,F("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.debug.apply(null,F("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.info.apply(null,F("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.warn.apply(null,F("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];p.error.apply(null,F("E",t))}}]),e}(),B=function(e,t){return"".concat((n=e,n.startsWith("http")?"":function(e){return"https://mcs.".concat(null!=e?e:"us1",".twilio.com")}(t))).concat(e);var n},q=function(){function e(t,n,r,i){var a,o,s,u,c,l;Na(this,e);var f=null!==(a=null!==(o=i.MCS)&&void 0!==o?o:i)&&void 0!==a?a:{};this.region=null!==(s=null!==(u=f.region)&&void 0!==u?u:i.region)&&void 0!==s?s:"us1",this.mediaUrl=B(n,this.region),this.mediaSetUrl=r?B(r):"".concat(this.mediaUrl,"Set"),this.token=t,this.retryWhenThrottledOverride=null===(c=f.retryWhenThrottledOverride)||void 0===c||c,this.backoffConfigOverride=null!==(l=f.backoffConfigOverride)&&void 0!==l?l:e.backoffConfigDefault}return La(e,[{key:"updateToken",value:function(e){this.token=e}}],[{key:"backoffConfigDefault",get:function(){return{min:1e3,max:4e3,maxAttemptsCount:3}}},{key:"retryWhenThrottledDefault",get:function(){return true}}]),e}(),Media=function(){function Media(e,t,n){Na(this,Media),this.config=e,this.network=t,this._update(n)}return La(Media,[{key:"sid",get:function(){return this.state.sid}},{key:"serviceSid",get:function(){return this.state.serviceSid}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"fileName",get:function(){return this.state.filename}},{key:"filename",get:function(){return this.state.filename}},{key:"category",get:function(){return this.state.category}},{key:"getContentUrl",value:function(){var e=this;return new L(function(){var t=f.default(d.default.mark((function t(n,r,i){var a,o;return d.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.network.get("".concat(e.config.mediaUrl,"/").concat(e.sid)),i((function(){return a.cancel()})),t.prev=2,t.next=5,a;case 5:o=t.sent,e._update(o.body),n(e.state.contentDirectUrl),t.next=13;break;case 10:t.prev=10,t.t0=t.catch(2),r(t.t0);case 13:case"end":return t.stop()}}),t,null,[[2,10]])})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"_update",value:function(e){var t,n,r,i;this.state={sid:e.sid,serviceSid:e.service_sid,channelSid:e.channel_sid,messageSid:e.message_sid,dateCreated:e.date_created?new Date(e.date_created):null,dateUploadUpdated:e.date_upload_updated?new Date(e.date_upload_updated):null,dateUpdated:e.date_updated?new Date(e.date_updated):null,size:e.size,contentType:e.content_type,author:e.author,url:e.url,contentUrl:e.links.content,contentDirectUrl:null!==(t=e.links.content_direct_temporary)&&void 0!==t?t:null,filename:null!==(n=e.filename)&&void 0!==n?n:null,category:null!==(r=e.category)&&void 0!==r?r:"media",isMultipartUpstream:null!==(i=e.is_multipart_upstream)&&void 0!==i&&i}}}]),Media}(),z=function(e){Ca(n,e);var t=TP(n);function n(e,r,i,a,o){var s;return Na(this,n),(s=t.call(this,e)).code=r,s.body=i,s.status=a,s.headers=o,s}return La(n)}(hI(Error)),W=t.XMLHttpRequest||{};var G,$=function(){function e(){Na(this,e)}return La(e,[{key:"get",value:function(t,n){return e.request("GET",t,n)}},{key:"post",value:function(t,n,r){return e.request("POST",t,n,r)}}],[{key:"request",value:function(e,t,n,r){return new L((function(i,a,o){var s=new W,u=!1;for(var c in o((function(){s.abort(),u=!0})),s.open(e,t,!0),s.onreadystatechange=function(){if(4===s.readyState&&!u){var e,t=(e=s.getAllResponseHeaders())?e.split("\r\n").map((function(e){return e.split(": ")})).filter((function(e){return 2===e.length&&e[1].length>0})).reduce((function(e,t){return e[t[0]]=t[1],e}),{}):{},n=function(e){var t=e.getResponseHeader("Content-Type");if(!t||0!==t.indexOf("application/json")||0===e.responseText.length)return e.responseText;try{return JSON.parse(e.responseText)}catch(t){return e.responseText}}(s);if(200<=s.status&&s.status<300)i({status:s.status,headers:t,body:n});else{var r,o,c=null!==(r=s.statusText)&&void 0!==r?r:"NONE";if("string"==typeof n)if(n&&1===n.split("\n",2).length)o=n;else{var l,f=null===(l=n.replace(/<.*?>/g,"").split(/\r\n/g).filter((function(e){return e.length}))[0])||void 0===l?void 0:l.split(" ");o=(null==f?void 0:f.length)>2?null==f?void 0:f.slice(1).join(" "):""}else o=JSON.stringify(n);var d="".concat(s.status,": [").concat(c,"] ").concat(o);a(new z(d,s.status,n,c,t))}}},n)s.setRequestHeader(c,n[c]),"Content-Type"===c&&"application/json"===n[c]&&(r=JSON.stringify(r));s.send(r)}))}}]),e}(),V=D.scope("Network"),J=function(){function e(t,n){Na(this,e),this.config=t,this.transport=n}return La(e,[{key:"backoffConfig",value:function(){return Object.assign(q.backoffConfigDefault,this.config.backoffConfigOverride)}},{key:"retryWhenThrottled",value:function(){var e,t;return null!==(e=null!==(t=this.config.retryWhenThrottledOverride)&&void 0!==t?t:q.retryWhenThrottledDefault)&&void 0!==e&&e}},{key:"executeWithRetry",value:function(e,t){var n=this;return new L(function(){var r=f.default(d.default.mark((function r(i,a,s){var u,c;return d.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:u=new o.Retrier(n.backoffConfig()),c=[502,503,504],t&&c.push(429),s((function(){u.cancel(),u.removeAllListeners()})),u.on("attempt",f.default(d.default.mark((function t(){var n,r;return d.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,n=e(),s((function(){n.cancel(),u.cancel(),u.removeAllListeners()})),t.next=5,n;case 5:r=t.sent,u.succeeded(r),t.next=12;break;case 9:t.prev=9,t.t0=t.catch(0),c.indexOf(t.t0.status)>-1||"Twilsock disconnected"===t.t0.message?u.failed(t.t0):(u.removeAllListeners(),u.cancel(),a(t.t0));case 12:case"end":return t.stop()}}),t,null,[[0,9]])})))),u.on("succeeded",(function(e){i(e)})),u.on("cancelled",(function(e){return a(e)})),u.on("failed",(function(e){return a(e)})),u.start();case 9:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}())}},{key:"get",value:function(e){var t=this;return new L(function(){var n=f.default(d.default.mark((function n(r,i,a){var o,s,u;return d.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o={"X-Twilio-Token":t.config.token},s=t.executeWithRetry((function(){return t.transport.get(e,o)}),t.retryWhenThrottled()),V.trace("sending GET request to ",e," headers ",o),a((function(){return s.cancel()})),n.prev=4,n.next=7,s;case 7:u=n.sent,V.trace("response",u),r(u),n.next=16;break;case 12:n.prev=12,n.t0=n.catch(4),V.debug("get() error ".concat(n.t0)),i(n.t0);case 16:case"end":return n.stop()}}),n,null,[[4,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"post",value:function(e,n,r,i,a){var o=this,s={"X-Twilio-Token":this.config.token};"undefined"!=typeof FormData&&r instanceof FormData||!i||Object.assign(s,{"Content-Type":i});var u=new URL(e);return n&&u.searchParams.append("Category",n),a&&u.searchParams.append("Filename",a),new L(function(){var n=f.default(d.default.mark((function n(i,a,c){var l,f;return d.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return l=o.transport.post(u.href,s,r),c((function(){return l.cancel()})),V.trace("sending POST request to ".concat(e," with headers ").concat(s)),n.prev=3,n.next=6,l;case 6:f=n.sent,n.next=17;break;case 9:if(n.prev=9,n.t0=n.catch(3),!(void 0===t.XMLHttpRequest&&r instanceof FormData)){n.next=14;break}return a(new TypeError("Posting FormData supported only with browser engine's FormData")),n.abrupt("return");case 14:return V.debug("post() error ".concat(n.t0)),a(n.t0),n.abrupt("return");case 17:V.trace("response",f),i(f);case 19:case"end":return n.stop()}}),n,null,[[3,9]])})));return function(e,t,r){return n.apply(this,arguments)}}())}}]),e}(),K=D.scope("");e.default=(G=function(){function Client(e,t,n){var r,i;Na(this,Client);var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};this.options=a,this.options.logLevel=null!==(r=this.options.logLevel)&&void 0!==r?r:"silent",this.config=new q(e,t,n,this.options),K.setLevel(this.options.logLevel),this.options.transport=null!==(i=this.options.transport)&&void 0!==i?i:new $,this.transport=this.options.transport,this.network=new J(this.config,this.transport)}return La(Client,[{key:"updateToken",value:function(e){K.info("updateToken"),this.config.updateToken(e)}},{key:"get",value:function(e){var t=this;return new L(function(){var n=f.default(d.default.mark((function n(r,i,a){var o,s;return d.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o=t.network.get("".concat(t.config.mediaUrl,"/").concat(e)),a((function(){return o.cancel()})),n.prev=2,n.next=5,o;case 5:s=n.sent,r(new Media(t.config,t.network,s.body)),n.next=12;break;case 9:n.prev=9,n.t0=n.catch(2),i(n.t0);case 12:case"end":return n.stop()}}),n,null,[[2,9]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"post",value:function(e,t,n,r){var i=this;return new L(function(){var a=f.default(d.default.mark((function a(o,s,u){var c,l;return d.default.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return c=i.network.post(i.config.mediaUrl,null!=n?n:"media",t,e,r),u((function(){return c.cancel()})),a.prev=2,a.next=5,c;case 5:l=a.sent,o(new Media(i.config,i.network,l.body)),a.next=12;break;case 9:a.prev=9,a.t0=a.catch(2),s(a.t0);case 12:case"end":return a.stop()}}),a,null,[[2,9]])})));return function(e,t,n){return a.apply(this,arguments)}}())}},{key:"postFormData",value:function(e,t){var n=this;return new L(function(){var r=f.default(d.default.mark((function r(i,a,o){var s,u;return d.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return s=n.network.post(n.config.mediaUrl,null!=t?t:"media",e),o((function(){return s.cancel()})),r.prev=2,r.next=5,s;case 5:u=r.sent,i(new Media(n.config,n.network,u.body)),r.next=12;break;case 9:r.prev=9,r.t0=r.catch(2),a(r.t0);case 12:case"end":return r.stop()}}),r,null,[[2,9]])})));return function(e,t,n){return r.apply(this,arguments)}}())}},{key:"mediaSetGet",value:function(e){var t=this;return new L(function(){var n=f.default(d.default.mark((function n(r,i,a){var o,s,u,c;return d.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o={command:"get",list:e.map((function(e){return{media_sid:e}}))},s=t.network.post("".concat(t.config.mediaSetUrl),null,o,"application/json"),a((function(){return s.cancel()})),n.prev=3,n.next=6,s;case 6:u=n.sent,c=u.body.map((function(e){if(200===e.code)return new Media(t.config,t.network,e.media_record);i("Failed to obtain detailed information about Media items (failed SID ".concat(e.media_record.sid,")"))})),r(c),n.next=14;break;case 11:n.prev=11,n.t0=n.catch(3),i(n.t0);case 14:case"end":return n.stop()}}),n,null,[[3,11]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"mediaSetGetContentUrls",value:function(e){var t=this;return new L(function(){var n=f.default(d.default.mark((function n(r,i,a){var o,s,u,c;return d.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o={command:"get",list:e.map((function(e){return{media_sid:e}}))},s=t.network.post("".concat(t.config.mediaSetUrl),null,o,"application/json"),a((function(){return s.cancel()})),n.prev=3,n.next=6,s;case 6:u=n.sent,c=new Map,u.body.forEach((function(e){200===e.code?c.set(e.media_record.sid,e.media_record.links.content_direct_temporary):i("Failed to obtain detailed information about Media items (failed SID ".concat(e.media_record.sid,")"))})),r(c),n.next=15;break;case 12:n.prev=12,n.t0=n.catch(3),i(n.t0);case 15:case"end":return n.stop()}}),n,null,[[3,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}}]),Client}(),l.default(G,"version","0.6.1"),G),N([s.validateTypes(s.nonEmptyString),U("design:type",Function),U("design:paramtypes",[String]),U("design:returntype",void 0)],e.default.prototype,"updateToken",null),N([s.validateTypesAsync(s.nonEmptyString),U("design:type",Function),U("design:paramtypes",[String]),U("design:returntype",L)],e.default.prototype,"get",null),e.default=N([s.validateConstructorTypes(s.nonEmptyString,s.nonEmptyString,[s.nonEmptyString,s.literal(null)],[s.pureObject,"undefined"]),U("design:paramtypes",[String,String,Object,Object])],e.default),e.CancellablePromise=L,e.Client=e.default,e.McsClient=e.default,e.McsMedia=Media,e.Media=Media}(yI);var IP=Ut,CP=Mt,OP=nk.aTypedArray;(0,nk.exportTypedArrayMethod)("at",(function(e){var t=OP(this),n=IP(t.length),r=CP(e),i=r>=0?r:n+r;return i<0||i>=n?void 0:t[i]}));var PP=oo,AP="ArrayBuffer",jP=pw.ArrayBuffer;function MP(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}Rn({global:!0,forced:i.ArrayBuffer!==jP},{ArrayBuffer:jP}),PP(AP);var LP=If.scope("Participant"),Participant=function(e){Ca(Participant,e);var t,n,r,i=MP(Participant);function Participant(e,t,n,r,a){var o,s,u;if(Na(this,Participant),(u=i.call(this)).conversation=n,u.links=r,u.services=a,u.state={attributes:vh(e.attributes,"Retrieved malformed attributes from the server for participant: "+t,LP),dateCreated:e.dateCreated?hh(e.dateCreated):null,dateUpdated:e.dateCreated?hh(e.dateUpdated):null,sid:t,typingTimeout:null,isTyping:!1,identity:e.identity,roleSid:null!==(o=e.roleSid)&&void 0!==o?o:"",lastReadMessageIndex:Number.isInteger(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,lastReadTimestamp:e.lastConsumptionTimestamp?hh(e.lastConsumptionTimestamp):null,type:e.type||"chat",userInfo:e.userInfo,bindings:null!==(s=e.bindings)&&void 0!==s?s:{}},!e.identity&&!e.type)throw new Error("Received invalid Participant object from server: Missing identity or type of Participant.");return u}return La(Participant,[{key:"sid",get:function(){return this.state.sid}},{key:"attributes",get:function(){return this.state.attributes}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"identity",get:function(){return this.state.identity}},{key:"isTyping",get:function(){return this.state.isTyping}},{key:"lastReadMessageIndex",get:function(){return this.state.lastReadMessageIndex}},{key:"lastReadTimestamp",get:function(){return this.state.lastReadTimestamp}},{key:"roleSid",get:function(){return this.state.roleSid}},{key:"type",get:function(){return this.state.type}},{key:"bindings",get:function(){var e;return null!==(e=this.state.bindings)&&void 0!==e?e:{}}},{key:"_startTyping",value:function(e){var t=this;return this.state.typingTimeout&&clearTimeout(this.state.typingTimeout),this.state.isTyping=!0,this.emit("typingStarted",this),this.conversation.emit("typingStarted",this),this.state.typingTimeout=Number(setTimeout((function(){return t._endTyping()}),e)),this}},{key:"_endTyping",value:function(){this.state.typingTimeout&&(this.state.isTyping=!1,this.emit("typingEnded",this),this.conversation.emit("typingEnded",this),clearInterval(this.state.typingTimeout),this.state.typingTimeout=null)}},{key:"_update",value:function(e){var t=[],n=vh(e.attributes,"Retrieved malformed attributes from the server for participant: "+this.state.sid,LP);e.attributes&&!um(this.state.attributes,n)&&(this.state.attributes=n,t.push("attributes"));var r=hh(e.dateUpdated);e.dateUpdated&&(null==r?void 0:r.getTime())!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=r,t.push("dateUpdated"));var i=hh(e.dateCreated);if(e.dateCreated&&(null==i?void 0:i.getTime())!==(this.state.dateCreated&&this.state.dateCreated.getTime())&&(this.state.dateCreated=i,t.push("dateCreated")),e.roleSid&&this.state.roleSid!==e.roleSid&&(this.state.roleSid=e.roleSid,t.push("roleSid")),!Number.isInteger(e.lastConsumedMessageIndex)&&null!==e.lastConsumedMessageIndex||this.state.lastReadMessageIndex===e.lastConsumedMessageIndex||(this.state.lastReadMessageIndex=e.lastConsumedMessageIndex,t.push("lastReadMessageIndex")),e.lastConsumptionTimestamp){var a=new Date(e.lastConsumptionTimestamp);this.state.lastReadTimestamp&&this.state.lastReadTimestamp.getTime()===a.getTime()||(this.state.lastReadTimestamp=a,t.push("lastReadTimestamp"))}return e.bindings&&!um(this.state.bindings,e.bindings)&&(this.state.bindings=e.bindings,t.push("bindings")),t.length>0&&this.emit("updated",{participant:this,updateReasons:t}),this}},{key:"getUser",value:(r=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("chat"==this.type){e.next=2;break}throw new Error("Getting User is not supported for this Participant type: "+this.type);case 2:return e.abrupt("return",this.services.users.getUser(this.state.identity,this.state.userInfo));case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"remove",value:(n=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.conversation.removeParticipant(this));case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"updateAttributes",value:(t=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(t)});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),Participant}(om);function NP(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}ja(Participant,"typingStarted","typingStarted"),ja(Participant,"typingEnded","typingEnded"),ja(Participant,"updated","updated"),$c([wy(xy),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],Participant.prototype,"updateAttributes",null);var UP=If.scope("Participants"),FP=function(e){Ca(l,e);var t,n,r,i,a,o,s,u,c=NP(l);function l(e,t,n,r,i){var a;return Na(this,l),ja(Ra(a=c.call(this)),"rosterEntityPromise",null),a.conversation=e,a.participants=t,a.links=n,a.configuration=r,a.services=i,a}return La(l,[{key:"unsubscribe",value:(u=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.rosterEntityPromise){e.next=6;break}return e.next=3,this.rosterEntityPromise;case 3:e.sent.close(),this.rosterEntityPromise=null;case 6:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"subscribe",value:function(e){var t=this,n="string"==typeof e?this.services.syncClient.map({id:e,mode:"open_existing"}):Promise.resolve(e);return this.rosterEntityPromise=this.rosterEntityPromise||n.then((function(e){e.on("itemAdded",(function(e){UP.debug(t.conversation.sid+" itemAdded: "+e.item.key),t.upsertParticipant(e.item.key,e.item.data).then((function(e){t.emit("participantJoined",e)}))})),e.on("itemRemoved",(function(e){UP.debug(t.conversation.sid+" itemRemoved: "+e.key);var n=e.key;if(t.participants.has(n)){var r=t.participants.get(n);t.participants.delete(n),r&&t.emit("participantLeft",r)}})),e.on("itemUpdated",(function(e){UP.debug(t.conversation.sid+" itemUpdated: "+e.item.key),t.upsertParticipant(e.item.key,e.item.data)}));var n=[];return e.getItems().then((function e(r){return r.items.forEach((function(e){n.push(t.upsertParticipant(e.key,e.data))})),r.hasNextPage?r.nextPage().then(e):null})).then((function(){return Promise.all(n)})).then((function(){return e}))})).catch((function(e){throw t.rosterEntityPromise=null,"disconnected"!=t.services.syncClient.connectionState&&UP.error("Failed to get roster object for conversation",t.conversation.sid,e),UP.debug("ERROR: Failed to get roster object for conversation",t.conversation.sid,e),e}))}},{key:"upsertParticipantFromResponse",value:(s=Ta(Wc.mark((function e(t){var n,r,i,a,o,s,u,c;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.sid,i=t.attributes,a=t.date_created,o=t.date_updated,s=t.identity,u=t.role_sid,c=t.messaging_binding,e.next=3,this.upsertParticipant(r,{attributes:i,dateCreated:new Date(a),dateUpdated:new Date(o),identity:s,roleSid:u,lastConsumedMessageIndex:null,lastConsumptionTimestamp:null,type:null!==(n=null==c?void 0:c.type)&&void 0!==n?n:"chat"});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"upsertParticipant",value:(o=Ta(Wc.mark((function e(t,n){var r,i,a=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.participants.get(t))){e.next=3;break}return e.abrupt("return",r._update(n));case 3:return i={self:"".concat(this.links.participants,"/").concat(t)},r=new Participant(n,t,this.conversation,i,this.services),this.participants.set(t,r),r.on("updated",(function(e){return a.emit("participantUpdated",e)})),e.abrupt("return",r);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"getParticipants",value:(a=Ta(Wc.mark((function e(){var t=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then((function(){var e=[];return t.participants.forEach((function(t){return e.push(t)})),e})):[]);case 1:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getParticipantBySid",value:(i=Ta(Wc.mark((function e(t){var n=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then((function(){var e=n.participants.get(t);if(!e)throw new Error("Participant with SID "+t+" was not found");return e})):null);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(r=Ta(Wc.mark((function e(t){var n,r=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.abrupt("return",this.rosterEntityPromise?this.rosterEntityPromise.then((function(){if(r.participants.forEach((function(e){e.identity===t&&(n=e)})),!n)throw new Error("Participant with identity "+t+" was not found");return n})):null);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"add",value:(n=Ta(Wc.mark((function e(t,n){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:t,attributes:void 0!==n?JSON.stringify(n):void 0});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"addNonChatParticipant",value:(t=Ta(Wc.mark((function e(t,n){var r,i,a,o,s=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=s.length>2&&void 0!==s[2]?s[2]:{},o=s.length>3&&void 0!==s[3]?s[3]:{},e.next=4,this.services.commandExecutor.mutateResource("post",this.links.participants,{attributes:void 0!==a?JSON.stringify(a):void 0,messaging_binding:{address:n,proxy_address:t,name:null==o||null===(r=o.email)||void 0===r?void 0:r.name,level:null==o||null===(i=o.email)||void 0===i?void 0:i.level}});case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"remove",value:function(e){return this.services.commandExecutor.mutateResource("delete","".concat(this.links.participants,"/").concat(e))}}]),l}(om),DP=Rn,BP=Ln,qP=Q,zP=Ut,WP=Sr,GP=o,$P=Q_,VP=rc,JP=Z_,KP=eS,HP=L,YP=nS,QP=[],XP=QP.sort,ZP=GP((function(){QP.sort(void 0)})),eA=GP((function(){QP.sort(null)})),tA=VP("sort"),nA=!GP((function(){if(HP)return HP<70;if(!(JP&&JP>3)){if(KP)return!0;if(YP)return YP<603;var e,t,n,r,i="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(r=0;r<47;r++)QP.push({k:t+r,v:n})}for(QP.sort((function(e,t){return t.v-e.v})),r=0;r<QP.length;r++)t=QP[r].k.charAt(0),i.charAt(i.length-1)!==t&&(i+=t);return"DGBEFHACIJK"!==i}}));DP({target:"Array",proto:!0,forced:ZP||!eA||!tA||!nA},{sort:function(e){void 0!==e&&BP(e);var t=qP(this);if(nA)return void 0===e?XP.call(t):XP.call(t,e);var n,r,i=[],a=zP(t.length);for(r=0;r<a;r++)r in t&&i.push(t[r]);for(i=$P(i,function(e){return function(t,n){return void 0===n?-1:void 0===t?1:void 0!==e?+e(t,n)||0:WP(t)>WP(n)?1:-1}}(e)),n=i.length,r=0;r<n;)t[r]=i[r++];for(;r<a;)delete t[r++];return t}});var rA=gI,iA=k,aA=Sr;Rn({target:"String",proto:!0,forced:!kI("includes")},{includes:function(e){return!!~aA(iA(this)).indexOf(aA(rA(e)),arguments.length>1?arguments[1]:void 0)}});var Media=function(){function Media(e,t){Na(this,Media),ja(this,"mcsMedia",null),this.services=t,e instanceof yI.McsMedia&&(this.mcsMedia=e),this.state={sid:e.sid,category:e.category,filename:e.filename,contentType:e.contentType,size:e.size}}return La(Media,[{key:"sid",get:function(){return this.state.sid}},{key:"filename",get:function(){return this.state.filename}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"category",get:function(){return this.state.category}},{key:"getContentTemporaryUrl",value:function(){var e=this;return new yI.CancellablePromise(function(){var t=Ta(Wc.mark((function t(n,r,i){var a,o,s,u;return Wc.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=e._fetchMcsMedia(),s=null===(a=e.mcsMedia)||void 0===a?void 0:a.getContentUrl(),i((function(){o.cancel(),s&&s.cancel()})),t.prev=3,e.mcsMedia){t.next=9;break}return t.next=7,o;case 7:u=t.sent,s=u.getContentUrl();case 9:if(t.t0=n,!s){t.next=16;break}return t.next=13,s;case 13:t.t1=t.sent,t.next=17;break;case 16:t.t1=null;case 17:t.t2=t.t1,(0,t.t0)(t.t2),t.next=24;break;case 21:t.prev=21,t.t3=t.catch(3),r(t.t3);case 24:case"end":return t.stop()}}),t,null,[[3,21]])})));return function(e,n,r){return t.apply(this,arguments)}}())}},{key:"_fetchMcsMedia",value:function(){var e=this;return new yI.CancellablePromise(function(){var t=Ta(Wc.mark((function t(n,r,i){var a;return Wc.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(a=e.services.mcsClient.get(e.state.sid),!e.services.mcsClient){t.next=14;break}return i((function(){return a.cancel()})),t.prev=3,t.next=6,a;case 6:e.mcsMedia=t.sent,n(e.mcsMedia),t.next=13;break;case 10:t.prev=10,t.t0=t.catch(3),r(t.t0);case 13:return t.abrupt("return");case 14:r(new Error("Media Content Service is unavailable"));case 15:case"end":return t.stop()}}),t,null,[[3,10]])})));return function(e,n,r){return t.apply(this,arguments)}}())}}]),Media}(),AggregatedDeliveryReceipt=function(){function AggregatedDeliveryReceipt(e){Na(this,AggregatedDeliveryReceipt),this.state=e}return La(AggregatedDeliveryReceipt,[{key:"total",get:function(){return this.state.total}},{key:"sent",get:function(){return this.state.sent}},{key:"delivered",get:function(){return this.state.delivered}},{key:"read",get:function(){return this.state.read}},{key:"undelivered",get:function(){return this.state.undelivered}},{key:"failed",get:function(){return this.state.failed}},{key:"_update",value:function(e){this.state=e}},{key:"_isEquals",value:function(e){var t=this.total===e.total,n=this.sent===e.sent,r=this.delivered===e.delivered,i=this.read===e.read,a=this.undelivered===e.undelivered,o=this.failed===e.failed;return t&&n&&r&&i&&a&&o}}]),AggregatedDeliveryReceipt}(),oA=function(){function e(t,n,r,i){Na(this,e),this.state={prevToken:r,nextToken:i,source:n,items:t}}return La(e,[{key:"hasNextPage",get:function(){return!!this.state.nextToken}},{key:"hasPrevPage",get:function(){return!!this.state.prevToken}},{key:"items",get:function(){return this.state.items}},{key:"nextPage",value:function(){return this.hasNextPage?this.state.source(this.state.nextToken):Promise.reject(new Error("No next page"))}},{key:"prevPage",value:function(){return this.hasPrevPage?this.state.source(this.state.prevToken):Promise.reject(new Error("No previous page"))}}]),e}(),DetailedDeliveryReceipt=La((function DetailedDeliveryReceipt(e){Na(this,DetailedDeliveryReceipt),this.sid=e.sid,this.messageSid=e.message_sid,this.conversationSid=e.conversation_sid,this.channelMessageSid=e.channel_message_sid,this.participantSid=e.participant_sid,this.status=e.status||"queued",this.errorCode=e.error_code||0,this.dateCreated=e.date_created,this.dateUpdated=e.date_updated})),sA={};function uA(e){return e&&"object"===Oa(e)&&"default"in e?e:{default:e}}Object.defineProperty(sA,"__esModule",{value:!0});var cA=uA(_f.exports),lA=function(e){var t=cA.default.getLevel();cA.default.setLevel("warn"),cA.default.warn(e),cA.default.setLevel(t)},fA=sA.deprecated=function(e,t,n){return function(r,i,a){if("function"!=typeof a.value&&void 0===(null==a?void 0:a.get))throw new Error("The deprecated decorator can only be applied to methods or getters");if("function"!=typeof a.value){var o=a.get;a.get=function(){return lA("The getter ".concat(e," is deprecated").concat(t?", use "+t+" instead":"").concat(n?", "+n:".")),null==o?void 0:o.apply(this)}}else{var s=a.value;a.value=function(){lA("The method ".concat(e," is deprecated").concat(t?", use "+t+" instead":"").concat(n?", "+n:"."));for(var r=arguments.length,i=new Array(r),a=0;a<r;a++)i[a]=arguments[a];return s.apply(this,i)}}}},dA=sA.deprecationWarning=lA;function pA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function hA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?pA(Object(n),!0).forEach((function(t){ja(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function vA(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}var yA=If.scope("Message"),Message=function(e){Ca(Message,e);var t,n,r,i,a,o,s,u=vA(Message);function Message(e,t,n,r,i,a){var o,s,c,l,f;return Na(this,Message),(f=u.call(this)).conversation=n,f.links=r,f.configuration=i,f.services=a,f.state={sid:t.sid,index:e,author:t.author,subject:t.subject,body:null!==(o=t.text)&&void 0!==o?o:null,timestamp:t.timestamp?new Date(t.timestamp):null,dateUpdated:t.dateUpdated?new Date(t.dateUpdated):null,lastUpdatedBy:null!==(s=t.lastUpdatedBy)&&void 0!==s?s:null,attributes:vh(t.attributes,"Got malformed attributes for the message ".concat(t.sid),yA),type:null!==(c=t.type)&&void 0!==c?c:"text",media:"media"===t.type&&t.media?new Media(t.media,f.services):null,medias:"media"===t.type&&t.medias?t.medias.map((function(e){return new Media(e,f.services)})):"media"===t.type&&t.media&&!t.medias?[new Media(hA(hA({},t.media),{},{category:"media"}),f.services)]:null,participantSid:null!==(l=t.memberSid)&&void 0!==l?l:null,aggregatedDeliveryReceipt:t.delivery?new AggregatedDeliveryReceipt(t.delivery):null},f}return La(Message,[{key:"sid",get:function(){return this.state.sid}},{key:"author",get:function(){return this.state.author}},{key:"subject",get:function(){return this.state.subject}},{key:"body",get:function(){return this.state.body}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"index",get:function(){return this.state.index}},{key:"lastUpdatedBy",get:function(){return this.state.lastUpdatedBy}},{key:"dateCreated",get:function(){return this.state.timestamp}},{key:"attributes",get:function(){return this.state.attributes}},{key:"type",get:function(){return this.state.type}},{key:"media",get:function(){return this.state.media}},{key:"attachedMedia",get:function(){return this.getMediaByCategories(["media"])}},{key:"participantSid",get:function(){return this.state.participantSid}},{key:"aggregatedDeliveryReceipt",get:function(){return this.state.aggregatedDeliveryReceipt}},{key:"getMediaByCategory",value:function(e){return this.getMediaByCategories(e)}},{key:"getMediaByCategories",value:function(e){var t;return(null!==(t=this.state.medias)&&void 0!==t?t:[]).filter((function(t){return e.includes(t.category)}))}},{key:"getEmailBody",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"text/plain";return null!==(e=null===(t=this.getMediaByCategories(["body"]))||void 0===t?void 0:t.filter((function(e){return e.contentType==n})).shift())&&void 0!==e?e:null}},{key:"getEmailHistory",value:function(){var e,t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"text/plain";return null!==(e=null===(t=this.getMediaByCategories(["history"]))||void 0===t?void 0:t.filter((function(e){return e.contentType==n})).shift())&&void 0!==e?e:null}},{key:"_update",value:function(e){var t=[];!e.text&&"string"!=typeof e.text||e.text===this.state.body||(this.state.body=e.text,t.push("body")),e.subject&&e.subject!==this.state.subject&&(this.state.subject=e.subject,t.push("subject")),e.lastUpdatedBy&&e.lastUpdatedBy!==this.state.lastUpdatedBy&&(this.state.lastUpdatedBy=e.lastUpdatedBy,t.push("lastUpdatedBy")),e.author&&e.author!==this.state.author&&(this.state.author=e.author,t.push("author")),e.dateUpdated&&new Date(e.dateUpdated).getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=new Date(e.dateUpdated),t.push("dateUpdated")),e.timestamp&&new Date(e.timestamp).getTime()!==(this.state.timestamp&&this.state.timestamp.getTime())&&(this.state.timestamp=new Date(e.timestamp),t.push("dateCreated"));var n=vh(e.attributes,"Got malformed attributes for the message ".concat(this.sid),yA);um(this.state.attributes,n)||(this.state.attributes=n,t.push("attributes"));var r=e.delivery,i=this.state.aggregatedDeliveryReceipt;!!(r&&r.total&&r.delivered&&r.failed&&r.read&&r.sent&&r.undelivered)&&(i?i._isEquals(r)||(i._update(r),t.push("deliveryReceipt")):(this.state.aggregatedDeliveryReceipt=new AggregatedDeliveryReceipt(r),t.push("deliveryReceipt"))),t.length>0&&this.emit("updated",{message:this,updateReasons:t})}},{key:"getParticipant",value:(s=Ta(Wc.mark((function e(){var t,n,r=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,!this.state.participantSid){e.next=5;break}return e.next=4,this.conversation.getParticipantBySid(this.state.participantSid).catch((function(){return yA.debug('Participant with sid "'.concat(r.participantSid,'" not found for message ').concat(r.sid)),null}));case 4:t=e.sent;case 5:if(t||!this.state.author){e.next=9;break}return e.next=8,this.conversation.getParticipantByIdentity(this.state.author).catch((function(){return yA.debug('Participant with identity "'.concat(r.author,'" not found for message ').concat(r.sid)),null}));case 8:t=e.sent;case 9:if(!t){e.next=11;break}return e.abrupt("return",t);case 11:throw n="Participant with ",this.state.participantSid&&(n+="SID '"+this.state.participantSid+"' "),this.state.author&&(this.state.participantSid&&(n+="or "),n+="identity '"+this.state.author+"' "),"Participant with "===n&&(n="Participant "),n+="was not found",new Error(n);case 17:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"getDetailedDeliveryReceipts",value:(o=Ta(Wc.mark((function e(){var t,n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getDetailedDeliveryReceiptsPaginator();case 2:t=e.sent,n=t.items;case 4:if(!t.hasNextPage){e.next=11;break}return e.next=7,t.nextPage();case 7:t=e.sent,n=[].concat(RP(n),RP(t.items)),e.next=4;break;case 11:return e.abrupt("return",n);case 12:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"remove",value:(a=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"updateBody",value:(i=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{body:t});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"updateAttributes",value:(r=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==t?JSON.stringify(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"attachTemporaryUrlsFor",value:(n=Ta(Wc.mark((function e(t){var n,r=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=null==t?void 0:t.map((function(e){return e.sid})),!this.services.mcsClient||!n){e.next=7;break}return e.next=4,this.services.mcsClient.mediaSetGet(n);case 4:return e.abrupt("return",e.sent.map((function(e){return new Media(e,r.services)})));case 7:throw new Error("Media Content Service is unavailable");case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getTemporaryContentUrlsForMedia",value:function(e){var t=e.map((function(e){return e.sid}));return this.getTemporaryContentUrlsForMediaSids(t)}},{key:"getTemporaryContentUrlsForMediaSids",value:function(e){var t=this;return new yI.CancellablePromise(function(){var n=Ta(Wc.mark((function n(r,i,a){var o,s;return Wc.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(o=t.services.mcsClient.mediaSetGetContentUrls(null!=e?e:[]),t.services.mcsClient&&e){n.next=4;break}return i(new Error("Media Content Service is unavailable")),n.abrupt("return");case 4:return a((function(){o.cancel()})),n.prev=5,n.next=8,o;case 8:s=n.sent,r(s),n.next=15;break;case 12:n.prev=12,n.t0=n.catch(5),i(n.t0);case 15:case"end":return n.stop()}}),n,null,[[5,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"getTemporaryContentUrlsForAttachedMedia",value:function(){var e,t=this.attachedMedia,n=null!==(e=null==t?void 0:t.map((function(e){return e.sid})))&&void 0!==e?e:[];return this.getTemporaryContentUrlsForMediaSids(n)}},{key:"_getDetailedDeliveryReceiptsPaginator",value:(t=Ta(Wc.mark((function e(t){var n,r,i,a=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.configuration.links.messagesReceipts.replace("%s",this.conversation.sid).replace("%s",this.sid),r=new yh(n).arg("PageToken",null==t?void 0:t.pageToken).arg("PageSize",null==t?void 0:t.pageSize).build(),e.next=4,this.services.network.get(r);case 4:return i=e.sent,e.abrupt("return",new oA(i.body.delivery_receipts.map((function(e){return new DetailedDeliveryReceipt(e)})),(function(e,t){return a._getDetailedDeliveryReceiptsPaginator({pageToken:e,pageSize:t})}),i.body.meta.previous_token,i.body.meta.next_token));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),Message}(om);function mA(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return gA(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return gA(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function gA(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function bA(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}ja(Message,"updated","updated"),$c([fA("getMediaByCategory","getMediaByCategories"),Vc("design:type",Function),Vc("design:paramtypes",[Array]),Vc("design:returntype",Array)],Message.prototype,"getMediaByCategory",null),$c([ky([vy,"undefined"]),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Media)],Message.prototype,"getEmailBody",null),$c([ky([vy,"undefined"]),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Media)],Message.prototype,"getEmailHistory",null),$c([wy("string"),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],Message.prototype,"updateBody",null),$c([wy(xy),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],Message.prototype,"updateAttributes",null),$c([fA("attachTemporaryUrlsFor","getTemporaryContentUrlsForMedia"),Vc("design:type",Function),Vc("design:paramtypes",[Array]),Vc("design:returntype",Promise)],Message.prototype,"attachTemporaryUrlsFor",null),$c([wy(hy("media",Media)),Vc("design:type",Function),Vc("design:paramtypes",[Array]),Vc("design:returntype",yI.CancellablePromise)],Message.prototype,"getTemporaryContentUrlsForMedia",null),$c([wy(hy("strings","string")),Vc("design:type",Function),Vc("design:paramtypes",[Array]),Vc("design:returntype",yI.CancellablePromise)],Message.prototype,"getTemporaryContentUrlsForMediaSids",null);var kA=If.scope("Messages"),wA=function(e){Ca(u,e);var t,n,r,i,a,o,s=bA(u);function u(e,t,n){var r;return Na(this,u),(r=s.call(this)).conversation=e,r.configuration=t,r.services=n,r.messagesByIndex=new Map,r.messagesListPromise=null,r}return La(u,[{key:"subscribe",value:(o=Ta(Wc.mark((function e(t){var n,r=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.messagesListPromise){e.next=2;break}return e.abrupt("return",this.messagesListPromise);case 2:return this.messagesListPromise="string"==typeof t?this.services.syncClient.list({id:t,mode:"open_existing"}):Promise.resolve(t),e.prev=3,e.next=6,this.messagesListPromise;case 6:return(n=e.sent).on("itemAdded",(function(e){kA.debug("".concat(r.conversation.sid," itemAdded: ").concat(e.item.index));var t={self:"".concat(r.conversation._links.messages,"/").concat(e.item.data.sid),conversation:r.conversation._links.self,messages_receipts:"".concat(r.conversation._links.messages,"/").concat(e.item.data.sid,"/Receipts")},n=new Message(e.item.index,e.item.data,r.conversation,t,r.configuration,r.services);r.messagesByIndex.has(n.index)?kA.debug("Message arrived, but is already known and ignored",r.conversation.sid,n.index):(r.messagesByIndex.set(n.index,n),n.on("updated",(function(e){return r.emit("messageUpdated",e)})),r.emit("messageAdded",n))})),n.on("itemRemoved",(function(e){kA.debug("#{this.conversation.sid} itemRemoved: ".concat(e.index));var t=e.index;if(r.messagesByIndex.has(t)){var n=r.messagesByIndex.get(t);if(!n)return;r.messagesByIndex.delete(n.index),n.removeAllListeners("updated"),r.emit("messageRemoved",n)}})),n.on("itemUpdated",(function(e){kA.debug("".concat(r.conversation.sid," itemUpdated: ").concat(e.item.index));var t=r.messagesByIndex.get(e.item.index);t&&t._update(e.item.data)})),e.abrupt("return",n);case 13:throw e.prev=13,e.t0=e.catch(3),this.messagesListPromise=null,"disconnected"!==this.services.syncClient.connectionState&&kA.error("Failed to get messages object for conversation",this.conversation.sid,e.t0),kA.debug("ERROR: Failed to get messages object for conversation",this.conversation.sid,e.t0),e.t0;case 19:case"end":return e.stop()}}),e,this,[[3,13]])}))),function(e){return o.apply(this,arguments)})},{key:"unsubscribe",value:(a=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.messagesListPromise){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.messagesListPromise;case 4:e.sent.close(),this.messagesListPromise=null;case 7:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"sendV2",value:function(e){var t=this;return kA.debug("Sending message V2",e.mediaContent,e.attributes,e.emailOptions),new yI.CancellablePromise(function(){var n=Ta(Wc.mark((function n(r,i,a){var o,s,u,c,l,f,d,p,h,v,y,m;return Wc.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:s=[],u=[],a((function(){u.forEach((function(e){return e.cancel()}))})),c=mA(e.mediaContent),n.prev=4,c.s();case 6:if((l=c.n()).done){n.next=25;break}return f=pm(l.value,2),d=f[0],p=f[1],n.prev=8,kA.debug("Adding media to a message as ".concat(p instanceof FormData?"FormData":"SendMediaOptions"),p),y=p instanceof FormData?t.services.mcsClient.postFormData(p,d):t.services.mcsClient.post(null!==(h=p.contentType)&&void 0!==h?h:"",null!==(v=p.media)&&void 0!==v?v:"",d,p.filename),u.push(y),n.t0=s,n.next=15,y;case 15:n.t1=n.sent,n.t0.push.call(n.t0,n.t1),n.next=23;break;case 19:return n.prev=19,n.t2=n.catch(8),i(n.t2),n.abrupt("return");case 23:n.next=6;break;case 25:n.next=30;break;case 27:n.prev=27,n.t3=n.catch(4),c.e(n.t3);case 30:return n.prev=30,c.f(),n.finish(30);case 33:return m=t.services.commandExecutor.mutateResource("post",t.conversation._links.messages,{body:e.text,subject:null===(o=e.emailOptions)||void 0===o?void 0:o.subject,media_sids:s.map((function(e){return e.sid})),attributes:void 0!==e.attributes?JSON.stringify(e.attributes):void 0}),n.prev=34,n.t4=r,n.next=38,m;case 38:n.t5=n.sent,(0,n.t4)(n.t5),n.next=45;break;case 42:n.prev=42,n.t6=n.catch(34),i(n.t6);case 45:case"end":return n.stop()}}),n,null,[[4,27,30,33],[8,19],[34,42]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"send",value:(i=Ta(Wc.mark((function e(t){var n,r,i=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r=i.length>2?i[2]:void 0,kA.debug("Sending text message",t,n,r),e.abrupt("return",this.services.commandExecutor.mutateResource("post",this.conversation._links.messages,{body:null!=t?t:"",attributes:void 0!==n?JSON.stringify(n):void 0,subject:null==r?void 0:r.subject}));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"sendMedia",value:(r=Ta(Wc.mark((function e(t){var n,r,i,a,o,s=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=s.length>1&&void 0!==s[1]?s[1]:{},a=s.length>2?s[2]:void 0,kA.debug("Sending media message",t,i,a),kA.debug("Sending media message as ".concat(t instanceof FormData?"FormData":"SendMediaOptions"),t,i),!(t instanceof FormData)){e.next=10;break}return e.next=7,this.services.mcsClient.postFormData(t);case 7:e.t0=e.sent,e.next=13;break;case 10:return e.next=12,this.services.mcsClient.post(null!==(n=t.contentType)&&void 0!==n?n:"",null!==(r=t.media)&&void 0!==r?r:"","media",t.filename);case 12:e.t0=e.sent;case 13:return o=e.t0,e.next=16,this.services.commandExecutor.mutateResource("post",this.conversation._links.messages,{media_sids:[o.sid],attributes:void 0!==i?JSON.stringify(i):void 0});case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getMessages",value:(n=Ta(Wc.mark((function e(t,n){var r,i=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>2&&void 0!==i[2]?i[2]:"backwards",e.abrupt("return",this._getMessages(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"_wrapPaginator",value:function(e,t,n){var r=this,i="desc"===e,a=function(){return t.nextPage().then((function(t){return r._wrapPaginator(e,t,n)}))},o=function(){return t.prevPage().then((function(t){return r._wrapPaginator(e,t,n)}))};return n(t.items).then((function(e){return{items:e.sort((function(e,t){return e.index-t.index})),hasPrevPage:i?t.hasNextPage:t.hasPrevPage,hasNextPage:i?t.hasPrevPage:t.hasNextPage,prevPage:i?a:o,nextPage:i?o:a}}))}},{key:"_upsertMessage",value:function(e,t){var n=this,r=this.messagesByIndex.get(e);if(r)return r;var i={self:"".concat(this.conversation._links.messages,"/").concat(t.sid),conversation:this.conversation._links.self,messages_receipts:"".concat(this.conversation._links.messages,"/").concat(t.sid,"/Receipts")},a=new Message(e,t,this.conversation,i,this.configuration,this.services);return this.messagesByIndex.set(a.index,a),a.on("updated",(function(e){return n.emit("messageUpdated",e)})),a}},{key:"_getMessages",value:(t=Ta(Wc.mark((function e(){var t,n,r,i,a,o,s=this,u=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=u.length>0&&void 0!==u[0]?u[0]:30,n=u.length>1&&void 0!==u[1]?u[1]:"end",r=u.length>2&&void 0!==u[2]?u[2]:"forward",i="backwards"===r?"desc":"asc",e.next=6,this.messagesListPromise;case 6:return a=e.sent,e.next=9,null==a?void 0:a.getItems({from:"end"!==n?n:void 0,pageSize:t,order:i,limit:t});case 9:return o=e.sent,e.next=12,this._wrapPaginator(i,o,(function(e){return Promise.all(e.map((function(e){return s._upsertMessage(e.index,e.data)})))}));case 12:return e.abrupt("return",e.sent);case 13:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),u}(om),xA=function(){function e(t){Na(this,e),ja(this,"attributes",{}),ja(this,"mediaContent",[]),ja(this,"emailOptions",{}),this.messagesEntity=t}return La(e,[{key:"send",value:function(){var e=this;return new yI.CancellablePromise(function(){var t=Ta(Wc.mark((function t(n,r,i){var a,o;return Wc.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=e.messagesEntity.sendV2(e),i((function(){return a.cancel()})),t.prev=2,t.next=5,a;case 5:o=t.sent,n(ph(o.index)),t.next=12;break;case 9:t.prev=9,t.t0=t.catch(2),r(t.t0);case 12:case"end":return t.stop()}}),t,null,[[2,9]])})));return function(e,n,r){return t.apply(this,arguments)}}())}}]),e}(),_A=function(){function e(t,n){Na(this,e),this.limits=t,this.message=new xA(n),this.emailBodies=new Map,this.emailHistories=new Map}return La(e,[{key:"setBody",value:function(e){return this.message.text=e,this}},{key:"setSubject",value:function(e){return this.message.emailOptions.subject=e,this}},{key:"setAttributes",value:function(e){return this.message.attributes=e,this}},{key:"setEmailBody",value:function(e,t){return this.emailBodies.set(e,t),this}},{key:"setEmailHistory",value:function(e,t){return this.emailHistories.set(e,t),this}},{key:"addMedia",value:function(e){if("undefined"==typeof FormData&&e instanceof FormData)throw new Error("Could not add FormData content whilst not in a browser");if(!(e instanceof FormData)){var t=e;if(!t.contentType||!t.media)throw new Error("Media content in SendMediaOptions must contain non-empty contentType and media")}return this.message.mediaContent.push(["media",e]),this}},{key:"build",value:function(){var e=this;if(this.emailBodies.forEach((function(t,n){if(!e.limits.emailBodiesAllowedContentTypes.includes(n))throw new Error("Unsupported email body content type ".concat(n))})),this.emailHistories.forEach((function(t,n){if(!e.limits.emailHistoriesAllowedContentTypes.includes(n))throw new Error("Unsupported email history content type ".concat(n))})),this.emailBodies.size>this.limits.emailBodiesAllowedContentTypes.length)throw new Error("Too many email bodies attached to the message (".concat(this.emailBodies.size," > ").concat(this.limits.emailBodiesAllowedContentTypes.length,")"));if(this.emailHistories.size>this.limits.emailHistoriesAllowedContentTypes.length)throw new Error("Too many email histories attached to the message (".concat(this.emailHistories.size," > ").concat(this.limits.emailHistoriesAllowedContentTypes.length,")"));if(this.message.mediaContent.length>this.limits.mediaAttachmentsCountLimit)throw new Error("Too many media attachments in the message (".concat(this.message.mediaContent.length," > ").concat(this.limits.mediaAttachmentsCountLimit,")"));return this.emailBodies.forEach((function(t){e.message.mediaContent.push(["body",t])})),this.emailHistories.forEach((function(t){e.message.mediaContent.push(["history",t])})),this.message}},{key:"buildAndSend",value:function(){return this.build().send()}},{key:"getPayloadContentType",value:function(e){return"undefined"!=typeof FormData&&e instanceof FormData?e.get("Content-Type"):e.contentType}}]),e}();function SA(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return EA(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return EA(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function EA(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function TA(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}var RA={lastMessage:"lastMessage",attributes:"attributes",createdBy:"createdBy",dateCreated:"dateCreated",dateUpdated:"dateUpdated",friendlyName:"friendlyName",lastConsumedMessageIndex:"lastConsumedMessageIndex",notificationLevel:"notificationLevel",sid:"sid",status:"status",uniqueName:"uniqueName",state:"state",bindings:"bindings"},Conversation=function(e){Ca(Conversation,e);var t,n,r,i,a,o,s,u,c,l,f,d,p,h,v,y,m,g,b,k,w,x,_,S,E,T,R,I,C=TA(Conversation);function Conversation(e,t,n,r,i){var a,o,s;Na(this,Conversation),(s=C.call(this)).sid=t,s._links=n,s._configuration=r,s._services=i,s._entityName=e.channel,s._internalState={uniqueName:e.uniqueName||null,status:"notParticipating",attributes:null!==(a=e.attributes)&&void 0!==a?a:{},createdBy:e.createdBy,dateCreated:hh(e.dateCreated),dateUpdated:hh(e.dateUpdated),friendlyName:e.friendlyName||null,lastReadMessageIndex:Number.isInteger(e.lastConsumedMessageIndex)?e.lastConsumedMessageIndex:null,bindings:null!==(o=e.bindings)&&void 0!==o?o:{}},e.notificationLevel&&(s._internalState.notificationLevel=e.notificationLevel);var u={participants:s._links.participants};return s._participants=new Map,s._participantsEntity=new FP(Ra(s),s._participants,u,s._configuration,s._services),s._participantsEntity.on("participantJoined",(function(e){return s.emit("participantJoined",e)})),s._participantsEntity.on("participantLeft",(function(e){return s.emit("participantLeft",e)})),s._participantsEntity.on("participantUpdated",(function(e){return s.emit("participantUpdated",e)})),s._messagesEntity=new wA(Ra(s),r,i),s._messagesEntity.on("messageAdded",(function(e){return s._onMessageAdded(e)})),s._messagesEntity.on("messageUpdated",(function(e){return s.emit("messageUpdated",e)})),s._messagesEntity.on("messageRemoved",(function(e){return s.emit("messageRemoved",e)})),s}return La(Conversation,[{key:"uniqueName",get:function(){return this._internalState.uniqueName}},{key:"status",get:function(){return this._internalState.status}},{key:"friendlyName",get:function(){return this._internalState.friendlyName}},{key:"dateUpdated",get:function(){return this._internalState.dateUpdated}},{key:"dateCreated",get:function(){return this._internalState.dateCreated}},{key:"createdBy",get:function(){var e;return null!==(e=this._internalState.createdBy)&&void 0!==e?e:""}},{key:"attributes",get:function(){return this._internalState.attributes}},{key:"lastReadMessageIndex",get:function(){return this._internalState.lastReadMessageIndex}},{key:"lastMessage",get:function(){var e;return null!==(e=this._internalState.lastMessage)&&void 0!==e?e:void 0}},{key:"notificationLevel",get:function(){var e;return null!==(e=this._internalState.notificationLevel)&&void 0!==e?e:"default"}},{key:"bindings",get:function(){return this._internalState.bindings}},{key:"limits",get:function(){return this._configuration.limits}},{key:"state",get:function(){return this._internalState.state}},{key:"_statusSource",get:function(){return this._dataSource}},{key:"add",value:(I=Ta(Wc.mark((function e(t,n){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._participantsEntity.add(t,null!=n?n:{}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"addNonChatParticipant",value:(R=Ta(Wc.mark((function e(t,n){var r,i,a=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]?a[2]:{},i=a.length>3&&void 0!==a[3]?a[3]:{},e.abrupt("return",this._participantsEntity.addNonChatParticipant(t,n,null!=r?r:{},null!=i?i:{}));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return R.apply(this,arguments)})},{key:"advanceLastReadMessageIndex",value:(T=Ta(Wc.mark((function e(t){var n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:if(!(t<(null!==(n=this.lastReadMessageIndex)&&void 0!==n?n:0))){e.next=6;break}return e.next=5,this._setLastReadMessageIndex(this.lastReadMessageIndex);case 5:case 8:return e.abrupt("return",e.sent);case 6:return e.next=8,this._setLastReadMessageIndex(t);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"delete",value:(E=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("delete",this._links.self);case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"getAttributes",value:(S=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return e.abrupt("return",this.attributes);case 3:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"getMessages",value:(_=Ta(Wc.mark((function e(t,n,r){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._messagesEntity.getMessages(t,n,r));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return _.apply(this,arguments)})},{key:"getParticipants",value:(x=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._participantsEntity.getParticipants());case 3:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"getParticipantsCount",value:(w=Ta(Wc.mark((function e(){var t,n,r;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new yh(this._configuration.links.conversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:return r=e.sent,e.abrupt("return",null!==(t=r.body.participants_count)&&void 0!==t?t:0);case 5:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"getParticipantBySid",value:(k=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._participantsEntity.getParticipantBySid(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(b=Ta(Wc.mark((function e(){var t,n=arguments;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:"",e.abrupt("return",this._participantsEntity.getParticipantByIdentity(null!=t?t:""));case 2:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"getMessagesCount",value:(g=Ta(Wc.mark((function e(){var t,n,r;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new yh(this._configuration.links.conversations).path(this.sid).build(),e.next=3,this._services.network.get(n);case 3:return r=e.sent,e.abrupt("return",null!==(t=r.body.messages_count)&&void 0!==t?t:0);case 5:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"getUnreadMessagesCount",value:(m=Ta(Wc.mark((function e(){var t,n,r;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new yh(this._configuration.links.myConversations).path(this.sid).build(),e.next=3,this._services.network.get(t);case 3:if((n=e.sent).body.conversation_sid===this.sid){e.next=6;break}throw new Error("Conversation was not found in the user conversations list");case 6:if("number"!=typeof(r=n.body.unread_messages_count)){e.next=9;break}return e.abrupt("return",r);case 9:return e.abrupt("return",null);case 10:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"join",value:(y=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post",this._links.participants,{identity:this._configuration.userIdentity});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"leave",value:(v=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("joined"!==this._internalState.status){e.next=3;break}return e.next=3,this._services.commandExecutor.mutateResource("delete","".concat(this._links.participants,"/").concat(this._configuration.userIdentity));case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"removeParticipant",value:(h=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._participantsEntity.remove("string"==typeof t?t:t.sid);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"sendMessage",value:(p=Ta(Wc.mark((function e(t,n,r){var i,a,o,s;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t&&null!==t){e.next=5;break}return e.next=3,this._messagesEntity.send(t,n,r);case 3:return o=e.sent,e.abrupt("return",null!==(a=ph(o.index))&&void 0!==a?a:0);case 5:return e.next=7,this._messagesEntity.sendMedia(t,n,r);case 7:return s=e.sent,e.abrupt("return",null!==(i=ph(s.index))&&void 0!==i?i:0);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"prepareMessage",value:function(){return new _A(this.limits,this._messagesEntity)}},{key:"setAllMessagesRead",value:(d=Ta(Wc.mark((function e(){var t;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this.getMessages(1);case 4:if(!((t=e.sent).items.length>0)){e.next=7;break}return e.abrupt("return",this.advanceLastReadMessageIndex(t.items[0].index));case 7:return e.abrupt("return",0);case 8:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"setAllMessagesUnread",value:(f=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this._setLastReadMessageIndex(null);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"setUserNotificationLevel",value:(l=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post","".concat(this._configuration.links.myConversations,"/").concat(this.sid),{notification_level:t});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"typing",value:function(){return this._services.typingIndicator.send(this.sid)}},{key:"updateAttributes",value:(c=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post",this._links.self,{attributes:void 0!==t?JSON.stringify(t):void 0});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"updateFriendlyName",value:(u=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._internalState.friendlyName===t){e.next=3;break}return e.next=3,this._services.commandExecutor.mutateResource("post",this._links.self,{friendly_name:t});case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"updateLastReadMessageIndex",value:(s=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this._setLastReadMessageIndex(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"updateUniqueName",value:(o=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._internalState.uniqueName===t){e.next=4;break}return t||(t=""),e.next=4,this._services.commandExecutor.mutateResource("post",this._links.self,{unique_name:t});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"_subscribe",value:(a=Ta(Wc.mark((function e(){var t=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._entityPromise){e.next=2;break}return e.abrupt("return",this._entityPromise);case 2:return this._entityPromise=this._services.syncClient.document({id:this._entityName,mode:"open_existing"}),e.prev=3,e.next=6,this._entityPromise;case 6:return this._entity=e.sent,this._entity.on("updated",(function(e){return t._update(e.data)})),this._entity.on("removed",(function(){return t.emit("removed",t)})),this._update(this._entity.data),e.abrupt("return",this._entity);case 13:throw e.prev=13,e.t0=e.catch(3),this._entity=null,this._entityPromise=null,"disconnected"!=this._services.syncClient.connectionState&&Conversation._logger.error("Failed to get conversation object",e.t0),Conversation._logger.debug("ERROR: Failed to get conversation object",e.t0),e.t0;case 20:case"end":return e.stop()}}),e,this,[[3,13]])}))),function(){return a.apply(this,arguments)})},{key:"_fetchStreams",value:(i=Ta(Wc.mark((function e(){var t,n,r;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return Conversation._logger.trace("_streamsAvailable, this.entity.data=",null===(t=this._entity)||void 0===t?void 0:t.data),r=null===(n=this._entity)||void 0===n?void 0:n.data,e.next=6,this._services.syncClient.list({id:r.messages,mode:"open_existing"});case 6:return this._messagesList=e.sent,e.next=9,this._services.syncClient.map({id:r.roster,mode:"open_existing"});case 9:this._participantsMap=e.sent;case 10:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"_subscribeStreams",value:(r=Ta(Wc.mark((function e(){var t,n,r,i,a,o,s;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._subscribe();case 3:return Conversation._logger.trace("_subscribeStreams, this.entity.data=",null===(t=this._entity)||void 0===t?void 0:t.data),a=null===(n=this._entity)||void 0===n?void 0:n.data,o=a.messages,s=a.roster,e.next=9,Promise.all([this._messagesEntity.subscribe(null!==(r=this._messagesList)&&void 0!==r?r:o),this._participantsEntity.subscribe(null!==(i=this._participantsMap)&&void 0!==i?i:s)]);case 9:e.next=16;break;case 11:throw e.prev=11,e.t0=e.catch(0),"disconnected"!==this._services.syncClient.connectionState&&Conversation._logger.error("Failed to subscribe on conversation objects",this.sid,e.t0),Conversation._logger.debug("ERROR: Failed to subscribe on conversation objects",this.sid,e.t0),e.t0;case 16:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(){return r.apply(this,arguments)})},{key:"_unsubscribe",value:(n=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._entity){e.next=5;break}return e.next=3,this._entity.close();case 3:this._entity=null,this._entityPromise=null;case 5:return e.abrupt("return",Promise.all([this._participantsEntity.unsubscribe(),this._messagesEntity.unsubscribe()]));case 6:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"_setStatus",value:function(e,t){var n=this;this._dataSource=t,this._internalState.status!==e&&(this._internalState.status=e,"joined"!==e?this._entityPromise&&this._unsubscribe().catch((function(t){if(Conversation._logger.debug("ERROR while setting conversation status "+e,t),"disconnected"!==n._services.syncClient.connectionState)throw t})):this._subscribeStreams().catch((function(t){if(Conversation._logger.debug("ERROR while setting conversation status "+e,t),"disconnected"!==n._services.syncClient.connectionState)throw t})))}},{key:"_update",value:function(e){var t,n,r,i,a;Conversation._logger.trace("_update",e),Conversation.preprocessUpdate(e,this.sid);for(var o=new Set,s=0,u=Object.keys(e);s<u.length;s++){var c=u[s],l=RA[c];if(l)switch(l){case RA.status:if(!e.status||"unknown"===e.status||this._internalState.status===e.status)break;this._internalState.status=e.status,o.add(l);break;case RA.attributes:if(um(this._internalState.attributes,e.attributes))break;this._internalState.attributes=e.attributes,o.add(l);break;case RA.lastConsumedMessageIndex:if(void 0===e.lastConsumedMessageIndex||e.lastConsumedMessageIndex===this._internalState.lastReadMessageIndex)break;this._internalState.lastReadMessageIndex=e.lastConsumedMessageIndex,o.add("lastReadMessageIndex");break;case RA.lastMessage:if(this._internalState.lastMessage&&!e.lastMessage){delete this._internalState.lastMessage,o.add(l);break}this._internalState.lastMessage=this._internalState.lastMessage||{},void 0!==(null===(t=e.lastMessage)||void 0===t?void 0:t.index)&&e.lastMessage.index!==this._internalState.lastMessage.index&&(this._internalState.lastMessage.index=e.lastMessage.index,o.add(l)),void 0!==(null===(n=e.lastMessage)||void 0===n?void 0:n.timestamp)&&(null===(r=this._internalState.lastMessage)||void 0===r||null===(i=r.dateCreated)||void 0===i?void 0:i.getTime())!==e.lastMessage.timestamp.getTime()&&(this._internalState.lastMessage.dateCreated=e.lastMessage.timestamp,o.add(l)),um(this._internalState.lastMessage,{})&&delete this._internalState.lastMessage;break;case RA.state:var f=e.state||void 0;if(void 0!==f&&(f.dateUpdated=new Date(f.dateUpdated)),um(this._internalState.state,f))break;this._internalState.state=f,o.add(l);break;case RA.bindings:if(um(this._internalState.bindings,e.bindings))break;this._internalState.bindings=e.bindings,o.add(l);break;default:var d=e[c]instanceof Date,p=d&&(null===(a=this._internalState[l])||void 0===a?void 0:a.getTime())===e[c].getTime(),h=!d&&this[l]===e[c];if(p||h)break;this._internalState[l]=e[c],o.add(l)}}o.size>0&&this.emit("updated",{conversation:this,updateReasons:RP(o)})}},{key:"_onMessageAdded",value:function(e){var t,n=SA(this._participants.values());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.identity===e.author){r._endTyping();break}}}catch(e){n.e(e)}finally{n.f()}this.emit("messageAdded",e)}},{key:"_setLastReadMessageIndex",value:(t=Ta(Wc.mark((function e(t){var n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.mutateResource("post","".concat(this._configuration.links.myConversations,"/").concat(this.sid),{last_read_message_index:t});case 2:return n=e.sent,e.abrupt("return",n.unread_messages_count);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"preprocessUpdate",value:function(e,t){try{"string"==typeof e.attributes?e.attributes=JSON.parse(e.attributes):e.attributes&&JSON.stringify(e.attributes)}catch(n){Conversation._logger.warn("Retrieved malformed attributes from the server for conversation: "+t),e.attributes={}}try{e.dateCreated&&(e.dateCreated=new Date(e.dateCreated))}catch(n){Conversation._logger.warn("Retrieved malformed dateCreated from the server for conversation: "+t),delete e.dateCreated}try{e.dateUpdated&&(e.dateUpdated=new Date(e.dateUpdated))}catch(n){Conversation._logger.warn("Retrieved malformed dateUpdated from the server for conversation: "+t),delete e.dateUpdated}try{e.lastMessage&&e.lastMessage.timestamp&&(e.lastMessage.timestamp=new Date(e.lastMessage.timestamp))}catch(n){Conversation._logger.warn("Retrieved malformed lastMessage.timestamp from the server for conversation: "+t),delete e.lastMessage.timestamp}}}]),Conversation}(om);ja(Conversation,"participantJoined","participantJoined"),ja(Conversation,"participantLeft","participantLeft"),ja(Conversation,"participantUpdated","participantUpdated"),ja(Conversation,"messageAdded","messageAdded"),ja(Conversation,"messageRemoved","messageRemoved"),ja(Conversation,"messageUpdated","messageUpdated"),ja(Conversation,"typingEnded","typingEnded"),ja(Conversation,"typingStarted","typingStarted"),ja(Conversation,"updated","updated"),ja(Conversation,"removed","removed"),ja(Conversation,"_logger",If.scope("Conversation")),$c([wy(vy,_y),Vc("design:type",Function),Vc("design:paramtypes",[String,Object]),Vc("design:returntype",Promise)],Conversation.prototype,"add",null),$c([wy(vy,vy,_y),Vc("design:type",Function),Vc("design:paramtypes",[String,String,Object,Object]),Vc("design:returntype",Promise)],Conversation.prototype,"addNonChatParticipant",null),$c([wy(yy),Vc("design:type",Function),Vc("design:paramtypes",[Number]),Vc("design:returntype",Promise)],Conversation.prototype,"advanceLastReadMessageIndex",null),$c([wy(["undefined",yy],["undefined",yy],["undefined",py("backwards","forward")]),Vc("design:type",Function),Vc("design:paramtypes",[Number,Number,String]),Vc("design:returntype",Promise)],Conversation.prototype,"getMessages",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],Conversation.prototype,"getParticipantBySid",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],Conversation.prototype,"getParticipantByIdentity",null),$c([wy([vy,Participant]),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],Conversation.prototype,"removeParticipant",null),$c([wy(["string",FormData,py(null),my("media options",{contentType:vy,media:dy((function(e){var t="string"==typeof e&&e.length>0||e instanceof Uint8Array||e instanceof ArrayBuffer;return"function"==typeof Blob&&(t=t||e instanceof Blob),[t,"a non-empty string, an instance of Buffer or an instance of Blob"]}))})],_y,["undefined",py(null),my("email attributes",{subject:[vy,"undefined"]})]),Vc("design:type",Function),Vc("design:paramtypes",[Object,Object,Object]),Vc("design:returntype",Promise)],Conversation.prototype,"sendMessage",null),$c([wy(py("default","muted")),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],Conversation.prototype,"setUserNotificationLevel",null),$c([wy(xy),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],Conversation.prototype,"updateAttributes",null),$c([wy("string"),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],Conversation.prototype,"updateFriendlyName",null),$c([wy([py(null),yy]),Vc("design:type",Function),Vc("design:paramtypes",[Number]),Vc("design:returntype",Promise)],Conversation.prototype,"updateLastReadMessageIndex",null),$c([wy(["string",py(null)]),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],Conversation.prototype,"updateUniqueName",null);var IA=function(){function e(){var t=this;Na(this,e),this._promise=new Promise((function(e,n){t._resolve=e,t._reject=n}))}return La(e,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),e}();function CA(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return OA(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return OA(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function OA(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function PA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function AA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?PA(Object(n),!0).forEach((function(t){ja(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):PA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function jA(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}var MA=If.scope("Conversations"),LA=function(e){Ca(p,e);var t,n,r,i,a,o,s,u,c,l,f,d=jA(p);function p(e,t){var n;return Na(this,p),ja(Ra(n=d.call(this)),"conversations",new Map),ja(Ra(n),"myConversationsRead",new IA),ja(Ra(n),"tombstones",new Set),ja(Ra(n),"myConversationsFetched",!1),n.configuration=e,n.services=t,n}return La(p,[{key:"addConversation",value:(f=Ta(Wc.mark((function e(t){var n,r,i,a,o,s,u,c,l,f;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=void 0!==(null==t?void 0:t.attributes)?t.attributes:{},e.next=3,this.services.commandExecutor.mutateResource("post",this.configuration.links.conversations,{friendly_name:t.friendlyName,unique_name:t.uniqueName,attributes:void 0!==a?JSON.stringify(a):void 0});case 3:if(o=e.sent,s=null!==(n=o.sid)&&void 0!==n?n:null,u=null!==(r=null===(i=o.sync_objects)||void 0===i?void 0:i.conversation)&&void 0!==r?r:null,c=AA({self:o.url},o.links),!(l=this.conversations.get(s))){e.next=12;break}return e.next=11,l._subscribe();case 11:return e.abrupt("return",l);case 12:return f=new Conversation({channel:u,entityName:"",uniqueName:"",attributes:null,createdBy:"",friendlyName:"",lastConsumedMessageIndex:0,dateCreated:null,dateUpdated:null},s,c,this.configuration,this.services),this.conversations.set(f.sid,f),this._registerForEvents(f),e.next=17,f._subscribe();case 17:return this.emit("conversationAdded",f),e.abrupt("return",f);case 19:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"fetchConversations",value:(l=Ta(Wc.mark((function e(){var t,n,r,i,a,o,s,u=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._getMap();case 3:return(t=e.sent).on("itemAdded",(function(e){MA.debug("itemAdded: ".concat(e.item.key)),u._upsertConversation("sync",e.item.key,e.item.data)})),t.on("itemRemoved",(function(e){MA.debug("itemRemoved: ".concat(e.key));var t=e.key;u.myConversationsFetched||u.tombstones.add(t);var n=u.conversations.get(t);n&&("joined"===n.status&&(n._setStatus("notParticipating","sync"),u.emit("conversationLeft",n)),u.conversations.delete(t),u.emit("conversationRemoved",n),n.emit("removed",n))})),t.on("itemUpdated",(function(e){MA.debug("itemUpdated: ".concat(e.item.key)),u._upsertConversation("sync",e.item.key,e.item.data)})),e.next=9,this._fetchMyConversations();case 9:n=e.sent,r=[],i=CA(n);try{for(i.s();!(a=i.n()).done;)o=a.value,r.push(this._upsertConversation("rest",o.channel_sid,o))}catch(e){i.e(e)}finally{i.f()}return this.myConversationsRead.set(!0),e.next=16,Promise.all(r);case 16:return this.myConversationsFetched=!0,this.tombstones.clear(),MA.debug("The conversations list has been successfully fetched"),e.abrupt("return",this);case 22:throw e.prev=22,e.t0=e.catch(0),s="Failed to fetch the conversations list","disconnected"!==this.services.syncClient.connectionState&&MA.error(s,e.t0),MA.debug("ERROR: ".concat(s),e.t0),e.t0;case 28:case"end":return e.stop()}}),e,this,[[0,22]])}))),function(){return l.apply(this,arguments)})},{key:"getConversations",value:(c=Ta(Wc.mark((function e(){var t,n,r=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getMap();case 2:return t=e.sent,e.next=5,t.getItems();case 5:return n=e.sent,e.abrupt("return",this._wrapPaginator(n,(function(e){return Promise.all(e.map((function(e){return r._upsertConversation("sync",e.key,e.data)})))})));case 7:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"getConversation",value:(u=Ta(Wc.mark((function e(t){var n,r,i,a=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getMap();case 2:return n=e.sent,e.next=5,n.getItems({key:t});case 5:return r=e.sent,i=r.items.map((function(e){return a._upsertConversation("sync",e.key,e.data)})),e.abrupt("return",i.length>0?i[0]:null);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(s=Ta(Wc.mark((function e(t){var n,r,i,a,o;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new yh(this.configuration.links.myConversations).path(t).build(),e.next=3,this.services.network.get(n);case 3:return r=e.sent,i=r.body,a=i.conversation_sid,o={entityName:null,lastConsumedMessageIndex:i.last_read_message_index,status:(null==i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:i.sync_objects.conversation,notificationLevel:null==i?void 0:i.notification_level,sid:a},e.abrupt("return",a?this._upsertConversation("sync",a,o):null);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"peekConversation",value:(o=Ta(Wc.mark((function e(t){var n,r,i,a;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new yh(this.configuration.links.conversations).path(t).build(),e.next=3,this.services.network.get(n);case 3:return r=e.sent,i=r.body,a={entityName:null,status:(null==i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:"".concat(t,".channel"),sid:t},e.abrupt("return",this._upsertConversation("sync",t,a));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"_getMap",value:(a=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.syncClient.map({id:this.configuration.myConversations,mode:"open_existing"});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"_wrapPaginator",value:(i=Ta(Wc.mark((function e(t,n){var r,i=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n(t.items);case 2:return r=e.sent,e.abrupt("return",{items:r.filter((function(e){return null!==e})),hasNextPage:t.hasNextPage,hasPrevPage:t.hasPrevPage,nextPage:function(){return t.nextPage().then((function(e){return i._wrapPaginator(e,n)}))},prevPage:function(){return t.prevPage().then((function(e){return i._wrapPaginator(e,n)}))}});case 4:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})},{key:"_updateConversation",value:(r=Ta(Wc.mark((function e(t,n,r){var i,a,o;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=void 0!==n._statusSource&&t!==n._statusSource,a="rest"!==t||"sync"===n._statusSource,!i||!a||"sync"===t){e.next=5;break}return MA.trace("upsertConversation: conversation is known from sync and came from REST, ignoring",{sid:n.sid,data:r.status,conversation:n.status}),e.abrupt("return");case 5:if("joined"!==r.status||"joined"===n.status){e.next=15;break}return n._setStatus("joined",t),o={},void 0!==r.notificationLevel&&(o.notificationLevel=r.notificationLevel),void 0!==r.lastConsumedMessageIndex&&(o.lastConsumedMessageIndex=r.lastConsumedMessageIndex),um(o,{})||n._update(o),e.next=13,n._subscribe();case 13:return this.emit("conversationJoined",n),e.abrupt("return");case 15:if("notParticipating"!==r.status||"joined"!==n.status){e.next=22;break}return n._setStatus("notParticipating",t),n._update(r),e.next=20,n._subscribe();case 20:return this.emit("conversationLeft",n),e.abrupt("return");case 22:if("notParticipating"!==r.status){e.next=26;break}return e.next=25,n._subscribe();case 25:return e.abrupt("return");case 26:n._update(r);case 27:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"_upsertConversation",value:(n=Ta(Wc.mark((function e(t,n,r){var i,a,o,s;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(MA.trace("upsertConversation called for ".concat(n),r),!(i=this.conversations.get(n))){e.next=9;break}return MA.trace("upsertConversation: the conversation ".concat(i.sid," is known;")+"its status is known from the source ".concat(i._statusSource," ")+"and the update came from the source ".concat(t),i),e.next=6,this._updateConversation(t,i,r);case 6:return e.next=8,i._subscribe();case 8:return e.abrupt("return",i);case 9:if("rest"!==t||!this.tombstones.has(n)){e.next=12;break}return MA.trace("upsertChannel: the conversation is deleted but reappeared again from REST, ignoring",n),e.abrupt("return",null);case 12:return MA.trace("upsertConversation: creating a local conversation object with sid "+n,r),a="".concat(this.configuration.links.conversations,"/").concat(n),o={self:a,messages:"".concat(a,"/Messages"),participants:"".concat(a,"/Participants")},s=new Conversation(r,n,o,this.configuration,this.services),this.conversations.set(n,s),e.prev=17,e.next=20,s._subscribe();case 20:if("joined"!==r.status){e.next=23;break}return e.next=23,s._fetchStreams();case 23:e.next=32;break;case 25:if(e.prev=25,e.t0=e.catch(17),"SyncError"===e.t0.name){e.next=29;break}throw e.t0;case 29:return MA.trace("upsertChannel: the conversation is missing some Sync entity(ies), ignoring",n,e.t0),this.conversations.delete(n),e.abrupt("return",null);case 32:return this._registerForEvents(s),this.emit("conversationAdded",s),"joined"===r.status&&(s._setStatus("joined",t),this.emit("conversationJoined",s)),e.abrupt("return",s);case 36:case"end":return e.stop()}}),e,this,[[17,25]])}))),function(e,t,r){return n.apply(this,arguments)})},{key:"_fetchMyConversations",value:(t=Ta(Wc.mark((function e(){var t,n,r,i,a,o;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=null;case 2:return i=new yh(this.configuration.links.myConversations),n&&i.arg("PageToken",n),e.next=6,this.services.network.get(i.build());case 6:a=e.sent,o=null===(r=a.body)||void 0===r?void 0:r.conversations.map((function(e){return{descriptor:e,channel_sid:e.conversation_sid,status:e.status,channel:e.sync_objects.conversation,messages:e.sync_objects.messages,roster:"".concat(e.conversation_sid,".roster"),lastConsumedMessageIndex:e.last_read_message_index,notificationLevel:e.notification_level}})),n=a.body.meta.next_token,t=[].concat(RP(t),RP(o));case 10:if(n){e.next=2;break}case 11:return e.abrupt("return",t);case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_onConversationRemoved",value:function(e){var t=this.conversations.get(e);t&&(this.conversations.delete(e),this.emit("conversationRemoved",t))}},{key:"_registerForEvents",value:function(e){var t=this;e.on("removed",(function(){return t._onConversationRemoved(e.sid)})),e.on("updated",(function(e){return t.emit("conversationUpdated",e)})),e.on("participantJoined",(function(e){return t.emit("participantJoined",e)})),e.on("participantLeft",(function(e){return t.emit("participantLeft",e)})),e.on("participantUpdated",(function(e){return t.emit("participantUpdated",e)})),e.on("messageAdded",(function(e){return t.emit("messageAdded",e)})),e.on("messageUpdated",(function(e){return t.emit("messageUpdated",e)})),e.on("messageRemoved",(function(e){return t.emit("messageRemoved",e)})),e.on("typingStarted",(function(e){return t.emit("typingStarted",e)})),e.on("typingEnded",(function(e){return t.emit("typingEnded",e)}))}}]),p}(om),NA=Rn,UA=Qr.find,FA=Gf,DA="find",BA=!0;function qA(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}DA in[]&&Array(1).find((function(){BA=!1})),NA({target:"Array",proto:!0,forced:BA},{find:function(e){return UA(this,e,arguments.length>1?arguments[1]:void 0)}}),FA(DA);var zA=function(e){Ca(a,e);var t,n,r,i=qA(a);function a(e,t,n){var r;return Na(this,a),(r=i.call(this)).configuration=t,r.services=n,r.fifoStack=[],r.myself=e,r.myself.on("updated",(function(e){return r.emit("userUpdated",e)})),r.myself.on("userSubscribed",(function(){return r.emit("userSubscribed",r.myself)})),r.myself.on("userUnsubscribed",(function(){r.emit("userUnsubscribed",r.myself),r.myself._ensureFetched()})),r.subscribedUsers=new Map,r}return La(a,[{key:"handleUnsubscribeUser",value:function(e){this.subscribedUsers.has(e.identity)&&this.subscribedUsers.delete(e.identity);var t=0;this.fifoStack.find((function(n,r){return n==e.identity&&(t=r,!0)}))&&this.fifoStack.splice(t,1),this.emit("userUnsubscribed",e)}},{key:"handleSubscribeUser",value:function(e){if(!this.subscribedUsers.has(e.identity)){if(this.fifoStack.length>=this.configuration.userInfosToSubscribe){var t,n,r=this.fifoStack.shift();null===(t=this.subscribedUsers)||void 0===t||null===(n=t.get(r))||void 0===n||n.unsubscribe()}this.fifoStack.push(e.identity),this.subscribedUsers.set(e.identity,e),this.emit("userSubscribed",e)}}},{key:"getUser",value:(r=Ta(Wc.mark((function e(t,n){var r,i,a,o=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:if(t!=this.myself.identity){e.next=4;break}return e.abrupt("return",this.myself);case 4:if(!(i=this.subscribedUsers.get(t))){e.next=7;break}return e.abrupt("return",i);case 7:if(null===(r=n)||void 0===r){e.next=11;break}e.next=14;break;case 11:return e.next=13,this.getSyncUniqueName(t);case 13:n=e.sent;case 14:return(a=new User(t,n,this.configuration,this.services)).on("updated",(function(e){return o.emit("userUpdated",e)})),a.on("userSubscribed",(function(){return o.handleSubscribeUser(a)})),a.on("userUnsubscribed",(function(){return o.handleUnsubscribeUser(a)})),e.next=20,a._ensureFetched();case 20:return e.abrupt("return",a);case 21:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getSubscribedUsers",value:(n=Ta(Wc.mark((function e(){var t;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.myself._ensureFetched();case 2:return t=[this.myself],this.subscribedUsers.forEach((function(e){return t.push(e)})),e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getSyncUniqueName",value:(t=Ta(Wc.mark((function e(t){var n,r,i,a;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new yh(this.configuration.links.users).path(t).build(),e.next=3,this.services.network.get(i);case 3:return a=e.sent,e.abrupt("return",null!==(n=null===(r=a.body)||void 0===r?void 0:r.sync_objects.user_info_map)&&void 0!==n?n:"");case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),a}(om),WA=If.scope("TypingIndicator"),GA=function(){function e(t,n,r){Na(this,e),this.configuration=n,this.services=r,this.getConversation=t,this.serviceTypingTimeout=null,this.sentUpdates=new Map}var t;return La(e,[{key:"typingTimeout",get:function(){return this.configuration.typingIndicatorTimeoutOverride||this.serviceTypingTimeout||this.configuration.typingIndicatorTimeoutDefault}},{key:"initialize",value:function(){var e=this;this.services.notificationClient.on("message",function(){var t=Ta(Wc.mark((function t(n,r){return Wc.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==Bg.TYPING_INDICATOR){t.next=3;break}return t.next=3,e._handleRemoteTyping(r);case 3:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}())}},{key:"_handleRemoteTyping",value:(t=Ta(Wc.mark((function e(t){var n=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:WA.trace("Got new typing indicator ",t),this.getConversation(t.channel_sid).then((function(e){e&&e._participants.forEach((function(e){if(e.identity===t.identity){var r=n.configuration.typingIndicatorTimeoutOverride?n.configuration.typingIndicatorTimeoutOverride+1e3:1e3*t.typing_timeout;e._startTyping(r)}}))})).catch((function(e){throw WA.error(e),e}));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"send",value:function(e){var t=this.sentUpdates.get(e);return t&&t>Date.now()-this.typingTimeout?Promise.resolve():(this.sentUpdates.set(e,Date.now()),this._send(e))}},{key:"_send",value:function(e){var t=this;WA.trace("Sending typing indicator");var n=this.configuration.links.typing,r="ChannelSid=".concat(e);return this.services.twilsockClient.post(n,{"Content-Type":"application/x-www-form-urlencoded"},r,this.configuration.productId).then((function(e){e.body.hasOwnProperty("typing_timeout")&&(t.serviceTypingTimeout=1e3*e.body.typing_timeout)})).catch((function(e){throw WA.error("Failed to send typing indicator:",e),e}))}}]),e}(),PushNotification=La((function PushNotification(e){Na(this,PushNotification),this.title=e.title||null,this.body=e.body||null,this.sound=e.sound||null,this.badge=e.badge||null,this.action=e.action||null,this.type=e.type||null,this.data=e.data||{}})),$A="2.2.1";function VA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function JA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?VA(Object(n),!0).forEach((function(t){ja(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):VA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var KA,HA,YA=function(e){return e.replace(/(^\/+|\/+$)/g,"")},QA=function(){function e(t,n,r){Na(this,e),this._serviceUrl=t,this._services=n,this._productId=r}var t,n,r;return La(e,[{key:"_preProcessUrl",value:function(e){var t=YA(e);return/^https?:\/\//.test(e)?t:"".concat(YA(this._serviceUrl),"/").concat(t)}},{key:"_makeRequest",value:(r=Ta(Wc.mark((function e(t,n,r,i){var a,o,s,u;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=this._preProcessUrl(n),o=JA({"Content-Type":"application/json; charset=utf-8"},i||{}),e.t0=t,e.next="get"===e.t0?5:"post"===e.t0?11:"delete"===e.t0?15:19;break;case 5:return u=a,r&&(u+="?"+Object.entries(r).map((function(e){return e.map(encodeURIComponent).join("=")})).join("&")),e.next=9,this._services.transport.get(u,o,this._productId);case 9:case 13:case 17:return s=e.sent,e.abrupt("break",19);case 11:return e.next=13,this._services.transport.post(a,o,JSON.stringify(r),this._productId);case 15:return e.next=17,this._services.transport.delete(a,o,{},this._productId);case 19:if(!(s.status.code<200||s.status.code>=300)){e.next=21;break}throw new Error("Request responded with a non-success code ".concat(s.status.code));case 21:return e.abrupt("return",s);case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,n,i){return r.apply(this,arguments)})},{key:"fetchResource",value:(n=Ta(Wc.mark((function e(t,n){var r,i=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=1,e.next=4,new Lg({min:50,max:1600,maxAttemptsCount:6}).run((function(){return i._makeRequest("get",t,n)}));case 4:return r=e.sent,e.abrupt("return",r.body);case 8:throw e.prev=8,e.t0=e.catch(1),new Error('Fetch resource from "'.concat(t,'" failed.'));case 11:case"end":return e.stop()}}),e,null,[[1,8]])}))),function(e,t){return n.apply(this,arguments)})},{key:"mutateResource",value:(t=Ta(Wc.mark((function e(t,n,r){var i;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._makeRequest(t,n,r,{"X-Twilio-Mutation-Id":Sb.v4()});case 2:if(202!==(i=e.sent).status.code){e.next=7;break}return e.next=6,this.fetchResource(i.body.resource_url);case 6:return e.abrupt("return",e.sent);case 7:return e.abrupt("return",i.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,n,r){return t.apply(this,arguments)})}]),e}();function XA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ZA(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?XA(Object(n),!0).forEach((function(t){ja(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):XA(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ej(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Aa(e);if(t){var i=Aa(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Pa(this,n)}}var tj=La((function e(){Na(this,e)}));return e.Client=(KA=function(e){Ca(Client,e);var t,n,r,i,a,o,s,u,c,l,f,d,p,h,v,y=ej(Client);function Client(e){var t,n,r,i,a,o,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(Na(this,Client),ja(Ra(o=y.call(this)),"version",$A),ja(Ra(o),"connectionState","unknown"),ja(Ra(o),"parsePushNotification",HA.parsePushNotification),o._fpaToken=null!=e?e:"",o._options=null!=s?s:{},!o._options.disableDeepClone){var u=ZA(ZA({},o._options),{},{transport:void 0,twilsockClient:void 0});(u=dh(u)).transport=o._options.transport,u.twilsockClient=o._options.twilsockClient,o._options=u}o._options.logLevel=null!==(t=o._options.logLevel)&&void 0!==t?t:"silent",HA._logger.setLevel(o._options.logLevel);var c=o._options.productId="ip_messaging";if(o._options.clientMetadata=o._options.clientMetadata||{},o._options.clientMetadata.hasOwnProperty("type")||(o._options.clientMetadata.type="conversations"),o._options.clientMetadata.hasOwnProperty("sdk")||(o._options.clientMetadata.sdk="JS",o._options.clientMetadata.sdkv=$A),o._options.Sync=o._options.Sync||{},void 0===o._options.Sync.enableSessionStorage&&(o._options.Sync.enableSessionStorage=!0),o._options.region&&(o._options.Sync.region=o._options.region),!e)throw new Error("A valid Twilio token should be provided");o._services=new tj,o._myself=new User("","",null,o._services);var l=!o._options.twilsockClient;if(!o._options.initRegistrations){var f=new qg.InitRegistration(c);HA.populateInitRegistrations(f),o._options.initRegistrations=[f]}o._services.twilsockClient=o._options.twilsockClient=null!==(n=o._options.twilsockClient)&&void 0!==n?n:new qg.TwilsockClient(e,c,o._options),o._services.twilsockClient.on("tokenAboutToExpire",(function(){return o.emit("tokenAboutToExpire")})),o._services.twilsockClient.on("tokenExpired",(function(){return o.emit("tokenExpired")})),o._services.twilsockClient.on("connectionError",(function(e){return o.emit("connectionError",e)})),o._services.twilsockClient.on("stateChanged",(function(e){HA._logger.debug("Handling stateChanged for ConversationsClient: new state ".concat(e)),e!==o.connectionState&&(o.connectionState=e,o.emit("connectionStateChanged",o.connectionState))})),o._services.transport=o._options.transport=null!==(r=o._options.transport)&&void 0!==r?r:o._options.twilsockClient,o._services.notificationClient=o._options.notificationsClient=null!==(i=o._options.notificationsClient)&&void 0!==i?i:new PE.Notifications(e,o._options),o._services.syncClient=o._options.syncClient=null!==(a=o._options.syncClient)&&void 0!==a?a:new fI(e,o._options);var d=(null==s?void 0:s.Chat)||(null==s?void 0:s.IPMessaging)||s||{},p=d.region||(null==s?void 0:s.region),h=d.apiUri||d.typingUri||"https://aim.".concat(p||"us1",".twilio.com");o._services.commandExecutor=new QA(h,{transport:o._options.transport},c);var v=function(e){o._rejectEnsureReady(e),o.emit("stateChanged","failed"),o.emit("initFailed",{error:e})},m=function(){v({terminal:!0,message:"Twilsock has disconnected."})};return o._services.twilsockClient.once("connectionError",v),o._services.twilsockClient.once("disconnected",m),o._services.twilsockClient.once("connected",Ta(Wc.mark((function e(){var t,n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return HA._logger.debug("ConversationsClient started INITIALIZING"),o._services.twilsockClient.off("connectionError",v),o._services.twilsockClient.off("disconnected",m),e.prev=3,t="conversations.client.startup",o._services.twilsockClient.addPartialTelemetryEvent(new qg.TelemetryEventDescription(t,"Conversations client startup",new Date),t,qg.TelemetryPoint.Start),e.next=8,o._initialize();case 8:o._services.twilsockClient.addPartialTelemetryEvent(new qg.TelemetryEventDescription("","",new Date),t,qg.TelemetryPoint.End),e.next=17;break;case 11:e.prev=11,e.t0=e.catch(3),n={terminal:!0,message:e.t0.message},o._rejectEnsureReady(n),o.emit("stateChanged","failed"),o.emit("initFailed",{error:n});case 17:case"end":return e.stop()}}),e,null,[[3,11]])})))),o._ensureReady=new Promise((function(e,t){o._resolveEnsureReady=e,o._rejectEnsureReady=t})).catch((function(){})),l&&o._services.twilsockClient.connect(),o}return La(Client,[{key:"user",get:function(){return this._myself}},{key:"reachabilityEnabled",get:function(){if(!this._configuration)throw new Error("Reachability information could not yet be accessed as the client has not yet been initialized. Subscribe to the 'stateChanged' event to properly react to the client initialization.");return this._configuration.reachabilityEnabled}},{key:"token",get:function(){return this._fpaToken}},{key:"shutdown",value:(v=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._services.twilsockClient.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"updateToken",value:(h=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:if(HA._logger.info("updateToken"),this._fpaToken!==t){e.next=5;break}return e.abrupt("return",this);case 5:return e.next=7,this._services.twilsockClient.updateToken(t);case 7:return e.next=9,this._services.notificationClient.updateToken(t);case 9:return e.next=11,this._services.mcsClient.updateToken(t);case 11:return this._fpaToken=t,e.abrupt("return",this);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"getConversationBySid",value:(p=Ta(Wc.mark((function e(t){var n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.myConversationsRead.promise;case 4:return e.next=6,this._conversationsEntity.getConversation(t);case 6:if(n=e.sent){e.next=12;break}return e.next=10,this.peekConversationBySid(t);case 10:(n=e.sent)&&dA("The method getConversationBySid is deprecated to retrieve conversations you're not part of. Use peekConversationBySid instead.");case 12:if(n){e.next=14;break}throw new Error("Conversation with SID ".concat(t," was not found."));case 14:return e.abrupt("return",n);case 15:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"peekConversationBySid",value:(d=Ta(Wc.mark((function e(t){var n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.peekConversation(t);case 4:if(n=e.sent){e.next=7;break}throw new Error("Conversation with SID ".concat(t," was not found."));case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(f=Ta(Wc.mark((function e(t){var n;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.next=4,this._conversationsEntity.myConversationsRead.promise;case 4:return e.next=6,this._conversationsEntity.getConversationByUniqueName(t);case 6:if(n=e.sent){e.next=9;break}throw new Error("Conversation with unique name ".concat(t," was not found."));case 9:return e.abrupt("return",n);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"getSubscribedConversations",value:(l=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._conversationsPromise.then((function(e){return e.getConversations()})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"createConversation",value:(c=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return t=t||{},e.abrupt("return",this._conversationsPromise.then((function(e){return e.addConversation(t)})));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"setPushRegistrationId",value:(u=Ta(Wc.mark((function e(t,n){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return this._subscribeToPushNotifications(t),this._services.notificationClient.setPushRegistrationId(t,n),e.next=6,this._services.notificationClient.commitChanges();case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"unsetPushRegistrationId",value:(s=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return this._unsubscribeFromPushNotifications(t),e.next=5,this._services.notificationClient.commitChanges();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"removePushRegistrations",value:(o=Ta(Wc.mark((function e(t,n){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.notificationClient.removeRegistrations(t,n);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"handlePushNotification",value:(a=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:HA._logger.debug("handlePushNotification, notificationPayload=",t),this.emit("pushNotification",HA.parsePushNotification(t));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getUser",value:(i=Ta(Wc.mark((function e(t){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._services.users.getUser(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"getSubscribedUsers",value:(r=Ta(Wc.mark((function e(){return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ensureReady;case 2:return e.abrupt("return",this._services.users.getSubscribedUsers());case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"getTemporaryContentUrlsForMediaSids",value:function(e){var t=this;return new yI.CancellablePromise(function(){var n=Ta(Wc.mark((function n(r,i,a){var o,s;return Wc.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t._services.mcsClient&&e){n.next=3;break}return i(new Error("Media Content Service is unavailable")),n.abrupt("return");case 3:return o=t._services.mcsClient.mediaSetGetContentUrls(e),a((function(){o.cancel()})),n.prev=5,n.next=8,o;case 8:s=n.sent,r(s),n.next=15;break;case 12:n.prev=12,n.t0=n.catch(5),i(n.t0);case 15:case"end":return n.stop()}}),n,null,[[5,12]])})));return function(e,t,r){return n.apply(this,arguments)}}())}},{key:"getTemporaryContentUrlsForMedia",value:function(e){var t=e.map((function(e){return e.sid}));return this.getTemporaryContentUrlsForMediaSids(t)}},{key:"_initialize",value:(n=Ta(Wc.mark((function e(){var t,n=this;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._services.commandExecutor.fetchResource("Client/v2/Configuration");case 2:return t=e.sent,this._configuration=new Df(this._options,t,HA._logger),this._myself._resolveInitialization(this._configuration,this._configuration.userIdentity,this._configuration.userInfo,!0),this._services.typingIndicator=new GA(this.getConversationBySid.bind(this),this._configuration,this._services),this._services.network=new Dg(this._configuration,this._services),this._services.users=new zA(this._myself,this._configuration,this._services),this._services.users.on("userSubscribed",(function(e){n.emit("userSubscribed",e)})),this._services.users.on("userUpdated",(function(e){return n.emit("userUpdated",e)})),this._services.users.on("userUnsubscribed",(function(e){n.emit("userUnsubscribed",e)})),this._conversationsEntity=new LA(this._configuration,this._services),this._conversationsEntity.on("conversationAdded",(function(e){n.emit("conversationAdded",e)})),this._conversationsEntity.on("conversationRemoved",(function(e){n.emit("conversationRemoved",e)})),this._conversationsEntity.on("conversationJoined",(function(e){n.emit("conversationJoined",e)})),this._conversationsEntity.on("conversationLeft",(function(e){n.emit("conversationLeft",e)})),this._conversationsEntity.on("conversationUpdated",(function(e){return n.emit("conversationUpdated",e)})),this._conversationsEntity.on("participantJoined",(function(e){n.emit("participantJoined",e)})),this._conversationsEntity.on("participantLeft",(function(e){n.emit("participantLeft",e)})),this._conversationsEntity.on("participantUpdated",(function(e){return n.emit("participantUpdated",e)})),this._conversationsEntity.on("messageAdded",(function(e){return n.emit("messageAdded",e)})),this._conversationsEntity.on("messageUpdated",(function(e){return n.emit("messageUpdated",e)})),this._conversationsEntity.on("messageRemoved",(function(e){return n.emit("messageRemoved",e)})),this._conversationsEntity.on("typingStarted",(function(e){return n.emit("typingStarted",e)})),this._conversationsEntity.on("typingEnded",(function(e){return n.emit("typingEnded",e)})),this._conversationsPromise=this._conversationsEntity.fetchConversations().then((function(){return n._conversationsEntity})).catch((function(e){throw e})),e.next=28,this._services.users.myself._ensureFetched();case 28:HA._supportedPushChannels.forEach((function(e){return n._subscribeToPushNotifications(e)})),this._services.typingIndicator.initialize(),this._services.mcsClient=new yI.McsClient(this._fpaToken,this._configuration.links.mediaService,this._configuration.links.mediaSetService,ZA(ZA({},this._options),{},{transport:void 0})),this._resolveEnsureReady(),this.emit("stateChanged","initialized"),this.emit("initialized");case 34:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"_subscribeToPushNotifications",value:function(e){var t=this;[Bg.NEW_MESSAGE,Bg.ADDED_TO_CONVERSATION,Bg.REMOVED_FROM_CONVERSATION,Bg.TYPING_INDICATOR,Bg.CONSUMPTION_UPDATE].forEach((function(n){t._services.notificationClient.subscribe(e,n)}))}},{key:"_unsubscribeFromPushNotifications",value:function(e){var t=this;[Bg.NEW_MESSAGE,Bg.ADDED_TO_CONVERSATION,Bg.REMOVED_FROM_CONVERSATION,Bg.TYPING_INDICATOR,Bg.CONSUMPTION_UPDATE].forEach((function(n){t._services.notificationClient.unsubscribe(e,n)}))}}],[{key:"create",value:(t=Ta(Wc.mark((function e(t,n){var r;return Wc.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==n||!n.twilsockClient){e.next=2;break}throw new Error("Obsolete usage of ConversationsClient.create() factory method: if you pass twilsock from the outside then you must use ConversationsClient constructor and be prepared to work with uninitialized client.");case 2:return r=new HA(t,n),e.next=5,r._ensureReady;case 5:return e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})},{key:"parsePushNotification",value:function(e){if(HA._logger.debug("parsePushNotification, notificationPayload=",e),void 0!==e.aps){if(!e.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var t,n,r,i=HA._parsePushNotificationChatData(e),a=e.aps,o=null;if("string"==typeof a.alert)t=a.alert||null;else t=(null===(n=a.alert)||void 0===n?void 0:n.body)||null,o=(null===(r=a.alert)||void 0===r?void 0:r.title)||null;return new PushNotification({title:o,body:t,sound:a.sound||null,badge:a.badge||null,action:a.category||null,type:e.twi_message_type,data:i})}if(void 0!==e.data){var s=e.data;if(!s.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var u=HA._parsePushNotificationChatData(e.data);return new PushNotification({title:s.twi_title||null,body:s.twi_body||null,sound:s.twi_sound||null,badge:null,action:s.twi_action||null,type:s.twi_message_type,data:u})}throw new Error("Provided push notification payload is not Programmable Chat notification")}},{key:"_parsePushNotificationChatData",value:function(e){var t={};for(var n in HA._supportedPushDataFields){var r=e[n];if(null!=r)if("message_index"!==n&&"media_count"!==n){if("media"!==n)t[HA._supportedPushDataFields[n]]=r;else if("string"==typeof r)try{t[HA._supportedPushDataFields[n]]=JSON.parse(r)}catch(e){HA._logger.debug("Media message notification parsing error")}}else{var i=ph(r);null!==i&&(t[HA._supportedPushDataFields[n]]=i)}}return t}},{key:"populateInitRegistrations",value:function(e){e.populateInitRegistrations([Bg.TYPING_INDICATOR]),fI.populateInitRegistrations(e)}}]),Client}(om),ja(KA,"conversationAdded","conversationAdded"),ja(KA,"conversationJoined","conversationJoined"),ja(KA,"conversationLeft","conversationLeft"),ja(KA,"conversationRemoved","conversationRemoved"),ja(KA,"conversationUpdated","conversationUpdated"),ja(KA,"participantJoined","participantJoined"),ja(KA,"participantLeft","participantLeft"),ja(KA,"participantUpdated","participantUpdated"),ja(KA,"messageAdded","messageAdded"),ja(KA,"messageRemoved","messageRemoved"),ja(KA,"messageUpdated","messageUpdated"),ja(KA,"tokenAboutToExpire","tokenAboutToExpire"),ja(KA,"tokenExpired","tokenExpired"),ja(KA,"typingEnded","typingEnded"),ja(KA,"typingStarted","typingStarted"),ja(KA,"pushNotification","pushNotification"),ja(KA,"userSubscribed","userSubscribed"),ja(KA,"userUnsubscribed","userUnsubscribed"),ja(KA,"userUpdated","userUpdated"),ja(KA,"stateChanged","stateChanged"),ja(KA,"initialized","initialized"),ja(KA,"initFailed","initFailed"),ja(KA,"connectionStateChanged","connectionStateChanged"),ja(KA,"connectionError","connectionError"),ja(KA,"version",$A),ja(KA,"_logger",If.scope("Client")),ja(KA,"_supportedPushChannels",["fcm","apn"]),ja(KA,"_supportedPushDataFields",{conversation_sid:"conversationSid",conversation_title:"conversationTitle",message_sid:"messageSid",message_index:"messageIndex",media_count:"mediaCount",media:"media"}),HA=KA),$c([fA("token"),Vc("design:type",String),Vc("design:paramtypes",[])],e.Client.prototype,"token",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],e.Client.prototype,"updateToken",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],e.Client.prototype,"getConversationBySid",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],e.Client.prototype,"peekConversationBySid",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],e.Client.prototype,"getConversationByUniqueName",null),$c([wy(["undefined",my("conversation options",{friendlyName:["string","undefined"],isPrivate:["boolean","undefined"],uniqueName:["string","undefined"]})]),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],e.Client.prototype,"createConversation",null),$c([wy(py("fcm","apn"),"string"),Vc("design:type",Function),Vc("design:paramtypes",[String,String]),Vc("design:returntype",Promise)],e.Client.prototype,"setPushRegistrationId",null),$c([wy(py("fcm","apn")),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],e.Client.prototype,"unsetPushRegistrationId",null),$c([wy(py("fcm","apn"),vy),Vc("design:type",Function),Vc("design:paramtypes",[String,String]),Vc("design:returntype",Promise)],e.Client.prototype,"removePushRegistrations",null),$c([wy(gy),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",Promise)],e.Client.prototype,"handlePushNotification",null),$c([wy(vy),Vc("design:type",Function),Vc("design:paramtypes",[String]),Vc("design:returntype",Promise)],e.Client.prototype,"getUser",null),$c([wy(hy("strings","string")),Vc("design:type",Function),Vc("design:paramtypes",[Array]),Vc("design:returntype",yI.CancellablePromise)],e.Client.prototype,"getTemporaryContentUrlsForMediaSids",null),$c([wy(hy("media",Media)),Vc("design:type",Function),Vc("design:paramtypes",[Array]),Vc("design:returntype",yI.CancellablePromise)],e.Client.prototype,"getTemporaryContentUrlsForMedia",null),$c([fA("Client.create()","new Client()"),wy("string",["undefined",gy]),Vc("design:type",Function),Vc("design:paramtypes",[String,Object]),Vc("design:returntype",Promise)],e.Client,"create",null),$c([ky(gy),Vc("design:type",Function),Vc("design:paramtypes",[Object]),Vc("design:returntype",PushNotification)],e.Client,"parsePushNotification",null),e.Client=HA=$c([by(vy,[gy,"undefined"]),Vc("design:paramtypes",[String,Object])],e.Client),e.AggregatedDeliveryReceipt=AggregatedDeliveryReceipt,e.CancellablePromise=yI.CancellablePromise,e.Conversation=Conversation,e.DetailedDeliveryReceipt=DetailedDeliveryReceipt,e.Media=Media,e.Message=Message,e.MessageBuilder=_A,e.NotificationTypes=Bg,e.Participant=Participant,e.PushNotification=PushNotification,e.RestPaginator=oA,e.UnsentMessage=xA,e.User=User,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
