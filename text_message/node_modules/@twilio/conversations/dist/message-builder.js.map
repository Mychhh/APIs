{"version":3,"file":"message-builder.js","sources":["../src/message-builder.ts"],"sourcesContent":["import { CancellablePromise } from \"@twilio/mcs-client\";\nimport { ConversationLimits } from \"./interfaces/conversation-limits\";\nimport { SendMediaOptions } from \"./conversation\";\nimport { UnsentMessage } from \"./unsent-message\";\nimport { JSONValue } from \"./types\";\nimport { Messages } from \"./data/messages\";\n\n/**\n * Message builder. Allows the message to be built and sent via method chaining.\n *\n * Example:\n *\n * ```ts\n * await testConversation.prepareMessage()\n *   .setBody('Hello!')\n *   .setAttributes({foo: 'bar'})\n *   .addMedia(media1)\n *   .addMedia(media2)\n *   .build()\n *   .send();\n * ```\n */\nclass MessageBuilder {\n  private readonly message: UnsentMessage;\n  private emailBodies: Map<string, FormData | SendMediaOptions>;\n  private emailHistories: Map<string, FormData | SendMediaOptions>;\n\n  /**\n   * @internal\n   */\n  constructor(\n    private readonly limits: ConversationLimits,\n    messagesEntity: Messages\n  ) {\n    this.message = new UnsentMessage(messagesEntity);\n    this.emailBodies = new Map<string, FormData | SendMediaOptions>();\n    this.emailHistories = new Map<string, FormData | SendMediaOptions>();\n  }\n\n  /**\n   * Sets the message body.\n   * @param text Contents of the body.\n   */\n  setBody(text: string): MessageBuilder {\n    this.message.text = text;\n    return this;\n  }\n\n  /**\n   * Sets the message subject.\n   * @param subject Contents of the subject.\n   */\n  setSubject(subject: string): MessageBuilder {\n    this.message.emailOptions.subject = subject;\n    return this;\n  }\n\n  /**\n   * Sets the message attributes.\n   * @param attributes Message attributes.\n   */\n  setAttributes(attributes: JSONValue): MessageBuilder {\n    this.message.attributes = attributes;\n    return this;\n  }\n\n  /**\n   * Set the email body with a given content type.\n   * @param contentType Format of the body to set (text/plain or text/html).\n   * @param body Body payload in the selected format.\n   */\n  setEmailBody(\n    contentType: string,\n    body: FormData | SendMediaOptions\n  ): MessageBuilder {\n    this.emailBodies.set(contentType, body);\n    return this;\n  }\n\n  /**\n   * Set the email history with a given content type.\n   * @param contentType Format of the history to set (text/plain or text/html).\n   * @param history History payload in the selected format.\n   */\n  setEmailHistory(\n    contentType: string,\n    history: FormData | SendMediaOptions\n  ): MessageBuilder {\n    this.emailHistories.set(contentType, history);\n    return this;\n  }\n\n  /**\n   * Adds media to the message.\n   * @param payload Media to add.\n   */\n  addMedia(payload: FormData | SendMediaOptions): MessageBuilder {\n    if (typeof FormData === \"undefined\" && payload instanceof FormData) {\n      throw new Error(\"Could not add FormData content whilst not in a browser\");\n    }\n    if (!(payload instanceof FormData)) {\n      const mediaOptions = payload as SendMediaOptions;\n      if (!mediaOptions.contentType || !mediaOptions.media) {\n        throw new Error(\n          \"Media content in SendMediaOptions must contain non-empty contentType and media\"\n        );\n      }\n    }\n    this.message.mediaContent.push([\"media\", payload]);\n    return this;\n  }\n\n  /**\n   * Builds the message, making it ready to be sent.\n   */\n  build(): UnsentMessage {\n    this.emailBodies.forEach((_, key) => {\n      if (!this.limits.emailBodiesAllowedContentTypes.includes(key)) {\n        throw new Error(`Unsupported email body content type ${key}`);\n      }\n    });\n    this.emailHistories.forEach((_, key) => {\n      if (!this.limits.emailHistoriesAllowedContentTypes.includes(key)) {\n        throw new Error(`Unsupported email history content type ${key}`);\n      }\n    });\n    if (\n      this.emailBodies.size > this.limits.emailBodiesAllowedContentTypes.length\n    ) {\n      throw new Error(\n        `Too many email bodies attached to the message (${this.emailBodies.size} > ${this.limits.emailBodiesAllowedContentTypes.length})`\n      );\n    }\n    if (\n      this.emailHistories.size >\n      this.limits.emailHistoriesAllowedContentTypes.length\n    ) {\n      throw new Error(\n        `Too many email histories attached to the message (${this.emailHistories.size} > ${this.limits.emailHistoriesAllowedContentTypes.length})`\n      );\n    }\n\n    if (\n      this.message.mediaContent.length > this.limits.mediaAttachmentsCountLimit\n    ) {\n      throw new Error(\n        `Too many media attachments in the message (${this.message.mediaContent.length} > ${this.limits.mediaAttachmentsCountLimit})`\n      );\n    }\n\n    // @todo we don't know the sizes of the attachments in FormData\n    // @todo insertion below makes build() method non-repeatable - probably move to UnsentMessage.send() or even sendV2()?\n\n    this.emailBodies.forEach((body) => {\n      this.message.mediaContent.push([\"body\", body]);\n    });\n\n    this.emailHistories.forEach((history) => {\n      this.message.mediaContent.push([\"history\", history]);\n    });\n\n    return this.message;\n  }\n\n  /**\n   * Prepares a message and sends it to the conversation.\n   */\n  buildAndSend(): CancellablePromise<number | null> {\n    return this.build().send();\n  }\n\n  private getPayloadContentType(\n    payload: FormData | SendMediaOptions\n  ): string | null {\n    if (typeof FormData !== \"undefined\" && payload instanceof FormData) {\n      return payload.get(\"Content-Type\") as string;\n    }\n    return (payload as SendMediaOptions).contentType;\n  }\n}\n\nexport { MessageBuilder };\n"],"names":["UnsentMessage"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAOA;;;;;;;;;;;;;;AAcG;AACH,MAAM,cAAc,CAAA;AAKlB;;AAEG;IACH,WACmB,CAAA,MAA0B,EAC3C,cAAwB,EAAA;QADP,IAAM,CAAA,MAAA,GAAN,MAAM,CAAoB;QAG3C,IAAI,CAAC,OAAO,GAAG,IAAIA,2BAAa,CAAC,cAAc,CAAC,CAAC;AACjD,QAAA,IAAI,CAAC,WAAW,GAAG,IAAI,GAAG,EAAuC,CAAC;AAClE,QAAA,IAAI,CAAC,cAAc,GAAG,IAAI,GAAG,EAAuC,CAAC;KACtE;AAED;;;AAGG;AACH,IAAA,OAAO,CAAC,IAAY,EAAA;AAClB,QAAA,IAAI,CAAC,OAAO,CAAC,IAAI,GAAG,IAAI,CAAC;AACzB,QAAA,OAAO,IAAI,CAAC;KACb;AAED;;;AAGG;AACH,IAAA,UAAU,CAAC,OAAe,EAAA;QACxB,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,OAAO,GAAG,OAAO,CAAC;AAC5C,QAAA,OAAO,IAAI,CAAC;KACb;AAED;;;AAGG;AACH,IAAA,aAAa,CAAC,UAAqB,EAAA;AACjC,QAAA,IAAI,CAAC,OAAO,CAAC,UAAU,GAAG,UAAU,CAAC;AACrC,QAAA,OAAO,IAAI,CAAC;KACb;AAED;;;;AAIG;IACH,YAAY,CACV,WAAmB,EACnB,IAAiC,EAAA;QAEjC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,WAAW,EAAE,IAAI,CAAC,CAAC;AACxC,QAAA,OAAO,IAAI,CAAC;KACb;AAED;;;;AAIG;IACH,eAAe,CACb,WAAmB,EACnB,OAAoC,EAAA;QAEpC,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,WAAW,EAAE,OAAO,CAAC,CAAC;AAC9C,QAAA,OAAO,IAAI,CAAC;KACb;AAED;;;AAGG;AACH,IAAA,QAAQ,CAAC,OAAoC,EAAA;QAC3C,IAAI,OAAO,QAAQ,KAAK,WAAW,IAAI,OAAO,YAAY,QAAQ,EAAE;AAClE,YAAA,MAAM,IAAI,KAAK,CAAC,wDAAwD,CAAC,CAAC;AAC3E,SAAA;AACD,QAAA,IAAI,EAAE,OAAO,YAAY,QAAQ,CAAC,EAAE;YAClC,MAAM,YAAY,GAAG,OAA2B,CAAC;YACjD,IAAI,CAAC,YAAY,CAAC,WAAW,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE;AACpD,gBAAA,MAAM,IAAI,KAAK,CACb,gFAAgF,CACjF,CAAC;AACH,aAAA;AACF,SAAA;AACD,QAAA,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC,CAAC;AACnD,QAAA,OAAO,IAAI,CAAC;KACb;AAED;;AAEG;IACH,KAAK,GAAA;QACH,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,GAAG,KAAI;YAClC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,8BAA8B,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;AAC7D,gBAAA,MAAM,IAAI,KAAK,CAAC,uCAAuC,GAAG,CAAA,CAAE,CAAC,CAAC;AAC/D,aAAA;AACH,SAAC,CAAC,CAAC;QACH,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,GAAG,KAAI;YACrC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,iCAAiC,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE;AAChE,gBAAA,MAAM,IAAI,KAAK,CAAC,0CAA0C,GAAG,CAAA,CAAE,CAAC,CAAC;AAClE,aAAA;AACH,SAAC,CAAC,CAAC;AACH,QAAA,IACE,IAAI,CAAC,WAAW,CAAC,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,8BAA8B,CAAC,MAAM,EACzE;AACA,YAAA,MAAM,IAAI,KAAK,CACb,kDAAkD,IAAI,CAAC,WAAW,CAAC,IAAI,MAAM,IAAI,CAAC,MAAM,CAAC,8BAA8B,CAAC,MAAM,CAAA,CAAA,CAAG,CAClI,CAAC;AACH,SAAA;AACD,QAAA,IACE,IAAI,CAAC,cAAc,CAAC,IAAI;AACxB,YAAA,IAAI,CAAC,MAAM,CAAC,iCAAiC,CAAC,MAAM,EACpD;AACA,YAAA,MAAM,IAAI,KAAK,CACb,qDAAqD,IAAI,CAAC,cAAc,CAAC,IAAI,MAAM,IAAI,CAAC,MAAM,CAAC,iCAAiC,CAAC,MAAM,CAAA,CAAA,CAAG,CAC3I,CAAC;AACH,SAAA;AAED,QAAA,IACE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,0BAA0B,EACzE;AACA,YAAA,MAAM,IAAI,KAAK,CACb,8CAA8C,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,MAAM,CAAA,GAAA,EAAM,IAAI,CAAC,MAAM,CAAC,0BAA0B,CAAA,CAAA,CAAG,CAC9H,CAAC;AACH,SAAA;;;QAKD,IAAI,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,IAAI,KAAI;AAChC,YAAA,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC,CAAC;AACjD,SAAC,CAAC,CAAC;QAEH,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,OAAO,KAAI;AACtC,YAAA,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC,CAAC;AACvD,SAAC,CAAC,CAAC;QAEH,OAAO,IAAI,CAAC,OAAO,CAAC;KACrB;AAED;;AAEG;IACH,YAAY,GAAA;AACV,QAAA,OAAO,IAAI,CAAC,KAAK,EAAE,CAAC,IAAI,EAAE,CAAC;KAC5B;AAEO,IAAA,qBAAqB,CAC3B,OAAoC,EAAA;QAEpC,IAAI,OAAO,QAAQ,KAAK,WAAW,IAAI,OAAO,YAAY,QAAQ,EAAE;AAClE,YAAA,OAAO,OAAO,CAAC,GAAG,CAAC,cAAc,CAAW,CAAC;AAC9C,SAAA;QACD,OAAQ,OAA4B,CAAC,WAAW,CAAC;KAClD;AACF;;;;"}